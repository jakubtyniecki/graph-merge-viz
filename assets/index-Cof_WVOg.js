import{r as st,g as nt,c as ke}from"./vendor-Cd8GHXwj.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function s(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(t){if(t.ep)return;t.ep=!0;const a=s(t);fetch(t.href,a)}})();var ot=st();const at=nt(ot),J={UCG:{label:"Undirected Cyclic Graph",directed:!1,acyclic:!1},UTree:{label:"Undirected Tree",directed:!1,acyclic:!0,mustBeConnected:!0},DAG:{label:"Directed Acyclic Graph",directed:!0,acyclic:!0},DG:{label:"Directed Graph",directed:!0,acyclic:!1},Forest:{label:"Forest",directed:!1,acyclic:!0}},Q=()=>({name:"Default",graphType:"UCG",nodeTypes:[],edgeTypes:[],specialTypes:[],defaultLayoutAlgorithm:"fcose"}),it=(o,e="UCG")=>({name:o,graphType:e,nodeTypes:[],edgeTypes:[],specialTypes:[],defaultLayoutAlgorithm:"fcose"}),Ie=[{selector:"node",style:{label:"data(label)","background-color":"#4fc3f7",color:"#e0e0e0","text-valign":"center","text-halign":"center","font-size":"12px",width:40,height:40,"border-width":2,"border-color":"#2a3a5c","text-outline-width":2,"text-outline-color":"#1a1a2e"}},{selector:"edge",style:{width:2,"line-color":"#5a6a8c","target-arrow-color":"#5a6a8c","target-arrow-shape":"triangle","curve-style":"bezier","arrow-scale":.8}},{selector:"node:selected",style:{"border-color":"#fff","border-width":3}},{selector:"edge:selected",style:{"line-color":"#fff","target-arrow-color":"#fff",width:3}},{selector:".edge-excluded",style:{"line-style":"dashed","line-dash-pattern":[6,3]}},{selector:".edge-all-excluded",style:{"line-style":"dotted","line-dash-pattern":[2,4],opacity:.4}},{selector:".node-fully-excluded",style:{"border-style":"dotted","border-width":3,opacity:.5}},{selector:".tracking-hidden",style:{display:"none"}},{selector:".diff-added",style:{"background-color":"#4CAF50","border-color":"#4CAF50","line-color":"#4CAF50","target-arrow-color":"#4CAF50"}},{selector:".diff-removed",style:{"background-color":"#F44336","border-color":"#F44336","line-color":"#F44336","target-arrow-color":"#F44336",opacity:.5,"border-style":"dashed","line-style":"dashed"}},{selector:".diff-modified",style:{"border-color":"#FF9800","border-width":3,"line-color":"#FF9800","target-arrow-color":"#FF9800"}}];function we(o){const e=[...Ie],s=J[o?.graphType];s&&!s.directed&&e.push({selector:"edge",style:{"target-arrow-shape":"none"}});for(const n of o?.nodeTypes||[])e.push({selector:`node[type = "${n.id}"]`,style:{"background-color":n.color}});for(const n of o?.edgeTypes||[])e.push({selector:`edge[type = "${n.id}"]`,style:{"line-color":n.color,"target-arrow-color":n.color}});return e}const _=o=>JSON.parse(JSON.stringify(o)),fe=()=>({nodes:[],edges:[]}),V=o=>o.label,X=o=>`${o.source}→${o.target}`,lt=(o,e,s={},n=null)=>({source:o,target:e,type:n,props:{...s}}),Te=o=>o.nodes.length===0&&o.edges.length===0,ze=(o,e)=>{const s=new Set,n=[e];for(;n.length>0;){const t=n.shift();if(!s.has(t)){s.add(t);for(const a of o.edges)a.target===t&&!s.has(a.source)&&n.push(a.source)}}return{nodes:o.nodes.filter(t=>s.has(t.label)).map(t=>_(t)),edges:o.edges.filter(t=>s.has(t.source)&&s.has(t.target)).map(t=>_(t))}};function R(o,e){if(!o)return[];const s=[],n=new Map(o.nodes.map(i=>[V(i),i])),t=new Map(e.nodes.map(i=>[V(i),i])),a=new Map(o.edges.map(i=>[X(i),i])),l=new Map(e.edges.map(i=>[X(i),i]));for(const[i,r]of t)if(!n.has(i))s.push({type:"node",action:"added",key:i,oldProps:null,newProps:r.props});else{const c=n.get(i);Ee(c.props,r.props)||s.push({type:"node",action:"modified",key:i,oldProps:c.props,newProps:r.props})}for(const[i,r]of n)t.has(i)||s.push({type:"node",action:"removed",key:i,oldProps:r.props,newProps:null});for(const[i,r]of l)if(!a.has(i))s.push({type:"edge",action:"added",key:i,oldProps:null,newProps:r.props});else{const c=a.get(i);Ee(c.props,r.props)||s.push({type:"edge",action:"modified",key:i,oldProps:c.props,newProps:r.props})}for(const[i,r]of a)l.has(i)||s.push({type:"edge",action:"removed",key:i,oldProps:r.props,newProps:null});return s}function Ee(o,e){const s=Object.keys(o),n=Object.keys(e);return s.length!==n.length?!1:s.every(t=>o[t]===e[t])}function rt(o,e){if(!e||e.length===0)return o;const s=new Set(e),n=[...e];for(;n.length>0;){const t=n.shift();for(const a of o.edges)a.target===t&&!s.has(a.source)&&(s.add(a.source),n.push(a.source))}return{nodes:o.nodes.filter(t=>s.has(t.label)),edges:o.edges.filter(t=>s.has(t.source)&&s.has(t.target))}}function Ce(o,e,s=null){const n=new Map(o.nodes.map(a=>[V(a),_(a)])),t=new Map(o.edges.map(a=>[X(a),_(a)]));for(const a of e.nodes){const l=V(a);n.has(l)?n.get(l).props={...a.props}:n.set(l,_(a))}for(const a of e.edges){const l=X(a);t.has(l)?t.get(l).props={...a.props}:t.set(l,_(a))}if(s){const a=new Set(e.nodes.map(r=>V(r))),l=new Set(e.edges.map(r=>X(r)));for(const r of s.nodes){const c=V(r);a.has(c)||n.delete(c)}for(const r of s.edges){const c=X(r);l.has(c)||t.delete(c)}const i=new Set(n.keys());for(const[r,c]of t)(!i.has(c.source)||!i.has(c.target))&&t.delete(r)}return{nodes:[...n.values()],edges:[...t.values()]}}function ct(o){if(!o||typeof o!="object")return{ok:!1,error:"Invalid data: expected an object"};if(!Array.isArray(o.nodes))return{ok:!1,error:"Invalid data: missing nodes array"};if(!Array.isArray(o.edges))return{ok:!1,error:"Invalid data: missing edges array"};const e=new Set;for(const n of o.nodes){if(!n.label||typeof n.label!="string")return{ok:!1,error:"Invalid node: missing or invalid label"};if(e.has(n.label))return{ok:!1,error:`Duplicate node label: "${n.label}"`};if(e.add(n.label),n.props&&typeof n.props!="object")return{ok:!1,error:`Invalid props on node "${n.label}"`}}for(const n of o.edges){if(!n.source||!n.target)return{ok:!1,error:"Invalid edge: missing source or target"};if(!e.has(n.source))return{ok:!1,error:`Edge references unknown source: "${n.source}"`};if(!e.has(n.target))return{ok:!1,error:`Edge references unknown target: "${n.target}"`};if(n.props&&typeof n.props!="object")return{ok:!1,error:`Invalid props on edge "${n.source}→${n.target}"`}}return{ok:!0,graph:{nodes:o.nodes.map(n=>({label:n.label,type:n.type||null,props:n.props||{}})),edges:o.edges.map(n=>({source:n.source,target:n.target,type:n.type||null,props:n.props||{}}))}}}const dt=o=>JSON.stringify(o,null,2);function ut(o){try{const e=JSON.parse(o);return ct(e)}catch(e){return{ok:!1,error:`Invalid JSON: ${e.message}`}}}function pt(o,e="graph.json"){const s=new Blob([dt(o)],{type:"application/json"}),n=URL.createObjectURL(s),t=document.createElement("a");t.href=n,t.download=e,t.click(),URL.revokeObjectURL(n)}function ht(){return new Promise(o=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async()=>{const s=e.files[0];if(!s)return o({ok:!1,error:"No file selected"});try{const n=await s.text();o(ut(n))}catch(n){o({ok:!1,error:`Failed to read file: ${n.message}`})}},e.click()})}function y(o,e="info",s=3e3){const n=document.getElementById("toast-container"),t=document.createElement("div");t.className=`toast toast-${e}`,t.textContent=o,n.appendChild(t),setTimeout(()=>{t.style.opacity="0",t.style.transition="opacity 0.3s",setTimeout(()=>t.remove(),300)},s)}function gt(o,e,s){const n=new Set,t=[s];for(;t.length>0;){const a=t.shift();if(a===e)return!0;if(!n.has(a)){n.add(a);for(const l of o.edges)l.source===a&&!n.has(l.target)&&t.push(l.target)}}return!1}function ft(o,e,s){const n=new Set,t=[e];for(;t.length>0;){const a=t.shift();if(a===s)return!0;if(!n.has(a)){n.add(a);for(const l of o.edges)l.source===a&&!n.has(l.target)&&t.push(l.target),l.target===a&&!n.has(l.source)&&t.push(l.source)}}return!1}function mt(o,e,s,n){return n?gt(o,e,s):ft(o,e,s)}function je(o){if(o.nodes.length===0)return!0;const e=new Set,s=[o.nodes[0].label];for(;s.length>0;){const n=s.shift();if(!e.has(n)){e.add(n);for(const t of o.edges)t.source===n&&!e.has(t.target)&&s.push(t.target),t.target===n&&!e.has(t.source)&&s.push(t.source)}}return e.size===o.nodes.length}function yt(o,e){const s={nodes:o.nodes.filter(n=>n.label!==e),edges:o.edges.filter(n=>n.source!==e&&n.target!==e)};return s.nodes.length>1&&!je(s)}function bt(o,e,s){const n={nodes:[...o.nodes],edges:o.edges.filter(t=>!(t.source===e&&t.target===s))};return!je(n)}function vt(o,e,s){return o.edges.some(n=>n.source===e&&n.target===s||n.source===s&&n.target===e)}function xt(o,e,s,n){const t=J[n];return t?e===s?{ok:!1,error:"Self-loops are not allowed"}:!t.directed&&vt(o,e,s)?{ok:!1,error:`Edge ${e}–${s} already exists`}:t.directed&&o.edges.some(a=>a.source===e&&a.target===s)?{ok:!1,error:`Edge ${e}→${s} already exists`}:t.acyclic&&mt(o,e,s,t.directed)?{ok:!1,error:`Adding this edge would create a cycle (${t.label} must be acyclic)`}:{ok:!0}:{ok:!0}}function St(o,e){if(e){const s=new Set,n=new Set,t=a=>{s.add(a),n.add(a);for(const l of o.edges)if(l.source===a&&(n.has(l.target)||!s.has(l.target)&&t(l.target)))return!0;return n.delete(a),!1};for(const a of o.nodes)if(!s.has(a.label)&&t(a.label))return!0;return!1}else{const s={};for(const t of o.nodes)s[t.label]=t.label;const n=t=>(s[t]!==t&&(s[t]=n(s[t])),s[t]);for(const t of o.edges){const a=n(t.source),l=n(t.target);if(a===l)return!0;s[a]=l}return!1}}function kt(o){const e=new Map,s=new Map;for(const i of o.nodes)e.set(i.label,[]),s.set(i.label,0);for(const i of o.edges){const r=e.get(i.source);r&&r.push(i.target),s.set(i.target,(s.get(i.target)||0)+1)}const n=new Map;for(const i of o.nodes)n.set(i.label,0);for(const i of o.edges)n.set(i.source,(n.get(i.source)||0)+1);const t=[];for(const i of o.nodes)n.get(i.label)===0&&t.push(i.label);const a=[],l=new Set;for(;t.length>0;){const i=t.shift();if(!l.has(i)){l.add(i),a.push(i);for(const r of o.edges)if(r.target===i){const c=r.source;n.set(c,(n.get(c)||1)-1),n.get(c)===0&&t.push(c)}}}for(const i of o.nodes)l.has(i.label)||a.push(i.label);return a}function _t(o,e){if(!e||e.length===0)return new Map;const s=new Map(o.nodes.map(i=>[i.label,i])),n=new Map(o.nodes.map(i=>[i.label,[]]));for(const i of o.edges){const r=n.get(i.source);r&&r.push(i.target)}const t=kt(o),a=new Map;for(const i of t){const r=s.get(i);if(!r)continue;const c=n.get(i)||[];let u;if(c.length===0)r.type&&e.includes(r.type)?u=[{[r.type]:i}]:u=[{}];else{u=[];for(const p of c){const h=a.get(p)||[{}];u.push(...h)}const d=new Set;u=u.filter(p=>{const h=q(p,e);return d.has(h)?!1:(d.add(h),!0)}),r.type&&e.includes(r.type)&&(u=u.map(p=>({...p,[r.type]:i})))}a.set(i,u)}const l=new Map;for(const i of o.edges){const r=`${i.source}→${i.target}`;l.set(r,a.get(i.target)||[{}])}return l}function Pe(o,e,s,n=[]){const t=new Map;for(const[r,c]of Object.entries(e)){const u=Array.isArray(c)?new Set(c):new Set(Object.keys(c).length?[c]:[]);u.size>0&&t.set(r,u)}if(!s||s.size===0)return t;const a=new Map;for(const r of o.nodes)a.set(r.label,[]);for(const r of o.edges){const c=a.get(r.target);c&&c.push(r.source)}const l=[];for(const[r,c]of t){const[u]=r.split("→");l.push({target:u,tags:new Set(c)})}const i=new Set;for(;l.length>0;){const{target:r,tags:c}=l.shift(),u=`${r}:${[...c].sort().join(",")}`;if(!i.has(u)){i.add(u);for(const d of a.get(r)||[]){const p=`${d}→${r}`,h=s.get(p);if(!h)continue;const f=new Set(h.map(k=>q(k,n))),v=new Set([...c].filter(k=>f.has(k)));if(v.size>0){const k=t.get(p)||new Set,x=new Set([...k,...v]);t.set(p,x),l.push({target:d,tags:v})}}}}return t}function $t(o,e,s,n,t=[]){const a=o.edges.filter(l=>l.source===e);if(a.length===0)return!1;for(const l of a){const i=`${l.source}→${l.target}`,r=s.get(i)||[],c=n.get(i)||new Set;for(const u of r){const d=q(u,t);if(!c.has(d))return!1}}return!0}function ce(o,e,s){if(!s||!e)return{...o};const n={...o};for(const[t,a]of Object.entries(e))if(n[t]){const l=new Set([...n[t],...a]);n[t]=[...l]}else n[t]=[...a];return n}function j(o,e,s){const n=[];for(const t of e)o[t]&&n.push(o[t]);return n.length===0?"(any)":`(${n.join(", ")})`}function q(o,e){return e.map(s=>o[s]||"").join("|")}function Ae(o){const e={an:0,mn:0,rn:0,ae:0,me:0,re:0};for(const n of o){const t=n.type==="node";n.action==="added"?t?e.an++:e.ae++:n.action==="modified"?t?e.mn++:e.me++:n.action==="removed"&&(t?e.rn++:e.re++)}const s=[];return e.an&&s.push(`+${e.an}n`),e.mn&&s.push(`~${e.mn}n`),e.rn&&s.push(`-${e.rn}n`),e.ae&&s.push(`+${e.ae}e`),e.me&&s.push(`~${e.me}e`),e.re&&s.push(`-${e.re}e`),s.join(" ")}function Be(o){if(o.length===0)return"No changes.";const e={addedNodes:[],removedNodes:[],modifiedNodes:[],addedEdges:[],removedEdges:[],modifiedEdges:[]};for(const n of o)n.type==="node"?n.action==="added"?e.addedNodes.push(n.key):n.action==="removed"?e.removedNodes.push(n.key):n.action==="modified"&&e.modifiedNodes.push({key:n.key,changes:n.changes}):n.action==="added"?e.addedEdges.push(n.key):n.action==="removed"?e.removedEdges.push(n.key):n.action==="modified"&&e.modifiedEdges.push({key:n.key,changes:n.changes});const s=[];if(e.addedNodes.length){const n=e.addedNodes.length;s.push(`Added ${n} node${n>1?"s":""}: ${e.addedNodes.join(", ")}`)}if(e.removedNodes.length){const n=e.removedNodes.length;s.push(`Removed ${n} node${n>1?"s":""}: ${e.removedNodes.join(", ")}`)}if(e.modifiedNodes.length){const n=e.modifiedNodes.map(({key:a,changes:l})=>{const i=l&&l.length?`(${l.map(r=>r.key).join(", ")} changed)`:"";return i?`${a} ${i}`:a}),t=e.modifiedNodes.length;s.push(`Modified ${t} node${t>1?"s":""}: ${n.join(", ")}`)}if(e.addedEdges.length){const n=e.addedEdges.length;s.push(`Added ${n} edge${n>1?"s":""}: ${e.addedEdges.join(", ")}`)}if(e.removedEdges.length){const n=e.removedEdges.length;s.push(`Removed ${n} edge${n>1?"s":""}: ${e.removedEdges.join(", ")}`)}if(e.modifiedEdges.length){const n=e.modifiedEdges.map(({key:a,changes:l})=>{const i=l&&l.length?`(${l.map(r=>r.key).join(", ")} changed)`:"";return i?`${a} ${i}`:a}),t=e.modifiedEdges.length;s.push(`Modified ${t} edge${t>1?"s":""}: ${n.join(", ")}`)}return s.join(". ")+"."}class wt{constructor(e,s,n=null){this.id=e,this.graph=fe(),this.baseGraph=null,this.mergeDirection=null,this.lastApproval=null,this.container=s,this.template=n||Q(),this.layoutAlgorithm=n?.defaultLayoutAlgorithm||"fcose",this.pathTrackingEnabled=!1,this.showExclusions=!0,this.exclusions={},this._pathTags=null,this._effectiveExclusions=null,this._history=[],this._redoStack=[],this._maxHistory=10,this._approvalHistory=[],this._maxApprovalHistory=20,this._processingCount=0,this.cy=ke({container:s,elements:[],style:we(this.template),layout:{name:"grid"},selectionType:"additive"}),this._tooltip=null,this._trackingOverlay=null,this.cy.on("mouseover","edge",t=>{const l=t.target.data("pathTagsTooltip");!l||!this.pathTrackingEnabled||this._showTooltip(t.originalEvent,l)}),this.cy.on("mouseout","edge",()=>this._hideTooltip()),this.cy.on("pan zoom",()=>this._hideTooltip()),this._updateHeader()}setTemplate(e){this.template=e,this.cy.style().fromJson(we(e)).update()}get panelEl(){return this.container.closest("[data-panel-id]")}getGraph(){return _(this.graph)}getBaseGraph(){return this.baseGraph?_(this.baseGraph):null}getState(){return{id:this.id,graph:_(this.graph),baseGraph:this.baseGraph?_(this.baseGraph):null,mergeDirection:this.mergeDirection,lastApproval:this.lastApproval,layoutAlgorithm:this.layoutAlgorithm,pathTrackingEnabled:this.pathTrackingEnabled,showExclusions:this.showExclusions,exclusions:_(this.exclusions),_history:this._history.map(e=>_(e)),_redoStack:this._redoStack.map(e=>_(e)),_approvalHistory:this._approvalHistory.map(e=>({graph:_(e.graph),baseGraph:e.baseGraph?_(e.baseGraph):null,timestamp:e.timestamp,diffSummary:e.diffSummary,exclusions:_(e.exclusions||{})}))}}setState(e){this.graph=e.graph||fe(),this.baseGraph=e.baseGraph||null,this.mergeDirection=e.mergeDirection||null,this.lastApproval=e.lastApproval||null;const s={cose:"fcose",dagre:"level-by-level"},n=e.layoutAlgorithm||"fcose";this.layoutAlgorithm=s[n]||n,this.pathTrackingEnabled=e.pathTrackingEnabled||!1,this.showExclusions=e.showExclusions??!0,this.exclusions=_(e.exclusions||{}),this._history=e._history?e._history.map(t=>_(t)):[],this._redoStack=e._redoStack?e._redoStack.map(t=>_(t)):[],this._approvalHistory=e._approvalHistory?e._approvalHistory.map(t=>({graph:_(t.graph),baseGraph:t.baseGraph?_(t.baseGraph):null,timestamp:t.timestamp,diffSummary:t.diffSummary,exclusions:_(t.exclusions||{})})):[],this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader()}loadGraph(e){this.graph=_(e),this._syncCytoscape(),this._applyDiffClasses(),this._updateHeader(),this._emitChange()}addNode(e,s={},n=null){return this.graph.nodes.some(t=>t.label===e)?(y(`Node "${e}" already exists`,"error"),!1):(this._pushHistory(),this.graph={nodes:[...this.graph.nodes,{label:e,type:n,props:{...s}}],edges:[...this.graph.edges]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),!0)}addEdge(e,s,n={},t=null){if(!this.graph.nodes.some(i=>i.label===e))return y(`Source node "${e}" not found`,"error"),!1;if(!this.graph.nodes.some(i=>i.label===s))return y(`Target node "${s}" not found`,"error"),!1;const a=this.template?.graphType||"DG",l=xt(this.graph,e,s,a);return l.ok?(this._pushHistory(),this.graph={nodes:[...this.graph.nodes],edges:[...this.graph.edges,{source:e,target:s,type:t,props:{...n}}]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),!0):(y(l.error,"error"),!1)}updateNodeProps(e,s,n=void 0){this._pushHistory(),this.graph={nodes:this.graph.nodes.map(t=>t.label!==e?t:n!==void 0?{...t,props:{...s},type:n}:{...t,props:{...s}}),edges:[...this.graph.edges]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}updateEdgeProps(e,s,n,t=void 0){this._pushHistory(),this.graph={nodes:[...this.graph.nodes],edges:this.graph.edges.map(a=>a.source===e&&a.target===s?t!==void 0?{...a,props:{...n},type:t}:{...a,props:{...n}}:a)},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}async deleteSelected(e=null){const s=this.cy.$(":selected");if(s.empty()){y("Nothing selected","info");return}const n=this.template?.graphType||"DG",t=J[n],a=new Set;s.nodes().forEach(c=>a.add(c.data("label")));const l=new Set;if(s.edges().forEach(c=>l.add(`${c.data("source")}→${c.data("target")}`)),t?.mustBeConnected&&e){let c=!1;for(const u of a)if(yt(this.graph,u)){c=!0;break}if(!c)for(const u of l){const[d,p]=u.split("→");if(bt(this.graph,d,p)){c=!0;break}}if(c&&!await e("Disconnect Warning","Deleting this would disconnect the tree. Proceed anyway?"))return}this._pushHistory();const i=new Set([...l]);this.graph.edges.forEach(c=>{(a.has(c.source)||a.has(c.target))&&i.add(`${c.source}→${c.target}`)}),this.graph={nodes:this.graph.nodes.filter(c=>!a.has(c.label)),edges:this.graph.edges.filter(c=>!(l.has(`${c.source}→${c.target}`)||a.has(c.source)||a.has(c.target)))};const r={...this.exclusions};for(const c of i)delete r[c];this.exclusions=r,this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}clearGraph(){this._pushHistory(),this.graph=fe(),this.baseGraph=null,this.mergeDirection=null,this.lastApproval=null,this.exclusions={},this._approvalHistory=[],this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}approve(){let e="(initial)";if(this.baseGraph){const s=R(this.baseGraph,this.graph);e=s.length>0?Ae(s):"(no changes)"}this._approvalHistory.push({graph:_(this.graph),baseGraph:this.baseGraph?_(this.baseGraph):null,timestamp:new Date().toISOString(),diffSummary:e,exclusions:_(this.exclusions)}),this._approvalHistory.length>this._maxApprovalHistory&&this._approvalHistory.shift(),this.baseGraph=_(this.graph),this.mergeDirection=null,this.lastApproval=new Date().toISOString(),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._clearDiffClasses(),this._updateHeader(),this._emitChange(),y(`Panel ${this.id} approved`,"success")}receiveMerge(e,s,n=null,t=!1,a="mirror",l=[]){if(Te(this.graph)&&!this.baseGraph)return this.graph=_(e),this.baseGraph=_(e),this.lastApproval=new Date().toISOString(),this.mergeDirection=null,n&&(this.exclusions=ce(this.exclusions,n,t)),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),{ok:!0};this._pushHistory();const i=a==="scoped"&&l.length>0?rt(e,l):e,r=a==="push"||a==="sync"?null:this.baseGraph;this.graph=Ce(this.graph,i,r),this.mergeDirection=s,n&&(this.exclusions=ce(this.exclusions,n,t)),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange();const c=J[this.template?.graphType];return c?.acyclic&&St(this.graph,c.directed)&&y(`Warning: merge introduced a cycle in ${c.label}`,"warning"),{ok:!0}}pasteSubgraph(e,s,n=null,t=!1){return Te(this.graph)&&!this.baseGraph?(this.graph=_(e),this.baseGraph=_(e),this.lastApproval=new Date().toISOString(),this.mergeDirection=null,n&&(this.exclusions=ce(this.exclusions,n,t)),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()):(this._pushHistory(),this.graph=Ce(this.graph,e,null),this.mergeDirection=s,n&&(this.exclusions=ce(this.exclusions,n,t)),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()),{ok:!0}}selectBranch(e){const s=ze(this.graph,e);this.cy.elements().unselect();for(const n of s.nodes)this.cy.$id(n.label).select();for(const n of s.edges)this.cy.$id(`${n.source}→${n.target}`).select()}exportGraph(){pt(this.graph,`panel-${this.id}.json`)}undo(){if(this._history.length===0)return y("Nothing to undo","info"),!1;this._redoStack.push({graph:_(this.graph),exclusions:_(this.exclusions)});const e=this._history.pop();return this.graph=this._historyGraph(e),this.exclusions=this._historyExclusions(e),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),y("Undo","info"),!0}redo(){if(this._redoStack.length===0)return y("Nothing to redo","info"),!1;this._history.push({graph:_(this.graph),exclusions:_(this.exclusions)}),this._history.length>this._maxHistory&&this._history.shift();const e=this._redoStack.pop();return this.graph=this._historyGraph(e),this.exclusions=this._historyExclusions(e),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),y("Redo","info"),!0}restoreFromApproved(){if(!this.baseGraph)return y("No approved state to restore","info"),!1;this._pushHistory(),this.graph=_(this.baseGraph);const e=this._approvalHistory[this._approvalHistory.length-1];return this.exclusions=e?.exclusions?_(e.exclusions):{},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),y(`Panel ${this.id} restored to approved state`,"success"),!0}getSelectedSubgraph(){const e=this.cy.$(":selected");if(e.empty())return null;const s=new Set,n=[];e.nodes().forEach(a=>{s.add(a.data("label"));const l=this.graph.nodes.find(i=>i.label===a.data("label"));l&&n.push(_(l))});const t=[];return e.edges().forEach(a=>{const l=a.data("source"),i=a.data("target");if(s.has(l)&&s.has(i)){const r=this.graph.edges.find(c=>c.source===l&&c.target===i);r&&t.push(_(r))}}),{nodes:n,edges:t}}isClean(){return this.baseGraph?R(this.baseGraph,this.graph).length===0:!0}_pushHistory(){this._history.push({graph:_(this.graph),exclusions:_(this.exclusions)}),this._history.length>this._maxHistory&&this._history.shift(),this._redoStack=[]}_historyGraph(e){return e&&e.graph?e.graph:e}_historyExclusions(e){return e&&e.exclusions?e.exclusions:{}}_syncCytoscape(){const e=[];for(const s of this.graph.nodes)e.push({group:"nodes",data:{id:s.label,label:s.label,type:s.type||null,...this._flattenProps(s.props,"p_")}});for(const s of this.graph.edges)e.push({group:"edges",data:{id:`${s.source}→${s.target}`,source:s.source,target:s.target,type:s.type||null,...this._flattenProps(s.props,"p_")}});if(this.baseGraph){const s=new Set(this.graph.nodes.map(t=>t.label)),n=new Set(this.graph.edges.map(t=>`${t.source}→${t.target}`));for(const t of this.baseGraph.nodes)s.has(t.label)||e.push({group:"nodes",data:{id:t.label,label:t.label},classes:"diff-removed"});for(const t of this.baseGraph.edges){const a=`${t.source}→${t.target}`;if(!n.has(a)){const l=new Set([...s,...this.baseGraph.nodes.map(i=>i.label)]);l.has(t.source)&&l.has(t.target)&&e.push({group:"edges",data:{id:a,source:t.source,target:t.target},classes:"diff-removed"})}}}this.cy.elements().remove(),this.cy.add(e),this._runLayout()}_applyDiffClasses(){if(!this.baseGraph)return;const e=R(this.baseGraph,this.graph);this.cy.elements().removeClass("diff-added diff-modified");for(const s of e){if(s.action==="removed")continue;const n=(s.type==="node",s.key),t=this.cy.$id(n);t.length&&t.addClass(`diff-${s.action}`)}this._updateDiffOverlay()}_clearDiffClasses(){this.cy.elements().removeClass("diff-added diff-removed diff-modified"),this.cy.$(".diff-removed").remove(),this._updateDiffOverlay()}_updateHeader(){const e=this.panelEl?.querySelector(".panel-info");if(!e)return;const s=[];if(this.mergeDirection&&s.push(`<span class="merge-direction">${this.mergeDirection}</span>`),this.baseGraph&&!this.isClean()){const n=R(this.baseGraph,this.graph).length;s.push(`${n} change${n!==1?"s":""}`)}e.innerHTML=s.join(" · "),this._updateApprovalOverlay()}_updateApprovalOverlay(){let e=this.container.querySelector(".approval-indicator");if(e||(e=document.createElement("div"),e.className="approval-indicator",this.container.appendChild(e)),this.lastApproval){const s=new Date(this.lastApproval).toLocaleTimeString();e.textContent=`✓ ${s}`}else e.textContent=""}_flattenProps(e,s){const n={};for(const[t,a]of Object.entries(e))n[`${s}${t}`]=a;return n}setLayoutAlgorithm(e){this.layoutAlgorithm=e,this._runLayout(),this._emitChange()}_runLayout(){if(this.cy.elements().length===0)return;const e=this.layoutAlgorithm||"fcose";if(e==="level-by-level"){this._runLevelLayout();return}this.cy.layout({name:this.cy.nodes().length>1?e:"grid",animate:!1,fit:!0,padding:20}).run()}_runLevelLayout(){const e=this.cy.nodes();if(e.length===0)return;const s=e.filter(u=>u.outgoers("edge").length===0),n=s.length>0?s:e,t=new Map,a=[];for(n.forEach(u=>{t.set(u.id(),0),a.push(u.id())});a.length>0;){const u=a.shift(),d=t.get(u);this.cy.$id(u).incomers("edge").forEach(p=>{const h=p.source().id();(!t.has(h)||t.get(h)<d+1)&&(t.set(h,d+1),a.push(h))})}e.forEach(u=>{t.has(u.id())||t.set(u.id(),0)});const l=new Map;for(const[u,d]of t)l.has(d)||l.set(d,[]),l.get(d).push(u);const i=80,r=80,c={};for(const[u,d]of l){const p=u*i,f=-((d.length-1)*r)/2;d.forEach((v,k)=>{c[v]={x:f+k*r,y:p}})}this.cy.layout({name:"preset",positions:u=>c[u.id()]||{x:0,y:0},animate:!1,fit:!0,padding:20}).run()}_updateDiffOverlay(){const e=this.container.parentElement?.querySelector(`.diff-overlay[data-panel-diff="${this.id}"]`);if(!e)return;if(!this.baseGraph){e.classList.remove("visible");return}const s=R(this.baseGraph,this.graph);if(s.length===0){e.classList.remove("visible");return}e.textContent=Ae(s),e.classList.add("visible")}setPathTracking(e){this.pathTrackingEnabled=e,e?this._recomputePathTrackingAsync():(this._pathTags=null,this._effectiveExclusions=null,this._clearTrackingVisuals()),this._updateTrackingOverlay(),this._emitChange()}setShowExclusions(e){this.showExclusions=e,this._applyExclusionVisibility(),this._emitChange()}excludePathTag(e,s){this._pushHistory();const n=this.exclusions[e]||[];n.includes(s)||(this.exclusions={...this.exclusions,[e]:[...n,s]}),this._recomputePathTrackingAsync(),this._emitChange()}includePathTag(e,s){this._pushHistory();const t=(this.exclusions[e]||[]).filter(l=>l!==s),a={...this.exclusions};t.length===0?delete a[e]:a[e]=t,this.exclusions=a,this._recomputePathTrackingAsync(),this._emitChange()}getRelevantExclusions(e){const s=new Set(e.edges.map(t=>`${t.source}→${t.target}`)),n={};for(const[t,a]of Object.entries(this.exclusions))s.has(t)&&(n[t]=a);return n}_cleanupStaleExclusions(){if(!this._pathTags)return;const e=this.template?.specialTypes||[],s={};for(const[n,t]of Object.entries(this.exclusions)){const a=this._pathTags.get(n);if(!a||a.length===0)continue;const l=new Set(a.map(r=>q(r,e))),i=t.filter(r=>l.has(r));i.length>0&&(s[n]=i)}this.exclusions=s}_setProcessing(e){this._processingCount=e?this._processingCount+1:Math.max(0,this._processingCount-1),this.panelEl?.classList.toggle("processing",this._processingCount>0)}async _recomputePathTrackingAsync(){if(this.pathTrackingEnabled){this._setProcessing(!0),await new Promise(e=>setTimeout(e,0));try{this._recomputePathTracking()}finally{this._setProcessing(!1)}}}_recomputePathTracking(){if(!this.pathTrackingEnabled)return;const e=this.template?.specialTypes||[];e.length!==0&&(this._pathTags=_t(this.graph,e),this._effectiveExclusions=Pe(this.graph,this.exclusions,this._pathTags,e),this._cleanupStaleExclusions(),this._effectiveExclusions=Pe(this.graph,this.exclusions,this._pathTags,e),this._applyTrackingVisuals(),this._updateTrackingOverlay(),this._flashTrackingIndicator())}_flashTrackingIndicator(){const e=this.panelEl?.querySelector(".panel-info");e&&(e.classList.remove("tracking-flash"),e.offsetWidth,e.classList.add("tracking-flash"),setTimeout(()=>e.classList.remove("tracking-flash"),300))}_applyTrackingVisuals(){if(!this.pathTrackingEnabled||!this._pathTags)return;const e=this.template?.specialTypes||[];this.cy.edges().removeClass("edge-excluded edge-all-excluded"),this.cy.nodes().removeClass("node-fully-excluded");for(const s of this.graph.edges){const n=`${s.source}→${s.target}`,t=this._pathTags.get(n)||[],a=this._effectiveExclusions?.get(n)||new Set,l=this.cy.$id(n);if(l.empty())continue;const i=t.filter(u=>!a.has(q(u,e))),r=t.filter(u=>a.has(q(u,e))),c=[];i.length&&c.push("Included: "+i.map(u=>j(u,e,this.template?.nodeTypes)).join(", ")),r.length&&c.push("Excluded: "+r.map(u=>j(u,e,this.template?.nodeTypes)).join(", ")),l.data("pathTagsTooltip",c.join(`
`)||"(no tags)"),a.size>0&&l.addClass("edge-excluded"),t.length>0&&r.length===t.length&&l.addClass("edge-all-excluded")}for(const s of this.graph.nodes)$t(this.graph,s.label,this._pathTags,this._effectiveExclusions||new Map,e)&&this.cy.$id(s.label).addClass("node-fully-excluded");this._applyExclusionVisibility()}_applyExclusionVisibility(){this.pathTrackingEnabled&&(this.showExclusions?this.cy.elements().removeClass("tracking-hidden"):(this.cy.nodes(".node-fully-excluded").addClass("tracking-hidden"),this.cy.edges(".edge-all-excluded").addClass("tracking-hidden")))}_clearTrackingVisuals(){this.cy.elements().removeClass("edge-excluded edge-all-excluded node-fully-excluded tracking-hidden"),this.cy.edges().data("pathTagsTooltip",null),this._removeTrackingOverlay()}_showTooltip(e,s){this._tooltip||(this._tooltip=document.createElement("div"),this._tooltip.className="path-tooltip",this.container.appendChild(this._tooltip)),this._tooltip.textContent=s,this._tooltip.style.display="block";const n=this.container.getBoundingClientRect();this._tooltip.style.left=`${e.clientX-n.left+12}px`,this._tooltip.style.top=`${e.clientY-n.top-8}px`}_hideTooltip(){this._tooltip&&(this._tooltip.style.display="none")}_ensureTrackingOverlay(){if(this._trackingOverlay)return;const e=document.createElement("div");e.className="tracking-overlay",e.innerHTML='<label><input type="checkbox" class="show-exclusions-cb"> Show exclusions</label>',this.container.appendChild(e),e.querySelector(".show-exclusions-cb").addEventListener("change",s=>{this.setShowExclusions(s.target.checked)}),this._trackingOverlay=e}_removeTrackingOverlay(){this._trackingOverlay&&(this._trackingOverlay.remove(),this._trackingOverlay=null)}_updateTrackingOverlay(){if(this.pathTrackingEnabled){this._ensureTrackingOverlay();const e=this._trackingOverlay?.querySelector(".show-exclusions-cb");e&&(e.checked=this.showExclusions)}else this._removeTrackingOverlay()}_emitChange(){window.dispatchEvent(new CustomEvent("panel-change",{detail:{panelId:this.id}}))}}let me=null,ye=null;function Tt(o){const e=[];for(const s of o.split(",")){const n=s.trim();if(!n)continue;const t=n.match(/^(.+?)(\d+)-(\d+)$/);if(t){const[,a,l,i]=t,r=parseInt(l,10),c=parseInt(i,10);if(r<=c&&c-r<100){for(let u=r;u<=c;u++)e.push(`${a}${u}`);continue}}e.push(n)}return e}function Et(o,e){const s=(n,t)=>{const a=o.getBoundingClientRect(),l=n-a.left,i=t-a.top;return(c,u)=>{o.style.position="fixed",o.style.margin="0",o.style.transform="none",o.style.left=`${Math.max(0,c-l)}px`,o.style.top=`${Math.max(0,u-i)}px`}};e.addEventListener("mousedown",n=>{if(n.target.closest("button, input, select, textarea"))return;n.preventDefault();const t=s(n.clientX,n.clientY),a=i=>t(i.clientX,i.clientY),l=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}),e.addEventListener("touchstart",n=>{if(n.target.closest("button, input, select, textarea"))return;n.preventDefault();const t=n.touches[0],a=s(t.clientX,t.clientY),l=r=>{r.preventDefault();const c=r.touches[0];a(c.clientX,c.clientY)},i=()=>{document.removeEventListener("touchmove",l),document.removeEventListener("touchend",i)};document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",i)},{passive:!1})}let de=null;function Ge(){return de||(de=document.createElement("dialog"),document.body.appendChild(de)),de}let te=null;function xe(o){o&&o.querySelectorAll(".panel-overlay").forEach(e=>e.remove())}function N(o,e=null){const s=Ge();if(s.className="",s.innerHTML=o,e){xe(e);const t=document.createElement("div");t.className="panel-overlay",e.insertBefore(t,e.firstChild),te=e;const a=()=>{xe(e),te=null,s.removeEventListener("close",a)};s.addEventListener("close",a),s.className="panel-dialog",s.removeAttribute("style"),s.showModal();const l=e.getBoundingClientRect();s.style.position="fixed",s.style.transform="translate(-50%, -50%)",s.style.margin="0",s.style.left=`${l.left+l.width/2}px`,s.style.top=`${l.top+l.height/2}px`,requestAnimationFrame(()=>{const i=s.offsetWidth,r=s.offsetHeight,c=l.left+l.width/2,u=l.top+l.height/2,d=8;s.style.left=`${Math.max(i/2+d,Math.min(c,window.innerWidth-i/2-d))}px`,s.style.top=`${Math.max(r/2+d,Math.min(u,window.innerHeight-r/2-d))}px`})}else s.removeAttribute("style"),s.style.position="fixed",s.style.left="50%",s.style.top="50%",s.style.transform="translate(-50%, -50%)",s.style.margin="0",s.showModal();const n=s.querySelector(".dialog-header")||s.querySelector("h3");return n&&Et(s,n),s}function w(){const o=Ge();o.open&&o.close(),o.className="",o.innerHTML="",o.removeAttribute("style"),te&&(xe(te),te=null)}function D(o,e,s=null){return new Promise(n=>{const t=N(`
      <h3>${o}</h3>
      <p>${e}</p>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Confirm</button>
      </div>
    `,s);t.querySelector("#dlg-cancel").onclick=()=>{w(),n(!1)},t.querySelector("#dlg-ok").onclick=()=>{w(),n(!0)}})}function He(o,e,s=null){return new Promise(n=>{const t=N(`
      <div class="dialog-header">
        <h3>${o}</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p>${e}</p>
    `,s);t.querySelector("#dlg-close-x").onclick=()=>{w(),n()}})}function Ct(o,e=null){return new Promise(s=>{const n=N(`
      <h3>Rename Panel</h3>
      <label>Name</label>
      <input id="dlg-name" type="text" value="${o}" autofocus>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Rename</button>
      </div>
    `,e);n.querySelector("#dlg-cancel").onclick=()=>{w(),s(null)},n.querySelector("#dlg-ok").onclick=()=>{const t=n.querySelector("#dlg-name").value.trim();w(),s(t)},n.querySelector("#dlg-name").onkeydown=t=>{t.key==="Enter"&&n.querySelector("#dlg-ok").click()}})}function Ne(o){return Object.entries(o).map(([e,s])=>`${e}=${s}`).join(`
`)}function se(o){const e={};for(const s of o.split(`
`)){const n=s.trim();if(!n)continue;const t=n.indexOf("=");if(t===-1)continue;const a=n.slice(0,t).trim(),l=n.slice(t+1).trim();a&&(e[a]=l)}return e}function Re(o){const e=o.template,s=e?.nodeTypes?.length>0,n=s&&e.nodeTypes.some(l=>l.id===me)?me:null,t=s?`<label>Type</label>
    <select id="dlg-type">
      ${e.nodeTypes.map(l=>`<option value="${l.id}" ${(n||e.nodeTypes[0]?.id)===l.id?"selected":""}>${l.label}</option>`).join("")}
    </select>`:"",a=N(`
    <h3>Add Node</h3>
    <label>Label</label>
    <input id="dlg-label" type="text" placeholder="Node label (or A,B,C or P1-5)" autofocus>
    ${t}
    <label>Properties (key=value per line)</label>
    <textarea id="dlg-props" placeholder="color=blue&#10;weight=5"></textarea>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `,o.panelEl);a.querySelector("#dlg-cancel").onclick=w,a.querySelector("#dlg-ok").onclick=()=>{const l=a.querySelector("#dlg-label").value,i=Tt(l);if(i.length===0){y("Label required","error");return}const r=se(a.querySelector("#dlg-props").value),c=s&&a.querySelector("#dlg-type").value||null;s&&(me=c);for(const u of i)o.addNode(u,r,c);i.length>1&&y(`Added ${i.length} nodes`,"success"),w()},a.querySelector("#dlg-label").onkeydown=l=>{l.key==="Enter"&&a.querySelector("#dlg-ok").click()}}function Fe(o){const e=o.graph.nodes.map(p=>p.label);if(e.length<2){y("Need at least 2 nodes to create an edge","error");return}const s=o.template,n=J[s?.graphType||"DG"],t=n&&!n.directed,a=t?"Node A":"Source",l=t?"Node B":"Target",i=s?.edgeTypes?.length>0,r=i&&s.edgeTypes.some(p=>p.id===ye)?ye:null,c=i?`<label>Type</label>
    <select id="dlg-type">
      ${s.edgeTypes.map(p=>`<option value="${p.id}" ${(r||s.edgeTypes[0]?.id)===p.id?"selected":""}>${p.label}</option>`).join("")}
    </select>`:"",u=e.map(p=>`<option value="${p}">`).join(""),d=N(`
    <h3>Add Edge</h3>
    <datalist id="dlg-node-list">${u}</datalist>
    <label>${a}</label>
    <input id="dlg-source" list="dlg-node-list" placeholder="Start typing..." autocomplete="off">
    <label>${l}</label>
    <input id="dlg-target" list="dlg-node-list" placeholder="Start typing..." autocomplete="off">
    ${c}
    <label>Properties (key=value per line)</label>
    <textarea id="dlg-props" placeholder="weight=1"></textarea>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `,o.panelEl);d.querySelector("#dlg-source").value=e[0],e.length>1&&(d.querySelector("#dlg-target").value=e[1]),d.querySelector("#dlg-cancel").onclick=w,d.querySelector("#dlg-ok").onclick=()=>{const p=d.querySelector("#dlg-source").value.trim(),h=d.querySelector("#dlg-target").value.trim();if(!e.includes(p)){y(`Node "${p}" not found`,"error");return}if(!e.includes(h)){y(`Node "${h}" not found`,"error");return}if(p===h){y("Source and target must differ","error");return}const f=se(d.querySelector("#dlg-props").value),v=i&&d.querySelector("#dlg-type").value||null;i&&(ye=v),o.addEdge(p,h,f,v),w()}}function Ue(o){const e=o.cy.$(":selected");if(e.empty()){y("Nothing selected","info");return}const s=e[0],n=o.template;if(s.isNode()){const t=s.data("label"),a=o.graph.nodes.find(c=>c.label===t);if(!a)return;const l=n?.nodeTypes?.length>0,i=l?`<label>Type</label>
      <select id="dlg-type">
        ${n.nodeTypes.map(c=>`<option value="${c.id}" ${a.type===c.id?"selected":""}>${c.label}</option>`).join("")}
      </select>`:"",r=N(`
      <h3>Edit Node: ${t}</h3>
      ${i}
      <label>Properties (key=value per line)</label>
      <textarea id="dlg-props">${Ne(a.props)}</textarea>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Save</button>
      </div>
    `,o.panelEl);r.querySelector("#dlg-cancel").onclick=w,r.querySelector("#dlg-ok").onclick=()=>{const c=se(r.querySelector("#dlg-props").value),u=l?r.querySelector("#dlg-type").value||null:void 0;o.updateNodeProps(t,c,u),w()}}else{const t=s.data("source"),a=s.data("target"),l=o.graph.edges.find(x=>x.source===t&&x.target===a);if(!l)return;const i=n?.edgeTypes?.length>0,r=i?`<label>Type</label>
      <select id="dlg-type">
        ${n.edgeTypes.map(x=>`<option value="${x.id}" ${l.type===x.id?"selected":""}>${x.label}</option>`).join("")}
      </select>`:"",c=`${t}→${a}`,u=o.pathTrackingEnabled&&o._pathTags,d=u?o._pathTags.get(c)||[]:[],p=o.template?.specialTypes||[],h=()=>{if(!u||d.length===0)return"";const x=o._effectiveExclusions?.get(c)||new Set,g=d.filter(b=>!x.has(q(b,p))),S=d.filter(b=>x.has(q(b,p))),m=[];return g.length&&m.push("Included: "+g.map(b=>j(b,p,o.template?.nodeTypes||[])).join(", ")),S.length&&m.push("Excluded: "+S.map(b=>j(b,p,o.template?.nodeTypes||[])).join(", ")),m.join(`
`)||"(no active paths)"},f=()=>{if(!u||d.length===0)return"";const x=o._effectiveExclusions?.get(c)||new Set,g=new Set(o.exclusions[c]||[]);return d.map(S=>{const m=q(S,p),b=g.has(m),$=x.has(m)&&!b,C=b||$,T=j(S,p,o.template?.nodeTypes||[]),E=$?"excl-toggle excl-btn-propagated":C?"excl-toggle excl-btn-excluded":"excl-toggle excl-btn-included",P=$?`${T} (inherited from upstream)`:T;return`<button class="${E}" data-tag="${m}" data-propagated="${$}" title="${P}">${T}</button>`}).join("")},v=u&&d.length>0?`
      <div class="template-section-label" style="margin-top:12px">Path Tags</div>
      <pre id="edge-tag-summary" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-size:11px;margin-bottom:8px;white-space:pre-wrap;word-break:break-all">${h()}</pre>
      <div class="template-section-label">Manage Exclusions</div>
      <div id="edge-excl-toggles" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">${f()}</div>
    `:"",k=N(`
      <h3>Edit Edge: ${t} → ${a}</h3>
      ${r}
      <label>Properties (key=value per line)</label>
      <textarea id="dlg-props">${Ne(l.props)}</textarea>
      ${v}
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Save</button>
      </div>
    `,o.panelEl);if(u&&d.length>0){const x=new Set(o.exclusions[c]||[]),g=()=>{const m=o._effectiveExclusions?.get(c)||new Set,b=new Set(o.exclusions[c]||[]);return new Set([...m].filter($=>!b.has($)))},S=()=>{const m=g(),b=new Set([...x,...m]),$=d.filter(E=>!b.has(q(E,p))),C=d.filter(E=>b.has(q(E,p))),T=[];$.length&&T.push("Included: "+$.map(E=>j(E,p,o.template?.nodeTypes||[])).join(", ")),C.length&&T.push("Excluded: "+C.map(E=>j(E,p,o.template?.nodeTypes||[])).join(", ")),k.querySelector("#edge-tag-summary").textContent=T.join(`
`)||"(no active paths)",k.querySelectorAll("#edge-excl-toggles .excl-toggle").forEach(E=>{if(E.dataset.propagated==="true")return;const P=E.dataset.tag;E.className=x.has(P)?"excl-toggle excl-btn-excluded":"excl-toggle excl-btn-included"})};k.querySelectorAll("#edge-excl-toggles .excl-toggle").forEach(m=>{m.dataset.propagated!=="true"&&(m.onclick=()=>{const b=m.dataset.tag;x.has(b)?x.delete(b):x.add(b),S()})}),k.querySelector("#dlg-ok").onclick=()=>{const m=se(k.querySelector("#dlg-props").value),b=i?k.querySelector("#dlg-type").value||null:void 0;o.updateEdgeProps(t,a,m,b),x.size>0?o.exclusions[c]=[...x]:delete o.exclusions[c],o._recomputePathTrackingAsync(),o._emitChange(),w()}}else k.querySelector("#dlg-ok").onclick=()=>{const x=se(k.querySelector("#dlg-props").value),g=i?k.querySelector("#dlg-type").value||null:void 0;o.updateEdgeProps(t,a,x,g),w()};k.querySelector("#dlg-cancel").onclick=w}}async function Pt(o){const e=await ht();if(!e.ok){y(e.error,"error");return}const s=`import → ${o.id}`,n=o.receiveMerge(e.graph,s);n.ok?y("Graph imported","success"):y(n.error,"error")}function At(o){if(!o.baseGraph){N(`
      <div class="dialog-header">
        <h3>Changeset Summary</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="color: var(--text-muted); text-align: center; padding: 20px;">No baseline — approve first to track changes.</p>
    `,o.panelEl).querySelector("#dlg-close-x").onclick=w;return}const e=R(o.baseGraph,o.graph),s=Be(e);N(`
    <div class="dialog-header">
      <h3>Changeset Summary</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p class="changeset-summary-text">${s}</p>
  `,o.panelEl).querySelector("#dlg-close-x").onclick=w}function Nt(o){const e=o._approvalHistory||[];if(e.length===0){const t=N(`
      <div class="dialog-header">
        <h3>Approval History</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="color: var(--text-muted); text-align: center; padding: 20px;">No approvals yet.</p>
    `,o.panelEl);t.querySelector("#dlg-close-x").onclick=w;return}let s='<div class="changelog-list">';for(let t=e.length-1;t>=0;t--){const a=e[t],i=new Date(a.timestamp).toLocaleTimeString(),r=t+1;s+=`
      <div class="changelog-entry" style="display: flex; align-items: center; justify-content: space-between; padding: 8px;">
        <span style="font-family: 'Courier New', monospace; font-size: 11px;">
          #${r} ${i} <span style="color: var(--text-muted);">${a.diffSummary}</span>
        </span>
        <button class="btn-preview" data-index="${t}" style="font-size: 11px; padding: 4px 8px;">Preview</button>
      </div>
    `}s+="</div>";const n=N(`
    <div class="dialog-header">
      <h3>Approval History</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    ${s}
  `,o.panelEl);n.querySelectorAll(".btn-preview").forEach(t=>{t.onclick=()=>{const a=parseInt(t.dataset.index),l=e[a];w(),qt(l,a,o)}}),n.querySelector("#dlg-close-x").onclick=w}function qt(o,e,s){const n=s.panelEl,t=o.baseGraph!==null&&o.baseGraph!==void 0,a=`Approval #${e+1} — ${new Date(o.timestamp).toLocaleTimeString()}`,i=N(`
    <div class="preview-header">
      <h3 style="margin:0">${a}</h3>
      <div style="display:flex;gap:4px;align-items:center">
        <button id="preview-maximize" class="btn-icon" title="Maximize/minimize preview">&#x2922;</button>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
    </div>
    <div class="preview-canvas" id="preview-canvas"></div>
    <div class="preview-info-panel" id="preview-info-panel"></div>
    <div class="preview-footer">
      <button id="preview-info" class="btn-icon" title="Show grouped changeset summary for this approval">&#x24D8;</button>
      <div class="preview-toggle">
        <button id="toggle-approved" class="preview-toggle-btn active">Approved State</button>
        <button id="toggle-changeset" class="preview-toggle-btn" ${t?"":'disabled title="No baseline available for this entry"'}>Changeset View</button>
      </div>
    </div>
  `,n);i.style.minWidth="420px",i.style.minHeight="380px",i.style.maxWidth="80vw",i.style.maxHeight="80vh";const r=i.querySelector("#preview-canvas"),c=i.querySelector("#preview-info-panel");let u=!1;i.querySelector("#preview-maximize").onclick=()=>{u=!u,u?(i.style.position="fixed",i.style.left="20px",i.style.top="20px",i.style.transform="none",i.style.margin="0",i.style.width="calc(100vw - 40px)",i.style.height="calc(100vh - 40px)",i.style.maxWidth="none",i.style.maxHeight="none"):(i.style.position="",i.style.left="",i.style.top="",i.style.transform="",i.style.margin="",i.style.width="",i.style.height="",i.style.maxWidth="80vw",i.style.maxHeight="80vh"),c.classList.contains("visible")||(f.resize(),f.fit(void 0,20))};const d=()=>{const b=[];for(const $ of o.graph.nodes)b.push({group:"nodes",data:{id:$.label,label:$.label}});for(const $ of o.graph.edges)b.push({group:"edges",data:{id:`${$.source}→${$.target}`,source:$.source,target:$.target}});return b},p=()=>{if(!t)return d();const b=R(o.baseGraph,o.graph),$=new Map(b.map(T=>[T.key,T.action])),C=[];for(const T of o.graph.nodes){const E=$.get(T.label)||null;C.push({group:"nodes",data:{id:T.label,label:T.label},classes:E?`diff-${E}`:""})}for(const T of o.graph.edges){const E=`${T.source}→${T.target}`,P=$.get(E)||null;C.push({group:"edges",data:{id:E,source:T.source,target:T.target},classes:P?`diff-${P}`:""})}if(o.baseGraph){const T=new Set(o.graph.nodes.map(P=>P.label)),E=new Set(o.graph.edges.map(P=>`${P.source}→${P.target}`));for(const P of o.baseGraph.nodes)T.has(P.label)||C.push({group:"nodes",data:{id:P.label,label:P.label},classes:"diff-removed"});for(const P of o.baseGraph.edges){const _e=`${P.source}→${P.target}`;if(!E.has(_e)){const $e=new Set([...T,...o.baseGraph.nodes.map(tt=>tt.label)]);$e.has(P.source)&&$e.has(P.target)&&C.push({group:"edges",data:{id:_e,source:P.source,target:P.target},classes:"diff-removed"})}}}return C},h=s.layoutAlgorithm&&s.layoutAlgorithm!=="level-by-level"?s.layoutAlgorithm:"fcose",f=ke({container:r,elements:d(),style:Ie,layout:{name:h,animate:!1,fit:!0,padding:20},autoungrabify:!0,userZoomingEnabled:!0,userPanningEnabled:!0});let v="approved";const k=i.querySelector("#toggle-approved"),x=i.querySelector("#toggle-changeset"),g=b=>{if(b===v)return;v=b,k.classList.toggle("active",b==="approved"),x.classList.toggle("active",b==="changeset"),f.elements().remove();const $=b==="changeset"?p():d();f.add($),f.layout({name:h,animate:!1,fit:!0,padding:20}).run()};k.onclick=()=>g("approved"),t&&(x.onclick=()=>g("changeset"));const S=i.querySelector("#preview-info");let m=!1;S.onclick=()=>{if(m=!m,m){if(!t)c.innerHTML=`
          <p style="color: var(--text-muted); padding: 8px;">No baseline available for this approval entry.</p>
          <button id="info-back" style="margin-top:8px">&#x2190; Back</button>
        `;else{const b=R(o.baseGraph,o.graph),$=Be(b);c.innerHTML=`
          <p class="changeset-summary-text">${$}</p>
          <button id="info-back" style="margin-top:8px">&#x2190; Back</button>
        `}c.classList.add("visible"),r.style.display="none",c.querySelector("#info-back").onclick=()=>{m=!1,c.classList.remove("visible"),r.style.display="",f.resize(),f.fit(void 0,20)}}else c.classList.remove("visible"),r.style.display="",f.resize(),f.fit(void 0,20)},i.querySelector("#dlg-close-x").onclick=()=>{try{f.destroy()}catch{}w()}}function qe(){return`t${Date.now().toString(36)}${Math.random().toString(36).slice(2,5)}`}function Je(o,e,s=!1,n=null){let t=_(o);t.specialTypes||(t.specialTypes=[]);const a={cose:"fcose",dagre:"level-by-level"};a[t.defaultLayoutAlgorithm]&&(t.defaultLayoutAlgorithm=a[t.defaultLayoutAlgorithm]);const l=t.graphType==="DAG",i=(g,S)=>g.map(m=>{const b=S==="node"?"Node Type":"Edge Type";return`
    <div class="type-row" data-id="${m.id}" data-kind="${S}">
      <input type="text" class="type-label-input" value="${m.label}" placeholder="${b}">
      <input type="color" class="type-color-input" value="${m.color||"#4fc3f7"}">
      <button class="btn-delete-type" data-id="${m.id}" data-kind="${S}" title="Delete">✕</button>
    </div>
  `}).join(""),r=()=>{if(!l||t.nodeTypes.length===0)return"";const g=s,S=g?'<em style="font-size:10px;color:var(--text-muted)">Cannot change for active session</em>':"",m=t.nodeTypes.map(b=>{const $=t.specialTypes.indexOf(b.id),C=$!==-1,T=!C||$<=0||g?"disabled":"",E=!C||$>=t.specialTypes.length-1||g?"disabled":"";return`
        <div class="special-type-item">
          <input type="checkbox" class="special-type-cb" data-id="${b.id}" ${C?"checked":""} ${g?"disabled":""}>
          <span style="flex:1">${b.label}</span>
          <button class="st-up" data-id="${b.id}" ${T} title="Move up in order">↑</button>
          <button class="st-down" data-id="${b.id}" ${E} title="Move down in order">↓</button>
        </div>
      `}).join("");return`
      <div class="special-types-section">
        <div class="template-section-label">Path Tracking Types ${S}</div>
        <p style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Select node types used as anchors for path tracking (order matters).</p>
        <div id="special-types-list">${m}</div>
      </div>
    `},c=[{value:"fcose",label:"Force-Directed (fcose)"},{value:"level-by-level",label:"Level-by-Level (DAG)"},{value:"circle",label:"Circle"},{value:"concentric",label:"Concentric"},{value:"breadthfirst",label:"Breadth-First"},{value:"grid",label:"Grid"}],u=()=>`
    <div class="dialog-header">
      <h3>Edit Template</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <div class="template-graph-type-label">
      Graph Type: <strong>${J[t.graphType]?.label||t.graphType}</strong>
    </div>
    <div class="template-section-label">Node Types</div>
    <div id="node-types-list">${i(t.nodeTypes,"node")}</div>
    <button id="add-node-type" class="btn-secondary btn-add-type">+ Add Node Type</button>
    <div class="template-section-label">Edge Types</div>
    <div id="edge-types-list">${i(t.edgeTypes,"edge")}</div>
    <button id="add-edge-type" class="btn-secondary btn-add-type">+ Add Edge Type</button>
    ${r()}
    <div class="template-section-label">Default Layout Algorithm</div>
    <select id="default-layout-algo">
      ${c.map(g=>`<option value="${g.value}" ${(t.defaultLayoutAlgorithm||"fcose")===g.value?"selected":""}>${g.label}</option>`).join("")}
    </select>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Save</button>
    </div>
  `,d=()=>{p.querySelectorAll(".type-label-input").forEach(g=>{g.addEventListener("focus",()=>g.select())})},p=N(u());p.classList.add("dialog-wide"),d();const h=()=>{p.querySelectorAll(".type-row").forEach(S=>{const m=S.dataset.id,b=S.dataset.kind,$=S.querySelector(".type-label-input")?.value??"",C=S.querySelector(".type-color-input")?.value??"#4fc3f7";if(b==="node"){const T=t.nodeTypes.find(E=>E.id===m);T&&(T.label=$,T.color=C)}else{const T=t.edgeTypes.find(E=>E.id===m);T&&(T.label=$,T.color=C)}}),l&&(t.specialTypes=[],p.querySelectorAll(".special-type-cb:checked").forEach(S=>{t.specialTypes.push(S.dataset.id)})),p.querySelector("#node-types-list").innerHTML=i(t.nodeTypes,"node"),p.querySelector("#edge-types-list").innerHTML=i(t.edgeTypes,"edge");const g=p.querySelector(".special-types-section");g&&(g.outerHTML=r()),f(),v(),d()},f=()=>{p.querySelectorAll(".btn-delete-type").forEach(g=>{g.onclick=()=>{const S=g.dataset.id;g.dataset.kind==="node"?(t.nodeTypes=t.nodeTypes.filter(b=>b.id!==S),t.specialTypes=t.specialTypes.filter(b=>b!==S)):t.edgeTypes=t.edgeTypes.filter(b=>b.id!==S),h()}})},v=()=>{l&&(p.querySelectorAll(".st-up").forEach(g=>{g.onclick=()=>{const S=g.dataset.id,m=t.specialTypes.indexOf(S);m>0&&([t.specialTypes[m-1],t.specialTypes[m]]=[t.specialTypes[m],t.specialTypes[m-1]],h())}}),p.querySelectorAll(".st-down").forEach(g=>{g.onclick=()=>{const S=g.dataset.id,m=t.specialTypes.indexOf(S);m!==-1&&m<t.specialTypes.length-1&&([t.specialTypes[m],t.specialTypes[m+1]]=[t.specialTypes[m+1],t.specialTypes[m]],h())}}),p.querySelectorAll(".special-type-cb").forEach(g=>{g.onchange=()=>{const S=g.dataset.id;g.checked?t.specialTypes.includes(S)||t.specialTypes.push(S):t.specialTypes=t.specialTypes.filter(m=>m!==S),h()}}))};f(),v(),p.querySelector("#add-node-type").onclick=()=>{h(),t.nodeTypes.push({id:qe(),label:"New Type",color:"#4fc3f7"}),h()},p.querySelector("#add-edge-type").onclick=()=>{h(),t.edgeTypes.push({id:qe(),label:"New Type",color:"#5a6a8c"}),h()};const k=()=>{p.querySelectorAll(".type-row").forEach(g=>{const S=g.dataset.id,m=g.dataset.kind,b=g.querySelector(".type-label-input")?.value?.trim()||"Unnamed",$=g.querySelector(".type-color-input")?.value??"#4fc3f7";if(m==="node"){const C=t.nodeTypes.find(T=>T.id===S);C&&(C.label=b,C.color=$)}else{const C=t.edgeTypes.find(T=>T.id===S);C&&(C.label=b,C.color=$)}}),l&&(t.specialTypes=[],p.querySelectorAll(".special-type-cb:checked").forEach(g=>{t.specialTypes.push(g.dataset.id)})),t.defaultLayoutAlgorithm=p.querySelector("#default-layout-algo").value,e(t),y("Template saved","success")},x=n?()=>{w(),n()}:w;p.querySelector("#dlg-ok").onclick=k,p.querySelector("#dlg-cancel").onclick=x,p.querySelector("#dlg-close-x").onclick=x}function Le(o,e){const s=o.panelEl;if(!o.pathTrackingEnabled||!o._pathTags)return;const n=o.template,t=n?.specialTypes||[],a=o._pathTags.get(e)||[],l=o._effectiveExclusions?.get(e)||new Set,i=new Set(o.exclusions[e]||[]);if(a.length===0){y("No path tags on this edge","info");return}const r=v=>q(v,t),c=v=>j(v,t,n?.nodeTypes||[]);let u={...o.exclusions};const d=a.map(v=>{const k=r(v),x=i.has(k),g=l.has(k)&&!x,S=x||g,m=c(v);return`
      <div class="exclusion-item ${g?"propagated":""}">
        <input type="checkbox" class="excl-cb" data-tag="${k}" data-propagated="${g}" ${S?"":"checked"} title="${g?"Propagated from downstream — uncheck to add direct exclusion":""}">
        <span>${m}${g?' <em style="font-size:10px;color:var(--text-muted)">(inherited)</em>':""}</span>
      </div>
    `}).join(""),[p,h]=e.split("→"),f=N(`
    <div class="dialog-header">
      <h3>Exclusions: ${p} → ${h}</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Checked = included in tracking. Uncheck to exclude a path.</p>
    <div class="exclusion-list">${d}</div>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `,s);f.querySelector("#dlg-ok").onclick=()=>{const v=f.querySelectorAll(".excl-cb"),k=[];v.forEach(g=>{const S=g.dataset.tag;g.checked||k.push(S)});const x=k.filter(g=>f.querySelector(`.excl-cb[data-tag="${g}"]`)?.dataset.propagated!=="true");x.length>0?u[e]=x:delete u[e],o.exclusions=u,o._recomputePathTrackingAsync(),o._emitChange(),w()},f.querySelector("#dlg-cancel").onclick=w,f.querySelector("#dlg-close-x").onclick=w}function Lt(o){const e=o.panelEl,n=[{value:"fcose",label:"Force-Directed (fcose)"},{value:"level-by-level",label:"Level-by-Level (DAG)"},{value:"circle",label:"Circle"},{value:"concentric",label:"Concentric"},{value:"breadthfirst",label:"Breadth-First"},{value:"grid",label:"Grid"}].map(c=>`<option value="${c.value}" ${o.layoutAlgorithm===c.value?"selected":""}>${c.label}</option>`).join(""),t=o.template,a=t?.graphType==="DAG",l=a&&t?.specialTypes?.length>0,i=a?`
    <div class="template-section-label" style="margin-top:12px">Path Tracking</div>
    ${l?`
    <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;white-space:nowrap">
      <input type="checkbox" id="dlg-tracking" style="width:auto;flex-shrink:0" ${o.pathTrackingEnabled?"checked":""}>
      Enable path tracking
    </label>
    `:'<p style="font-size:11px;color:var(--text-muted)">No special types configured in template. Edit the template to add special types for DAG path tracking.</p>'}
  `:"",r=N(`
    <div class="dialog-header">
      <h3>Panel Options</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <label>Layout Algorithm</label>
    <select id="dlg-layout-algo">${n}</select>
    ${i}
    <div class="dialog-actions">
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `,e);r.querySelector("#dlg-ok").onclick=()=>{const c=r.querySelector("#dlg-layout-algo").value;if(o.setLayoutAlgorithm(c),l){const u=r.querySelector("#dlg-tracking")?.checked||!1;u!==o.pathTrackingEnabled&&o.setPathTracking(u)}y("Options applied","success"),w()},r.querySelector("#dlg-close-x").onclick=w}function De(o,e,s,n,t){const a=o.template?.specialTypes||[],l=g=>{if(!g)return[];const S=g.graph.nodes;return a.length>0?S.filter(m=>a.includes(m.type)):S},i=l(o),r=l(e),c=n[s],u=c&&typeof c=="object"?c.scopeNodes||[]:[],d=u.length>0,p=(g,S)=>g.length===0?`<p style="font-size:11px;color:var(--text-muted)">${S}</p>`:g.map(m=>{const b=u.includes(m.label)?"checked":"";return`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:12px">
        <input type="checkbox" class="scope-node-cb" value="${m.label}" ${b} style="width:auto;margin:0">
        <span>${m.label}</span>
      </div>`}).join(""),h=a.length>0?"No special-type nodes":"No nodes",[f,v]=s.split("→"),k=N(`
    <div class="dialog-header">
      <h3>Select Scope Nodes</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">
      Select nodes from either panel. Only upstream ancestors of selected nodes (in source) will be merged.
    </p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px">
      <div>
        <div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:6px">Target: ${v}</div>
        <div style="max-height:180px;overflow-y:auto">${p(i,h)}</div>
      </div>
      <div>
        <div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:6px">Source: ${f}</div>
        <div style="max-height:180px;overflow-y:auto">${p(r,h)}</div>
      </div>
    </div>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `),x=()=>{d||delete n[s],w(),t&&t()};k.querySelector("#dlg-ok").onclick=()=>{const g=[...k.querySelectorAll(".scope-node-cb:checked")].map(S=>S.value);n[s]={strategy:"scoped",scopeNodes:g},w(),t&&t()},k.querySelector("#dlg-cancel").onclick=x,k.querySelector("#dlg-close-x").onclick=x}function Dt(o,e,s){const n=o.map(l=>`<option value="${l.id}">${l.name}</option>`).join(""),t=N(`
    <h3>Add Merge Button</h3>
    <label>Source Panel</label>
    <select id="dlg-source">${n}</select>
    <label>Target Panel</label>
    <select id="dlg-target">${n}</select>
    <p id="dlg-warning" style="color:var(--warning);font-size:11px;display:none;margin-bottom:6px">This merge direction already exists.</p>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `),a=()=>{const l=t.querySelector("#dlg-source").value,i=t.querySelector("#dlg-target").value,r=e.some(c=>c.source===l&&c.target===i);t.querySelector("#dlg-warning").style.display=r?"":"none"};t.querySelector("#dlg-source").onchange=a,t.querySelector("#dlg-target").onchange=a,t.querySelector("#dlg-cancel").onclick=w,t.querySelector("#dlg-ok").onclick=()=>{const l=t.querySelector("#dlg-source").value,i=t.querySelector("#dlg-target").value;if(l===i){y("Source and target must differ","error");return}w(),s({source:l,target:i})}}function Mt(o){const s=Object.keys(o).map(n=>`<option value="${n}">${n}</option>`).join("");return new Promise(n=>{const t=N(`
      <h3>New Session</h3>
      <label>Session Name</label>
      <input id="dlg-name" type="text" placeholder="Session name" autofocus>
      <label>Template</label>
      <select id="dlg-template">${s}</select>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Create</button>
      </div>
    `);t.querySelector("#dlg-cancel").onclick=()=>{w(),n(null)},t.querySelector("#dlg-ok").onclick=()=>{const a=t.querySelector("#dlg-name").value.trim();if(!a){y("Session name required","error");return}const l=t.querySelector("#dlg-template").value;w(),n({name:a,templateName:l})},t.querySelector("#dlg-name").onkeydown=a=>{a.key==="Enter"&&t.querySelector("#dlg-ok").click()}})}const Me=200;class Ot{constructor(e,{onPanelCreate:s,onPanelDestroy:n,onMerge:t,getState:a,setState:l,confirmClose:i,onResizeEnd:r,getPanels:c}){this.rootEl=e,this.onPanelCreate=s,this.onPanelDestroy=n,this.onMerge=t,this._getState=a||null,this._setState=l||null,this._confirmClose=i||null,this._onResizeEnd=r||null,this._getPanels=c||null,this.nextId=1,this.tree=null,this._zoomedPanelId=null,this._zoomSavedStates=new Map,this.mergeStrategies={},this.mergeButtonLists={},this._gutterSplitNodes={}}_getStrategy(e){const s=this.mergeStrategies[e];return s?typeof s=="string"?{strategy:s,scopeNodes:[]}:s:{strategy:"mirror",scopeNodes:[]}}_strategyBadge(e){switch(e){case"push":return"(P)";case"scoped":return"(S)";case"none":return"(N)";default:return"(M)"}}init(){const e=window.innerWidth<=600?"h":"v";this.tree={type:"split",direction:e,children:[{type:"panel",id:String(this.nextId++)},{type:"panel",id:String(this.nextId++)}],sizes:[50,50]},this.render()}getLayout(){return{tree:this.tree,nextId:this.nextId,mergeStrategies:this.mergeStrategies,mergeButtonLists:this.mergeButtonLists}}setLayout(e){this.tree=e.tree,this.nextId=e.nextId,this.mergeStrategies=e.mergeStrategies||{},this.mergeButtonLists=e.mergeButtonLists||{},this.render()}getMergeStrategies(){return this.mergeStrategies}setMergeStrategies(e){this.mergeStrategies=e||{}}getAllPanelIds(){const e=[],s=n=>{n.type==="panel"?e.push(n.id):n.children.forEach(s)};return this.tree&&s(this.tree),e}splitPanel(e,s){const n=String(this.nextId++),t=this._findPanelNode(this.tree,e);return this.tree=this._mapTree(this.tree,a=>a.type==="panel"&&a.id===e?{type:"split",direction:s,children:[{type:"panel",id:e,name:t?.name},{type:"panel",id:n}],sizes:[50,50]}:a),this.render(),n}closePanel(e){if(!(this.getAllPanelIds().length<=1)){this._zoomedPanelId===e&&(this._zoomedPanelId=null);for(const s of Object.keys(this.mergeButtonLists))this.mergeButtonLists[s]=this.mergeButtonLists[s].filter(n=>n.source!==e&&n.target!==e);this.tree=this._removePanel(this.tree,e),this.render()}}addPanel(){const e=String(this.nextId++),s=window.innerWidth<=600?"h":"v";return this.tree={type:"split",direction:s,children:[this.tree,{type:"panel",id:e}],sizes:[70,30]},this.render(),e}toggleZoom(e){this._zoomedPanelId===e?this._zoomedPanelId=null:this._zoomedPanelId=e,this.render()}render(){const e=new Map,s=new Set;this.rootEl.querySelectorAll(".panel-canvas").forEach(t=>{s.add(t.dataset.panel)});for(const t of s)if(this._getState){const a=this._getState(t);a&&e.set(t,a)}for(const t of s)this.onPanelDestroy(t);if(this.rootEl.innerHTML="",!this.tree)return;if(this._zoomedPanelId){const t=this._findPanelNode(this.tree,this._zoomedPanelId);if(t){for(const i of s)i!==this._zoomedPanelId&&e.has(i)&&this._zoomSavedStates.set(i,e.get(i));const a=this._renderPanel(t);a.style.flex="1",a.classList.add("zoomed"),this.rootEl.appendChild(a);const l=a.querySelector(".panel-canvas");this.onPanelCreate(this._zoomedPanelId,l),e.has(this._zoomedPanelId)&&this._setState&&this._setState(this._zoomedPanelId,e.get(this._zoomedPanelId));return}this._zoomedPanelId=null}for(const[t,a]of this._zoomSavedStates)e.has(t)||e.set(t,a);this._zoomSavedStates.clear();const n=this._renderNode(this.tree);n.style.flex="1",n.style.display="flex",n.style.minWidth="0",n.style.minHeight="0",this.rootEl.appendChild(n);for(const t of this.getAllPanelIds()){const a=this.rootEl.querySelector(`.panel-canvas[data-panel="${t}"]`);a&&(this.onPanelCreate(t,a),e.has(t)&&this._setState&&this._setState(t,e.get(t)))}}_renderNode(e){return e.type==="panel"?this._renderPanel(e):this._renderSplit(e)}_renderPanel(e){const s=e.name||`Panel ${e.id}`,n=document.createElement("div");n.className="panel",n.dataset.panelId=e.id;const t=document.createElement("div");t.className="panel-header",t.innerHTML=`
      <span class="panel-header-left">
        <button data-action="panel-options" class="btn-icon btn-header-icon" title="Panel options">&#x2699;</button>
        <button data-action="refresh" class="btn-icon btn-header-icon" title="Re-layout">&#x21BB;</button>
        <span class="panel-header-sep"></span>
        <button data-action="undo" class="btn-icon btn-header-icon" title="Undo (Ctrl+Z)">&#x21B6;</button>
        <button data-action="redo" class="btn-icon btn-header-icon" title="Redo (Ctrl+Shift+Z)">&#x21B7;</button>
        <span class="processing-indicator" title="Processing...">&#x27F3;</span>
      </span>
      <span class="panel-info"></span>
      <span class="panel-header-right">
        <button class="panel-split-btn" data-split="v" title="Split this panel into two side-by-side panels">&#x2194;</button>
        <button class="panel-split-btn" data-split="h" title="Split this panel into two stacked panels">&#x2195;</button>
        <span class="panel-header-sep"></span>
        <button class="panel-zoom-btn" title="Toggle full-screen zoom on this panel (Escape to exit)">&#x2922;</button>
        <span class="panel-header-sep"></span>
        <button class="panel-close-btn" title="Close this panel and remove it from the layout">&#x2715;</button>
      </span>
    `,n.appendChild(t),t.querySelector(".panel-zoom-btn").onclick=()=>this.toggleZoom(e.id),t.querySelector('[data-split="v"]').onclick=()=>this.splitPanel(e.id,"v"),t.querySelector('[data-split="h"]').onclick=()=>this.splitPanel(e.id,"h"),t.querySelector(".panel-close-btn").onclick=async()=>{this._confirmClose&&!await this._confirmClose(e.id)||this.closePanel(e.id)};const a=document.createElement("div");a.className="panel-canvas",a.dataset.panel=e.id;const l=document.createElement("div");l.className="panel-name-overlay",l.title="Click to rename",l.textContent=s,l.onclick=()=>{Ct(s,n).then(c=>{if(c!==null){e.name=c||void 0;const u=c||`Panel ${e.id}`;l.textContent=u,this.render()}})},a.appendChild(l);const i=document.createElement("div");i.className="diff-overlay",i.dataset.panelDiff=e.id,a.appendChild(i),n.appendChild(a);const r=document.createElement("div");return r.className="panel-actions",r.innerHTML=`
      <span class="panel-actions-left">
        <button data-action="add-node" class="btn-add" title="Add a new labeled node to the graph">+N</button>
        <button data-action="add-edge" class="btn-add" title="Add a new directed edge between two existing nodes">+E</button>
        <span class="action-separator"></span>
        <button data-action="approve" class="btn-approve" title="Snapshot current state as baseline and clear all diffs">&#x2713;</button>
        <button data-action="restore" class="btn-restore" title="Revert graph to last approved state (undo all changes since approval)">&#x21BA;</button>
        <span class="action-separator"></span>
        <button data-action="clear" class="btn-clear" title="Reset panel to empty state (clears graph, approval history, and diffs)">&#x232B;</button>
      </span>
      <span class="panel-actions-right">
        <button data-action="changeset" class="btn-icon" title="View pending changeset summary">&#x24D8;</button>
        <button data-action="changelog" class="btn-icon" title="View approval history">&#x2630;</button>
        <button data-action="import" class="btn-icon" title="Import graph from a JSON file">&#x21A5;</button>
        <button data-action="export" class="btn-icon" title="Export current graph as a JSON file">&#x21A7;</button>
      </span>
    `,n.appendChild(r),n}_renderSplit(e){const s=e.direction==="v",n=document.createElement("div");n.className=s?"split-v":"split-h";const t=this._renderNode(e.children[0]),a=this._renderNode(e.children[1]);t.style.flex=`${e.sizes[0]} 1 0`,t.style.overflow="hidden",t.style.display="flex",t.style.minWidth="0",t.style.minHeight="0",a.style.flex=`${e.sizes[1]} 1 0`,a.style.overflow="hidden",a.style.display="flex",a.style.minWidth="0",a.style.minHeight="0";const l=this._renderMergeGutter(e);return n.appendChild(t),n.appendChild(l),n.appendChild(a),n}_panelName(e){return e.name||`Panel ${e.id}`}_getPanelName(e){const s=this._findPanelNode(this.tree,e);return s?this._panelName(s):`Panel ${e}`}_gutterKey(e){const s=this._allPanelNodes(e.children[0]).map(t=>t.id).sort().join(","),n=this._allPanelNodes(e.children[1]).map(t=>t.id).sort().join(",");return`${s}|${n}`}_defaultButtons(e){const s=this._getZones(e.children[0],e.direction,"first"),n=this._getZones(e.children[1],e.direction,"second"),t=p=>{let h=0;return p.map(f=>{const v={start:h,end:h+f.size,panels:f.panels,slot:f.slot};return h+=f.size,v})},a=t(s),l=t(n),i=new Set([0,100]);for(const p of[...a,...l])i.add(p.start),i.add(p.end);const r=[...i].sort((p,h)=>p-h),c=(p,h)=>p.find(f=>f.start<=h&&h<f.end),u=[],d=new Set;for(let p=0;p<r.length-1;p++){const h=(r[p]+r[p+1])/2,f=c(a,h),v=c(l,h);if(!(!f||!v)&&!(f.slot!==null&&v.slot!==null&&f.slot!==v.slot))for(const k of f.panels)for(const x of v.panels){const g=`${k.id}→${x.id}`,S=`${x.id}→${k.id}`;d.has(g)||(d.add(g),u.push({source:k.id,target:x.id})),d.has(S)||(d.add(S),u.push({source:x.id,target:k.id}))}}return u}_getButtonList(e){const s=this._gutterKey(e);return this.mergeButtonLists[s]||(this.mergeButtonLists[s]=this._defaultButtons(e)),this.mergeButtonLists[s]}_rerenderGutter(e){const s=this._gutterSplitNodes[e];if(!s)return;const n=this.rootEl.querySelector(`.merge-gutter[data-gutter-key="${CSS.escape(e)}"]`);n&&n.replaceWith(this._renderMergeGutter(s))}_renderMergeGutter(e){const s=e.direction==="v",n=document.createElement("div");n.className="merge-gutter";const t=this._gutterKey(e);n.dataset.gutterKey=t,this._gutterSplitNodes[t]=e;const a=this._getButtonList(e),l=new Set(this._allPanelNodes(e.children[0]).map(p=>p.id)),i=document.createElement("div");i.className="merge-zone merge-zone-flat",a.forEach((p,h)=>{const{source:f,target:v}=p,k=`${f}→${v}`,x=this._getStrategy(k),g=this._getPanelName(f),S=this._getPanelName(v),m=l.has(f)?`${g} » ${S}`:`${S} « ${g}`,b=document.createElement("button");b.className="merge-btn",x.strategy==="none"&&b.classList.add("merge-btn-disabled"),b.innerHTML=`<span class="merge-btn-text">${m}</span><span class="merge-strategy-badge">${this._strategyBadge(x.strategy)}</span>`,b.title=`Merge ${g} into ${S}`,b.dataset.mergeSource=f,b.dataset.mergeTarget=v,b.onclick=()=>{if(this._getStrategy(k).strategy==="none"){He("Merge Disabled","This merge direction is set to None.");return}this.onMerge(f,v)};const $=document.createElement("div");$.className="merge-btn-row",$.appendChild(b),i.appendChild($)});const r=document.createElement("button");r.className="merge-gutter-settings",r.innerHTML="&#x2699;",r.title="Manage merge buttons",r.onclick=()=>this._showMergeManagementModal(t,e),i.appendChild(r),n.appendChild(i);const c=document.createElement("div");c.className="resize-handle",this._setupResize(c,e,n),n.appendChild(c);const u=this._firstPanelId(e.children[0]),d=this._firstPanelId(e.children[1]);return requestAnimationFrame(()=>{if(!n.isConnected)return;const p=this.rootEl.querySelector(`.panel[data-panel-id="${u}"]`),h=this.rootEl.querySelector(`.panel[data-panel-id="${d}"]`);if(!p||!h)return;const f=()=>{if(!n.isConnected){v.disconnect();return}const k=n.getBoundingClientRect(),x=p.getBoundingClientRect(),g=h.getBoundingClientRect();if(s){const S=Math.min(x.height,g.height),m=Math.max(x.top,g.top)-k.top;i.style.top=`${Math.max(0,m)}px`,i.style.height=`${S}px`}else{const S=Math.min(x.width,g.width),m=Math.max(x.left,g.left)-k.left;i.style.left=`${Math.max(0,m)}px`,i.style.width=`${S}px`}},v=new ResizeObserver(f);v.observe(p),v.observe(h),f(),n._resizeObserver=v}),n}_getZones(e,s,n){if(e.type==="panel")return[{panels:[{id:e.id,name:this._panelName(e)}],size:100,slot:null}];const t=s==="v"?"h":"v";if(e.direction===t){const l=this._getZones(e.children[0],s,n),i=this._getZones(e.children[1],s,n);return[...l.map(r=>({panels:r.panels,size:r.size*e.sizes[0]/100,slot:r.slot!==null?r.slot:0})),...i.map(r=>({panels:r.panels,size:r.size*e.sizes[1]/100,slot:r.slot!==null?r.slot:1}))]}const a=n==="first"?e.children[1]:e.children[0];return this._getZones(a,s,n)}_allPanelNodes(e){return e.type==="panel"?[{id:e.id,name:this._panelName(e)}]:[...this._allPanelNodes(e.children[0]),...this._allPanelNodes(e.children[1])]}_findPanelNode(e,s){return e?e.type==="panel"?e.id===s?e:null:this._findPanelNode(e.children[0],s)||this._findPanelNode(e.children[1],s):null}_firstPanelId(e){return e.type==="panel"?e.id:this._firstPanelId(e.children[0])}_allPanelIds(e){return e.type==="panel"?[e.id]:[...this._allPanelIds(e.children[0]),...this._allPanelIds(e.children[1])]}_setupResize(e,s,n){const t=s.direction==="v",a=l=>{const i=n.parentElement;if(!i)return null;const r=i.getBoundingClientRect(),c=t?r.width:r.height;t?n.offsetWidth:n.offsetHeight;const u=p=>{let f=(t?p.x-r.left:p.y-r.top)/c;f=Math.max(Me/c,Math.min(1-Me/c,f)),s.sizes[0]=f*100,s.sizes[1]=(1-f)*100;const v=i.querySelectorAll(":scope > .panel, :scope > .split-v, :scope > .split-h");v.length>=2&&(v[0].style.flex=`${s.sizes[0]} 1 0`,v[v.length-1].style.flex=`${s.sizes[1]} 1 0`)},d=()=>{document.body.style.cursor="",document.body.style.userSelect="",this._onResizeEnd&&this._onResizeEnd(s)};return document.body.style.cursor=t?"col-resize":"row-resize",document.body.style.userSelect="none",{onMove:u,onEnd:d}};e.addEventListener("mousedown",l=>{l.preventDefault();const i=a({x:l.clientX,y:l.clientY});if(!i)return;const r=u=>i.onMove({x:u.clientX,y:u.clientY}),c=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",c),i.onEnd()};document.addEventListener("mousemove",r),document.addEventListener("mouseup",c)}),e.addEventListener("touchstart",l=>{l.preventDefault();const i=l.touches[0],r=a({x:i.clientX,y:i.clientY});if(!r)return;const c=d=>{d.preventDefault();const p=d.touches[0];r.onMove({x:p.clientX,y:p.clientY})},u=()=>{document.removeEventListener("touchmove",c),document.removeEventListener("touchend",u),document.removeEventListener("touchcancel",u),r.onEnd()};document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",u),document.addEventListener("touchcancel",u)})}_showStrategyPicker(e,s,n){document.querySelector(".merge-strategy-picker")?.remove();const t=this._getStrategy(e),a=t.strategy,l=document.createElement("div");l.className="merge-strategy-picker";const i=s.getBoundingClientRect();l.style.cssText=`position:fixed;left:${i.left}px;top:${i.bottom+4}px;z-index:10000`;const r=[{strat:"mirror",label:"Mirror (M)"},{strat:"push",label:"Push (P)"},{strat:"scoped",label:"Scoped (S)"},{strat:"none",label:"None (N)"}];l.innerHTML=r.map(d=>`<div class="strategy-option${a===d.strat?" active":""}" data-strat="${d.strat}">${a===d.strat?"✓ ":""}${d.label}</div>`).join("")+`
      <hr class="strategy-separator">
      <div class="strategy-option strategy-delete" data-strat="__delete__">&#x2715; Delete</div>
    `,document.body.appendChild(l);const c=()=>{const d=this._getStrategy(e),p=s.querySelector(".merge-strategy-badge");p&&(p.textContent=this._strategyBadge(d.strategy)),s.classList.toggle("merge-btn-disabled",d.strategy==="none")},u=d=>{l.contains(d.target)||(l.remove(),document.removeEventListener("mousedown",u))};l.querySelectorAll(".strategy-option").forEach(d=>{d.onclick=p=>{p.stopPropagation();const h=d.dataset.strat;if(l.remove(),document.removeEventListener("mousedown",u),h==="__delete__"){if(n&&this.mergeButtonLists[n]){const f=this.mergeButtonLists[n].findIndex(v=>`${v.source}→${v.target}`===e);f!==-1&&this.mergeButtonLists[n].splice(f,1),this._rerenderGutter(n),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}return}if(h==="mirror"?delete this.mergeStrategies[e]:this.mergeStrategies[e]={strategy:h,scopeNodes:t.scopeNodes||[]},h==="scoped"){const[f,v]=e.split("→"),k=this._getPanels?this._getPanels():null,x=k?.get(v),g=k?.get(f);x?De(x,g,e,this.mergeStrategies,()=>{c(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}):(c(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})))}else c(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}}),setTimeout(()=>document.addEventListener("mousedown",u),0)}updateMergeButtonStates(e){this.rootEl.querySelectorAll(".merge-btn[data-merge-source]").forEach(s=>{if(s.classList.contains("merge-btn-disabled"))return;const n=s.dataset.mergeSource,t=e.get(n),a=t?t.isClean():!0;s.classList.toggle("merge-btn-allowed",a),s.classList.toggle("merge-btn-blocked",!a)})}_showMergeManagementModal(e,s){const n=this.mergeButtonLists[e]||[],t=new Set(this._allPanelNodes(s.children[0]).map(u=>u.id)),a=()=>n.map((u,d)=>{const{source:p,target:h}=u,f=`${p}→${h}`,v=this._getStrategy(f),k=this._getPanelName(p),x=this._getPanelName(h),g=t.has(p)?`${k} » ${x}`:`${x} « ${k}`,S=[{value:"mirror",label:"Mirror"},{value:"push",label:"Push"},{value:"scoped",label:"Scoped"},{value:"none",label:"None"}].map(m=>`<option value="${m.value}" ${v.strategy===m.value?"selected":""}>${m.label}</option>`).join("");return`
        <div class="mgmt-row" data-idx="${d}">
          <span class="mgmt-btn-label">${g}</span>
          <select class="mgmt-strat-select" data-key="${f}" data-idx="${d}">${S}</select>
          <button class="mgmt-up-btn btn-icon" data-idx="${d}" title="Move up" ${d===0?"disabled":""}>&#x25B2;</button>
          <button class="mgmt-dn-btn btn-icon" data-idx="${d}" title="Move down" ${d===n.length-1?"disabled":""}>&#x25BC;</button>
          <button class="mgmt-delete-btn btn-danger" data-idx="${d}" title="Delete">&#x00D7;</button>
        </div>
      `}).join(""),i=N(`
      <div class="dialog-header">
        <h3>Merge Buttons</h3>
        <button id="mgmt-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Changes are applied live. Use &#x25B2;&#x25BC; buttons to reorder.</p>
      <div id="mgmt-list">${a()||'<p style="color:var(--text-muted);padding:8px;text-align:center">No merge buttons</p>'}</div>
      <button id="mgmt-add" class="btn-secondary" style="margin-top:8px">+ Add Merge Button</button>
    `);i.classList.add("dialog-wide");const r=()=>{i.querySelector("#mgmt-list").innerHTML=a()||'<p style="color:var(--text-muted);padding:8px;text-align:center">No merge buttons</p>',c()},c=()=>{i.querySelectorAll(".mgmt-delete-btn").forEach(u=>{u.onclick=()=>{const d=parseInt(u.dataset.idx);n.splice(d,1),this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),r()}}),i.querySelectorAll(".mgmt-up-btn").forEach(u=>{u.onclick=()=>{const d=parseInt(u.dataset.idx);d!==0&&([n[d-1],n[d]]=[n[d],n[d-1]],this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),r())}}),i.querySelectorAll(".mgmt-dn-btn").forEach(u=>{u.onclick=()=>{const d=parseInt(u.dataset.idx);d!==n.length-1&&([n[d],n[d+1]]=[n[d+1],n[d]],this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),r())}}),i.querySelectorAll(".mgmt-strat-select").forEach(u=>{u.onchange=()=>{const d=u.dataset.key,p=u.value;if(p==="mirror")delete this.mergeStrategies[d];else{const h=this._getStrategy(d);this.mergeStrategies[d]={strategy:p,scopeNodes:h.scopeNodes||[]}}if(this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),p==="scoped"){const[h,f]=d.split("→"),v=this._getPanels?this._getPanels():null,k=v?.get(f),x=v?.get(h);k&&De(k,x,d,this.mergeStrategies,()=>{this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))})}}})};c(),i.querySelector("#mgmt-add").onclick=()=>{const u=this._allPanelNodes(this.tree),d=this.mergeButtonLists[e]||[];w(),Dt(u,d,({source:p,target:h})=>{this.mergeButtonLists[e]||(this.mergeButtonLists[e]=[]),this.mergeButtonLists[e].push({source:p,target:h}),this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),this._showMergeManagementModal(e,s)})},i.querySelector("#mgmt-close-x").onclick=w}_mapTree(e,s){const n=s(e);return n!==e?n:e.type==="panel"?e:{...e,children:[this._mapTree(e.children[0],s),this._mapTree(e.children[1],s)]}}_removePanel(e,s){return e.type==="panel"?e:e.children[0].type==="panel"&&e.children[0].id===s?e.children[1]:e.children[1].type==="panel"&&e.children[1].id===s?e.children[0]:{...e,children:[this._removePanel(e.children[0],s),this._removePanel(e.children[1],s)]}}}let ne=null;function It(){let o=0;for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e),n=localStorage.getItem(s);o+=(s.length+n.length)*2}return o}function zt(o){return o<1024?`${o}B`:o<1024*1024?`${(o/1024).toFixed(1)}KB`:`${(o/(1024*1024)).toFixed(1)}MB`}function jt(){const o=localStorage.getItem("graph-merge-sessions");if(!o)return null;try{const e=JSON.parse(o);let s=0,n=0,t=0,a=null;for(const[l,i]of Object.entries(e))if(i.panels){for(const[r,c]of Object.entries(i.panels))t++,c.graph&&(s+=c.graph.nodes?.length||0,n+=c.graph.edges?.length||0);i.savedAt&&(!a||new Date(i.savedAt)>new Date(a))&&(a=i.savedAt)}return{sessionCount:Object.keys(e).length,totalNodes:s,totalEdges:n,totalPanels:t,latestSavedAt:a}}catch(e){return console.error("Failed to parse session stats:",e),null}}function Z(){if(!ne)return;const o=ne.querySelector(".status-left"),e=ne.querySelector(".status-right"),s=It(),n=jt();let t=`Storage: ${zt(s)}`;if(n&&(t+=` | ${n.totalNodes}n ${n.totalEdges}e ${n.totalPanels}p ${n.sessionCount}s`),o.textContent=t,n&&n.latestSavedAt){const a=new Date(n.latestSavedAt).toLocaleTimeString();e.textContent=`Last: ${a}`}else e.textContent=""}function Bt(){if(ne=document.getElementById("status-bar"),!ne){console.warn("Status bar element not found");return}window.addEventListener("panel-change",Z),Z()}const We="graph-merge-templates";function I(){try{const o=JSON.parse(localStorage.getItem(We));if(o&&typeof o=="object")return o.Default||(o.Default=Q()),o}catch{}return{Default:Q()}}function ee(o){localStorage.setItem(We,JSON.stringify(o))}function ue(o,e){if(!e.includes(o))return o;let s=2;for(;e.includes(`${o} (${s})`);)s++;return`${o} (${s})`}function Gt(o){const e=J[o.graphType]?.label||o.graphType,s=o.nodeTypes?.length||0,n=o.edgeTypes?.length||0;return`${e} · ${s} node type${s!==1?"s":""} · ${n} edge type${n!==1?"s":""}`}function Se(){let o=null;const e=i=>{const r=Object.keys(i);return r.length===0?'<p style="color:var(--text-muted);padding:12px;text-align:center">No templates</p>':r.map(c=>{const u=i[c];return`
        <div class="template-list-item ${c===o?"selected":""}" data-name="${c}">
          <span class="tpl-name">${c}</span>
          <span class="tpl-meta">${Gt(u)}</span>
        </div>
      `}).join("")},s=i=>`
    <div class="dialog-header">
      <h3>Templates</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <div class="template-list" id="tpl-list">
      ${e(i)}
    </div>
    <div class="template-modal-footer">
      <button id="tpl-add">Add</button>
      <button id="tpl-remove">Remove</button>
      <button id="tpl-edit">Edit</button>
      <button id="tpl-copy">Copy</button>
      <button id="tpl-import">Import</button>
      <button id="tpl-export">Export</button>
    </div>
  `,n=I(),t=N(s(n));t.classList.add("dialog-wide");const a=()=>{const i=I();t.querySelector("#tpl-list").innerHTML=e(i),l()},l=()=>{t.querySelectorAll(".template-list-item").forEach(i=>{i.onclick=()=>{o=i.dataset.name,a()}})};l(),t.addEventListener("click",i=>{i.target.matches("#dlg-close-x")&&w()}),t.querySelector("#tpl-add").onclick=()=>{const i=Object.entries(J).map(([r,c])=>`<option value="${r}">${c.label}</option>`).join("");t.querySelector("#tpl-list").innerHTML=`
      <div style="padding:12px;display:flex;flex-direction:column;gap:8px">
        <label>Template Name</label>
        <input id="tpl-new-name" type="text" placeholder="Template name" autofocus>
        <label>Graph Type</label>
        <select id="tpl-graph-type">${i}</select>
        <div style="display:flex;gap:8px;margin-top:4px">
          <button id="tpl-create-confirm" class="btn-primary">Create</button>
          <button id="tpl-create-cancel">Cancel</button>
        </div>
      </div>
    `,t.querySelector("#tpl-new-name").focus(),t.querySelector("#tpl-create-cancel").onclick=a,t.querySelector("#tpl-create-confirm").onclick=()=>{const r=t.querySelector("#tpl-new-name").value.trim();if(!r){y("Template name required","error");return}const c=t.querySelector("#tpl-graph-type").value,u=I(),d=ue(r,Object.keys(u));u[d]=it(d,c),ee(u),o=d,y(`Created template "${d}"`,"success"),a()}},t.querySelector("#tpl-remove").onclick=()=>{if(!o){y("Select a template first","info");return}if(o==="Default"){y("Cannot remove the Default template","info");return}const i=I(),r=o;confirm(`Delete template "${r}"?`)&&(delete i[r],ee(i),o=null,y(`Deleted template "${r}"`,"info"),a())},t.querySelector("#tpl-edit").onclick=()=>{if(!o){y("Select a template first","info");return}const r=I()[o];if(!r)return;w();const c=o;Je(JSON.parse(JSON.stringify(r)),u=>{const d=I();d[c]=u,ee(d),y("Template updated","success"),Se()},!1,()=>Se())},t.querySelector("#tpl-copy").onclick=()=>{if(!o){y("Select a template first","info");return}const i=I(),r=i[o];if(!r)return;const c=ue(o+" Copy",Object.keys(i));i[c]={...JSON.parse(JSON.stringify(r)),name:c},ee(i),o=c,y(`Copied as "${c}"`,"success"),a()},t.querySelector("#tpl-import").onclick=()=>{const i=document.createElement("input");i.type="file",i.accept=".json",i.onchange=()=>{const r=i.files[0];if(!r)return;const c=new FileReader;c.onload=u=>{let d;try{d=JSON.parse(u.target.result)}catch{y("Invalid JSON file","error");return}if(!d.template||!d.template.name){y("Invalid template file","error");return}const p=I(),h=ue(d.template.name,Object.keys(p));p[h]={...d.template,name:h},ee(p),o=h,y(`Imported template "${h}"`,"success"),a()},c.readAsText(r)},i.click()},t.querySelector("#tpl-export").onclick=()=>{if(!o){y("Select a template first","info");return}const r=I()[o];if(!r)return;const c=JSON.stringify({version:1,template:r},null,2),u=new Blob([c],{type:"application/json"}),d=URL.createObjectURL(u),p=document.createElement("a");p.href=d,p.download=`template-${o.replace(/[^a-zA-Z0-9_-]/g,"_")}.json`,p.click(),URL.revokeObjectURL(d),y(`Exported template "${o}"`,"success")}}const Ze="graph-merge-sessions",Ye="graph-merge-active-session";let ae=null,F=null,Oe=null,B=Q(),W=null;function U(){try{return JSON.parse(localStorage.getItem(Ze))||{}}catch{return{}}}function ie(o){localStorage.setItem(Ze,JSON.stringify(o))}function K(){return localStorage.getItem(Ye)||"Default"}function pe(o){localStorage.setItem(Ye,o)}function Ht(o){if(!o.state||o.layout)return o;const e=Object.keys(o.state),s={};let n=1;for(const t of e.slice(0,2)){const a=String(n++),l=o.state[t];s[a]={...l,id:a}}return{layout:{tree:{type:"split",direction:"v",children:[{type:"panel",id:"1"},{type:"panel",id:"2"}],sizes:[50,50]},nextId:n},panels:s,template:{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[]},savedAt:o.savedAt}}function Rt(o){return o.template?(o.template.specialTypes||(o={...o,template:{...o.template,specialTypes:[]}}),o):{...o,template:{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[],specialTypes:[]}}}function Ft(o){if(!o.panels)return o;const e={};for(const[s,n]of Object.entries(o.panels))e[s]={pathTrackingEnabled:!1,showExclusions:!0,exclusions:{},...n};return{...o,panels:e}}function Ut(){return B}function Y(){if(!ae||!F)return;const o=K(),e=U(),s={};for(const[n,t]of ae)s[n]=t.getState();e[o]={layout:F.getLayout(),panels:s,template:B,savedAt:new Date().toISOString()},ie(e)}function ge(o){if(!ae||!F)return;const e=U();let s=e[o];if(s){if(s=Ht(s),s=Rt(s),s=Ft(s),e[o]=s,ie(e),s.layoutAlgorithm&&s.panels)for(const n of Object.values(s.panels))n.layoutAlgorithm||(n.layoutAlgorithm=s.layoutAlgorithm);if(B=s.template||Q(),W&&W(B),s.layout&&F.setLayout(s.layout),s.panels)for(const[n,t]of ae)s.panels[n]&&t.setState(s.panels[n]);pe(o),Z()}}function Ve(){clearTimeout(Oe),Oe=setTimeout(Y,2e3)}function oe(){const o=document.getElementById("session-controls");if(!o)return;const e=U(),s=K(),n=Object.keys(e);n.includes(s)||n.unshift(s);const t=n.map(d=>`<option value="${d}" ${d===s?"selected":""}>${d}</option>`).join("");o.innerHTML=`
    <select id="session-select">${t}</select>
    <div class="session-menu-wrapper">
      <button id="session-menu-toggle" class="btn-icon" title="Session actions">&#x2630;</button>
      <div id="session-menu" class="session-dropdown" hidden>
        <button id="session-new">New</button>
        <button id="session-rename">Rename</button>
        <button id="session-delete">Delete</button>
        <hr class="menu-divider">
        <button id="session-edit-template">Edit Template</button>
        <hr class="menu-divider">
        <button id="session-export">Export</button>
        <button id="session-import">Import</button>
      </div>
    </div>
    <button id="templates-btn" title="Manage templates">Templates</button>
    <button id="add-panel-btn" title="Add panel" style="font-weight:bold;font-size:14px">+</button>
    <button class="help-btn" id="help-btn" title="Keyboard shortcuts">?</button>
  `;const a=o.querySelector("#session-menu"),l=o.querySelector("#session-menu-toggle"),i=()=>a.hidden=!0;l.onclick=d=>{d.stopPropagation(),a.hidden=!a.hidden};const r=d=>{o.contains(d.target)||i()};document.addEventListener("click",r);const c=new MutationObserver(()=>{document.contains(l)||(document.removeEventListener("click",r),c.disconnect())});c.observe(document.body,{childList:!0,subtree:!0});const u=(d,p)=>{const h=o.querySelector(d);h&&(h.onclick=()=>{i(),p()})};o.querySelector("#templates-btn").onclick=()=>Se(),o.querySelector("#session-select").onchange=d=>{Y(),ge(d.target.value),y(`Switched to "${d.target.value}"`,"info"),Z()},u("#session-new",async()=>{const d=I(),p=await Mt(d);if(!p)return;const{name:h,templateName:f}=p,v=JSON.parse(JSON.stringify(d[f]||Q()));Y(),B=v,W&&W(B),F.init(),pe(h.trim()),Y(),oe(),y(`Created session "${h.trim()}"`,"success"),Z()}),u("#session-rename",()=>{const d=K(),p=prompt("New name:",d);if(!p||!p.trim()||p.trim()===d)return;const h=U();h[p.trim()]=h[d],delete h[d],ie(h),pe(p.trim()),oe(),y(`Renamed to "${p.trim()}"`,"success")}),u("#session-delete",()=>{const d=K();if(!confirm(`Delete session "${d}"?`))return;const p=U();delete p[d],ie(p);const h=Object.keys(p);h.length>0?ge(h[0]):(pe("Default"),F.init()),oe(),y(`Deleted session "${d}"`,"info"),Z()}),u("#session-edit-template",()=>{Je(B,d=>{B=d,W&&W(B),Ve(),y("Template updated","success")},!0)}),u("#session-export",Wt),u("#session-import",Zt),o.querySelector("#add-panel-btn").onclick=()=>F.addPanel(),o.querySelector("#help-btn").onclick=()=>{Jt()}}function Jt(){let o=document.querySelector(".keyboard-help");o||(o=document.createElement("div"),o.className="keyboard-help",o.innerHTML=`
      <h3>Keyboard Shortcuts</h3>
      <dl>
        <dt><kbd>Ctrl</kbd>+<kbd>Z</kbd></dt><dd>Undo</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Z</kbd></dt><dd>Redo</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>C</kbd></dt><dd>Copy selected subgraph</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>V</kbd></dt><dd>Paste into focused panel</dd>
        <dt><kbd>Delete</kbd></dt><dd>Delete selected elements</dd>
        <dt><kbd>Escape</kbd></dt><dd>Deselect all / close dialog</dd>
      </dl>
      <div class="dialog-actions" style="margin-top:12px">
        <button onclick="this.closest('.keyboard-help').classList.remove('visible')">Close</button>
      </div>
    `,document.body.appendChild(o)),o.classList.toggle("visible")}function Wt(){Y();const o=K(),s=U()[o];if(!s){y("No session to export","error");return}const n=JSON.stringify({version:2,exportedAt:new Date().toISOString(),sessionName:o,...s},null,2),t=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(t),l=document.createElement("a");l.href=a;const i=new Date().toISOString().slice(0,10),r=o.replace(/[^a-zA-Z0-9_-]/g,"_");l.download=`session-${r}-${i}.json`,l.click(),URL.revokeObjectURL(a),y(`Exported session "${o}"`,"success")}function Zt(){const o=document.createElement("input");o.type="file",o.accept=".json",o.onchange=()=>{const e=o.files[0];if(!e)return;const s=new FileReader;s.onload=n=>{let t;try{t=JSON.parse(n.target.result)}catch{y("Invalid JSON file","error");return}if(!t.layout||!t.panels){y("Invalid session file: missing layout or panels","error");return}const a=U(),l=t.sessionName||"Imported",i=prompt("Session name for imported session:",ue(l,Object.keys(a)));if(!i||!i.trim())return;const r=i.trim();a[r]={layout:t.layout,panels:t.panels,template:t.template||{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[]},layoutAlgorithm:t.layoutAlgorithm,savedAt:t.savedAt||new Date().toISOString()},ie(a),Y(),ge(r),oe(),y(`Imported session "${r}"`,"success"),Z()},s.readAsText(e)},o.click()}function Yt(o,e,s){ae=o,F=e,W=s,window.addEventListener("panel-change",Ve);const n=K();U()[n]?ge(n):Y(),oe()}let H=null,L=null,le={},M=null,re=null,G=null;function Vt(o){H=o,document.getElementById("app").addEventListener("mousedown",e=>{const s=e.target.closest("[data-panel-id]");s&&(M=s.dataset.panelId)}),document.addEventListener("keydown",e=>{if(!e.target.matches("input, textarea, select")){if(e.ctrlKey&&e.key==="c")e.preventDefault(),Qt();else if(e.ctrlKey&&e.key==="v")e.preventDefault(),es();else if(e.key==="Delete"||e.key==="Backspace"){if(M){const s=H().get(M);s&&s.deleteSelected((n,t)=>D(n,t,s.panelEl))}}else if(e.key==="Escape"&&M){const s=H().get(M);s&&s.cy.elements().unselect()}}})}function Xe(o){const e=H().get(o);if(!e)return;const s=e.getSelectedSubgraph();if(!s||s.nodes.length===0&&s.edges.length===0){y("Nothing selected to copy","info");return}L=s,le=e.getRelevantExclusions(s),re="elements",G=null,y(`Copied ${s.nodes.length} node(s), ${s.edges.length} edge(s)`,"success")}function Ke(o){if(!L){y("Clipboard is empty","info");return}const e=H().get(o);if(!e)return;const s=H().get(M),n=s?s.pathTrackingEnabled:!1,t=`paste → ${e.id}`,a=e.pasteSubgraph(L,t,le,n);a.ok?y("Pasted subgraph","success"):y(a.error,"error")}function Xt(o,e){const s=H().get(o);if(!s)return;const n=ze(s.graph,e);if(n.nodes.length===0){y("No ancestors found","info");return}L=n,le=s.getRelevantExclusions(n),re="branch",G=e,s.selectBranch(e),y(`Copied branch from "${e}" (${n.nodes.length} node(s), ${n.edges.length} edge(s))`,"success")}function Kt(o,e){if(!L||re!=="branch"||!G){y("No branch in clipboard","info");return}const s=H().get(o);if(!s)return;let n=L;e!==G&&(n={nodes:[...L.nodes],edges:[...L.edges,lt(G,e)]});const t=H().get(M),a=t?t.pathTrackingEnabled:!1,l=`branch paste → ${e}`,i=s.pasteSubgraph(n,l,le,a);i.ok?y(e===G?"Pasted branch (no linking edge)":`Pasted branch with edge ${G} → ${e}`,"success"):y(i.error,"error")}function Qe(){L=null,le={},re=null,G=null,y("Clipboard cleared","info")}function et(){return L?{hasContent:!0,mode:re,branchRoot:G,nodeCount:L.nodes.length,edgeCount:L.edges.length}:{hasContent:!1}}function Qt(){if(!M){y("Click a panel first","info");return}Xe(M)}function es(){if(!M){y("Click a panel first","info");return}Ke(M)}let z=null;function ts(){return z||(z=document.createElement("div"),z.className="context-menu",z.style.display="none",document.body.appendChild(z),document.addEventListener("click",o=>{z.contains(o.target)||he()}),document.addEventListener("touchstart",o=>{z.contains(o.target)||he()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&he()})),z}function be(o,e,s){const n=ts();n.innerHTML="";for(const t of s){if(t.separator){const l=document.createElement("div");l.className="context-menu-separator",n.appendChild(l);continue}const a=document.createElement("button");a.className="context-menu-item",t.disabled&&(a.className+=" context-menu-item-disabled"),a.textContent=t.label,t.disabled||(a.onclick=()=>{he(),t.action()}),n.appendChild(a)}n.style.display="block",n.style.left=`${o}px`,n.style.top=`${e}px`,requestAnimationFrame(()=>{const t=n.getBoundingClientRect();t.right>window.innerWidth&&(n.style.left=`${window.innerWidth-t.width-4}px`),t.bottom>window.innerHeight&&(n.style.top=`${window.innerHeight-t.height-4}px`)})}function he(){z&&(z.style.display="none")}function ve(o){const e=o.originalEvent||o;return e.touches&&e.touches.length>0?{x:e.touches[0].clientX,y:e.touches[0].clientY}:e.changedTouches&&e.changedTouches.length>0?{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}:{x:e.clientX||0,y:e.clientY||0}}function ss(o){const e=[{label:"Add Node",action:()=>Re(o)},{label:"Add Edge",action:()=>Fe(o)}],s=o.cy.$(":selected"),n=et();return(!s.empty()||n.hasContent)&&(e.push({separator:!0}),s.empty()||e.push({label:`Copy Selected (${s.length})`,action:()=>Xe(o.id)}),n.hasContent&&(e.push({label:`Paste (${n.nodeCount}n, ${n.edgeCount}e)`,action:async()=>{await D("Paste Confirmation",`Paste ${n.nodeCount} node(s) and ${n.edgeCount} edge(s)?${n.mode==="branch"?`
Branch root: "${n.branchRoot}"`:""}`,o.panelEl)&&Ke(o.id)}}),e.push({label:"Cancel Copy",action:()=>Qe()}))),s.empty()||(e.push({separator:!0}),e.push({label:`Delete Selected (${s.length})`,action:()=>o.deleteSelected((t,a)=>D(t,a,o.panelEl))})),e.push({separator:!0}),e.push({label:"Select All",action:()=>o.cy.elements().select()}),s.empty()||e.push({label:"Deselect All",action:()=>o.cy.elements().unselect()}),e}function ns(o,e){const s=e.data("label"),n=et(),t=o.cy.$(":selected").length,a=[{label:`Edit Node "${s}"`,action:()=>{o.cy.elements().unselect(),e.select(),Ue(o)}},{label:`Delete Node "${s}"`,action:()=>{o.cy.elements().unselect(),e.select(),o.deleteSelected((l,i)=>D(l,i,o.panelEl))}}];return t>1&&(a.push({separator:!0}),a.push({label:`Delete all selected (${t})`,action:()=>o.deleteSelected((l,i)=>D(l,i,o.panelEl))})),o.pathTrackingEnabled&&e.hasClass("node-fully-excluded")&&(a.push({separator:!0}),a.push({label:"Include All Paths",action:()=>{const l=o.graph.edges.filter(i=>i.source===s);for(const i of l){const r=`${i.source}→${i.target}`;if(o.exclusions[r]){const c=[...o.exclusions[r]||[]];for(const u of c)o.includePathTag(r,u)}}}})),a.push({separator:!0}),a.push({label:`Select Branch from "${s}"`,action:()=>o.selectBranch(s)}),a.push({label:`Copy Branch from "${s}"`,action:()=>Xt(o.id,s)}),n.hasContent&&n.mode==="branch"&&a.push({label:`Paste Branch onto "${s}"`,action:async()=>{const l=n.branchRoot!==s?`
Will create edge: ${n.branchRoot} → ${s}`:"";await D("Paste Branch Confirmation",`Paste branch from "${n.branchRoot}" (${n.nodeCount}n, ${n.edgeCount}e)?${l}`,o.panelEl)&&Kt(o.id,s)}}),n.hasContent&&a.push({label:"Cancel Copy",action:()=>Qe()}),a}function os(o,e){const s=e.data("source"),n=e.data("target"),t=`${s}→${n}`,a=o.cy.$(":selected").length,l=[{label:`Edit Edge "${s} -> ${n}"`,action:()=>{o.cy.elements().unselect(),e.select(),Ue(o)}},{label:`Delete Edge "${s} -> ${n}"`,action:()=>{o.cy.elements().unselect(),e.select(),o.deleteSelected((i,r)=>D(i,r,o.panelEl))}}];if(a>1&&(l.push({separator:!0}),l.push({label:`Delete all selected (${a})`,action:()=>o.deleteSelected((i,r)=>D(i,r,o.panelEl))})),o.pathTrackingEnabled&&o._pathTags){const i=o.template?.specialTypes||[],r=o._pathTags.get(t)||[],c=o._effectiveExclusions?.get(t)||new Set,u=new Set(o.exclusions[t]||[]);if(r.length>0){l.push({separator:!0});const d=h=>q(h,i),p=h=>j(h,i,o.template?.nodeTypes||[]);if(r.length<=6)for(const h of r){const f=d(h),v=u.has(f),k=c.has(f)&&!v,x=p(h);v?l.push({label:`Include ${x}`,action:()=>o.includePathTag(t,f)}):k?l.push({label:`Excluded ${x} (inherited)`,action:()=>Le(o,t)}):l.push({label:`Exclude ${x}`,action:()=>o.excludePathTag(t,f)})}else l.push({label:"Exclusions...",action:()=>Le(o,t)})}}return l}function as(o){o.container.addEventListener("contextmenu",t=>t.preventDefault());const e=t=>{if(t.target!==o.cy)return;const a=ve(t);be(a.x,a.y,ss(o))};o.cy.on("cxttap",e),o.cy.on("taphold",e);const s=t=>{const a=t.target;if(a.hasClass("diff-removed"))return;const l=ve(t);be(l.x,l.y,ns(o,a))};o.cy.on("cxttap","node",s),o.cy.on("taphold","node",s);const n=t=>{const a=t.target;if(a.hasClass("diff-removed"))return;const l=ve(t);be(l.x,l.y,os(o,a))};o.cy.on("cxttap","edge",n),o.cy.on("taphold","edge",n)}ke.use(at);const A=new Map;function is(o){for(const e of A.values())e.setTemplate(o)}const O=new Ot(document.getElementById("app"),{onPanelCreate(o,e){const s=Ut(),n=new wt(o,e,s);A.set(o,n),as(n)},onPanelDestroy(o){const e=A.get(o);e&&(e.cy.destroy(),A.delete(o))},async onMerge(o,e){const s=A.get(o),n=A.get(e);if(!s||!n)return;const t=`${o}→${e}`,a=O._getStrategy(t),l=a.strategy,i=a.scopeNodes||[];if(l==="none")return;if(s.baseGraph&&!s.isClean()){await He("Merge Blocked",`Panel ${o} has unapproved changes. Approve Panel ${o} first, then merge.`,document.querySelector(`.panel[data-panel-id="${e}"]`));return}const r=`${o} → ${e}`,c=n.receiveMerge(s.getGraph(),r,s.exclusions,s.pathTrackingEnabled,l,i);c.ok?y(`Pushed ${r}`,"success"):y(c.error,"error")},getState(o){const e=A.get(o);return e?e.getState():null},setState(o,e){const s=A.get(o);s&&s.setState(e)},async confirmClose(o){return await D("Close Panel?",`Close Panel ${o}? Graph data will be lost.`,document.querySelector(`.panel[data-panel-id="${o}"]`))},getPanels(){return A},onResizeEnd(o){const e=O._allPanelIds(o.children[0]),s=O._allPanelIds(o.children[1]);for(const n of[...e,...s]){const t=A.get(n);t&&t.cy&&(t.cy.resize(),t.cy.fit())}}});document.getElementById("app").addEventListener("click",async o=>{const e=o.target.closest("[data-action]");if(!e)return;const s=e.closest(".panel");if(!s)return;const n=s.dataset.panelId,t=A.get(n);if(t)switch(e.dataset.action){case"add-node":Re(t);break;case"add-edge":Fe(t);break;case"clear":{await D("Clear Panel?",`Reset Panel ${n} to empty state? This clears the graph, approval history, and all diffs.`,s)&&t.clearGraph();break}case"approve":{await D("Approve Panel?",`This will set the current state of Panel ${n} as the baseline and clear all diffs.`,s)&&t.approve();break}case"undo":t.undo();break;case"redo":t.redo();break;case"changeset":At(t);break;case"changelog":Nt(t);break;case"refresh":t.cy.resize(),t._runLayout(),t._recomputePathTracking();break;case"restore":{await D("Restore Panel?",`Restore Panel ${n} to last approved state? Current changes will be lost.`,s)&&t.restoreFromApproved();break}case"import":Pt(t);break;case"export":t.exportGraph();break;case"panel-options":Lt(t);break}});O.init();Yt(A,O,o=>{is(o)});Vt(()=>A);Bt();requestAnimationFrame(()=>O.updateMergeButtonStates(A));document.addEventListener("keydown",async o=>{if(o.key==="Escape"&&O._zoomedPanelId){O.toggleZoom(O._zoomedPanelId);return}if((o.ctrlKey||o.metaKey)&&o.key==="z"&&!o.shiftKey){o.preventDefault();const e=Array.from(A.values()).find(s=>s.cy.container()===document.activeElement||s.cy.container().contains(document.activeElement));e?e.undo():A.size>0&&A.values().next().value.undo()}if((o.ctrlKey||o.metaKey)&&o.key==="z"&&o.shiftKey){o.preventDefault();const e=Array.from(A.values()).find(s=>s.cy.container()===document.activeElement||s.cy.container().contains(document.activeElement));e?e.redo():A.size>0&&A.values().next().value.redo()}});const ls=()=>O.updateMergeButtonStates(A);window.addEventListener("panel-change",ls);window.__panels=A;window.__layout=O;
