import{r as Qe,g as et,c as _e}from"./vendor-Cd8GHXwj.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();var tt=Qe();const st=et(tt),J={UCG:{label:"Undirected Cyclic Graph",directed:!1,acyclic:!1},UTree:{label:"Undirected Tree",directed:!1,acyclic:!0,mustBeConnected:!0},DAG:{label:"Directed Acyclic Graph",directed:!0,acyclic:!0},DG:{label:"Directed Graph",directed:!0,acyclic:!1},Forest:{label:"Forest",directed:!1,acyclic:!0}},ee=()=>({name:"Default",graphType:"UCG",nodeTypes:[],edgeTypes:[],specialTypes:[]}),nt=(n,e="UCG")=>({name:n,graphType:e,nodeTypes:[],edgeTypes:[],specialTypes:[]}),Me=[{selector:"node",style:{label:"data(label)","background-color":"#4fc3f7",color:"#e0e0e0","text-valign":"center","text-halign":"center","font-size":"12px",width:40,height:40,"border-width":2,"border-color":"#2a3a5c","text-outline-width":2,"text-outline-color":"#1a1a2e"}},{selector:"edge",style:{width:2,"line-color":"#5a6a8c","target-arrow-color":"#5a6a8c","target-arrow-shape":"triangle","curve-style":"bezier","arrow-scale":.8}},{selector:"node:selected",style:{"border-color":"#fff","border-width":3}},{selector:"edge:selected",style:{"line-color":"#fff","target-arrow-color":"#fff",width:3}},{selector:".edge-excluded",style:{"line-style":"dashed","line-dash-pattern":[6,3]}},{selector:".edge-all-excluded",style:{"line-style":"dotted","line-dash-pattern":[2,4],opacity:.4}},{selector:".node-fully-excluded",style:{"border-style":"dotted","border-width":3,opacity:.5}},{selector:".tracking-hidden",style:{display:"none"}},{selector:".diff-added",style:{"background-color":"#4CAF50","border-color":"#4CAF50","line-color":"#4CAF50","target-arrow-color":"#4CAF50"}},{selector:".diff-removed",style:{"background-color":"#F44336","border-color":"#F44336","line-color":"#F44336","target-arrow-color":"#F44336",opacity:.5,"border-style":"dashed","line-style":"dashed"}},{selector:".diff-modified",style:{"border-color":"#FF9800","border-width":3,"line-color":"#FF9800","target-arrow-color":"#FF9800"}}];function $e(n){const e=[...Me],t=J[n?.graphType];t&&!t.directed&&e.push({selector:"edge",style:{"target-arrow-shape":"none"}});for(const s of n?.nodeTypes||[])e.push({selector:`node[type = "${s.id}"]`,style:{"background-color":s.color}});for(const s of n?.edgeTypes||[])e.push({selector:`edge[type = "${s.id}"]`,style:{"line-color":s.color,"target-arrow-color":s.color}});return e}const S=n=>JSON.parse(JSON.stringify(n)),me=()=>({nodes:[],edges:[]}),Y=n=>n.label,X=n=>`${n.source}→${n.target}`,ot=(n,e,t={},s=null)=>({source:n,target:e,type:s,props:{...t}}),we=n=>n.nodes.length===0&&n.edges.length===0,Oe=(n,e)=>{const t=new Set,s=[e];for(;s.length>0;){const o=s.shift();if(!t.has(o)){t.add(o);for(const a of n.edges)a.target===o&&!t.has(a.source)&&s.push(a.source)}}return{nodes:n.nodes.filter(o=>t.has(o.label)).map(o=>S(o)),edges:n.edges.filter(o=>t.has(o.source)&&t.has(o.target)).map(o=>S(o))}};function R(n,e){if(!n)return[];const t=[],s=new Map(n.nodes.map(i=>[Y(i),i])),o=new Map(e.nodes.map(i=>[Y(i),i])),a=new Map(n.edges.map(i=>[X(i),i])),l=new Map(e.edges.map(i=>[X(i),i]));for(const[i,c]of o)if(!s.has(i))t.push({type:"node",action:"added",key:i,oldProps:null,newProps:c.props});else{const r=s.get(i);Te(r.props,c.props)||t.push({type:"node",action:"modified",key:i,oldProps:r.props,newProps:c.props})}for(const[i,c]of s)o.has(i)||t.push({type:"node",action:"removed",key:i,oldProps:c.props,newProps:null});for(const[i,c]of l)if(!a.has(i))t.push({type:"edge",action:"added",key:i,oldProps:null,newProps:c.props});else{const r=a.get(i);Te(r.props,c.props)||t.push({type:"edge",action:"modified",key:i,oldProps:r.props,newProps:c.props})}for(const[i,c]of a)l.has(i)||t.push({type:"edge",action:"removed",key:i,oldProps:c.props,newProps:null});return t}function Te(n,e){const t=Object.keys(n),s=Object.keys(e);return t.length!==s.length?!1:t.every(o=>n[o]===e[o])}function at(n,e){if(!e||e.length===0)return n;const t=new Set(e),s=[...e];for(;s.length>0;){const o=s.shift();for(const a of n.edges)a.target===o&&!t.has(a.source)&&(t.add(a.source),s.push(a.source))}return{nodes:n.nodes.filter(o=>t.has(o.label)),edges:n.edges.filter(o=>t.has(o.source)&&t.has(o.target))}}function Ee(n,e,t=null){const s=new Map(n.nodes.map(a=>[Y(a),S(a)])),o=new Map(n.edges.map(a=>[X(a),S(a)]));for(const a of e.nodes){const l=Y(a);s.has(l)?s.get(l).props={...a.props}:s.set(l,S(a))}for(const a of e.edges){const l=X(a);o.has(l)?o.get(l).props={...a.props}:o.set(l,S(a))}if(t){const a=new Set(e.nodes.map(c=>Y(c))),l=new Set(e.edges.map(c=>X(c)));for(const c of t.nodes){const r=Y(c);a.has(r)||s.delete(r)}for(const c of t.edges){const r=X(c);l.has(r)||o.delete(r)}const i=new Set(s.keys());for(const[c,r]of o)(!i.has(r.source)||!i.has(r.target))&&o.delete(c)}return{nodes:[...s.values()],edges:[...o.values()]}}function it(n){if(!n||typeof n!="object")return{ok:!1,error:"Invalid data: expected an object"};if(!Array.isArray(n.nodes))return{ok:!1,error:"Invalid data: missing nodes array"};if(!Array.isArray(n.edges))return{ok:!1,error:"Invalid data: missing edges array"};const e=new Set;for(const s of n.nodes){if(!s.label||typeof s.label!="string")return{ok:!1,error:"Invalid node: missing or invalid label"};if(e.has(s.label))return{ok:!1,error:`Duplicate node label: "${s.label}"`};if(e.add(s.label),s.props&&typeof s.props!="object")return{ok:!1,error:`Invalid props on node "${s.label}"`}}for(const s of n.edges){if(!s.source||!s.target)return{ok:!1,error:"Invalid edge: missing source or target"};if(!e.has(s.source))return{ok:!1,error:`Edge references unknown source: "${s.source}"`};if(!e.has(s.target))return{ok:!1,error:`Edge references unknown target: "${s.target}"`};if(s.props&&typeof s.props!="object")return{ok:!1,error:`Invalid props on edge "${s.source}→${s.target}"`}}return{ok:!0,graph:{nodes:n.nodes.map(s=>({label:s.label,type:s.type||null,props:s.props||{}})),edges:n.edges.map(s=>({source:s.source,target:s.target,type:s.type||null,props:s.props||{}}))}}}const lt=n=>JSON.stringify(n,null,2);function rt(n){try{const e=JSON.parse(n);return it(e)}catch(e){return{ok:!1,error:`Invalid JSON: ${e.message}`}}}function ct(n,e="graph.json"){const t=new Blob([lt(n)],{type:"application/json"}),s=URL.createObjectURL(t),o=document.createElement("a");o.href=s,o.download=e,o.click(),URL.revokeObjectURL(s)}function dt(){return new Promise(n=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async()=>{const t=e.files[0];if(!t)return n({ok:!1,error:"No file selected"});try{const s=await t.text();n(rt(s))}catch(s){n({ok:!1,error:`Failed to read file: ${s.message}`})}},e.click()})}function m(n,e="info",t=3e3){const s=document.getElementById("toast-container"),o=document.createElement("div");o.className=`toast toast-${e}`,o.textContent=n,s.appendChild(o),setTimeout(()=>{o.style.opacity="0",o.style.transition="opacity 0.3s",setTimeout(()=>o.remove(),300)},t)}function pt(n,e,t){const s=new Set,o=[t];for(;o.length>0;){const a=o.shift();if(a===e)return!0;if(!s.has(a)){s.add(a);for(const l of n.edges)l.source===a&&!s.has(l.target)&&o.push(l.target)}}return!1}function ut(n,e,t){const s=new Set,o=[e];for(;o.length>0;){const a=o.shift();if(a===t)return!0;if(!s.has(a)){s.add(a);for(const l of n.edges)l.source===a&&!s.has(l.target)&&o.push(l.target),l.target===a&&!s.has(l.source)&&o.push(l.source)}}return!1}function ht(n,e,t,s){return s?pt(n,e,t):ut(n,e,t)}function Ie(n){if(n.nodes.length===0)return!0;const e=new Set,t=[n.nodes[0].label];for(;t.length>0;){const s=t.shift();if(!e.has(s)){e.add(s);for(const o of n.edges)o.source===s&&!e.has(o.target)&&t.push(o.target),o.target===s&&!e.has(o.source)&&t.push(o.source)}}return e.size===n.nodes.length}function gt(n,e){const t={nodes:n.nodes.filter(s=>s.label!==e),edges:n.edges.filter(s=>s.source!==e&&s.target!==e)};return t.nodes.length>1&&!Ie(t)}function ft(n,e,t){const s={nodes:[...n.nodes],edges:n.edges.filter(o=>!(o.source===e&&o.target===t))};return!Ie(s)}function yt(n,e,t){return n.edges.some(s=>s.source===e&&s.target===t||s.source===t&&s.target===e)}function mt(n,e,t,s){const o=J[s];return o?e===t?{ok:!1,error:"Self-loops are not allowed"}:!o.directed&&yt(n,e,t)?{ok:!1,error:`Edge ${e}–${t} already exists`}:o.directed&&n.edges.some(a=>a.source===e&&a.target===t)?{ok:!1,error:`Edge ${e}→${t} already exists`}:o.acyclic&&ht(n,e,t,o.directed)?{ok:!1,error:`Adding this edge would create a cycle (${o.label} must be acyclic)`}:{ok:!0}:{ok:!0}}function bt(n,e){if(e){const t=new Set,s=new Set,o=a=>{t.add(a),s.add(a);for(const l of n.edges)if(l.source===a&&(s.has(l.target)||!t.has(l.target)&&o(l.target)))return!0;return s.delete(a),!1};for(const a of n.nodes)if(!t.has(a.label)&&o(a.label))return!0;return!1}else{const t={};for(const o of n.nodes)t[o.label]=o.label;const s=o=>(t[o]!==o&&(t[o]=s(t[o])),t[o]);for(const o of n.edges){const a=s(o.source),l=s(o.target);if(a===l)return!0;t[a]=l}return!1}}function vt(n){const e=new Map,t=new Map;for(const i of n.nodes)e.set(i.label,[]),t.set(i.label,0);for(const i of n.edges){const c=e.get(i.source);c&&c.push(i.target),t.set(i.target,(t.get(i.target)||0)+1)}const s=new Map;for(const i of n.nodes)s.set(i.label,0);for(const i of n.edges)s.set(i.source,(s.get(i.source)||0)+1);const o=[];for(const i of n.nodes)s.get(i.label)===0&&o.push(i.label);const a=[],l=new Set;for(;o.length>0;){const i=o.shift();if(!l.has(i)){l.add(i),a.push(i);for(const c of n.edges)if(c.target===i){const r=c.source;s.set(r,(s.get(r)||1)-1),s.get(r)===0&&o.push(r)}}}for(const i of n.nodes)l.has(i.label)||a.push(i.label);return a}function xt(n,e){if(!e||e.length===0)return new Map;const t=new Map(n.nodes.map(i=>[i.label,i])),s=new Map(n.nodes.map(i=>[i.label,[]]));for(const i of n.edges){const c=s.get(i.source);c&&c.push(i.target)}const o=vt(n),a=new Map;for(const i of o){const c=t.get(i);if(!c)continue;const r=s.get(i)||[];let d;if(r.length===0)c.type&&e.includes(c.type)?d=[{[c.type]:i}]:d=[{}];else{d=[];for(const u of r){const h=a.get(u)||[{}];d.push(...h)}const p=new Set;d=d.filter(u=>{const h=A(u,e);return p.has(h)?!1:(p.add(h),!0)}),c.type&&e.includes(c.type)&&(d=d.map(u=>({...u,[c.type]:i})))}a.set(i,d)}const l=new Map;for(const i of n.edges){const c=`${i.source}→${i.target}`;l.set(c,a.get(i.target)||[{}])}return l}function Ce(n,e,t,s=[]){const o=new Map;for(const[c,r]of Object.entries(e)){const d=Array.isArray(r)?new Set(r):new Set(Object.keys(r).length?[r]:[]);d.size>0&&o.set(c,d)}if(!t||t.size===0)return o;const a=new Map;for(const c of n.nodes)a.set(c.label,[]);for(const c of n.edges){const r=a.get(c.target);r&&r.push(c.source)}const l=[];for(const[c,r]of o){const[d]=c.split("→");l.push({target:d,tags:new Set(r)})}const i=new Set;for(;l.length>0;){const{target:c,tags:r}=l.shift(),d=`${c}:${[...r].sort().join(",")}`;if(!i.has(d)){i.add(d);for(const p of a.get(c)||[]){const u=`${p}→${c}`,h=t.get(u);if(!h)continue;const g=new Set(h.map(y=>A(y,s))),f=new Set([...r].filter(y=>g.has(y)));if(f.size>0){const y=o.get(u)||new Set,b=new Set([...y,...f]);o.set(u,b),l.push({target:p,tags:f})}}}}return o}function St(n,e,t,s,o=[]){const a=n.edges.filter(l=>l.source===e);if(a.length===0)return!1;for(const l of a){const i=`${l.source}→${l.target}`,c=t.get(i)||[],r=s.get(i)||new Set;for(const d of c){const p=A(d,o);if(!r.has(p))return!1}}return!0}function ce(n,e,t){if(!t||!e)return{...n};const s={...n};for(const[o,a]of Object.entries(e))if(s[o]){const l=new Set([...s[o],...a]);s[o]=[...l]}else s[o]=[...a];return s}function j(n,e,t){const s=[];for(const o of e)n[o]&&s.push(n[o]);return s.length===0?"(any)":`(${s.join(", ")})`}function A(n,e){return e.map(t=>n[t]||"").join("|")}function Pe(n){const e={an:0,mn:0,rn:0,ae:0,me:0,re:0};for(const s of n){const o=s.type==="node";s.action==="added"?o?e.an++:e.ae++:s.action==="modified"?o?e.mn++:e.me++:s.action==="removed"&&(o?e.rn++:e.re++)}const t=[];return e.an&&t.push(`+${e.an}n`),e.mn&&t.push(`~${e.mn}n`),e.rn&&t.push(`-${e.rn}n`),e.ae&&t.push(`+${e.ae}e`),e.me&&t.push(`~${e.me}e`),e.re&&t.push(`-${e.re}e`),t.join(" ")}function ze(n){if(n.length===0)return"No changes.";const e={addedNodes:[],removedNodes:[],modifiedNodes:[],addedEdges:[],removedEdges:[],modifiedEdges:[]};for(const s of n)s.type==="node"?s.action==="added"?e.addedNodes.push(s.key):s.action==="removed"?e.removedNodes.push(s.key):s.action==="modified"&&e.modifiedNodes.push({key:s.key,changes:s.changes}):s.action==="added"?e.addedEdges.push(s.key):s.action==="removed"?e.removedEdges.push(s.key):s.action==="modified"&&e.modifiedEdges.push({key:s.key,changes:s.changes});const t=[];if(e.addedNodes.length){const s=e.addedNodes.length;t.push(`Added ${s} node${s>1?"s":""}: ${e.addedNodes.join(", ")}`)}if(e.removedNodes.length){const s=e.removedNodes.length;t.push(`Removed ${s} node${s>1?"s":""}: ${e.removedNodes.join(", ")}`)}if(e.modifiedNodes.length){const s=e.modifiedNodes.map(({key:a,changes:l})=>{const i=l&&l.length?`(${l.map(c=>c.key).join(", ")} changed)`:"";return i?`${a} ${i}`:a}),o=e.modifiedNodes.length;t.push(`Modified ${o} node${o>1?"s":""}: ${s.join(", ")}`)}if(e.addedEdges.length){const s=e.addedEdges.length;t.push(`Added ${s} edge${s>1?"s":""}: ${e.addedEdges.join(", ")}`)}if(e.removedEdges.length){const s=e.removedEdges.length;t.push(`Removed ${s} edge${s>1?"s":""}: ${e.removedEdges.join(", ")}`)}if(e.modifiedEdges.length){const s=e.modifiedEdges.map(({key:a,changes:l})=>{const i=l&&l.length?`(${l.map(c=>c.key).join(", ")} changed)`:"";return i?`${a} ${i}`:a}),o=e.modifiedEdges.length;t.push(`Modified ${o} edge${o>1?"s":""}: ${s.join(", ")}`)}return t.join(". ")+"."}class kt{constructor(e,t,s=null){this.id=e,this.graph=me(),this.baseGraph=null,this.mergeDirection=null,this.lastApproval=null,this.container=t,this.template=s||ee(),this.layoutAlgorithm="fcose",this.pathTrackingEnabled=!1,this.showExclusions=!0,this.exclusions={},this._pathTags=null,this._effectiveExclusions=null,this._history=[],this._redoStack=[],this._maxHistory=10,this._approvalHistory=[],this._maxApprovalHistory=20,this._processingCount=0,this.cy=_e({container:t,elements:[],style:$e(this.template),layout:{name:"grid"},selectionType:"additive"}),this._tooltip=null,this._trackingOverlay=null,this.cy.on("mouseover","edge",o=>{const l=o.target.data("pathTagsTooltip");!l||!this.pathTrackingEnabled||this._showTooltip(o.originalEvent,l)}),this.cy.on("mouseout","edge",()=>this._hideTooltip()),this.cy.on("pan zoom",()=>this._hideTooltip()),this._updateHeader()}setTemplate(e){this.template=e,this.cy.style().fromJson($e(e)).update()}get panelEl(){return this.container.closest("[data-panel-id]")}getGraph(){return S(this.graph)}getBaseGraph(){return this.baseGraph?S(this.baseGraph):null}getState(){return{id:this.id,graph:S(this.graph),baseGraph:this.baseGraph?S(this.baseGraph):null,mergeDirection:this.mergeDirection,lastApproval:this.lastApproval,layoutAlgorithm:this.layoutAlgorithm,pathTrackingEnabled:this.pathTrackingEnabled,showExclusions:this.showExclusions,exclusions:S(this.exclusions),_history:this._history.map(e=>S(e)),_redoStack:this._redoStack.map(e=>S(e)),_approvalHistory:this._approvalHistory.map(e=>({graph:S(e.graph),baseGraph:e.baseGraph?S(e.baseGraph):null,timestamp:e.timestamp,diffSummary:e.diffSummary,exclusions:S(e.exclusions||{})}))}}setState(e){this.graph=e.graph||me(),this.baseGraph=e.baseGraph||null,this.mergeDirection=e.mergeDirection||null,this.lastApproval=e.lastApproval||null,this.layoutAlgorithm=e.layoutAlgorithm||"fcose",this.pathTrackingEnabled=e.pathTrackingEnabled||!1,this.showExclusions=e.showExclusions??!0,this.exclusions=S(e.exclusions||{}),this._history=e._history?e._history.map(t=>S(t)):[],this._redoStack=e._redoStack?e._redoStack.map(t=>S(t)):[],this._approvalHistory=e._approvalHistory?e._approvalHistory.map(t=>({graph:S(t.graph),baseGraph:t.baseGraph?S(t.baseGraph):null,timestamp:t.timestamp,diffSummary:t.diffSummary,exclusions:S(t.exclusions||{})})):[],this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader()}loadGraph(e){this.graph=S(e),this._syncCytoscape(),this._applyDiffClasses(),this._updateHeader(),this._emitChange()}addNode(e,t={},s=null){return this.graph.nodes.some(o=>o.label===e)?(m(`Node "${e}" already exists`,"error"),!1):(this._pushHistory(),this.graph={nodes:[...this.graph.nodes,{label:e,type:s,props:{...t}}],edges:[...this.graph.edges]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),!0)}addEdge(e,t,s={},o=null){if(!this.graph.nodes.some(i=>i.label===e))return m(`Source node "${e}" not found`,"error"),!1;if(!this.graph.nodes.some(i=>i.label===t))return m(`Target node "${t}" not found`,"error"),!1;const a=this.template?.graphType||"DG",l=mt(this.graph,e,t,a);return l.ok?(this._pushHistory(),this.graph={nodes:[...this.graph.nodes],edges:[...this.graph.edges,{source:e,target:t,type:o,props:{...s}}]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),!0):(m(l.error,"error"),!1)}updateNodeProps(e,t,s=void 0){this._pushHistory(),this.graph={nodes:this.graph.nodes.map(o=>o.label!==e?o:s!==void 0?{...o,props:{...t},type:s}:{...o,props:{...t}}),edges:[...this.graph.edges]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}updateEdgeProps(e,t,s,o=void 0){this._pushHistory(),this.graph={nodes:[...this.graph.nodes],edges:this.graph.edges.map(a=>a.source===e&&a.target===t?o!==void 0?{...a,props:{...s},type:o}:{...a,props:{...s}}:a)},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}async deleteSelected(e=null){const t=this.cy.$(":selected");if(t.empty()){m("Nothing selected","info");return}const s=this.template?.graphType||"DG",o=J[s],a=new Set;t.nodes().forEach(r=>a.add(r.data("label")));const l=new Set;if(t.edges().forEach(r=>l.add(`${r.data("source")}→${r.data("target")}`)),o?.mustBeConnected&&e){let r=!1;for(const d of a)if(gt(this.graph,d)){r=!0;break}if(!r)for(const d of l){const[p,u]=d.split("→");if(ft(this.graph,p,u)){r=!0;break}}if(r&&!await e("Disconnect Warning","Deleting this would disconnect the tree. Proceed anyway?"))return}this._pushHistory();const i=new Set([...l]);this.graph.edges.forEach(r=>{(a.has(r.source)||a.has(r.target))&&i.add(`${r.source}→${r.target}`)}),this.graph={nodes:this.graph.nodes.filter(r=>!a.has(r.label)),edges:this.graph.edges.filter(r=>!(l.has(`${r.source}→${r.target}`)||a.has(r.source)||a.has(r.target)))};const c={...this.exclusions};for(const r of i)delete c[r];this.exclusions=c,this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}clearGraph(){this._pushHistory(),this.graph=me(),this.baseGraph=null,this.mergeDirection=null,this.lastApproval=null,this.exclusions={},this._approvalHistory=[],this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}approve(){let e="(initial)";if(this.baseGraph){const t=R(this.baseGraph,this.graph);e=t.length>0?Pe(t):"(no changes)"}this._approvalHistory.push({graph:S(this.graph),baseGraph:this.baseGraph?S(this.baseGraph):null,timestamp:new Date().toISOString(),diffSummary:e,exclusions:S(this.exclusions)}),this._approvalHistory.length>this._maxApprovalHistory&&this._approvalHistory.shift(),this.baseGraph=S(this.graph),this.mergeDirection=null,this.lastApproval=new Date().toISOString(),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._clearDiffClasses(),this._updateHeader(),this._emitChange(),m(`Panel ${this.id} approved`,"success")}receiveMerge(e,t,s=null,o=!1,a="mirror",l=[]){if(we(this.graph)&&!this.baseGraph)return this.graph=S(e),this.baseGraph=S(e),this.lastApproval=new Date().toISOString(),this.mergeDirection=null,s&&(this.exclusions=ce(this.exclusions,s,o)),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),{ok:!0};this._pushHistory();const i=a==="scoped"&&l.length>0?at(e,l):e,c=a==="push"||a==="sync"?null:this.baseGraph;this.graph=Ee(this.graph,i,c),this.mergeDirection=t,s&&(this.exclusions=ce(this.exclusions,s,o)),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange();const r=J[this.template?.graphType];return r?.acyclic&&bt(this.graph,r.directed)&&m(`Warning: merge introduced a cycle in ${r.label}`,"warning"),{ok:!0}}pasteSubgraph(e,t,s=null,o=!1){return we(this.graph)&&!this.baseGraph?(this.graph=S(e),this.baseGraph=S(e),this.lastApproval=new Date().toISOString(),this.mergeDirection=null,s&&(this.exclusions=ce(this.exclusions,s,o)),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()):(this._pushHistory(),this.graph=Ee(this.graph,e,null),this.mergeDirection=t,s&&(this.exclusions=ce(this.exclusions,s,o)),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()),{ok:!0}}selectBranch(e){const t=Oe(this.graph,e);this.cy.elements().unselect();for(const s of t.nodes)this.cy.$id(s.label).select();for(const s of t.edges)this.cy.$id(`${s.source}→${s.target}`).select()}exportGraph(){ct(this.graph,`panel-${this.id}.json`)}undo(){if(this._history.length===0)return m("Nothing to undo","info"),!1;this._redoStack.push({graph:S(this.graph),exclusions:S(this.exclusions)});const e=this._history.pop();return this.graph=this._historyGraph(e),this.exclusions=this._historyExclusions(e),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),m("Undo","info"),!0}redo(){if(this._redoStack.length===0)return m("Nothing to redo","info"),!1;this._history.push({graph:S(this.graph),exclusions:S(this.exclusions)}),this._history.length>this._maxHistory&&this._history.shift();const e=this._redoStack.pop();return this.graph=this._historyGraph(e),this.exclusions=this._historyExclusions(e),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),m("Redo","info"),!0}restoreFromApproved(){if(!this.baseGraph)return m("No approved state to restore","info"),!1;this._pushHistory(),this.graph=S(this.baseGraph);const e=this._approvalHistory[this._approvalHistory.length-1];return this.exclusions=e?.exclusions?S(e.exclusions):{},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),m(`Panel ${this.id} restored to approved state`,"success"),!0}getSelectedSubgraph(){const e=this.cy.$(":selected");if(e.empty())return null;const t=new Set,s=[];e.nodes().forEach(a=>{t.add(a.data("label"));const l=this.graph.nodes.find(i=>i.label===a.data("label"));l&&s.push(S(l))});const o=[];return e.edges().forEach(a=>{const l=a.data("source"),i=a.data("target");if(t.has(l)&&t.has(i)){const c=this.graph.edges.find(r=>r.source===l&&r.target===i);c&&o.push(S(c))}}),{nodes:s,edges:o}}isClean(){return this.baseGraph?R(this.baseGraph,this.graph).length===0:!0}_pushHistory(){this._history.push({graph:S(this.graph),exclusions:S(this.exclusions)}),this._history.length>this._maxHistory&&this._history.shift(),this._redoStack=[]}_historyGraph(e){return e&&e.graph?e.graph:e}_historyExclusions(e){return e&&e.exclusions?e.exclusions:{}}_syncCytoscape(){const e=[];for(const t of this.graph.nodes)e.push({group:"nodes",data:{id:t.label,label:t.label,type:t.type||null,...this._flattenProps(t.props,"p_")}});for(const t of this.graph.edges)e.push({group:"edges",data:{id:`${t.source}→${t.target}`,source:t.source,target:t.target,type:t.type||null,...this._flattenProps(t.props,"p_")}});if(this.baseGraph){const t=new Set(this.graph.nodes.map(o=>o.label)),s=new Set(this.graph.edges.map(o=>`${o.source}→${o.target}`));for(const o of this.baseGraph.nodes)t.has(o.label)||e.push({group:"nodes",data:{id:o.label,label:o.label},classes:"diff-removed"});for(const o of this.baseGraph.edges){const a=`${o.source}→${o.target}`;if(!s.has(a)){const l=new Set([...t,...this.baseGraph.nodes.map(i=>i.label)]);l.has(o.source)&&l.has(o.target)&&e.push({group:"edges",data:{id:a,source:o.source,target:o.target},classes:"diff-removed"})}}}this.cy.elements().remove(),this.cy.add(e),this._runLayout()}_applyDiffClasses(){if(!this.baseGraph)return;const e=R(this.baseGraph,this.graph);this.cy.elements().removeClass("diff-added diff-modified");for(const t of e){if(t.action==="removed")continue;const s=(t.type==="node",t.key),o=this.cy.$id(s);o.length&&o.addClass(`diff-${t.action}`)}this._updateDiffOverlay()}_clearDiffClasses(){this.cy.elements().removeClass("diff-added diff-removed diff-modified"),this.cy.$(".diff-removed").remove(),this._updateDiffOverlay()}_updateHeader(){const e=this.panelEl?.querySelector(".panel-info");if(!e)return;const t=[];if(this.mergeDirection&&t.push(`<span class="merge-direction">${this.mergeDirection}</span>`),this.baseGraph&&!this.isClean()){const s=R(this.baseGraph,this.graph).length;t.push(`${s} change${s!==1?"s":""}`)}e.innerHTML=t.join(" · "),this._updateApprovalOverlay()}_updateApprovalOverlay(){let e=this.container.querySelector(".approval-indicator");if(e||(e=document.createElement("div"),e.className="approval-indicator",this.container.appendChild(e)),this.lastApproval){const t=new Date(this.lastApproval).toLocaleTimeString();e.textContent=`✓ ${t}`}else e.textContent=""}_flattenProps(e,t){const s={};for(const[o,a]of Object.entries(e))s[`${t}${o}`]=a;return s}setLayoutAlgorithm(e){this.layoutAlgorithm=e,this._runLayout(),this._emitChange()}_runLayout(){if(this.cy.elements().length===0)return;const e=this.layoutAlgorithm||"fcose";if(e==="level-by-level"){this._runLevelLayout();return}this.cy.layout({name:this.cy.nodes().length>1?e:"grid",animate:!1,fit:!0,padding:20}).run()}_runLevelLayout(){const e=this.cy.nodes();if(e.length===0)return;const t=e.filter(d=>d.outgoers("edge").length===0),s=t.length>0?t:e,o=new Map,a=[];for(s.forEach(d=>{o.set(d.id(),0),a.push(d.id())});a.length>0;){const d=a.shift(),p=o.get(d);this.cy.$id(d).incomers("edge").forEach(u=>{const h=u.source().id();(!o.has(h)||o.get(h)<p+1)&&(o.set(h,p+1),a.push(h))})}e.forEach(d=>{o.has(d.id())||o.set(d.id(),0)});const l=new Map;for(const[d,p]of o)l.has(p)||l.set(p,[]),l.get(p).push(d);const i=80,c=80,r={};for(const[d,p]of l){const u=d*i,g=-((p.length-1)*c)/2;p.forEach((f,y)=>{r[f]={x:g+y*c,y:u}})}this.cy.layout({name:"preset",positions:d=>r[d.id()]||{x:0,y:0},animate:!1,fit:!0,padding:20}).run()}_updateDiffOverlay(){const e=this.container.parentElement?.querySelector(`.diff-overlay[data-panel-diff="${this.id}"]`);if(!e)return;if(!this.baseGraph){e.classList.remove("visible");return}const t=R(this.baseGraph,this.graph);if(t.length===0){e.classList.remove("visible");return}e.textContent=Pe(t),e.classList.add("visible")}setPathTracking(e){this.pathTrackingEnabled=e,e?this._recomputePathTrackingAsync():(this._pathTags=null,this._effectiveExclusions=null,this._clearTrackingVisuals()),this._updateTrackingOverlay(),this._emitChange()}setShowExclusions(e){this.showExclusions=e,this._applyExclusionVisibility(),this._emitChange()}excludePathTag(e,t){this._pushHistory();const s=this.exclusions[e]||[];s.includes(t)||(this.exclusions={...this.exclusions,[e]:[...s,t]}),this._recomputePathTrackingAsync(),this._emitChange()}includePathTag(e,t){this._pushHistory();const o=(this.exclusions[e]||[]).filter(l=>l!==t),a={...this.exclusions};o.length===0?delete a[e]:a[e]=o,this.exclusions=a,this._recomputePathTrackingAsync(),this._emitChange()}getRelevantExclusions(e){const t=new Set(e.edges.map(o=>`${o.source}→${o.target}`)),s={};for(const[o,a]of Object.entries(this.exclusions))t.has(o)&&(s[o]=a);return s}_cleanupStaleExclusions(){if(!this._pathTags)return;const e=this.template?.specialTypes||[],t={};for(const[s,o]of Object.entries(this.exclusions)){const a=this._pathTags.get(s);if(!a||a.length===0)continue;const l=new Set(a.map(c=>A(c,e))),i=o.filter(c=>l.has(c));i.length>0&&(t[s]=i)}this.exclusions=t}_setProcessing(e){this._processingCount=e?this._processingCount+1:Math.max(0,this._processingCount-1),this.panelEl?.classList.toggle("processing",this._processingCount>0)}async _recomputePathTrackingAsync(){if(this.pathTrackingEnabled){this._setProcessing(!0),await new Promise(e=>setTimeout(e,0));try{this._recomputePathTracking()}finally{this._setProcessing(!1)}}}_recomputePathTracking(){if(!this.pathTrackingEnabled)return;const e=this.template?.specialTypes||[];e.length!==0&&(this._pathTags=xt(this.graph,e),this._effectiveExclusions=Ce(this.graph,this.exclusions,this._pathTags,e),this._cleanupStaleExclusions(),this._effectiveExclusions=Ce(this.graph,this.exclusions,this._pathTags,e),this._applyTrackingVisuals(),this._updateTrackingOverlay(),this._flashTrackingIndicator())}_flashTrackingIndicator(){const e=this.panelEl?.querySelector(".panel-info");e&&(e.classList.remove("tracking-flash"),e.offsetWidth,e.classList.add("tracking-flash"),setTimeout(()=>e.classList.remove("tracking-flash"),300))}_applyTrackingVisuals(){if(!this.pathTrackingEnabled||!this._pathTags)return;const e=this.template?.specialTypes||[];this.cy.edges().removeClass("edge-excluded edge-all-excluded"),this.cy.nodes().removeClass("node-fully-excluded");for(const t of this.graph.edges){const s=`${t.source}→${t.target}`,o=this._pathTags.get(s)||[],a=this._effectiveExclusions?.get(s)||new Set,l=this.cy.$id(s);if(l.empty())continue;const i=o.filter(d=>!a.has(A(d,e))),c=o.filter(d=>a.has(A(d,e))),r=[];i.length&&r.push("Included: "+i.map(d=>j(d,e,this.template?.nodeTypes)).join(", ")),c.length&&r.push("Excluded: "+c.map(d=>j(d,e,this.template?.nodeTypes)).join(", ")),l.data("pathTagsTooltip",r.join(`
`)||"(no tags)"),a.size>0&&l.addClass("edge-excluded"),o.length>0&&c.length===o.length&&l.addClass("edge-all-excluded")}for(const t of this.graph.nodes)St(this.graph,t.label,this._pathTags,this._effectiveExclusions||new Map,e)&&this.cy.$id(t.label).addClass("node-fully-excluded");this._applyExclusionVisibility()}_applyExclusionVisibility(){this.pathTrackingEnabled&&(this.showExclusions?this.cy.elements().removeClass("tracking-hidden"):(this.cy.nodes(".node-fully-excluded").addClass("tracking-hidden"),this.cy.edges(".edge-all-excluded").addClass("tracking-hidden")))}_clearTrackingVisuals(){this.cy.elements().removeClass("edge-excluded edge-all-excluded node-fully-excluded tracking-hidden"),this.cy.edges().data("pathTagsTooltip",null),this._removeTrackingOverlay()}_showTooltip(e,t){this._tooltip||(this._tooltip=document.createElement("div"),this._tooltip.className="path-tooltip",this.container.appendChild(this._tooltip)),this._tooltip.textContent=t,this._tooltip.style.display="block";const s=this.container.getBoundingClientRect();this._tooltip.style.left=`${e.clientX-s.left+12}px`,this._tooltip.style.top=`${e.clientY-s.top-8}px`}_hideTooltip(){this._tooltip&&(this._tooltip.style.display="none")}_ensureTrackingOverlay(){if(this._trackingOverlay)return;const e=document.createElement("div");e.className="tracking-overlay",e.innerHTML='<label><input type="checkbox" class="show-exclusions-cb"> Show exclusions</label>',this.container.appendChild(e),e.querySelector(".show-exclusions-cb").addEventListener("change",t=>{this.setShowExclusions(t.target.checked)}),this._trackingOverlay=e}_removeTrackingOverlay(){this._trackingOverlay&&(this._trackingOverlay.remove(),this._trackingOverlay=null)}_updateTrackingOverlay(){if(this.pathTrackingEnabled){this._ensureTrackingOverlay();const e=this._trackingOverlay?.querySelector(".show-exclusions-cb");e&&(e.checked=this.showExclusions)}else this._removeTrackingOverlay()}_emitChange(){window.dispatchEvent(new CustomEvent("panel-change",{detail:{panelId:this.id}}))}}let be=null,ve=null;function _t(n){const e=[];for(const t of n.split(",")){const s=t.trim();if(!s)continue;const o=s.match(/^(.+?)(\d+)-(\d+)$/);if(o){const[,a,l,i]=o,c=parseInt(l,10),r=parseInt(i,10);if(c<=r&&r-c<100){for(let d=c;d<=r;d++)e.push(`${a}${d}`);continue}}e.push(s)}return e}function $t(n,e){const t=s=>{if(s.target.closest("button, input, select, textarea"))return;s.preventDefault();const o=n.getBoundingClientRect(),a=s.clientX-o.left,l=s.clientY-o.top,i=r=>{n.style.position="fixed",n.style.margin="0",n.style.transform="none",n.style.left=`${Math.max(0,r.clientX-a)}px`,n.style.top=`${Math.max(0,r.clientY-l)}px`},c=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",c)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",c)};e.addEventListener("mousedown",t)}let de=null;function je(){return de||(de=document.createElement("dialog"),document.body.appendChild(de)),de}let se=null;function ke(n){n&&n.querySelectorAll(".panel-overlay").forEach(e=>e.remove())}function N(n,e=null){const t=je();if(t.className="",t.innerHTML=n,e){ke(e);const o=document.createElement("div");o.className="panel-overlay",e.insertBefore(o,e.firstChild),se=e;const a=()=>{ke(e),se=null,t.removeEventListener("close",a)};t.addEventListener("close",a),t.className="panel-dialog",t.removeAttribute("style"),t.showModal();const l=e.getBoundingClientRect();t.style.position="fixed",t.style.transform="translate(-50%, -50%)",t.style.margin="0",t.style.left=`${l.left+l.width/2}px`,t.style.top=`${l.top+l.height/2}px`,requestAnimationFrame(()=>{const i=t.offsetWidth,c=t.offsetHeight,r=l.left+l.width/2,d=l.top+l.height/2,p=8;t.style.left=`${Math.max(i/2+p,Math.min(r,window.innerWidth-i/2-p))}px`,t.style.top=`${Math.max(c/2+p,Math.min(d,window.innerHeight-c/2-p))}px`})}else t.removeAttribute("style"),t.style.position="fixed",t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)",t.style.margin="0",t.showModal();const s=t.querySelector(".dialog-header")||t.querySelector("h3");return s&&$t(t,s),t}function w(){const n=je();n.open&&n.close(),n.className="",n.innerHTML="",n.removeAttribute("style"),se&&(ke(se),se=null)}function I(n,e,t=null){return new Promise(s=>{const o=N(`
      <h3>${n}</h3>
      <p>${e}</p>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Confirm</button>
      </div>
    `,t);o.querySelector("#dlg-cancel").onclick=()=>{w(),s(!1)},o.querySelector("#dlg-ok").onclick=()=>{w(),s(!0)}})}function Ge(n,e,t=null){return new Promise(s=>{const o=N(`
      <div class="dialog-header">
        <h3>${n}</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p>${e}</p>
    `,t);o.querySelector("#dlg-close-x").onclick=()=>{w(),s()}})}function wt(n,e=null){return new Promise(t=>{const s=N(`
      <h3>Rename Panel</h3>
      <label>Name</label>
      <input id="dlg-name" type="text" value="${n}" autofocus>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Rename</button>
      </div>
    `,e);s.querySelector("#dlg-cancel").onclick=()=>{w(),t(null)},s.querySelector("#dlg-ok").onclick=()=>{const o=s.querySelector("#dlg-name").value.trim();w(),t(o)},s.querySelector("#dlg-name").onkeydown=o=>{o.key==="Enter"&&s.querySelector("#dlg-ok").click()}})}function Ne(n){return Object.entries(n).map(([e,t])=>`${e}=${t}`).join(`
`)}function ge(n){const e={};for(const t of n.split(`
`)){const s=t.trim();if(!s)continue;const o=s.indexOf("=");if(o===-1)continue;const a=s.slice(0,o).trim(),l=s.slice(o+1).trim();a&&(e[a]=l)}return e}function He(n){const e=n.template,t=e?.nodeTypes?.length>0,s=t&&e.nodeTypes.some(l=>l.id===be)?be:null,o=t?`<label>Type</label>
    <select id="dlg-type">
      ${e.nodeTypes.map(l=>`<option value="${l.id}" ${(s||e.nodeTypes[0]?.id)===l.id?"selected":""}>${l.label}</option>`).join("")}
    </select>`:"",a=N(`
    <h3>Add Node</h3>
    <label>Label</label>
    <input id="dlg-label" type="text" placeholder="Node label (or A,B,C or P1-5)" autofocus>
    ${o}
    <label>Properties (key=value per line)</label>
    <textarea id="dlg-props" placeholder="color=blue&#10;weight=5"></textarea>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `,n.panelEl);a.querySelector("#dlg-cancel").onclick=w,a.querySelector("#dlg-ok").onclick=()=>{const l=a.querySelector("#dlg-label").value,i=_t(l);if(i.length===0){m("Label required","error");return}const c=ge(a.querySelector("#dlg-props").value),r=t&&a.querySelector("#dlg-type").value||null;t&&(be=r);for(const d of i)n.addNode(d,c,r);i.length>1&&m(`Added ${i.length} nodes`,"success"),w()},a.querySelector("#dlg-label").onkeydown=l=>{l.key==="Enter"&&a.querySelector("#dlg-ok").click()}}function Be(n){const e=n.graph.nodes.map(u=>u.label);if(e.length<2){m("Need at least 2 nodes to create an edge","error");return}const t=n.template,s=J[t?.graphType||"DG"],o=s&&!s.directed,a=o?"Node A":"Source",l=o?"Node B":"Target",i=t?.edgeTypes?.length>0,c=i&&t.edgeTypes.some(u=>u.id===ve)?ve:null,r=i?`<label>Type</label>
    <select id="dlg-type">
      ${t.edgeTypes.map(u=>`<option value="${u.id}" ${(c||t.edgeTypes[0]?.id)===u.id?"selected":""}>${u.label}</option>`).join("")}
    </select>`:"",d=e.map(u=>`<option value="${u}">`).join(""),p=N(`
    <h3>Add Edge</h3>
    <datalist id="dlg-node-list">${d}</datalist>
    <label>${a}</label>
    <input id="dlg-source" list="dlg-node-list" placeholder="Start typing..." autocomplete="off">
    <label>${l}</label>
    <input id="dlg-target" list="dlg-node-list" placeholder="Start typing..." autocomplete="off">
    ${r}
    <label>Properties (key=value per line)</label>
    <textarea id="dlg-props" placeholder="weight=1"></textarea>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `,n.panelEl);p.querySelector("#dlg-source").value=e[0],e.length>1&&(p.querySelector("#dlg-target").value=e[1]),p.querySelector("#dlg-cancel").onclick=w,p.querySelector("#dlg-ok").onclick=()=>{const u=p.querySelector("#dlg-source").value.trim(),h=p.querySelector("#dlg-target").value.trim();if(!e.includes(u)){m(`Node "${u}" not found`,"error");return}if(!e.includes(h)){m(`Node "${h}" not found`,"error");return}if(u===h){m("Source and target must differ","error");return}const g=ge(p.querySelector("#dlg-props").value),f=i&&p.querySelector("#dlg-type").value||null;i&&(ve=f),n.addEdge(u,h,g,f),w()}}function Re(n){const e=n.cy.$(":selected");if(e.empty()){m("Nothing selected","info");return}const t=e[0],s=n.template;if(t.isNode()){const o=t.data("label"),a=n.graph.nodes.find(r=>r.label===o);if(!a)return;const l=s?.nodeTypes?.length>0,i=l?`<label>Type</label>
      <select id="dlg-type">
        ${s.nodeTypes.map(r=>`<option value="${r.id}" ${a.type===r.id?"selected":""}>${r.label}</option>`).join("")}
      </select>`:"",c=N(`
      <h3>Edit Node: ${o}</h3>
      ${i}
      <label>Properties (key=value per line)</label>
      <textarea id="dlg-props">${Ne(a.props)}</textarea>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Save</button>
      </div>
    `,n.panelEl);c.querySelector("#dlg-cancel").onclick=w,c.querySelector("#dlg-ok").onclick=()=>{const r=ge(c.querySelector("#dlg-props").value),d=l?c.querySelector("#dlg-type").value||null:void 0;n.updateNodeProps(o,r,d),w()}}else{const o=t.data("source"),a=t.data("target"),l=n.graph.edges.find(b=>b.source===o&&b.target===a);if(!l)return;const i=s?.edgeTypes?.length>0,c=i?`<label>Type</label>
      <select id="dlg-type">
        ${s.edgeTypes.map(b=>`<option value="${b.id}" ${l.type===b.id?"selected":""}>${b.label}</option>`).join("")}
      </select>`:"",r=`${o}→${a}`,d=n.pathTrackingEnabled&&n._pathTags,p=d?n._pathTags.get(r)||[]:[],u=n.template?.specialTypes||[],h=()=>{if(!d||p.length===0)return"";const b=n._effectiveExclusions?.get(r)||new Set,_=p.filter(v=>!b.has(A(v,u))),k=p.filter(v=>b.has(A(v,u))),x=[];return _.length&&x.push("Included: "+_.map(v=>j(v,u,n.template?.nodeTypes||[])).join(", ")),k.length&&x.push("Excluded: "+k.map(v=>j(v,u,n.template?.nodeTypes||[])).join(", ")),x.join(`
`)||"(no active paths)"},g=()=>{if(!d||p.length===0)return"";const b=n._effectiveExclusions?.get(r)||new Set,_=new Set(n.exclusions[r]||[]);return p.map(k=>{const x=A(k,u),v=_.has(x),$=b.has(x)&&!v,E=v||$,C=j(k,u,n.template?.nodeTypes||[]),T=$?"excl-toggle excl-btn-propagated":E?"excl-toggle excl-btn-excluded":"excl-toggle excl-btn-included",z=$?`${C} (inherited from upstream)`:C;return`<button class="${T}" data-tag="${x}" data-propagated="${$}" title="${z}">${C}</button>`}).join("")},f=d&&p.length>0?`
      <div class="template-section-label" style="margin-top:12px">Path Tags</div>
      <pre id="edge-tag-summary" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-size:11px;margin-bottom:8px;white-space:pre-wrap;word-break:break-all">${h()}</pre>
      <div class="template-section-label">Manage Exclusions</div>
      <div id="edge-excl-toggles" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">${g()}</div>
    `:"",y=N(`
      <h3>Edit Edge: ${o} → ${a}</h3>
      ${c}
      <label>Properties (key=value per line)</label>
      <textarea id="dlg-props">${Ne(l.props)}</textarea>
      ${f}
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Save</button>
      </div>
    `,n.panelEl);if(d&&p.length>0){const b=()=>{const _=n._effectiveExclusions?.get(r)||new Set;new Set(n.exclusions[r]||[]);const k=p.filter($=>!_.has(A($,u))),x=p.filter($=>_.has(A($,u))),v=[];k.length&&v.push("Included: "+k.map($=>j($,u,n.template?.nodeTypes||[])).join(", ")),x.length&&v.push("Excluded: "+x.map($=>j($,u,n.template?.nodeTypes||[])).join(", ")),y.querySelector("#edge-tag-summary").textContent=v.join(`
`)||"(no active paths)",y.querySelectorAll("#edge-excl-toggles .excl-toggle").forEach($=>{const E=$.dataset.tag;if($.dataset.propagated==="true")return;const T=(n._effectiveExclusions?.get(r)||new Set).has(E);$.className=T?"excl-toggle excl-btn-excluded":"excl-toggle excl-btn-included"})};y.querySelectorAll("#edge-excl-toggles .excl-toggle").forEach(_=>{_.dataset.propagated!=="true"&&(_.onclick=()=>{const k=_.dataset.tag;(n._effectiveExclusions?.get(r)||new Set).has(k)?n.includePathTag(r,k):n.excludePathTag(r,k),b()})})}y.querySelector("#dlg-cancel").onclick=w,y.querySelector("#dlg-ok").onclick=()=>{const b=ge(y.querySelector("#dlg-props").value),_=i?y.querySelector("#dlg-type").value||null:void 0;n.updateEdgeProps(o,a,b,_),w()}}}async function Tt(n){const e=await dt();if(!e.ok){m(e.error,"error");return}const t=`import → ${n.id}`,s=n.receiveMerge(e.graph,t);s.ok?m("Graph imported","success"):m(s.error,"error")}function Et(n){if(!n.baseGraph){N(`
      <div class="dialog-header">
        <h3>Changeset Summary</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="color: var(--text-muted); text-align: center; padding: 20px;">No baseline — approve first to track changes.</p>
    `,n.panelEl).querySelector("#dlg-close-x").onclick=w;return}const e=R(n.baseGraph,n.graph),t=ze(e);N(`
    <div class="dialog-header">
      <h3>Changeset Summary</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p class="changeset-summary-text">${t}</p>
  `,n.panelEl).querySelector("#dlg-close-x").onclick=w}function Ct(n){const e=n._approvalHistory||[];if(e.length===0){const o=N(`
      <div class="dialog-header">
        <h3>Approval History</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="color: var(--text-muted); text-align: center; padding: 20px;">No approvals yet.</p>
    `,n.panelEl);o.querySelector("#dlg-close-x").onclick=w;return}let t='<div class="changelog-list">';for(let o=e.length-1;o>=0;o--){const a=e[o],i=new Date(a.timestamp).toLocaleTimeString(),c=o+1;t+=`
      <div class="changelog-entry" style="display: flex; align-items: center; justify-content: space-between; padding: 8px;">
        <span style="font-family: 'Courier New', monospace; font-size: 11px;">
          #${c} ${i} <span style="color: var(--text-muted);">${a.diffSummary}</span>
        </span>
        <button class="btn-preview" data-index="${o}" style="font-size: 11px; padding: 4px 8px;">Preview</button>
      </div>
    `}t+="</div>";const s=N(`
    <div class="dialog-header">
      <h3>Approval History</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    ${t}
  `,n.panelEl);s.querySelectorAll(".btn-preview").forEach(o=>{o.onclick=()=>{const a=parseInt(o.dataset.index),l=e[a];w(),Pt(l,a,n)}}),s.querySelector("#dlg-close-x").onclick=w}function Pt(n,e,t){const s=t.panelEl,o=n.baseGraph!==null&&n.baseGraph!==void 0,a=`Approval #${e+1} — ${new Date(n.timestamp).toLocaleTimeString()}`,i=N(`
    <div class="preview-header">
      <h3 style="margin:0">${a}</h3>
      <div style="display:flex;gap:4px;align-items:center">
        <button id="preview-maximize" class="btn-icon" title="Maximize/minimize preview">&#x2922;</button>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
    </div>
    <div class="preview-canvas" id="preview-canvas"></div>
    <div class="preview-info-panel" id="preview-info-panel"></div>
    <div class="preview-footer">
      <button id="preview-info" class="btn-icon" title="Show grouped changeset summary for this approval">&#x24D8;</button>
      <div class="preview-toggle">
        <button id="toggle-approved" class="preview-toggle-btn active">Approved State</button>
        <button id="toggle-changeset" class="preview-toggle-btn" ${o?"":'disabled title="No baseline available for this entry"'}>Changeset View</button>
      </div>
    </div>
  `,s);i.style.minWidth="420px",i.style.minHeight="380px",i.style.maxWidth="80vw",i.style.maxHeight="80vh";const c=i.querySelector("#preview-canvas"),r=i.querySelector("#preview-info-panel");let d=!1;i.querySelector("#preview-maximize").onclick=()=>{d=!d,d?(i.style.position="fixed",i.style.left="20px",i.style.top="20px",i.style.transform="none",i.style.margin="0",i.style.width="calc(100vw - 40px)",i.style.height="calc(100vh - 40px)",i.style.maxWidth="none",i.style.maxHeight="none"):(i.style.position="",i.style.left="",i.style.top="",i.style.transform="",i.style.margin="",i.style.width="",i.style.height="",i.style.maxWidth="80vw",i.style.maxHeight="80vh"),r.classList.contains("visible")||(h.resize(),h.fit(void 0,20))};const p=()=>{const x=[];for(const v of n.graph.nodes)x.push({group:"nodes",data:{id:v.label,label:v.label}});for(const v of n.graph.edges)x.push({group:"edges",data:{id:`${v.source}→${v.target}`,source:v.source,target:v.target}});return x},u=()=>{if(!o)return p();const x=R(n.baseGraph,n.graph),v=new Map(x.map(E=>[E.key,E.action])),$=[];for(const E of n.graph.nodes){const C=v.get(E.label)||null;$.push({group:"nodes",data:{id:E.label,label:E.label},classes:C?`diff-${C}`:""})}for(const E of n.graph.edges){const C=`${E.source}→${E.target}`,T=v.get(C)||null;$.push({group:"edges",data:{id:C,source:E.source,target:E.target},classes:T?`diff-${T}`:""})}if(n.baseGraph){const E=new Set(n.graph.nodes.map(T=>T.label)),C=new Set(n.graph.edges.map(T=>`${T.source}→${T.target}`));for(const T of n.baseGraph.nodes)E.has(T.label)||$.push({group:"nodes",data:{id:T.label,label:T.label},classes:"diff-removed"});for(const T of n.baseGraph.edges){const z=`${T.source}→${T.target}`;if(!C.has(z)){const V=new Set([...E,...n.baseGraph.nodes.map(ye=>ye.label)]);V.has(T.source)&&V.has(T.target)&&$.push({group:"edges",data:{id:z,source:T.source,target:T.target},classes:"diff-removed"})}}}return $},h=_e({container:c,elements:p(),style:Me,layout:{name:"fcose",animate:!1,fit:!0,padding:20},autoungrabify:!0,userZoomingEnabled:!0,userPanningEnabled:!0});let g="approved";const f=i.querySelector("#toggle-approved"),y=i.querySelector("#toggle-changeset"),b=x=>{if(x===g)return;g=x,f.classList.toggle("active",x==="approved"),y.classList.toggle("active",x==="changeset"),h.elements().remove();const v=x==="changeset"?u():p();h.add(v),h.layout({name:"fcose",animate:!1,fit:!0,padding:20}).run()};f.onclick=()=>b("approved"),o&&(y.onclick=()=>b("changeset"));const _=i.querySelector("#preview-info");let k=!1;_.onclick=()=>{if(k=!k,k){if(!o)r.innerHTML=`
          <p style="color: var(--text-muted); padding: 8px;">No baseline available for this approval entry.</p>
          <button id="info-back" style="margin-top:8px">&#x2190; Back</button>
        `;else{const x=R(n.baseGraph,n.graph),v=ze(x);r.innerHTML=`
          <p class="changeset-summary-text">${v}</p>
          <button id="info-back" style="margin-top:8px">&#x2190; Back</button>
        `}r.classList.add("visible"),c.style.display="none",r.querySelector("#info-back").onclick=()=>{k=!1,r.classList.remove("visible"),c.style.display="",h.resize(),h.fit(void 0,20)}}else r.classList.remove("visible"),c.style.display="",h.resize(),h.fit(void 0,20)},i.querySelector("#dlg-close-x").onclick=()=>{try{h.destroy()}catch{}w()}}function Ae(){return`t${Date.now().toString(36)}${Math.random().toString(36).slice(2,5)}`}function Fe(n,e,t=!1){let s=S(n);s.specialTypes||(s.specialTypes=[]);const o=s.graphType==="DAG",a=(g,f)=>g.map(y=>{const b=f==="node"?"Node Type":"Edge Type",_=t?"":`<button class="btn-delete-type" data-id="${y.id}" data-kind="${f}" title="Delete">✕</button>`;return`
    <div class="type-row" data-id="${y.id}" data-kind="${f}">
      <input type="text" class="type-label-input" value="${y.label}" placeholder="${b}">
      <input type="color" class="type-color-input" value="${y.color||"#4fc3f7"}">
      ${_}
    </div>
  `}).join(""),l=()=>{if(!o||s.nodeTypes.length===0)return"";const g=t,f=g?'<em style="font-size:10px;color:var(--text-muted)">Cannot change for active session</em>':"",y=s.nodeTypes.map((b,_)=>{const k=s.specialTypes.includes(b.id),x=_===0||!k||g?"disabled":"",v=_===s.nodeTypes.length-1||!k||g?"disabled":"";return`
        <div class="special-type-item">
          <input type="checkbox" class="special-type-cb" data-id="${b.id}" ${k?"checked":""} ${g?"disabled":""}>
          <span style="flex:1">${b.label}</span>
          <button class="st-up" data-id="${b.id}" ${x} title="Move up in order">↑</button>
          <button class="st-down" data-id="${b.id}" ${v} title="Move down in order">↓</button>
        </div>
      `}).join("");return`
      <div class="special-types-section">
        <div class="template-section-label">Path Tracking Types ${f}</div>
        <p style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Select node types used as anchors for path tracking (order matters).</p>
        <div id="special-types-list">${y}</div>
      </div>
    `},i=()=>`
    <div class="dialog-header">
      <h3>Edit Template</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <div class="template-graph-type-label">
      Graph Type: <strong>${J[s.graphType]?.label||s.graphType}</strong>
    </div>
    <div class="template-section-label">Node Types</div>
    <div id="node-types-list">${a(s.nodeTypes,"node")}</div>
    ${t?"":'<button id="add-node-type" class="btn-secondary btn-add-type">+ Add Node Type</button>'}
    <div class="template-section-label">Edge Types</div>
    <div id="edge-types-list">${a(s.edgeTypes,"edge")}</div>
    ${t?"":'<button id="add-edge-type" class="btn-secondary btn-add-type">+ Add Edge Type</button>'}
    ${l()}
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Save</button>
    </div>
  `,c=()=>{r.querySelectorAll(".type-label-input").forEach(g=>{g.addEventListener("focus",()=>g.select())})},r=N(i());r.classList.add("dialog-wide"),c();const d=()=>{r.querySelectorAll(".type-row").forEach(f=>{const y=f.dataset.id,b=f.dataset.kind,_=f.querySelector(".type-label-input")?.value??"",k=f.querySelector(".type-color-input")?.value??"#4fc3f7";if(b==="node"){const x=s.nodeTypes.find(v=>v.id===y);x&&(x.label=_,x.color=k)}else{const x=s.edgeTypes.find(v=>v.id===y);x&&(x.label=_,x.color=k)}}),o&&!t&&(s.specialTypes=[],r.querySelectorAll(".special-type-cb:checked").forEach(f=>{s.specialTypes.push(f.dataset.id)})),r.querySelector("#node-types-list").innerHTML=a(s.nodeTypes,"node"),r.querySelector("#edge-types-list").innerHTML=a(s.edgeTypes,"edge");const g=r.querySelector(".special-types-section");g&&(g.outerHTML=l()),p(),u(),c()},p=()=>{r.querySelectorAll(".btn-delete-type").forEach(g=>{g.onclick=()=>{const f=g.dataset.id;g.dataset.kind==="node"?(s.nodeTypes=s.nodeTypes.filter(b=>b.id!==f),s.specialTypes=s.specialTypes.filter(b=>b!==f)):s.edgeTypes=s.edgeTypes.filter(b=>b.id!==f),d()}})},u=()=>{!o||t||(r.querySelectorAll(".st-up").forEach(g=>{g.onclick=()=>{const f=g.dataset.id,y=s.specialTypes.indexOf(f);y>0&&([s.specialTypes[y-1],s.specialTypes[y]]=[s.specialTypes[y],s.specialTypes[y-1]],d())}}),r.querySelectorAll(".st-down").forEach(g=>{g.onclick=()=>{const f=g.dataset.id,y=s.specialTypes.indexOf(f);y!==-1&&y<s.specialTypes.length-1&&([s.specialTypes[y],s.specialTypes[y+1]]=[s.specialTypes[y+1],s.specialTypes[y]],d())}}),r.querySelectorAll(".special-type-cb").forEach(g=>{g.onchange=()=>{const f=g.dataset.id;g.checked?s.specialTypes.includes(f)||s.specialTypes.push(f):s.specialTypes=s.specialTypes.filter(y=>y!==f),d()}}))};p(),u(),t||(r.querySelector("#add-node-type").onclick=()=>{d(),s.nodeTypes.push({id:Ae(),label:"New Type",color:"#4fc3f7"}),d()},r.querySelector("#add-edge-type").onclick=()=>{d(),s.edgeTypes.push({id:Ae(),label:"New Type",color:"#5a6a8c"}),d()});const h=()=>{r.querySelectorAll(".type-row").forEach(g=>{const f=g.dataset.id,y=g.dataset.kind,b=g.querySelector(".type-label-input")?.value?.trim()||"Unnamed",_=g.querySelector(".type-color-input")?.value??"#4fc3f7";if(y==="node"){const k=s.nodeTypes.find(x=>x.id===f);k&&(k.label=b,k.color=_)}else{const k=s.edgeTypes.find(x=>x.id===f);k&&(k.label=b,k.color=_)}}),o&&!t&&(s.specialTypes=[],r.querySelectorAll(".special-type-cb:checked").forEach(g=>{s.specialTypes.push(g.dataset.id)})),e(s),m("Template saved","success")};r.querySelector("#dlg-ok").onclick=h,r.querySelector("#dlg-cancel").onclick=w,r.querySelector("#dlg-close-x").onclick=w}function qe(n,e){const t=n.panelEl;if(!n.pathTrackingEnabled||!n._pathTags)return;const s=n.template,o=s?.specialTypes||[],a=n._pathTags.get(e)||[],l=n._effectiveExclusions?.get(e)||new Set,i=new Set(n.exclusions[e]||[]);if(a.length===0){m("No path tags on this edge","info");return}const c=g=>A(g,o),r=g=>j(g,o,s?.nodeTypes||[]),d=a.map(g=>{const f=c(g),y=i.has(f),b=l.has(f)&&!y,_=y||b,k=r(g);return`
      <div class="exclusion-item ${b?"propagated":""}">
        <input type="checkbox" class="excl-cb" data-tag="${f}" data-propagated="${b}" ${_?"":"checked"} title="${b?"Propagated from downstream — uncheck to add direct exclusion":""}">
        <span>${k}${b?' <em style="font-size:10px;color:var(--text-muted)">(inherited)</em>':""}</span>
      </div>
    `}).join(""),[p,u]=e.split("→"),h=N(`
    <div class="dialog-header">
      <h3>Exclusions: ${p} → ${u}</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Checked = included in tracking. Uncheck to exclude a path.</p>
    <div class="exclusion-list">${d}</div>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `,t);h.querySelector("#dlg-ok").onclick=()=>{h.querySelectorAll(".excl-cb").forEach(f=>{const y=f.dataset.tag,b=f.checked,_=i.has(y);!b&&!_?n.excludePathTag(e,y):b&&_&&n.includePathTag(e,y)}),w()},h.querySelector("#dlg-cancel").onclick=w,h.querySelector("#dlg-close-x").onclick=w}function Nt(n){const e=n.panelEl,s=[{value:"fcose",label:"Force-Directed (fcose)"},{value:"level-by-level",label:"Level-by-Level (DAG)"},{value:"circle",label:"Circle"},{value:"concentric",label:"Concentric"},{value:"breadthfirst",label:"Breadth-First"},{value:"grid",label:"Grid"}].map(r=>`<option value="${r.value}" ${n.layoutAlgorithm===r.value?"selected":""}>${r.label}</option>`).join(""),o=n.template,a=o?.graphType==="DAG",l=a&&o?.specialTypes?.length>0,i=a?`
    <div class="template-section-label" style="margin-top:12px">Path Tracking</div>
    ${l?`
    <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;white-space:nowrap">
      <input type="checkbox" id="dlg-tracking" style="width:auto;flex-shrink:0" ${n.pathTrackingEnabled?"checked":""}>
      Enable path tracking
    </label>
    `:'<p style="font-size:11px;color:var(--text-muted)">No special types configured in template. Edit the template to add special types for DAG path tracking.</p>'}
  `:"",c=N(`
    <div class="dialog-header">
      <h3>Panel Options</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <label>Layout Algorithm</label>
    <select id="dlg-layout-algo">${s}</select>
    ${i}
    <div class="dialog-actions">
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `,e);c.querySelector("#dlg-ok").onclick=()=>{const r=c.querySelector("#dlg-layout-algo").value;if(n.setLayoutAlgorithm(r),l){const d=c.querySelector("#dlg-tracking")?.checked||!1;d!==n.pathTrackingEnabled&&n.setPathTracking(d)}m("Options applied","success"),w()},c.querySelector("#dlg-close-x").onclick=w}function At(n,e,t,s){const o=n.template?.specialTypes||[],a=n.graph.nodes,l=o.length>0?a.filter(h=>o.includes(h.type)):a,i=t[e],c=i&&typeof i=="object"?i.scopeNodes||[]:[],r=c.length>0;let d;l.length===0?o.length>0?d='<p style="color:var(--text-muted);padding:8px 0">No special-type nodes found in target panel. Configure Path Tracking types in template settings.</p>':d='<p style="color:var(--text-muted);padding:8px 0">No nodes in target panel.</p>':d=l.map(h=>{const g=c.includes(h.label)?"checked":"";return`<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;font-size:12px">
          <input type="checkbox" class="scope-node-cb" value="${h.label}" ${g} style="width:auto;margin:0">
          <span>${h.label}</span>
        </div>`}).join("");const p=N(`
    <div class="dialog-header">
      <h3>Select Scope Nodes</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Select nodes in the target panel. Only upstream ancestors of these nodes will be merged.</p>
    <div style="max-height:200px;overflow-y:auto;margin-bottom:8px">${d}</div>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `),u=()=>{r||delete t[e],w(),s&&s()};p.querySelector("#dlg-ok").onclick=()=>{const h=[...p.querySelectorAll(".scope-node-cb:checked")].map(g=>g.value);t[e]={strategy:"scoped",scopeNodes:h},w(),s&&s()},p.querySelector("#dlg-cancel").onclick=u,p.querySelector("#dlg-close-x").onclick=u}function qt(n,e,t){const s=n.map(l=>`<option value="${l.id}">${l.name}</option>`).join(""),o=N(`
    <h3>Add Merge Button</h3>
    <label>Source Panel</label>
    <select id="dlg-source">${s}</select>
    <label>Target Panel</label>
    <select id="dlg-target">${s}</select>
    <p id="dlg-warning" style="color:var(--warning);font-size:11px;display:none;margin-bottom:6px">This merge direction already exists.</p>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `),a=()=>{const l=o.querySelector("#dlg-source").value,i=o.querySelector("#dlg-target").value,c=e.some(r=>r.source===l&&r.target===i);o.querySelector("#dlg-warning").style.display=c?"":"none"};o.querySelector("#dlg-source").onchange=a,o.querySelector("#dlg-target").onchange=a,o.querySelector("#dlg-cancel").onclick=w,o.querySelector("#dlg-ok").onclick=()=>{const l=o.querySelector("#dlg-source").value,i=o.querySelector("#dlg-target").value;if(l===i){m("Source and target must differ","error");return}w(),t({source:l,target:i})}}function Dt(n){const t=Object.keys(n).map(s=>`<option value="${s}">${s}</option>`).join("");return new Promise(s=>{const o=N(`
      <h3>New Session</h3>
      <label>Session Name</label>
      <input id="dlg-name" type="text" placeholder="Session name" autofocus>
      <label>Template</label>
      <select id="dlg-template">${t}</select>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Create</button>
      </div>
    `);o.querySelector("#dlg-cancel").onclick=()=>{w(),s(null)},o.querySelector("#dlg-ok").onclick=()=>{const a=o.querySelector("#dlg-name").value.trim();if(!a){m("Session name required","error");return}const l=o.querySelector("#dlg-template").value;w(),s({name:a,templateName:l})},o.querySelector("#dlg-name").onkeydown=a=>{a.key==="Enter"&&o.querySelector("#dlg-ok").click()}})}const De=200;class Lt{constructor(e,{onPanelCreate:t,onPanelDestroy:s,onMerge:o,getState:a,setState:l,confirmClose:i,onResizeEnd:c,getPanels:r}){this.rootEl=e,this.onPanelCreate=t,this.onPanelDestroy=s,this.onMerge=o,this._getState=a||null,this._setState=l||null,this._confirmClose=i||null,this._onResizeEnd=c||null,this._getPanels=r||null,this.nextId=1,this.tree=null,this._zoomedPanelId=null,this._zoomSavedStates=new Map,this.mergeStrategies={},this.mergeButtonLists={},this._gutterSplitNodes={}}_getStrategy(e){const t=this.mergeStrategies[e];return t?typeof t=="string"?{strategy:t,scopeNodes:[]}:t:{strategy:"mirror",scopeNodes:[]}}_strategyBadge(e){switch(e){case"push":return"(P)";case"scoped":return"(S)";case"none":return"(N)";default:return"(M)"}}init(){const e=window.innerWidth<=600?"h":"v";this.tree={type:"split",direction:e,children:[{type:"panel",id:String(this.nextId++)},{type:"panel",id:String(this.nextId++)}],sizes:[50,50]},this.render()}getLayout(){return{tree:this.tree,nextId:this.nextId,mergeStrategies:this.mergeStrategies,mergeButtonLists:this.mergeButtonLists}}setLayout(e){this.tree=e.tree,this.nextId=e.nextId,this.mergeStrategies=e.mergeStrategies||{},this.mergeButtonLists=e.mergeButtonLists||{},this.render()}getMergeStrategies(){return this.mergeStrategies}setMergeStrategies(e){this.mergeStrategies=e||{}}getAllPanelIds(){const e=[],t=s=>{s.type==="panel"?e.push(s.id):s.children.forEach(t)};return this.tree&&t(this.tree),e}splitPanel(e,t){const s=String(this.nextId++),o=this._findPanelNode(this.tree,e);return this.tree=this._mapTree(this.tree,a=>a.type==="panel"&&a.id===e?{type:"split",direction:t,children:[{type:"panel",id:e,name:o?.name},{type:"panel",id:s}],sizes:[50,50]}:a),this.render(),s}closePanel(e){if(!(this.getAllPanelIds().length<=1)){this._zoomedPanelId===e&&(this._zoomedPanelId=null);for(const t of Object.keys(this.mergeButtonLists))this.mergeButtonLists[t]=this.mergeButtonLists[t].filter(s=>s.source!==e&&s.target!==e);this.tree=this._removePanel(this.tree,e),this.render()}}addPanel(){const e=String(this.nextId++),t=window.innerWidth<=600?"h":"v";return this.tree={type:"split",direction:t,children:[this.tree,{type:"panel",id:e}],sizes:[70,30]},this.render(),e}toggleZoom(e){this._zoomedPanelId===e?this._zoomedPanelId=null:this._zoomedPanelId=e,this.render()}render(){const e=new Map,t=new Set;this.rootEl.querySelectorAll(".panel-canvas").forEach(o=>{t.add(o.dataset.panel)});for(const o of t)if(this._getState){const a=this._getState(o);a&&e.set(o,a)}for(const o of t)this.onPanelDestroy(o);if(this.rootEl.innerHTML="",!this.tree)return;if(this._zoomedPanelId){const o=this._findPanelNode(this.tree,this._zoomedPanelId);if(o){for(const i of t)i!==this._zoomedPanelId&&e.has(i)&&this._zoomSavedStates.set(i,e.get(i));const a=this._renderPanel(o);a.style.flex="1",a.classList.add("zoomed"),this.rootEl.appendChild(a);const l=a.querySelector(".panel-canvas");this.onPanelCreate(this._zoomedPanelId,l),e.has(this._zoomedPanelId)&&this._setState&&this._setState(this._zoomedPanelId,e.get(this._zoomedPanelId));return}this._zoomedPanelId=null}for(const[o,a]of this._zoomSavedStates)e.has(o)||e.set(o,a);this._zoomSavedStates.clear();const s=this._renderNode(this.tree);s.style.flex="1",s.style.display="flex",s.style.minWidth="0",s.style.minHeight="0",this.rootEl.appendChild(s);for(const o of this.getAllPanelIds()){const a=this.rootEl.querySelector(`.panel-canvas[data-panel="${o}"]`);a&&(this.onPanelCreate(o,a),e.has(o)&&this._setState&&this._setState(o,e.get(o)))}}_renderNode(e){return e.type==="panel"?this._renderPanel(e):this._renderSplit(e)}_renderPanel(e){const t=e.name||`Panel ${e.id}`,s=document.createElement("div");s.className="panel",s.dataset.panelId=e.id;const o=document.createElement("div");o.className="panel-header",o.innerHTML=`
      <span class="panel-name" title="Click to rename">${t}</span>
      <span class="panel-header-actions">
        <button data-action="undo" class="btn-icon btn-header-icon" title="Undo (Ctrl+Z)">&#x2190;</button>
        <button data-action="redo" class="btn-icon btn-header-icon" title="Redo (Ctrl+Shift+Z)">&#x2192;</button>
        <span class="action-separator-sm"></span>
        <button data-action="refresh" class="btn-icon btn-header-icon" title="Re-layout">&#x21BB;</button>
        <button data-action="panel-options" class="btn-icon btn-header-icon" title="Panel options">&#x2699;</button>
        <span class="processing-indicator" title="Processing...">&#x27F3;</span>
      </span>
      <span class="panel-info"></span>
      <span class="panel-header-btns">
        <span class="panel-split-group">
          <button class="panel-split-btn" data-split="v" title="Split this panel into two side-by-side panels">&#x2194;</button>
          <button class="panel-split-btn" data-split="h" title="Split this panel into two stacked panels">&#x2195;</button>
        </span>
        <span class="panel-window-group">
          <button class="panel-zoom-btn" title="Toggle full-screen zoom on this panel (Escape to exit)">&#x2922;</button>
          <button class="panel-close-btn" title="Close this panel and remove it from the layout">&#x2715;</button>
        </span>
      </span>
    `,s.appendChild(o);const a=o.querySelector(".panel-name");a.style.cursor="pointer",a.onclick=()=>{wt(t,s).then(r=>{r!==null&&(e.name=r||void 0,a.textContent=r||`Panel ${e.id}`,this.render())})},o.querySelector(".panel-zoom-btn").onclick=()=>this.toggleZoom(e.id),o.querySelector('[data-split="v"]').onclick=()=>this.splitPanel(e.id,"v"),o.querySelector('[data-split="h"]').onclick=()=>this.splitPanel(e.id,"h"),o.querySelector(".panel-close-btn").onclick=async()=>{this._confirmClose&&!await this._confirmClose(e.id)||this.closePanel(e.id)};const l=document.createElement("div");l.className="panel-canvas",l.dataset.panel=e.id;const i=document.createElement("div");i.className="diff-overlay",i.dataset.panelDiff=e.id,l.appendChild(i),s.appendChild(l);const c=document.createElement("div");return c.className="panel-actions",c.innerHTML=`
      <span class="panel-actions-left">
        <button data-action="add-node" class="btn-add" title="Add a new labeled node to the graph">+N</button>
        <button data-action="add-edge" class="btn-add" title="Add a new directed edge between two existing nodes">+E</button>
        <span class="action-separator"></span>
        <button data-action="approve" class="btn-approve" title="Snapshot current state as baseline and clear all diffs">&#x2713;</button>
        <button data-action="restore" class="btn-restore" title="Revert graph to last approved state (undo all changes since approval)">&#x21BA;</button>
        <span class="action-separator"></span>
        <button data-action="clear" class="btn-clear" title="Reset panel to empty state (clears graph, approval history, and diffs)">&#x232B;</button>
      </span>
      <span class="panel-actions-right">
        <button data-action="changeset" class="btn-icon" title="View pending changeset summary">&#x24D8;</button>
        <button data-action="changelog" class="btn-icon" title="View approval history">&#x2630;</button>
        <button data-action="import" class="btn-icon" title="Import graph from a JSON file">&#x21A5;</button>
        <button data-action="export" class="btn-icon" title="Export current graph as a JSON file">&#x21A7;</button>
      </span>
    `,s.appendChild(c),s}_renderSplit(e){const t=e.direction==="v",s=document.createElement("div");s.className=t?"split-v":"split-h";const o=this._renderNode(e.children[0]),a=this._renderNode(e.children[1]);o.style.flex=`${e.sizes[0]} 1 0`,o.style.overflow="hidden",o.style.display="flex",o.style.minWidth="0",o.style.minHeight="0",a.style.flex=`${e.sizes[1]} 1 0`,a.style.overflow="hidden",a.style.display="flex",a.style.minWidth="0",a.style.minHeight="0";const l=this._renderMergeGutter(e);return s.appendChild(o),s.appendChild(l),s.appendChild(a),s}_panelName(e){return e.name||`Panel ${e.id}`}_getPanelName(e){const t=this._findPanelNode(this.tree,e);return t?this._panelName(t):`Panel ${e}`}_gutterKey(e){const t=this._allPanelNodes(e.children[0]).map(o=>o.id).sort().join(","),s=this._allPanelNodes(e.children[1]).map(o=>o.id).sort().join(",");return`${t}|${s}`}_defaultButtons(e){const t=this._getZones(e.children[0],e.direction,"first"),s=this._getZones(e.children[1],e.direction,"second"),o=u=>{let h=0;return u.map(g=>{const f={start:h,end:h+g.size,panels:g.panels,slot:g.slot};return h+=g.size,f})},a=o(t),l=o(s),i=new Set([0,100]);for(const u of[...a,...l])i.add(u.start),i.add(u.end);const c=[...i].sort((u,h)=>u-h),r=(u,h)=>u.find(g=>g.start<=h&&h<g.end),d=[],p=new Set;for(let u=0;u<c.length-1;u++){const h=(c[u]+c[u+1])/2,g=r(a,h),f=r(l,h);if(!(!g||!f)&&!(g.slot!==null&&f.slot!==null&&g.slot!==f.slot))for(const y of g.panels)for(const b of f.panels){const _=`${y.id}→${b.id}`,k=`${b.id}→${y.id}`;p.has(_)||(p.add(_),d.push({source:y.id,target:b.id})),p.has(k)||(p.add(k),d.push({source:b.id,target:y.id}))}}return d}_getButtonList(e){const t=this._gutterKey(e);return this.mergeButtonLists[t]||(this.mergeButtonLists[t]=this._defaultButtons(e)),this.mergeButtonLists[t]}_rerenderGutter(e){const t=this._gutterSplitNodes[e];if(!t)return;const s=this.rootEl.querySelector(`.merge-gutter[data-gutter-key="${CSS.escape(e)}"]`);s&&s.replaceWith(this._renderMergeGutter(t))}_renderMergeGutter(e){const t=e.direction==="v",s=document.createElement("div");s.className="merge-gutter";const o=this._gutterKey(e);s.dataset.gutterKey=o,this._gutterSplitNodes[o]=e;const a=this._getButtonList(e),l=new Set(this._allPanelNodes(e.children[0]).map(u=>u.id)),i=t?"▶▶":"▼▼",c=t?"◀◀":"▲▲",r=document.createElement("div");if(r.className="merge-zone merge-zone-flat",a.length===0){const u=document.createElement("div");u.className="merge-zone-empty",u.textContent="No merge buttons",r.appendChild(u)}a.forEach((u,h)=>{const{source:g,target:f}=u,y=`${g}→${f}`,b=this._getStrategy(y),_=l.has(g)?i:c,k=this._getPanelName(g),x=this._getPanelName(f),v=document.createElement("button");v.className="merge-btn",b.strategy==="none"&&v.classList.add("merge-btn-disabled"),v.innerHTML=`<span class="merge-btn-text">${k} ${_} ${x}</span><span class="merge-strategy-badge">${this._strategyBadge(b.strategy)}</span>`,v.title=`Merge ${k} into ${x}. Right-click to change strategy or delete.`,v.dataset.mergeSource=g,v.dataset.mergeTarget=f,v.onclick=()=>{if(this._getStrategy(y).strategy==="none"){Ge("Merge Disabled","This merge direction is set to None.");return}this.onMerge(g,f)},v.addEventListener("contextmenu",C=>{C.preventDefault(),this._showStrategyPicker(y,v,o)});const $=document.createElement("div");$.className="merge-btn-row",$.draggable=!0;const E=document.createElement("span");E.className="merge-btn-drag",E.textContent="⋮⋮",E.title="Drag to reorder",$.appendChild(E),$.appendChild(v),$.addEventListener("dragstart",C=>{C.dataTransfer.setData("text/plain",String(h)),C.dataTransfer.effectAllowed="move",$.classList.add("dragging")}),$.addEventListener("dragend",()=>$.classList.remove("dragging")),$.addEventListener("dragover",C=>{C.preventDefault(),C.dataTransfer.dropEffect="move"}),$.addEventListener("drop",C=>{C.preventDefault();const T=parseInt(C.dataTransfer.getData("text/plain")),z=h;if(T===z)return;const V=this.mergeButtonLists[o];if(!V)return;const ye=V.splice(T,1)[0];V.splice(T<z?z-1:z,0,ye),this._rerenderGutter(o),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}),r.appendChild($)});const d=document.createElement("button");d.className="merge-btn-add",d.textContent="+",d.title="Add merge button",d.onclick=()=>{const u=this._allPanelNodes(this.tree),h=this.mergeButtonLists[o]||[];qt(u,h,({source:g,target:f})=>{this.mergeButtonLists[o].push({source:g,target:f}),this._rerenderGutter(o),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))})},r.appendChild(d),s.appendChild(r);const p=document.createElement("div");return p.className="resize-handle",this._setupResize(p,e,s),s.appendChild(p),s}_getZones(e,t,s){if(e.type==="panel")return[{panels:[{id:e.id,name:this._panelName(e)}],size:100,slot:null}];const o=t==="v"?"h":"v";if(e.direction===o){const l=this._getZones(e.children[0],t,s),i=this._getZones(e.children[1],t,s);return[...l.map(c=>({panels:c.panels,size:c.size*e.sizes[0]/100,slot:c.slot!==null?c.slot:0})),...i.map(c=>({panels:c.panels,size:c.size*e.sizes[1]/100,slot:c.slot!==null?c.slot:1}))]}const a=s==="first"?e.children[1]:e.children[0];return this._getZones(a,t,s)}_allPanelNodes(e){return e.type==="panel"?[{id:e.id,name:this._panelName(e)}]:[...this._allPanelNodes(e.children[0]),...this._allPanelNodes(e.children[1])]}_findPanelNode(e,t){return e?e.type==="panel"?e.id===t?e:null:this._findPanelNode(e.children[0],t)||this._findPanelNode(e.children[1],t):null}_firstPanelId(e){return e.type==="panel"?e.id:this._firstPanelId(e.children[0])}_allPanelIds(e){return e.type==="panel"?[e.id]:[...this._allPanelIds(e.children[0]),...this._allPanelIds(e.children[1])]}_setupResize(e,t,s){const o=t.direction==="v",a=l=>{const i=s.parentElement;if(!i)return null;const c=i.getBoundingClientRect(),r=o?c.width:c.height;o?s.offsetWidth:s.offsetHeight;const d=u=>{let g=(o?u.x-c.left:u.y-c.top)/r;g=Math.max(De/r,Math.min(1-De/r,g)),t.sizes[0]=g*100,t.sizes[1]=(1-g)*100;const f=i.querySelectorAll(":scope > .panel, :scope > .split-v, :scope > .split-h");f.length>=2&&(f[0].style.flex=`${t.sizes[0]} 1 0`,f[f.length-1].style.flex=`${t.sizes[1]} 1 0`)},p=()=>{document.body.style.cursor="",document.body.style.userSelect="",this._onResizeEnd&&this._onResizeEnd(t)};return document.body.style.cursor=o?"col-resize":"row-resize",document.body.style.userSelect="none",{onMove:d,onEnd:p}};e.addEventListener("mousedown",l=>{l.preventDefault();const i=a({x:l.clientX,y:l.clientY});if(!i)return;const c=d=>i.onMove({x:d.clientX,y:d.clientY}),r=()=>{document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",r),i.onEnd()};document.addEventListener("mousemove",c),document.addEventListener("mouseup",r)}),e.addEventListener("touchstart",l=>{l.preventDefault();const i=l.touches[0],c=a({x:i.clientX,y:i.clientY});if(!c)return;const r=p=>{p.preventDefault();const u=p.touches[0];c.onMove({x:u.clientX,y:u.clientY})},d=()=>{document.removeEventListener("touchmove",r),document.removeEventListener("touchend",d),document.removeEventListener("touchcancel",d),c.onEnd()};document.addEventListener("touchmove",r,{passive:!1}),document.addEventListener("touchend",d),document.addEventListener("touchcancel",d)})}_showStrategyPicker(e,t,s){document.querySelector(".merge-strategy-picker")?.remove();const o=this._getStrategy(e),a=o.strategy,l=document.createElement("div");l.className="merge-strategy-picker";const i=t.getBoundingClientRect();l.style.cssText=`position:fixed;left:${i.left}px;top:${i.bottom+4}px;z-index:10000`;const c=[{strat:"mirror",label:"Mirror (M)"},{strat:"push",label:"Push (P)"},{strat:"scoped",label:"Scoped (S)"},{strat:"none",label:"None (N)"}];l.innerHTML=c.map(p=>`<div class="strategy-option${a===p.strat?" active":""}" data-strat="${p.strat}">${a===p.strat?"✓ ":""}${p.label}</div>`).join("")+`
      <hr class="strategy-separator">
      <div class="strategy-option strategy-delete" data-strat="__delete__">&#x1F5D1; Delete</div>
    `,document.body.appendChild(l);const r=()=>{const p=this._getStrategy(e),u=t.querySelector(".merge-strategy-badge");u&&(u.textContent=this._strategyBadge(p.strategy)),t.classList.toggle("merge-btn-disabled",p.strategy==="none")},d=p=>{l.contains(p.target)||(l.remove(),document.removeEventListener("mousedown",d))};l.querySelectorAll(".strategy-option").forEach(p=>{p.onclick=u=>{u.stopPropagation();const h=p.dataset.strat;if(l.remove(),document.removeEventListener("mousedown",d),h==="__delete__"){if(s&&this.mergeButtonLists[s]){const g=this.mergeButtonLists[s].findIndex(f=>`${f.source}→${f.target}`===e);g!==-1&&this.mergeButtonLists[s].splice(g,1),this._rerenderGutter(s),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}return}if(h==="mirror"?delete this.mergeStrategies[e]:this.mergeStrategies[e]={strategy:h,scopeNodes:o.scopeNodes||[]},h==="scoped"){const g=e.split("→")[1],y=(this._getPanels?this._getPanels():null)?.get(g);y?At(y,e,this.mergeStrategies,()=>{r(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}):(r(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})))}else r(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}}),setTimeout(()=>document.addEventListener("mousedown",d),0)}updateMergeButtonStates(e){this.rootEl.querySelectorAll(".merge-btn[data-merge-source]").forEach(t=>{if(t.classList.contains("merge-btn-disabled"))return;const s=t.dataset.mergeSource,o=e.get(s),a=o?o.isClean():!0;t.classList.toggle("merge-btn-allowed",a),t.classList.toggle("merge-btn-blocked",!a)})}_mapTree(e,t){const s=t(e);return s!==e?s:e.type==="panel"?e:{...e,children:[this._mapTree(e.children[0],t),this._mapTree(e.children[1],t)]}}_removePanel(e,t){return e.type==="panel"?e:e.children[0].type==="panel"&&e.children[0].id===t?e.children[1]:e.children[1].type==="panel"&&e.children[1].id===t?e.children[0]:{...e,children:[this._removePanel(e.children[0],t),this._removePanel(e.children[1],t)]}}}let ne=null;function Mt(){let n=0;for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e),s=localStorage.getItem(t);n+=(t.length+s.length)*2}return n}function Ot(n){return n<1024?`${n}B`:n<1024*1024?`${(n/1024).toFixed(1)}KB`:`${(n/(1024*1024)).toFixed(1)}MB`}function It(){const n=localStorage.getItem("graph-merge-sessions");if(!n)return null;try{const e=JSON.parse(n);let t=0,s=0,o=0,a=null;for(const[l,i]of Object.entries(e))if(i.panels){for(const[c,r]of Object.entries(i.panels))o++,r.graph&&(t+=r.graph.nodes?.length||0,s+=r.graph.edges?.length||0);i.savedAt&&(!a||new Date(i.savedAt)>new Date(a))&&(a=i.savedAt)}return{sessionCount:Object.keys(e).length,totalNodes:t,totalEdges:s,totalPanels:o,latestSavedAt:a}}catch(e){return console.error("Failed to parse session stats:",e),null}}function W(){if(!ne)return;const n=ne.querySelector(".status-left"),e=ne.querySelector(".status-right"),t=Mt(),s=It();let o=`Storage: ${Ot(t)}`;if(s&&(o+=` | ${s.totalNodes}n ${s.totalEdges}e ${s.totalPanels}p ${s.sessionCount}s`),n.textContent=o,s&&s.latestSavedAt){const a=new Date(s.latestSavedAt).toLocaleTimeString();e.textContent=`Last: ${a}`}else e.textContent=""}function zt(){if(ne=document.getElementById("status-bar"),!ne){console.warn("Status bar element not found");return}window.addEventListener("panel-change",W),W()}const Ue="graph-merge-templates";function M(){try{const n=JSON.parse(localStorage.getItem(Ue));if(n&&typeof n=="object")return n.Default||(n.Default=ee()),n}catch{}return{Default:ee()}}function te(n){localStorage.setItem(Ue,JSON.stringify(n))}function pe(n,e){if(!e.includes(n))return n;let t=2;for(;e.includes(`${n} (${t})`);)t++;return`${n} (${t})`}function jt(n){const e=J[n.graphType]?.label||n.graphType,t=n.nodeTypes?.length||0,s=n.edgeTypes?.length||0;return`${e} · ${t} node type${t!==1?"s":""} · ${s} edge type${s!==1?"s":""}`}function Gt(){let n=null;const e=i=>{const c=Object.keys(i);return c.length===0?'<p style="color:var(--text-muted);padding:12px;text-align:center">No templates</p>':c.map(r=>{const d=i[r];return`
        <div class="template-list-item ${r===n?"selected":""}" data-name="${r}">
          <span class="tpl-name">${r}</span>
          <span class="tpl-meta">${jt(d)}</span>
        </div>
      `}).join("")},t=i=>`
    <div class="dialog-header">
      <h3>Templates</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <div class="template-list" id="tpl-list">
      ${e(i)}
    </div>
    <div class="template-modal-footer">
      <button id="tpl-add">Add</button>
      <button id="tpl-remove">Remove</button>
      <button id="tpl-edit">Edit</button>
      <button id="tpl-copy">Copy</button>
      <button id="tpl-import">Import</button>
      <button id="tpl-export">Export</button>
    </div>
  `,s=M(),o=N(t(s));o.classList.add("dialog-wide");const a=()=>{const i=M();o.querySelector("#tpl-list").innerHTML=e(i),l()},l=()=>{o.querySelectorAll(".template-list-item").forEach(i=>{i.onclick=()=>{n=i.dataset.name,a()}})};l(),o.addEventListener("click",i=>{i.target.matches("#dlg-close-x")&&w()}),o.querySelector("#tpl-add").onclick=()=>{const i=Object.entries(J).map(([c,r])=>`<option value="${c}">${r.label}</option>`).join("");o.querySelector("#tpl-list").innerHTML=`
      <div style="padding:12px;display:flex;flex-direction:column;gap:8px">
        <label>Template Name</label>
        <input id="tpl-new-name" type="text" placeholder="Template name" autofocus>
        <label>Graph Type</label>
        <select id="tpl-graph-type">${i}</select>
        <div style="display:flex;gap:8px;margin-top:4px">
          <button id="tpl-create-confirm" class="btn-primary">Create</button>
          <button id="tpl-create-cancel">Cancel</button>
        </div>
      </div>
    `,o.querySelector("#tpl-new-name").focus(),o.querySelector("#tpl-create-cancel").onclick=a,o.querySelector("#tpl-create-confirm").onclick=()=>{const c=o.querySelector("#tpl-new-name").value.trim();if(!c){m("Template name required","error");return}const r=o.querySelector("#tpl-graph-type").value,d=M(),p=pe(c,Object.keys(d));d[p]=nt(p,r),te(d),n=p,m(`Created template "${p}"`,"success"),a()}},o.querySelector("#tpl-remove").onclick=()=>{if(!n){m("Select a template first","info");return}if(n==="Default"){m("Cannot remove the Default template","info");return}const i=M(),c=n;confirm(`Delete template "${c}"?`)&&(delete i[c],te(i),n=null,m(`Deleted template "${c}"`,"info"),a())},o.querySelector("#tpl-edit").onclick=()=>{if(!n){m("Select a template first","info");return}const c=M()[n];c&&(w(),Fe(JSON.parse(JSON.stringify(c)),r=>{const d=M();d[n]=r,te(d),m("Template updated","success")},!1))},o.querySelector("#tpl-copy").onclick=()=>{if(!n){m("Select a template first","info");return}const i=M(),c=i[n];if(!c)return;const r=pe(n+" Copy",Object.keys(i));i[r]={...JSON.parse(JSON.stringify(c)),name:r},te(i),n=r,m(`Copied as "${r}"`,"success"),a()},o.querySelector("#tpl-import").onclick=()=>{const i=document.createElement("input");i.type="file",i.accept=".json",i.onchange=()=>{const c=i.files[0];if(!c)return;const r=new FileReader;r.onload=d=>{let p;try{p=JSON.parse(d.target.result)}catch{m("Invalid JSON file","error");return}if(!p.template||!p.template.name){m("Invalid template file","error");return}const u=M(),h=pe(p.template.name,Object.keys(u));u[h]={...p.template,name:h},te(u),n=h,m(`Imported template "${h}"`,"success"),a()},r.readAsText(c)},i.click()},o.querySelector("#tpl-export").onclick=()=>{if(!n){m("Select a template first","info");return}const c=M()[n];if(!c)return;const r=JSON.stringify({version:1,template:c},null,2),d=new Blob([r],{type:"application/json"}),p=URL.createObjectURL(d),u=document.createElement("a");u.href=p,u.download=`template-${n.replace(/[^a-zA-Z0-9_-]/g,"_")}.json`,u.click(),URL.revokeObjectURL(p),m(`Exported template "${n}"`,"success")}}const Je="graph-merge-sessions",Ke="graph-merge-active-session";let ae=null,F=null,Le=null,G=ee(),K=null;function U(){try{return JSON.parse(localStorage.getItem(Je))||{}}catch{return{}}}function ie(n){localStorage.setItem(Je,JSON.stringify(n))}function Q(){return localStorage.getItem(Ke)||"Default"}function ue(n){localStorage.setItem(Ke,n)}function Ht(n){if(!n.state||n.layout)return n;const e=Object.keys(n.state),t={};let s=1;for(const o of e.slice(0,2)){const a=String(s++),l=n.state[o];t[a]={...l,id:a}}return{layout:{tree:{type:"split",direction:"v",children:[{type:"panel",id:"1"},{type:"panel",id:"2"}],sizes:[50,50]},nextId:s},panels:t,template:{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[]},savedAt:n.savedAt}}function Bt(n){return n.template?(n.template.specialTypes||(n={...n,template:{...n.template,specialTypes:[]}}),n):{...n,template:{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[],specialTypes:[]}}}function Rt(n){if(!n.panels)return n;const e={};for(const[t,s]of Object.entries(n.panels))e[t]={pathTrackingEnabled:!1,showExclusions:!0,exclusions:{},...s};return{...n,panels:e}}function Ft(){return G}function Z(){if(!ae||!F)return;const n=Q(),e=U(),t={};for(const[s,o]of ae)t[s]=o.getState();e[n]={layout:F.getLayout(),panels:t,template:G,savedAt:new Date().toISOString()},ie(e)}function fe(n){if(!ae||!F)return;const e=U();let t=e[n];if(t){if(t=Ht(t),t=Bt(t),t=Rt(t),e[n]=t,ie(e),t.layoutAlgorithm&&t.panels)for(const s of Object.values(t.panels))s.layoutAlgorithm||(s.layoutAlgorithm=t.layoutAlgorithm);if(G=t.template||ee(),K&&K(G),t.layout&&F.setLayout(t.layout),t.panels)for(const[s,o]of ae)t.panels[s]&&o.setState(t.panels[s]);ue(n),W()}}function We(){clearTimeout(Le),Le=setTimeout(Z,2e3)}function oe(){const n=document.getElementById("session-controls");if(!n)return;const e=U(),t=Q(),s=Object.keys(e);s.includes(t)||s.unshift(t);const o=s.map(p=>`<option value="${p}" ${p===t?"selected":""}>${p}</option>`).join("");n.innerHTML=`
    <select id="session-select">${o}</select>
    <div class="session-menu-wrapper">
      <button id="session-menu-toggle" class="btn-icon" title="Session actions">&#x2630;</button>
      <div id="session-menu" class="session-dropdown" hidden>
        <button id="session-new">New</button>
        <button id="session-rename">Rename</button>
        <button id="session-delete">Delete</button>
        <hr class="menu-divider">
        <button id="session-edit-template">Edit Template</button>
        <hr class="menu-divider">
        <button id="session-export">Export</button>
        <button id="session-import">Import</button>
      </div>
    </div>
    <button id="templates-btn" title="Manage templates">Templates</button>
    <button id="add-panel-btn" title="Add panel" style="font-weight:bold;font-size:14px">+</button>
    <button class="help-btn" id="help-btn" title="Keyboard shortcuts">?</button>
  `;const a=n.querySelector("#session-menu"),l=n.querySelector("#session-menu-toggle"),i=()=>a.hidden=!0;l.onclick=p=>{p.stopPropagation(),a.hidden=!a.hidden};const c=p=>{n.contains(p.target)||i()};document.addEventListener("click",c);const r=new MutationObserver(()=>{document.contains(l)||(document.removeEventListener("click",c),r.disconnect())});r.observe(document.body,{childList:!0,subtree:!0});const d=(p,u)=>{const h=n.querySelector(p);h&&(h.onclick=()=>{i(),u()})};n.querySelector("#templates-btn").onclick=()=>Gt(),n.querySelector("#session-select").onchange=p=>{Z(),fe(p.target.value),m(`Switched to "${p.target.value}"`,"info"),W()},d("#session-new",async()=>{const p=M(),u=await Dt(p);if(!u)return;const{name:h,templateName:g}=u,f=JSON.parse(JSON.stringify(p[g]||ee()));Z(),G=f,K&&K(G),F.init(),ue(h.trim()),Z(),oe(),m(`Created session "${h.trim()}"`,"success"),W()}),d("#session-rename",()=>{const p=Q(),u=prompt("New name:",p);if(!u||!u.trim()||u.trim()===p)return;const h=U();h[u.trim()]=h[p],delete h[p],ie(h),ue(u.trim()),oe(),m(`Renamed to "${u.trim()}"`,"success")}),d("#session-delete",()=>{const p=Q();if(!confirm(`Delete session "${p}"?`))return;const u=U();delete u[p],ie(u);const h=Object.keys(u);h.length>0?fe(h[0]):(ue("Default"),F.init()),oe(),m(`Deleted session "${p}"`,"info"),W()}),d("#session-edit-template",()=>{Fe(G,p=>{G=p,K&&K(G),We(),m("Template updated","success")},!0)}),d("#session-export",Jt),d("#session-import",Kt),n.querySelector("#add-panel-btn").onclick=()=>F.addPanel(),n.querySelector("#help-btn").onclick=()=>{Ut()}}function Ut(){let n=document.querySelector(".keyboard-help");n||(n=document.createElement("div"),n.className="keyboard-help",n.innerHTML=`
      <h3>Keyboard Shortcuts</h3>
      <dl>
        <dt><kbd>Ctrl</kbd>+<kbd>Z</kbd></dt><dd>Undo</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Z</kbd></dt><dd>Redo</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>C</kbd></dt><dd>Copy selected subgraph</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>V</kbd></dt><dd>Paste into focused panel</dd>
        <dt><kbd>Delete</kbd></dt><dd>Delete selected elements</dd>
        <dt><kbd>Escape</kbd></dt><dd>Deselect all / close dialog</dd>
      </dl>
      <div class="dialog-actions" style="margin-top:12px">
        <button onclick="this.closest('.keyboard-help').classList.remove('visible')">Close</button>
      </div>
    `,document.body.appendChild(n)),n.classList.toggle("visible")}function Jt(){Z();const n=Q(),t=U()[n];if(!t){m("No session to export","error");return}const s=JSON.stringify({version:2,exportedAt:new Date().toISOString(),sessionName:n,...t},null,2),o=new Blob([s],{type:"application/json"}),a=URL.createObjectURL(o),l=document.createElement("a");l.href=a;const i=new Date().toISOString().slice(0,10),c=n.replace(/[^a-zA-Z0-9_-]/g,"_");l.download=`session-${c}-${i}.json`,l.click(),URL.revokeObjectURL(a),m(`Exported session "${n}"`,"success")}function Kt(){const n=document.createElement("input");n.type="file",n.accept=".json",n.onchange=()=>{const e=n.files[0];if(!e)return;const t=new FileReader;t.onload=s=>{let o;try{o=JSON.parse(s.target.result)}catch{m("Invalid JSON file","error");return}if(!o.layout||!o.panels){m("Invalid session file: missing layout or panels","error");return}const a=U(),l=o.sessionName||"Imported",i=prompt("Session name for imported session:",pe(l,Object.keys(a)));if(!i||!i.trim())return;const c=i.trim();a[c]={layout:o.layout,panels:o.panels,template:o.template||{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[]},layoutAlgorithm:o.layoutAlgorithm,savedAt:o.savedAt||new Date().toISOString()},ie(a),Z(),fe(c),oe(),m(`Imported session "${c}"`,"success"),W()},t.readAsText(e)},n.click()}function Wt(n,e,t){ae=n,F=e,K=t,window.addEventListener("panel-change",We);const s=Q();U()[s]?fe(s):Z(),oe()}let B=null,q=null,le={},D=null,re=null,H=null;function Zt(n){B=n,document.getElementById("app").addEventListener("mousedown",e=>{const t=e.target.closest("[data-panel-id]");t&&(D=t.dataset.panelId)}),document.addEventListener("keydown",e=>{if(!e.target.matches("input, textarea, select")){if(e.ctrlKey&&e.key==="c")e.preventDefault(),Xt();else if(e.ctrlKey&&e.key==="v")e.preventDefault(),Qt();else if(e.key==="Delete"||e.key==="Backspace"){if(D){const t=B().get(D);t&&t.deleteSelected((s,o)=>I(s,o,t.panelEl))}}else if(e.key==="Escape"&&D){const t=B().get(D);t&&t.cy.elements().unselect()}}})}function Ze(n){const e=B().get(n);if(!e)return;const t=e.getSelectedSubgraph();if(!t||t.nodes.length===0&&t.edges.length===0){m("Nothing selected to copy","info");return}q=t,le=e.getRelevantExclusions(t),re="elements",H=null,m(`Copied ${t.nodes.length} node(s), ${t.edges.length} edge(s)`,"success")}function Ve(n){if(!q){m("Clipboard is empty","info");return}const e=B().get(n);if(!e)return;const t=B().get(D),s=t?t.pathTrackingEnabled:!1,o=`paste → ${e.id}`,a=e.pasteSubgraph(q,o,le,s);a.ok?m("Pasted subgraph","success"):m(a.error,"error")}function Vt(n,e){const t=B().get(n);if(!t)return;const s=Oe(t.graph,e);if(s.nodes.length===0){m("No ancestors found","info");return}q=s,le=t.getRelevantExclusions(s),re="branch",H=e,t.selectBranch(e),m(`Copied branch from "${e}" (${s.nodes.length} node(s), ${s.edges.length} edge(s))`,"success")}function Yt(n,e){if(!q||re!=="branch"||!H){m("No branch in clipboard","info");return}const t=B().get(n);if(!t)return;let s=q;e!==H&&(s={nodes:[...q.nodes],edges:[...q.edges,ot(H,e)]});const o=B().get(D),a=o?o.pathTrackingEnabled:!1,l=`branch paste → ${e}`,i=t.pasteSubgraph(s,l,le,a);i.ok?m(e===H?"Pasted branch (no linking edge)":`Pasted branch with edge ${H} → ${e}`,"success"):m(i.error,"error")}function Ye(){q=null,le={},re=null,H=null,m("Clipboard cleared","info")}function Xe(){return q?{hasContent:!0,mode:re,branchRoot:H,nodeCount:q.nodes.length,edgeCount:q.edges.length}:{hasContent:!1}}function Xt(){if(!D){m("Click a panel first","info");return}Ze(D)}function Qt(){if(!D){m("Click a panel first","info");return}Ve(D)}let O=null;function es(){return O||(O=document.createElement("div"),O.className="context-menu",O.style.display="none",document.body.appendChild(O),document.addEventListener("click",n=>{O.contains(n.target)||he()}),document.addEventListener("touchstart",n=>{O.contains(n.target)||he()}),document.addEventListener("keydown",n=>{n.key==="Escape"&&he()})),O}function xe(n,e,t){const s=es();s.innerHTML="";for(const o of t){if(o.separator){const l=document.createElement("div");l.className="context-menu-separator",s.appendChild(l);continue}const a=document.createElement("button");a.className="context-menu-item",o.disabled&&(a.className+=" context-menu-item-disabled"),a.textContent=o.label,o.disabled||(a.onclick=()=>{he(),o.action()}),s.appendChild(a)}s.style.display="block",s.style.left=`${n}px`,s.style.top=`${e}px`,requestAnimationFrame(()=>{const o=s.getBoundingClientRect();o.right>window.innerWidth&&(s.style.left=`${window.innerWidth-o.width-4}px`),o.bottom>window.innerHeight&&(s.style.top=`${window.innerHeight-o.height-4}px`)})}function he(){O&&(O.style.display="none")}function Se(n){const e=n.originalEvent||n;return e.touches&&e.touches.length>0?{x:e.touches[0].clientX,y:e.touches[0].clientY}:e.changedTouches&&e.changedTouches.length>0?{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}:{x:e.clientX||0,y:e.clientY||0}}function ts(n){const e=[{label:"Add Node",action:()=>He(n)},{label:"Add Edge",action:()=>Be(n)}],t=n.cy.$(":selected"),s=Xe();return(!t.empty()||s.hasContent)&&(e.push({separator:!0}),t.empty()||e.push({label:`Copy Selected (${t.length})`,action:()=>Ze(n.id)}),s.hasContent&&(e.push({label:`Paste (${s.nodeCount}n, ${s.edgeCount}e)`,action:async()=>{await I("Paste Confirmation",`Paste ${s.nodeCount} node(s) and ${s.edgeCount} edge(s)?${s.mode==="branch"?`
Branch root: "${s.branchRoot}"`:""}`,n.panelEl)&&Ve(n.id)}}),e.push({label:"Cancel Copy",action:()=>Ye()}))),t.empty()||(e.push({separator:!0}),e.push({label:`Delete Selected (${t.length})`,action:()=>n.deleteSelected((o,a)=>I(o,a,n.panelEl))})),e.push({separator:!0}),e.push({label:"Select All",action:()=>n.cy.elements().select()}),t.empty()||e.push({label:"Deselect All",action:()=>n.cy.elements().unselect()}),e}function ss(n,e){const t=e.data("label"),s=Xe(),o=[{label:`Edit Node "${t}"`,action:()=>{n.cy.elements().unselect(),e.select(),Re(n)}},{label:`Delete Node "${t}"`,action:()=>{n.cy.elements().unselect(),e.select(),n.deleteSelected((a,l)=>I(a,l,n.panelEl))}}];return n.pathTrackingEnabled&&e.hasClass("node-fully-excluded")&&(o.push({separator:!0}),o.push({label:"Include All Paths",action:()=>{const a=n.graph.edges.filter(l=>l.source===t);for(const l of a){const i=`${l.source}→${l.target}`;if(n.exclusions[i]){const c=[...n.exclusions[i]||[]];for(const r of c)n.includePathTag(i,r)}}}})),o.push({separator:!0}),o.push({label:`Select Branch from "${t}"`,action:()=>n.selectBranch(t)}),o.push({label:`Copy Branch from "${t}"`,action:()=>Vt(n.id,t)}),s.hasContent&&s.mode==="branch"&&o.push({label:`Paste Branch onto "${t}"`,action:async()=>{const a=s.branchRoot!==t?`
Will create edge: ${s.branchRoot} → ${t}`:"";await I("Paste Branch Confirmation",`Paste branch from "${s.branchRoot}" (${s.nodeCount}n, ${s.edgeCount}e)?${a}`,n.panelEl)&&Yt(n.id,t)}}),s.hasContent&&o.push({label:"Cancel Copy",action:()=>Ye()}),o}function ns(n,e){const t=e.data("source"),s=e.data("target"),o=`${t}→${s}`,a=[{label:`Edit Edge "${t} -> ${s}"`,action:()=>{n.cy.elements().unselect(),e.select(),Re(n)}},{label:`Delete Edge "${t} -> ${s}"`,action:()=>{n.cy.elements().unselect(),e.select(),n.deleteSelected((l,i)=>I(l,i,n.panelEl))}}];if(n.pathTrackingEnabled&&n._pathTags){const l=n.template?.specialTypes||[],i=n._pathTags.get(o)||[],c=n._effectiveExclusions?.get(o)||new Set,r=new Set(n.exclusions[o]||[]);if(i.length>0){a.push({separator:!0});const d=u=>A(u,l),p=u=>j(u,l,n.template?.nodeTypes||[]);if(i.length<=6)for(const u of i){const h=d(u),g=r.has(h),f=c.has(h)&&!g,y=p(u);g?a.push({label:`Include ${y}`,action:()=>n.includePathTag(o,h)}):f?a.push({label:`Excluded ${y} (inherited)`,action:()=>qe(n,o)}):a.push({label:`Exclude ${y}`,action:()=>n.excludePathTag(o,h)})}else a.push({label:"Exclusions...",action:()=>qe(n,o)})}}return a}function os(n){n.container.addEventListener("contextmenu",o=>o.preventDefault());const e=o=>{if(o.target!==n.cy)return;const a=Se(o);xe(a.x,a.y,ts(n))};n.cy.on("cxttap",e),n.cy.on("taphold",e);const t=o=>{const a=o.target;if(a.hasClass("diff-removed"))return;const l=Se(o);xe(l.x,l.y,ss(n,a))};n.cy.on("cxttap","node",t),n.cy.on("taphold","node",t);const s=o=>{const a=o.target;if(a.hasClass("diff-removed"))return;const l=Se(o);xe(l.x,l.y,ns(n,a))};n.cy.on("cxttap","edge",s),n.cy.on("taphold","edge",s)}_e.use(st);const P=new Map;function as(n){for(const e of P.values())e.setTemplate(n)}const L=new Lt(document.getElementById("app"),{onPanelCreate(n,e){const t=Ft(),s=new kt(n,e,t);P.set(n,s),os(s)},onPanelDestroy(n){const e=P.get(n);e&&(e.cy.destroy(),P.delete(n))},async onMerge(n,e){const t=P.get(n),s=P.get(e);if(!t||!s)return;const o=`${n}→${e}`,a=L._getStrategy(o),l=a.strategy,i=a.scopeNodes||[];if(l==="none")return;if(t.baseGraph&&!t.isClean()){await Ge("Merge Blocked",`Panel ${n} has unapproved changes. Approve Panel ${n} first, then merge.`,document.querySelector(`.panel[data-panel-id="${e}"]`));return}const c=`${n} → ${e}`,r=s.receiveMerge(t.getGraph(),c,t.exclusions,t.pathTrackingEnabled,l,i);r.ok?m(`Pushed ${c}`,"success"):m(r.error,"error")},getState(n){const e=P.get(n);return e?e.getState():null},setState(n,e){const t=P.get(n);t&&t.setState(e)},async confirmClose(n){return await I("Close Panel?",`Close Panel ${n}? Graph data will be lost.`,document.querySelector(`.panel[data-panel-id="${n}"]`))},getPanels(){return P},onResizeEnd(n){const e=L._allPanelIds(n.children[0]),t=L._allPanelIds(n.children[1]);for(const s of[...e,...t]){const o=P.get(s);o&&o.cy&&(o.cy.resize(),o.cy.fit())}}});document.getElementById("app").addEventListener("click",async n=>{const e=n.target.closest("[data-action]");if(!e)return;const t=e.closest(".panel");if(!t)return;const s=t.dataset.panelId,o=P.get(s);if(o)switch(e.dataset.action){case"add-node":He(o);break;case"add-edge":Be(o);break;case"clear":{await I("Clear Panel?",`Reset Panel ${s} to empty state? This clears the graph, approval history, and all diffs.`,t)&&o.clearGraph();break}case"approve":{await I("Approve Panel?",`This will set the current state of Panel ${s} as the baseline and clear all diffs.`,t)&&o.approve();break}case"undo":o.undo();break;case"redo":o.redo();break;case"changeset":Et(o);break;case"changelog":Ct(o);break;case"refresh":o.cy.resize(),o._runLayout(),o._recomputePathTracking();break;case"restore":{await I("Restore Panel?",`Restore Panel ${s} to last approved state? Current changes will be lost.`,t)&&o.restoreFromApproved();break}case"import":Tt(o);break;case"export":o.exportGraph();break;case"panel-options":Nt(o);break}});L.init();Wt(P,L,n=>{as(n)});Zt(()=>P);zt();requestAnimationFrame(()=>L.updateMergeButtonStates(P));document.addEventListener("keydown",async n=>{if(n.key==="Escape"&&L._zoomedPanelId){L.toggleZoom(L._zoomedPanelId);return}if((n.ctrlKey||n.metaKey)&&n.key==="z"&&!n.shiftKey){n.preventDefault();const e=Array.from(P.values()).find(t=>t.cy.container()===document.activeElement||t.cy.container().contains(document.activeElement));e?e.undo():P.size>0&&P.values().next().value.undo()}if((n.ctrlKey||n.metaKey)&&n.key==="z"&&n.shiftKey){n.preventDefault();const e=Array.from(P.values()).find(t=>t.cy.container()===document.activeElement||t.cy.container().contains(document.activeElement));e?e.redo():P.size>0&&P.values().next().value.redo()}});const is=()=>L.updateMergeButtonStates(P);window.addEventListener("panel-change",is);window.__panels=P;window.__layout=L;
