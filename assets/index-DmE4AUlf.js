import{r as tt,g as st,c as $e}from"./vendor-Cd8GHXwj.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const l of a.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&o(l)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();var nt=tt();const ot=st(nt),J={UCG:{label:"Undirected Cyclic Graph",directed:!1,acyclic:!1},UTree:{label:"Undirected Tree",directed:!1,acyclic:!0,mustBeConnected:!0},DAG:{label:"Directed Acyclic Graph",directed:!0,acyclic:!0},DG:{label:"Directed Graph",directed:!0,acyclic:!1},Forest:{label:"Forest",directed:!1,acyclic:!0}},ee=()=>({name:"Default",graphType:"UCG",nodeTypes:[],edgeTypes:[],specialTypes:[],defaultLayoutAlgorithm:"cose"}),at=(n,e="UCG")=>({name:n,graphType:e,nodeTypes:[],edgeTypes:[],specialTypes:[],defaultLayoutAlgorithm:"cose"}),Oe=[{selector:"node",style:{label:"data(label)","background-color":"#4fc3f7",color:"#e0e0e0","text-valign":"center","text-halign":"center","font-size":"12px",width:40,height:40,"border-width":2,"border-color":"#2a3a5c","text-outline-width":2,"text-outline-color":"#1a1a2e"}},{selector:"edge",style:{width:2,"line-color":"#5a6a8c","target-arrow-color":"#5a6a8c","target-arrow-shape":"triangle","curve-style":"bezier","arrow-scale":.8}},{selector:"node:selected",style:{"border-color":"#fff","border-width":3}},{selector:"edge:selected",style:{"line-color":"#fff","target-arrow-color":"#fff",width:3}},{selector:".edge-excluded",style:{"line-style":"dashed","line-dash-pattern":[6,3]}},{selector:".edge-all-excluded",style:{"line-style":"dotted","line-dash-pattern":[2,4],opacity:.4}},{selector:".node-fully-excluded",style:{"border-style":"dotted","border-width":3,opacity:.5}},{selector:".tracking-hidden",style:{display:"none"}},{selector:".diff-added",style:{"background-color":"#4CAF50","border-color":"#4CAF50","line-color":"#4CAF50","target-arrow-color":"#4CAF50"}},{selector:".diff-removed",style:{"background-color":"#F44336","border-color":"#F44336","line-color":"#F44336","target-arrow-color":"#F44336",opacity:.5,"border-style":"dashed","line-style":"dashed"}},{selector:".diff-modified",style:{"border-color":"#FF9800","border-width":3,"line-color":"#FF9800","target-arrow-color":"#FF9800"}}];function Te(n){const e=[...Oe],t=J[n?.graphType];t&&!t.directed&&e.push({selector:"edge",style:{"target-arrow-shape":"none"}});for(const o of n?.nodeTypes||[])e.push({selector:`node[type = "${o.id}"]`,style:{"background-color":o.color}});for(const o of n?.edgeTypes||[])e.push({selector:`edge[type = "${o.id}"]`,style:{"line-color":o.color,"target-arrow-color":o.color}});return e}const $=n=>JSON.parse(JSON.stringify(n)),ye=()=>({nodes:[],edges:[]}),V=n=>n.label,X=n=>`${n.source}→${n.target}`,it=(n,e,t={},o=null)=>({source:n,target:e,type:o,props:{...t}}),we=n=>n.nodes.length===0&&n.edges.length===0,Ie=(n,e)=>{const t=new Set,o=[e];for(;o.length>0;){const s=o.shift();if(!t.has(s)){t.add(s);for(const a of n.edges)a.target===s&&!t.has(a.source)&&o.push(a.source)}}return{nodes:n.nodes.filter(s=>t.has(s.label)).map(s=>$(s)),edges:n.edges.filter(s=>t.has(s.source)&&t.has(s.target)).map(s=>$(s))}};function R(n,e){if(!n)return[];const t=[],o=new Map(n.nodes.map(i=>[V(i),i])),s=new Map(e.nodes.map(i=>[V(i),i])),a=new Map(n.edges.map(i=>[X(i),i])),l=new Map(e.edges.map(i=>[X(i),i]));for(const[i,r]of s)if(!o.has(i))t.push({type:"node",action:"added",key:i,oldProps:null,newProps:r.props});else{const c=o.get(i);Ee(c.props,r.props)||t.push({type:"node",action:"modified",key:i,oldProps:c.props,newProps:r.props})}for(const[i,r]of o)s.has(i)||t.push({type:"node",action:"removed",key:i,oldProps:r.props,newProps:null});for(const[i,r]of l)if(!a.has(i))t.push({type:"edge",action:"added",key:i,oldProps:null,newProps:r.props});else{const c=a.get(i);Ee(c.props,r.props)||t.push({type:"edge",action:"modified",key:i,oldProps:c.props,newProps:r.props})}for(const[i,r]of a)l.has(i)||t.push({type:"edge",action:"removed",key:i,oldProps:r.props,newProps:null});return t}function Ee(n,e){const t=Object.keys(n),o=Object.keys(e);return t.length!==o.length?!1:t.every(s=>n[s]===e[s])}function lt(n,e){if(!e||e.length===0)return n;const t=new Set(e),o=[...e];for(;o.length>0;){const s=o.shift();for(const a of n.edges)a.target===s&&!t.has(a.source)&&(t.add(a.source),o.push(a.source))}return{nodes:n.nodes.filter(s=>t.has(s.label)),edges:n.edges.filter(s=>t.has(s.source)&&t.has(s.target))}}function Ce(n,e,t=null){const o=new Map(n.nodes.map(a=>[V(a),$(a)])),s=new Map(n.edges.map(a=>[X(a),$(a)]));for(const a of e.nodes){const l=V(a);o.has(l)?o.get(l).props={...a.props}:o.set(l,$(a))}for(const a of e.edges){const l=X(a);s.has(l)?s.get(l).props={...a.props}:s.set(l,$(a))}if(t){const a=new Set(e.nodes.map(r=>V(r))),l=new Set(e.edges.map(r=>X(r)));for(const r of t.nodes){const c=V(r);a.has(c)||o.delete(c)}for(const r of t.edges){const c=X(r);l.has(c)||s.delete(c)}const i=new Set(o.keys());for(const[r,c]of s)(!i.has(c.source)||!i.has(c.target))&&s.delete(r)}return{nodes:[...o.values()],edges:[...s.values()]}}function rt(n){if(!n||typeof n!="object")return{ok:!1,error:"Invalid data: expected an object"};if(!Array.isArray(n.nodes))return{ok:!1,error:"Invalid data: missing nodes array"};if(!Array.isArray(n.edges))return{ok:!1,error:"Invalid data: missing edges array"};const e=new Set;for(const o of n.nodes){if(!o.label||typeof o.label!="string")return{ok:!1,error:"Invalid node: missing or invalid label"};if(e.has(o.label))return{ok:!1,error:`Duplicate node label: "${o.label}"`};if(e.add(o.label),o.props&&typeof o.props!="object")return{ok:!1,error:`Invalid props on node "${o.label}"`}}for(const o of n.edges){if(!o.source||!o.target)return{ok:!1,error:"Invalid edge: missing source or target"};if(!e.has(o.source))return{ok:!1,error:`Edge references unknown source: "${o.source}"`};if(!e.has(o.target))return{ok:!1,error:`Edge references unknown target: "${o.target}"`};if(o.props&&typeof o.props!="object")return{ok:!1,error:`Invalid props on edge "${o.source}→${o.target}"`}}return{ok:!0,graph:{nodes:n.nodes.map(o=>({label:o.label,type:o.type||null,props:o.props||{}})),edges:n.edges.map(o=>({source:o.source,target:o.target,type:o.type||null,props:o.props||{}}))}}}const ct=n=>JSON.stringify(n,null,2);function dt(n){try{const e=JSON.parse(n);return rt(e)}catch(e){return{ok:!1,error:`Invalid JSON: ${e.message}`}}}function ut(n,e="graph.json"){const t=new Blob([ct(n)],{type:"application/json"}),o=URL.createObjectURL(t),s=document.createElement("a");s.href=o,s.download=e,s.click(),URL.revokeObjectURL(o)}function pt(){return new Promise(n=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async()=>{const t=e.files[0];if(!t)return n({ok:!1,error:"No file selected"});try{const o=await t.text();n(dt(o))}catch(o){n({ok:!1,error:`Failed to read file: ${o.message}`})}},e.click()})}function y(n,e="info",t=3e3){const o=document.getElementById("toast-container"),s=document.createElement("div");s.className=`toast toast-${e}`,s.textContent=n,o.appendChild(s),setTimeout(()=>{s.style.opacity="0",s.style.transition="opacity 0.3s",setTimeout(()=>s.remove(),300)},t)}function ht(n,e,t){const o=new Set,s=[t];for(;s.length>0;){const a=s.shift();if(a===e)return!0;if(!o.has(a)){o.add(a);for(const l of n.edges)l.source===a&&!o.has(l.target)&&s.push(l.target)}}return!1}function gt(n,e,t){const o=new Set,s=[e];for(;s.length>0;){const a=s.shift();if(a===t)return!0;if(!o.has(a)){o.add(a);for(const l of n.edges)l.source===a&&!o.has(l.target)&&s.push(l.target),l.target===a&&!o.has(l.source)&&s.push(l.source)}}return!1}function ft(n,e,t,o){return o?ht(n,e,t):gt(n,e,t)}function ze(n){if(n.nodes.length===0)return!0;const e=new Set,t=[n.nodes[0].label];for(;t.length>0;){const o=t.shift();if(!e.has(o)){e.add(o);for(const s of n.edges)s.source===o&&!e.has(s.target)&&t.push(s.target),s.target===o&&!e.has(s.source)&&t.push(s.source)}}return e.size===n.nodes.length}function mt(n,e){const t={nodes:n.nodes.filter(o=>o.label!==e),edges:n.edges.filter(o=>o.source!==e&&o.target!==e)};return t.nodes.length>1&&!ze(t)}function yt(n,e,t){const o={nodes:[...n.nodes],edges:n.edges.filter(s=>!(s.source===e&&s.target===t))};return!ze(o)}function bt(n,e,t){return n.edges.some(o=>o.source===e&&o.target===t||o.source===t&&o.target===e)}function vt(n,e,t,o){const s=J[o];return s?e===t?{ok:!1,error:"Self-loops are not allowed"}:!s.directed&&bt(n,e,t)?{ok:!1,error:`Edge ${e}–${t} already exists`}:s.directed&&n.edges.some(a=>a.source===e&&a.target===t)?{ok:!1,error:`Edge ${e}→${t} already exists`}:s.acyclic&&ft(n,e,t,s.directed)?{ok:!1,error:`Adding this edge would create a cycle (${s.label} must be acyclic)`}:{ok:!0}:{ok:!0}}function xt(n,e){if(e){const t=new Set,o=new Set,s=a=>{t.add(a),o.add(a);for(const l of n.edges)if(l.source===a&&(o.has(l.target)||!t.has(l.target)&&s(l.target)))return!0;return o.delete(a),!1};for(const a of n.nodes)if(!t.has(a.label)&&s(a.label))return!0;return!1}else{const t={};for(const s of n.nodes)t[s.label]=s.label;const o=s=>(t[s]!==s&&(t[s]=o(t[s])),t[s]);for(const s of n.edges){const a=o(s.source),l=o(s.target);if(a===l)return!0;t[a]=l}return!1}}function St(n){const e=new Map,t=new Map;for(const i of n.nodes)e.set(i.label,[]),t.set(i.label,0);for(const i of n.edges){const r=e.get(i.source);r&&r.push(i.target),t.set(i.target,(t.get(i.target)||0)+1)}const o=new Map;for(const i of n.nodes)o.set(i.label,0);for(const i of n.edges)o.set(i.source,(o.get(i.source)||0)+1);const s=[];for(const i of n.nodes)o.get(i.label)===0&&s.push(i.label);const a=[],l=new Set;for(;s.length>0;){const i=s.shift();if(!l.has(i)){l.add(i),a.push(i);for(const r of n.edges)if(r.target===i){const c=r.source;o.set(c,(o.get(c)||1)-1),o.get(c)===0&&s.push(c)}}}for(const i of n.nodes)l.has(i.label)||a.push(i.label);return a}function kt(n,e){if(!e||e.length===0)return new Map;const t=new Map(n.nodes.map(i=>[i.label,i])),o=new Map(n.nodes.map(i=>[i.label,[]]));for(const i of n.edges){const r=o.get(i.source);r&&r.push(i.target)}const s=St(n),a=new Map;for(const i of s){const r=t.get(i);if(!r)continue;const c=o.get(i)||[];let u;if(c.length===0)r.type&&e.includes(r.type)?u=[{[r.type]:i}]:u=[{}];else{u=[];for(const p of c){const h=a.get(p)||[{}];u.push(...h)}const d=new Set;u=u.filter(p=>{const h=L(p,e);return d.has(h)?!1:(d.add(h),!0)}),r.type&&e.includes(r.type)&&(u=u.map(p=>({...p,[r.type]:i})))}a.set(i,u)}const l=new Map;for(const i of n.edges){const r=`${i.source}→${i.target}`;l.set(r,a.get(i.target)||[{}])}return l}function Pe(n,e,t,o=[]){const s=new Map;for(const[r,c]of Object.entries(e)){const u=Array.isArray(c)?new Set(c):new Set(Object.keys(c).length?[c]:[]);u.size>0&&s.set(r,u)}if(!t||t.size===0)return s;const a=new Map;for(const r of n.nodes)a.set(r.label,[]);for(const r of n.edges){const c=a.get(r.target);c&&c.push(r.source)}const l=[];for(const[r,c]of s){const[u]=r.split("→");l.push({target:u,tags:new Set(c)})}const i=new Set;for(;l.length>0;){const{target:r,tags:c}=l.shift(),u=`${r}:${[...c].sort().join(",")}`;if(!i.has(u)){i.add(u);for(const d of a.get(r)||[]){const p=`${d}→${r}`,h=t.get(p);if(!h)continue;const f=new Set(h.map(k=>L(k,o))),x=new Set([...c].filter(k=>f.has(k)));if(x.size>0){const k=s.get(p)||new Set,g=new Set([...k,...x]);s.set(p,g),l.push({target:d,tags:x})}}}}return s}function _t(n,e,t,o,s=[]){const a=n.edges.filter(l=>l.source===e);if(a.length===0)return!1;for(const l of a){const i=`${l.source}→${l.target}`,r=t.get(i)||[],c=o.get(i)||new Set;for(const u of r){const d=L(u,s);if(!c.has(d))return!1}}return!0}function de(n,e,t){if(!t||!e)return{...n};const o={...n};for(const[s,a]of Object.entries(e))if(o[s]){const l=new Set([...o[s],...a]);o[s]=[...l]}else o[s]=[...a];return o}function j(n,e,t){const o=[];for(const s of e)n[s]&&o.push(n[s]);return o.length===0?"(any)":`(${o.join(", ")})`}function L(n,e){return e.map(t=>n[t]||"").join("|")}function Ne(n){const e={an:0,mn:0,rn:0,ae:0,me:0,re:0};for(const o of n){const s=o.type==="node";o.action==="added"?s?e.an++:e.ae++:o.action==="modified"?s?e.mn++:e.me++:o.action==="removed"&&(s?e.rn++:e.re++)}const t=[];return e.an&&t.push(`+${e.an}n`),e.mn&&t.push(`~${e.mn}n`),e.rn&&t.push(`-${e.rn}n`),e.ae&&t.push(`+${e.ae}e`),e.me&&t.push(`~${e.me}e`),e.re&&t.push(`-${e.re}e`),t.join(" ")}function je(n){if(n.length===0)return"No changes.";const e={addedNodes:[],removedNodes:[],modifiedNodes:[],addedEdges:[],removedEdges:[],modifiedEdges:[]};for(const o of n)o.type==="node"?o.action==="added"?e.addedNodes.push(o.key):o.action==="removed"?e.removedNodes.push(o.key):o.action==="modified"&&e.modifiedNodes.push({key:o.key,changes:o.changes}):o.action==="added"?e.addedEdges.push(o.key):o.action==="removed"?e.removedEdges.push(o.key):o.action==="modified"&&e.modifiedEdges.push({key:o.key,changes:o.changes});const t=[];if(e.addedNodes.length){const o=e.addedNodes.length;t.push(`Added ${o} node${o>1?"s":""}: ${e.addedNodes.join(", ")}`)}if(e.removedNodes.length){const o=e.removedNodes.length;t.push(`Removed ${o} node${o>1?"s":""}: ${e.removedNodes.join(", ")}`)}if(e.modifiedNodes.length){const o=e.modifiedNodes.map(({key:a,changes:l})=>{const i=l&&l.length?`(${l.map(r=>r.key).join(", ")} changed)`:"";return i?`${a} ${i}`:a}),s=e.modifiedNodes.length;t.push(`Modified ${s} node${s>1?"s":""}: ${o.join(", ")}`)}if(e.addedEdges.length){const o=e.addedEdges.length;t.push(`Added ${o} edge${o>1?"s":""}: ${e.addedEdges.join(", ")}`)}if(e.removedEdges.length){const o=e.removedEdges.length;t.push(`Removed ${o} edge${o>1?"s":""}: ${e.removedEdges.join(", ")}`)}if(e.modifiedEdges.length){const o=e.modifiedEdges.map(({key:a,changes:l})=>{const i=l&&l.length?`(${l.map(r=>r.key).join(", ")} changed)`:"";return i?`${a} ${i}`:a}),s=e.modifiedEdges.length;t.push(`Modified ${s} edge${s>1?"s":""}: ${o.join(", ")}`)}return t.join(". ")+"."}class $t{constructor(e,t,o=null){this.id=e,this.graph=ye(),this.baseGraph=null,this.mergeDirection=null,this.lastApproval=null,this.container=t,this.template=o||ee(),this.layoutAlgorithm="fcose",this.pathTrackingEnabled=!1,this.showExclusions=!0,this.exclusions={},this._pathTags=null,this._effectiveExclusions=null,this._history=[],this._redoStack=[],this._maxHistory=10,this._approvalHistory=[],this._maxApprovalHistory=20,this._processingCount=0,this.cy=$e({container:t,elements:[],style:Te(this.template),layout:{name:"grid"},selectionType:"additive"}),this._tooltip=null,this._trackingOverlay=null,this.cy.on("mouseover","edge",s=>{const l=s.target.data("pathTagsTooltip");!l||!this.pathTrackingEnabled||this._showTooltip(s.originalEvent,l)}),this.cy.on("mouseout","edge",()=>this._hideTooltip()),this.cy.on("pan zoom",()=>this._hideTooltip()),this._updateHeader()}setTemplate(e){this.template=e,this.cy.style().fromJson(Te(e)).update()}get panelEl(){return this.container.closest("[data-panel-id]")}getGraph(){return $(this.graph)}getBaseGraph(){return this.baseGraph?$(this.baseGraph):null}getState(){return{id:this.id,graph:$(this.graph),baseGraph:this.baseGraph?$(this.baseGraph):null,mergeDirection:this.mergeDirection,lastApproval:this.lastApproval,layoutAlgorithm:this.layoutAlgorithm,pathTrackingEnabled:this.pathTrackingEnabled,showExclusions:this.showExclusions,exclusions:$(this.exclusions),_history:this._history.map(e=>$(e)),_redoStack:this._redoStack.map(e=>$(e)),_approvalHistory:this._approvalHistory.map(e=>({graph:$(e.graph),baseGraph:e.baseGraph?$(e.baseGraph):null,timestamp:e.timestamp,diffSummary:e.diffSummary,exclusions:$(e.exclusions||{})}))}}setState(e){this.graph=e.graph||ye(),this.baseGraph=e.baseGraph||null,this.mergeDirection=e.mergeDirection||null,this.lastApproval=e.lastApproval||null,this.layoutAlgorithm=e.layoutAlgorithm||"fcose",this.pathTrackingEnabled=e.pathTrackingEnabled||!1,this.showExclusions=e.showExclusions??!0,this.exclusions=$(e.exclusions||{}),this._history=e._history?e._history.map(t=>$(t)):[],this._redoStack=e._redoStack?e._redoStack.map(t=>$(t)):[],this._approvalHistory=e._approvalHistory?e._approvalHistory.map(t=>({graph:$(t.graph),baseGraph:t.baseGraph?$(t.baseGraph):null,timestamp:t.timestamp,diffSummary:t.diffSummary,exclusions:$(t.exclusions||{})})):[],this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader()}loadGraph(e){this.graph=$(e),this._syncCytoscape(),this._applyDiffClasses(),this._updateHeader(),this._emitChange()}addNode(e,t={},o=null){return this.graph.nodes.some(s=>s.label===e)?(y(`Node "${e}" already exists`,"error"),!1):(this._pushHistory(),this.graph={nodes:[...this.graph.nodes,{label:e,type:o,props:{...t}}],edges:[...this.graph.edges]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),!0)}addEdge(e,t,o={},s=null){if(!this.graph.nodes.some(i=>i.label===e))return y(`Source node "${e}" not found`,"error"),!1;if(!this.graph.nodes.some(i=>i.label===t))return y(`Target node "${t}" not found`,"error"),!1;const a=this.template?.graphType||"DG",l=vt(this.graph,e,t,a);return l.ok?(this._pushHistory(),this.graph={nodes:[...this.graph.nodes],edges:[...this.graph.edges,{source:e,target:t,type:s,props:{...o}}]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),!0):(y(l.error,"error"),!1)}updateNodeProps(e,t,o=void 0){this._pushHistory(),this.graph={nodes:this.graph.nodes.map(s=>s.label!==e?s:o!==void 0?{...s,props:{...t},type:o}:{...s,props:{...t}}),edges:[...this.graph.edges]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}updateEdgeProps(e,t,o,s=void 0){this._pushHistory(),this.graph={nodes:[...this.graph.nodes],edges:this.graph.edges.map(a=>a.source===e&&a.target===t?s!==void 0?{...a,props:{...o},type:s}:{...a,props:{...o}}:a)},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}async deleteSelected(e=null){const t=this.cy.$(":selected");if(t.empty()){y("Nothing selected","info");return}const o=this.template?.graphType||"DG",s=J[o],a=new Set;t.nodes().forEach(c=>a.add(c.data("label")));const l=new Set;if(t.edges().forEach(c=>l.add(`${c.data("source")}→${c.data("target")}`)),s?.mustBeConnected&&e){let c=!1;for(const u of a)if(mt(this.graph,u)){c=!0;break}if(!c)for(const u of l){const[d,p]=u.split("→");if(yt(this.graph,d,p)){c=!0;break}}if(c&&!await e("Disconnect Warning","Deleting this would disconnect the tree. Proceed anyway?"))return}this._pushHistory();const i=new Set([...l]);this.graph.edges.forEach(c=>{(a.has(c.source)||a.has(c.target))&&i.add(`${c.source}→${c.target}`)}),this.graph={nodes:this.graph.nodes.filter(c=>!a.has(c.label)),edges:this.graph.edges.filter(c=>!(l.has(`${c.source}→${c.target}`)||a.has(c.source)||a.has(c.target)))};const r={...this.exclusions};for(const c of i)delete r[c];this.exclusions=r,this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}clearGraph(){this._pushHistory(),this.graph=ye(),this.baseGraph=null,this.mergeDirection=null,this.lastApproval=null,this.exclusions={},this._approvalHistory=[],this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}approve(){let e="(initial)";if(this.baseGraph){const t=R(this.baseGraph,this.graph);e=t.length>0?Ne(t):"(no changes)"}this._approvalHistory.push({graph:$(this.graph),baseGraph:this.baseGraph?$(this.baseGraph):null,timestamp:new Date().toISOString(),diffSummary:e,exclusions:$(this.exclusions)}),this._approvalHistory.length>this._maxApprovalHistory&&this._approvalHistory.shift(),this.baseGraph=$(this.graph),this.mergeDirection=null,this.lastApproval=new Date().toISOString(),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._clearDiffClasses(),this._updateHeader(),this._emitChange(),y(`Panel ${this.id} approved`,"success")}receiveMerge(e,t,o=null,s=!1,a="mirror",l=[]){if(we(this.graph)&&!this.baseGraph)return this.graph=$(e),this.baseGraph=$(e),this.lastApproval=new Date().toISOString(),this.mergeDirection=null,o&&(this.exclusions=de(this.exclusions,o,s)),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),{ok:!0};this._pushHistory();const i=a==="scoped"&&l.length>0?lt(e,l):e,r=a==="push"||a==="sync"?null:this.baseGraph;this.graph=Ce(this.graph,i,r),this.mergeDirection=t,o&&(this.exclusions=de(this.exclusions,o,s)),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange();const c=J[this.template?.graphType];return c?.acyclic&&xt(this.graph,c.directed)&&y(`Warning: merge introduced a cycle in ${c.label}`,"warning"),{ok:!0}}pasteSubgraph(e,t,o=null,s=!1){return we(this.graph)&&!this.baseGraph?(this.graph=$(e),this.baseGraph=$(e),this.lastApproval=new Date().toISOString(),this.mergeDirection=null,o&&(this.exclusions=de(this.exclusions,o,s)),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()):(this._pushHistory(),this.graph=Ce(this.graph,e,null),this.mergeDirection=t,o&&(this.exclusions=de(this.exclusions,o,s)),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()),{ok:!0}}selectBranch(e){const t=Ie(this.graph,e);this.cy.elements().unselect();for(const o of t.nodes)this.cy.$id(o.label).select();for(const o of t.edges)this.cy.$id(`${o.source}→${o.target}`).select()}exportGraph(){ut(this.graph,`panel-${this.id}.json`)}undo(){if(this._history.length===0)return y("Nothing to undo","info"),!1;this._redoStack.push({graph:$(this.graph),exclusions:$(this.exclusions)});const e=this._history.pop();return this.graph=this._historyGraph(e),this.exclusions=this._historyExclusions(e),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),y("Undo","info"),!0}redo(){if(this._redoStack.length===0)return y("Nothing to redo","info"),!1;this._history.push({graph:$(this.graph),exclusions:$(this.exclusions)}),this._history.length>this._maxHistory&&this._history.shift();const e=this._redoStack.pop();return this.graph=this._historyGraph(e),this.exclusions=this._historyExclusions(e),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),y("Redo","info"),!0}restoreFromApproved(){if(!this.baseGraph)return y("No approved state to restore","info"),!1;this._pushHistory(),this.graph=$(this.baseGraph);const e=this._approvalHistory[this._approvalHistory.length-1];return this.exclusions=e?.exclusions?$(e.exclusions):{},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),y(`Panel ${this.id} restored to approved state`,"success"),!0}getSelectedSubgraph(){const e=this.cy.$(":selected");if(e.empty())return null;const t=new Set,o=[];e.nodes().forEach(a=>{t.add(a.data("label"));const l=this.graph.nodes.find(i=>i.label===a.data("label"));l&&o.push($(l))});const s=[];return e.edges().forEach(a=>{const l=a.data("source"),i=a.data("target");if(t.has(l)&&t.has(i)){const r=this.graph.edges.find(c=>c.source===l&&c.target===i);r&&s.push($(r))}}),{nodes:o,edges:s}}isClean(){return this.baseGraph?R(this.baseGraph,this.graph).length===0:!0}_pushHistory(){this._history.push({graph:$(this.graph),exclusions:$(this.exclusions)}),this._history.length>this._maxHistory&&this._history.shift(),this._redoStack=[]}_historyGraph(e){return e&&e.graph?e.graph:e}_historyExclusions(e){return e&&e.exclusions?e.exclusions:{}}_syncCytoscape(){const e=[];for(const t of this.graph.nodes)e.push({group:"nodes",data:{id:t.label,label:t.label,type:t.type||null,...this._flattenProps(t.props,"p_")}});for(const t of this.graph.edges)e.push({group:"edges",data:{id:`${t.source}→${t.target}`,source:t.source,target:t.target,type:t.type||null,...this._flattenProps(t.props,"p_")}});if(this.baseGraph){const t=new Set(this.graph.nodes.map(s=>s.label)),o=new Set(this.graph.edges.map(s=>`${s.source}→${s.target}`));for(const s of this.baseGraph.nodes)t.has(s.label)||e.push({group:"nodes",data:{id:s.label,label:s.label},classes:"diff-removed"});for(const s of this.baseGraph.edges){const a=`${s.source}→${s.target}`;if(!o.has(a)){const l=new Set([...t,...this.baseGraph.nodes.map(i=>i.label)]);l.has(s.source)&&l.has(s.target)&&e.push({group:"edges",data:{id:a,source:s.source,target:s.target},classes:"diff-removed"})}}}this.cy.elements().remove(),this.cy.add(e),this._runLayout()}_applyDiffClasses(){if(!this.baseGraph)return;const e=R(this.baseGraph,this.graph);this.cy.elements().removeClass("diff-added diff-modified");for(const t of e){if(t.action==="removed")continue;const o=(t.type==="node",t.key),s=this.cy.$id(o);s.length&&s.addClass(`diff-${t.action}`)}this._updateDiffOverlay()}_clearDiffClasses(){this.cy.elements().removeClass("diff-added diff-removed diff-modified"),this.cy.$(".diff-removed").remove(),this._updateDiffOverlay()}_updateHeader(){const e=this.panelEl?.querySelector(".panel-info");if(!e)return;const t=[];if(this.mergeDirection&&t.push(`<span class="merge-direction">${this.mergeDirection}</span>`),this.baseGraph&&!this.isClean()){const o=R(this.baseGraph,this.graph).length;t.push(`${o} change${o!==1?"s":""}`)}e.innerHTML=t.join(" · "),this._updateApprovalOverlay()}_updateApprovalOverlay(){let e=this.container.querySelector(".approval-indicator");if(e||(e=document.createElement("div"),e.className="approval-indicator",this.container.appendChild(e)),this.lastApproval){const t=new Date(this.lastApproval).toLocaleTimeString();e.textContent=`✓ ${t}`}else e.textContent=""}_flattenProps(e,t){const o={};for(const[s,a]of Object.entries(e))o[`${t}${s}`]=a;return o}setLayoutAlgorithm(e){this.layoutAlgorithm=e,this._runLayout(),this._emitChange()}_runLayout(){if(this.cy.elements().length===0)return;const e=this.layoutAlgorithm||"fcose";if(e==="level-by-level"){this._runLevelLayout();return}this.cy.layout({name:this.cy.nodes().length>1?e:"grid",animate:!1,fit:!0,padding:20}).run()}_runLevelLayout(){const e=this.cy.nodes();if(e.length===0)return;const t=e.filter(u=>u.outgoers("edge").length===0),o=t.length>0?t:e,s=new Map,a=[];for(o.forEach(u=>{s.set(u.id(),0),a.push(u.id())});a.length>0;){const u=a.shift(),d=s.get(u);this.cy.$id(u).incomers("edge").forEach(p=>{const h=p.source().id();(!s.has(h)||s.get(h)<d+1)&&(s.set(h,d+1),a.push(h))})}e.forEach(u=>{s.has(u.id())||s.set(u.id(),0)});const l=new Map;for(const[u,d]of s)l.has(d)||l.set(d,[]),l.get(d).push(u);const i=80,r=80,c={};for(const[u,d]of l){const p=u*i,f=-((d.length-1)*r)/2;d.forEach((x,k)=>{c[x]={x:f+k*r,y:p}})}this.cy.layout({name:"preset",positions:u=>c[u.id()]||{x:0,y:0},animate:!1,fit:!0,padding:20}).run()}_updateDiffOverlay(){const e=this.container.parentElement?.querySelector(`.diff-overlay[data-panel-diff="${this.id}"]`);if(!e)return;if(!this.baseGraph){e.classList.remove("visible");return}const t=R(this.baseGraph,this.graph);if(t.length===0){e.classList.remove("visible");return}e.textContent=Ne(t),e.classList.add("visible")}setPathTracking(e){this.pathTrackingEnabled=e,e?this._recomputePathTrackingAsync():(this._pathTags=null,this._effectiveExclusions=null,this._clearTrackingVisuals()),this._updateTrackingOverlay(),this._emitChange()}setShowExclusions(e){this.showExclusions=e,this._applyExclusionVisibility(),this._emitChange()}excludePathTag(e,t){this._pushHistory();const o=this.exclusions[e]||[];o.includes(t)||(this.exclusions={...this.exclusions,[e]:[...o,t]}),this._recomputePathTrackingAsync(),this._emitChange()}includePathTag(e,t){this._pushHistory();const s=(this.exclusions[e]||[]).filter(l=>l!==t),a={...this.exclusions};s.length===0?delete a[e]:a[e]=s,this.exclusions=a,this._recomputePathTrackingAsync(),this._emitChange()}getRelevantExclusions(e){const t=new Set(e.edges.map(s=>`${s.source}→${s.target}`)),o={};for(const[s,a]of Object.entries(this.exclusions))t.has(s)&&(o[s]=a);return o}_cleanupStaleExclusions(){if(!this._pathTags)return;const e=this.template?.specialTypes||[],t={};for(const[o,s]of Object.entries(this.exclusions)){const a=this._pathTags.get(o);if(!a||a.length===0)continue;const l=new Set(a.map(r=>L(r,e))),i=s.filter(r=>l.has(r));i.length>0&&(t[o]=i)}this.exclusions=t}_setProcessing(e){this._processingCount=e?this._processingCount+1:Math.max(0,this._processingCount-1),this.panelEl?.classList.toggle("processing",this._processingCount>0)}async _recomputePathTrackingAsync(){if(this.pathTrackingEnabled){this._setProcessing(!0),await new Promise(e=>setTimeout(e,0));try{this._recomputePathTracking()}finally{this._setProcessing(!1)}}}_recomputePathTracking(){if(!this.pathTrackingEnabled)return;const e=this.template?.specialTypes||[];e.length!==0&&(this._pathTags=kt(this.graph,e),this._effectiveExclusions=Pe(this.graph,this.exclusions,this._pathTags,e),this._cleanupStaleExclusions(),this._effectiveExclusions=Pe(this.graph,this.exclusions,this._pathTags,e),this._applyTrackingVisuals(),this._updateTrackingOverlay(),this._flashTrackingIndicator())}_flashTrackingIndicator(){const e=this.panelEl?.querySelector(".panel-info");e&&(e.classList.remove("tracking-flash"),e.offsetWidth,e.classList.add("tracking-flash"),setTimeout(()=>e.classList.remove("tracking-flash"),300))}_applyTrackingVisuals(){if(!this.pathTrackingEnabled||!this._pathTags)return;const e=this.template?.specialTypes||[];this.cy.edges().removeClass("edge-excluded edge-all-excluded"),this.cy.nodes().removeClass("node-fully-excluded");for(const t of this.graph.edges){const o=`${t.source}→${t.target}`,s=this._pathTags.get(o)||[],a=this._effectiveExclusions?.get(o)||new Set,l=this.cy.$id(o);if(l.empty())continue;const i=s.filter(u=>!a.has(L(u,e))),r=s.filter(u=>a.has(L(u,e))),c=[];i.length&&c.push("Included: "+i.map(u=>j(u,e,this.template?.nodeTypes)).join(", ")),r.length&&c.push("Excluded: "+r.map(u=>j(u,e,this.template?.nodeTypes)).join(", ")),l.data("pathTagsTooltip",c.join(`
`)||"(no tags)"),a.size>0&&l.addClass("edge-excluded"),s.length>0&&r.length===s.length&&l.addClass("edge-all-excluded")}for(const t of this.graph.nodes)_t(this.graph,t.label,this._pathTags,this._effectiveExclusions||new Map,e)&&this.cy.$id(t.label).addClass("node-fully-excluded");this._applyExclusionVisibility()}_applyExclusionVisibility(){this.pathTrackingEnabled&&(this.showExclusions?this.cy.elements().removeClass("tracking-hidden"):(this.cy.nodes(".node-fully-excluded").addClass("tracking-hidden"),this.cy.edges(".edge-all-excluded").addClass("tracking-hidden")))}_clearTrackingVisuals(){this.cy.elements().removeClass("edge-excluded edge-all-excluded node-fully-excluded tracking-hidden"),this.cy.edges().data("pathTagsTooltip",null),this._removeTrackingOverlay()}_showTooltip(e,t){this._tooltip||(this._tooltip=document.createElement("div"),this._tooltip.className="path-tooltip",this.container.appendChild(this._tooltip)),this._tooltip.textContent=t,this._tooltip.style.display="block";const o=this.container.getBoundingClientRect();this._tooltip.style.left=`${e.clientX-o.left+12}px`,this._tooltip.style.top=`${e.clientY-o.top-8}px`}_hideTooltip(){this._tooltip&&(this._tooltip.style.display="none")}_ensureTrackingOverlay(){if(this._trackingOverlay)return;const e=document.createElement("div");e.className="tracking-overlay",e.innerHTML='<label><input type="checkbox" class="show-exclusions-cb"> Show exclusions</label>',this.container.appendChild(e),e.querySelector(".show-exclusions-cb").addEventListener("change",t=>{this.setShowExclusions(t.target.checked)}),this._trackingOverlay=e}_removeTrackingOverlay(){this._trackingOverlay&&(this._trackingOverlay.remove(),this._trackingOverlay=null)}_updateTrackingOverlay(){if(this.pathTrackingEnabled){this._ensureTrackingOverlay();const e=this._trackingOverlay?.querySelector(".show-exclusions-cb");e&&(e.checked=this.showExclusions)}else this._removeTrackingOverlay()}_emitChange(){window.dispatchEvent(new CustomEvent("panel-change",{detail:{panelId:this.id}}))}}let be=null,ve=null;function Tt(n){const e=[];for(const t of n.split(",")){const o=t.trim();if(!o)continue;const s=o.match(/^(.+?)(\d+)-(\d+)$/);if(s){const[,a,l,i]=s,r=parseInt(l,10),c=parseInt(i,10);if(r<=c&&c-r<100){for(let u=r;u<=c;u++)e.push(`${a}${u}`);continue}}e.push(o)}return e}function wt(n,e){const t=(o,s)=>{const a=n.getBoundingClientRect(),l=o-a.left,i=s-a.top;return(c,u)=>{n.style.position="fixed",n.style.margin="0",n.style.transform="none",n.style.left=`${Math.max(0,c-l)}px`,n.style.top=`${Math.max(0,u-i)}px`}};e.addEventListener("mousedown",o=>{if(o.target.closest("button, input, select, textarea"))return;o.preventDefault();const s=t(o.clientX,o.clientY),a=i=>s(i.clientX,i.clientY),l=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",l)}),e.addEventListener("touchstart",o=>{if(o.target.closest("button, input, select, textarea"))return;o.preventDefault();const s=o.touches[0],a=t(s.clientX,s.clientY),l=r=>{r.preventDefault();const c=r.touches[0];a(c.clientX,c.clientY)},i=()=>{document.removeEventListener("touchmove",l),document.removeEventListener("touchend",i)};document.addEventListener("touchmove",l,{passive:!1}),document.addEventListener("touchend",i)},{passive:!1})}let ue=null;function Ge(){return ue||(ue=document.createElement("dialog"),document.body.appendChild(ue)),ue}let se=null;function ke(n){n&&n.querySelectorAll(".panel-overlay").forEach(e=>e.remove())}function N(n,e=null){const t=Ge();if(t.className="",t.innerHTML=n,e){ke(e);const s=document.createElement("div");s.className="panel-overlay",e.insertBefore(s,e.firstChild),se=e;const a=()=>{ke(e),se=null,t.removeEventListener("close",a)};t.addEventListener("close",a),t.className="panel-dialog",t.removeAttribute("style"),t.showModal();const l=e.getBoundingClientRect();t.style.position="fixed",t.style.transform="translate(-50%, -50%)",t.style.margin="0",t.style.left=`${l.left+l.width/2}px`,t.style.top=`${l.top+l.height/2}px`,requestAnimationFrame(()=>{const i=t.offsetWidth,r=t.offsetHeight,c=l.left+l.width/2,u=l.top+l.height/2,d=8;t.style.left=`${Math.max(i/2+d,Math.min(c,window.innerWidth-i/2-d))}px`,t.style.top=`${Math.max(r/2+d,Math.min(u,window.innerHeight-r/2-d))}px`})}else t.removeAttribute("style"),t.style.position="fixed",t.style.left="50%",t.style.top="50%",t.style.transform="translate(-50%, -50%)",t.style.margin="0",t.showModal();const o=t.querySelector(".dialog-header")||t.querySelector("h3");return o&&wt(t,o),t}function w(){const n=Ge();n.open&&n.close(),n.className="",n.innerHTML="",n.removeAttribute("style"),se&&(ke(se),se=null)}function q(n,e,t=null){return new Promise(o=>{const s=N(`
      <h3>${n}</h3>
      <p>${e}</p>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Confirm</button>
      </div>
    `,t);s.querySelector("#dlg-cancel").onclick=()=>{w(),o(!1)},s.querySelector("#dlg-ok").onclick=()=>{w(),o(!0)}})}function He(n,e,t=null){return new Promise(o=>{const s=N(`
      <div class="dialog-header">
        <h3>${n}</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p>${e}</p>
    `,t);s.querySelector("#dlg-close-x").onclick=()=>{w(),o()}})}function Et(n,e=null){return new Promise(t=>{const o=N(`
      <h3>Rename Panel</h3>
      <label>Name</label>
      <input id="dlg-name" type="text" value="${n}" autofocus>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Rename</button>
      </div>
    `,e);o.querySelector("#dlg-cancel").onclick=()=>{w(),t(null)},o.querySelector("#dlg-ok").onclick=()=>{const s=o.querySelector("#dlg-name").value.trim();w(),t(s)},o.querySelector("#dlg-name").onkeydown=s=>{s.key==="Enter"&&o.querySelector("#dlg-ok").click()}})}function Ae(n){return Object.entries(n).map(([e,t])=>`${e}=${t}`).join(`
`)}function fe(n){const e={};for(const t of n.split(`
`)){const o=t.trim();if(!o)continue;const s=o.indexOf("=");if(s===-1)continue;const a=o.slice(0,s).trim(),l=o.slice(s+1).trim();a&&(e[a]=l)}return e}function Be(n){const e=n.template,t=e?.nodeTypes?.length>0,o=t&&e.nodeTypes.some(l=>l.id===be)?be:null,s=t?`<label>Type</label>
    <select id="dlg-type">
      ${e.nodeTypes.map(l=>`<option value="${l.id}" ${(o||e.nodeTypes[0]?.id)===l.id?"selected":""}>${l.label}</option>`).join("")}
    </select>`:"",a=N(`
    <h3>Add Node</h3>
    <label>Label</label>
    <input id="dlg-label" type="text" placeholder="Node label (or A,B,C or P1-5)" autofocus>
    ${s}
    <label>Properties (key=value per line)</label>
    <textarea id="dlg-props" placeholder="color=blue&#10;weight=5"></textarea>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `,n.panelEl);a.querySelector("#dlg-cancel").onclick=w,a.querySelector("#dlg-ok").onclick=()=>{const l=a.querySelector("#dlg-label").value,i=Tt(l);if(i.length===0){y("Label required","error");return}const r=fe(a.querySelector("#dlg-props").value),c=t&&a.querySelector("#dlg-type").value||null;t&&(be=c);for(const u of i)n.addNode(u,r,c);i.length>1&&y(`Added ${i.length} nodes`,"success"),w()},a.querySelector("#dlg-label").onkeydown=l=>{l.key==="Enter"&&a.querySelector("#dlg-ok").click()}}function Re(n){const e=n.graph.nodes.map(p=>p.label);if(e.length<2){y("Need at least 2 nodes to create an edge","error");return}const t=n.template,o=J[t?.graphType||"DG"],s=o&&!o.directed,a=s?"Node A":"Source",l=s?"Node B":"Target",i=t?.edgeTypes?.length>0,r=i&&t.edgeTypes.some(p=>p.id===ve)?ve:null,c=i?`<label>Type</label>
    <select id="dlg-type">
      ${t.edgeTypes.map(p=>`<option value="${p.id}" ${(r||t.edgeTypes[0]?.id)===p.id?"selected":""}>${p.label}</option>`).join("")}
    </select>`:"",u=e.map(p=>`<option value="${p}">`).join(""),d=N(`
    <h3>Add Edge</h3>
    <datalist id="dlg-node-list">${u}</datalist>
    <label>${a}</label>
    <input id="dlg-source" list="dlg-node-list" placeholder="Start typing..." autocomplete="off">
    <label>${l}</label>
    <input id="dlg-target" list="dlg-node-list" placeholder="Start typing..." autocomplete="off">
    ${c}
    <label>Properties (key=value per line)</label>
    <textarea id="dlg-props" placeholder="weight=1"></textarea>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `,n.panelEl);d.querySelector("#dlg-source").value=e[0],e.length>1&&(d.querySelector("#dlg-target").value=e[1]),d.querySelector("#dlg-cancel").onclick=w,d.querySelector("#dlg-ok").onclick=()=>{const p=d.querySelector("#dlg-source").value.trim(),h=d.querySelector("#dlg-target").value.trim();if(!e.includes(p)){y(`Node "${p}" not found`,"error");return}if(!e.includes(h)){y(`Node "${h}" not found`,"error");return}if(p===h){y("Source and target must differ","error");return}const f=fe(d.querySelector("#dlg-props").value),x=i&&d.querySelector("#dlg-type").value||null;i&&(ve=x),n.addEdge(p,h,f,x),w()}}function Fe(n){const e=n.cy.$(":selected");if(e.empty()){y("Nothing selected","info");return}const t=e[0],o=n.template;if(t.isNode()){const s=t.data("label"),a=n.graph.nodes.find(c=>c.label===s);if(!a)return;const l=o?.nodeTypes?.length>0,i=l?`<label>Type</label>
      <select id="dlg-type">
        ${o.nodeTypes.map(c=>`<option value="${c.id}" ${a.type===c.id?"selected":""}>${c.label}</option>`).join("")}
      </select>`:"",r=N(`
      <h3>Edit Node: ${s}</h3>
      ${i}
      <label>Properties (key=value per line)</label>
      <textarea id="dlg-props">${Ae(a.props)}</textarea>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Save</button>
      </div>
    `,n.panelEl);r.querySelector("#dlg-cancel").onclick=w,r.querySelector("#dlg-ok").onclick=()=>{const c=fe(r.querySelector("#dlg-props").value),u=l?r.querySelector("#dlg-type").value||null:void 0;n.updateNodeProps(s,c,u),w()}}else{const s=t.data("source"),a=t.data("target"),l=n.graph.edges.find(g=>g.source===s&&g.target===a);if(!l)return;const i=o?.edgeTypes?.length>0,r=i?`<label>Type</label>
      <select id="dlg-type">
        ${o.edgeTypes.map(g=>`<option value="${g.id}" ${l.type===g.id?"selected":""}>${g.label}</option>`).join("")}
      </select>`:"",c=`${s}→${a}`,u=n.pathTrackingEnabled&&n._pathTags,d=u?n._pathTags.get(c)||[]:[],p=n.template?.specialTypes||[],h=()=>{if(!u||d.length===0)return"";const g=n._effectiveExclusions?.get(c)||new Set,m=d.filter(S=>!g.has(L(S,p))),b=d.filter(S=>g.has(L(S,p))),_=[];return m.length&&_.push("Included: "+m.map(S=>j(S,p,n.template?.nodeTypes||[])).join(", ")),b.length&&_.push("Excluded: "+b.map(S=>j(S,p,n.template?.nodeTypes||[])).join(", ")),_.join(`
`)||"(no active paths)"},f=()=>{if(!u||d.length===0)return"";const g=n._effectiveExclusions?.get(c)||new Set,m=new Set(n.exclusions[c]||[]);return d.map(b=>{const _=L(b,p),S=m.has(_),v=g.has(_)&&!S,E=S||v,T=j(b,p,n.template?.nodeTypes||[]),A=v?"excl-toggle excl-btn-propagated":E?"excl-toggle excl-btn-excluded":"excl-toggle excl-btn-included",C=v?`${T} (inherited from upstream)`:T;return`<button class="${A}" data-tag="${_}" data-propagated="${v}" title="${C}">${T}</button>`}).join("")},x=u&&d.length>0?`
      <div class="template-section-label" style="margin-top:12px">Path Tags</div>
      <pre id="edge-tag-summary" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-size:11px;margin-bottom:8px;white-space:pre-wrap;word-break:break-all">${h()}</pre>
      <div class="template-section-label">Manage Exclusions</div>
      <div id="edge-excl-toggles" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">${f()}</div>
    `:"",k=N(`
      <h3>Edit Edge: ${s} → ${a}</h3>
      ${r}
      <label>Properties (key=value per line)</label>
      <textarea id="dlg-props">${Ae(l.props)}</textarea>
      ${x}
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Save</button>
      </div>
    `,n.panelEl);if(u&&d.length>0){const g=()=>{const m=n._effectiveExclusions?.get(c)||new Set;new Set(n.exclusions[c]||[]);const b=d.filter(v=>!m.has(L(v,p))),_=d.filter(v=>m.has(L(v,p))),S=[];b.length&&S.push("Included: "+b.map(v=>j(v,p,n.template?.nodeTypes||[])).join(", ")),_.length&&S.push("Excluded: "+_.map(v=>j(v,p,n.template?.nodeTypes||[])).join(", ")),k.querySelector("#edge-tag-summary").textContent=S.join(`
`)||"(no active paths)",k.querySelectorAll("#edge-excl-toggles .excl-toggle").forEach(v=>{const E=v.dataset.tag;if(v.dataset.propagated==="true")return;const A=(n._effectiveExclusions?.get(c)||new Set).has(E);v.className=A?"excl-toggle excl-btn-excluded":"excl-toggle excl-btn-included"})};k.querySelectorAll("#edge-excl-toggles .excl-toggle").forEach(m=>{m.dataset.propagated!=="true"&&(m.onclick=()=>{const b=m.dataset.tag;(n._effectiveExclusions?.get(c)||new Set).has(b)?n.includePathTag(c,b):n.excludePathTag(c,b),g()})})}k.querySelector("#dlg-cancel").onclick=w,k.querySelector("#dlg-ok").onclick=()=>{const g=fe(k.querySelector("#dlg-props").value),m=i?k.querySelector("#dlg-type").value||null:void 0;n.updateEdgeProps(s,a,g,m),w()}}}async function Ct(n){const e=await pt();if(!e.ok){y(e.error,"error");return}const t=`import → ${n.id}`,o=n.receiveMerge(e.graph,t);o.ok?y("Graph imported","success"):y(o.error,"error")}function Pt(n){if(!n.baseGraph){N(`
      <div class="dialog-header">
        <h3>Changeset Summary</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="color: var(--text-muted); text-align: center; padding: 20px;">No baseline — approve first to track changes.</p>
    `,n.panelEl).querySelector("#dlg-close-x").onclick=w;return}const e=R(n.baseGraph,n.graph),t=je(e);N(`
    <div class="dialog-header">
      <h3>Changeset Summary</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p class="changeset-summary-text">${t}</p>
  `,n.panelEl).querySelector("#dlg-close-x").onclick=w}function Nt(n){const e=n._approvalHistory||[];if(e.length===0){const s=N(`
      <div class="dialog-header">
        <h3>Approval History</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="color: var(--text-muted); text-align: center; padding: 20px;">No approvals yet.</p>
    `,n.panelEl);s.querySelector("#dlg-close-x").onclick=w;return}let t='<div class="changelog-list">';for(let s=e.length-1;s>=0;s--){const a=e[s],i=new Date(a.timestamp).toLocaleTimeString(),r=s+1;t+=`
      <div class="changelog-entry" style="display: flex; align-items: center; justify-content: space-between; padding: 8px;">
        <span style="font-family: 'Courier New', monospace; font-size: 11px;">
          #${r} ${i} <span style="color: var(--text-muted);">${a.diffSummary}</span>
        </span>
        <button class="btn-preview" data-index="${s}" style="font-size: 11px; padding: 4px 8px;">Preview</button>
      </div>
    `}t+="</div>";const o=N(`
    <div class="dialog-header">
      <h3>Approval History</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    ${t}
  `,n.panelEl);o.querySelectorAll(".btn-preview").forEach(s=>{s.onclick=()=>{const a=parseInt(s.dataset.index),l=e[a];w(),At(l,a,n)}}),o.querySelector("#dlg-close-x").onclick=w}function At(n,e,t){const o=t.panelEl,s=n.baseGraph!==null&&n.baseGraph!==void 0,a=`Approval #${e+1} — ${new Date(n.timestamp).toLocaleTimeString()}`,i=N(`
    <div class="preview-header">
      <h3 style="margin:0">${a}</h3>
      <div style="display:flex;gap:4px;align-items:center">
        <button id="preview-maximize" class="btn-icon" title="Maximize/minimize preview">&#x2922;</button>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
    </div>
    <div class="preview-canvas" id="preview-canvas"></div>
    <div class="preview-info-panel" id="preview-info-panel"></div>
    <div class="preview-footer">
      <button id="preview-info" class="btn-icon" title="Show grouped changeset summary for this approval">&#x24D8;</button>
      <div class="preview-toggle">
        <button id="toggle-approved" class="preview-toggle-btn active">Approved State</button>
        <button id="toggle-changeset" class="preview-toggle-btn" ${s?"":'disabled title="No baseline available for this entry"'}>Changeset View</button>
      </div>
    </div>
  `,o);i.style.minWidth="420px",i.style.minHeight="380px",i.style.maxWidth="80vw",i.style.maxHeight="80vh";const r=i.querySelector("#preview-canvas"),c=i.querySelector("#preview-info-panel");let u=!1;i.querySelector("#preview-maximize").onclick=()=>{u=!u,u?(i.style.position="fixed",i.style.left="20px",i.style.top="20px",i.style.transform="none",i.style.margin="0",i.style.width="calc(100vw - 40px)",i.style.height="calc(100vh - 40px)",i.style.maxWidth="none",i.style.maxHeight="none"):(i.style.position="",i.style.left="",i.style.top="",i.style.transform="",i.style.margin="",i.style.width="",i.style.height="",i.style.maxWidth="80vw",i.style.maxHeight="80vh"),c.classList.contains("visible")||(f.resize(),f.fit(void 0,20))};const d=()=>{const S=[];for(const v of n.graph.nodes)S.push({group:"nodes",data:{id:v.label,label:v.label}});for(const v of n.graph.edges)S.push({group:"edges",data:{id:`${v.source}→${v.target}`,source:v.source,target:v.target}});return S},p=()=>{if(!s)return d();const S=R(n.baseGraph,n.graph),v=new Map(S.map(T=>[T.key,T.action])),E=[];for(const T of n.graph.nodes){const A=v.get(T.label)||null;E.push({group:"nodes",data:{id:T.label,label:T.label},classes:A?`diff-${A}`:""})}for(const T of n.graph.edges){const A=`${T.source}→${T.target}`,C=v.get(A)||null;E.push({group:"edges",data:{id:A,source:T.source,target:T.target},classes:C?`diff-${C}`:""})}if(n.baseGraph){const T=new Set(n.graph.nodes.map(C=>C.label)),A=new Set(n.graph.edges.map(C=>`${C.source}→${C.target}`));for(const C of n.baseGraph.nodes)T.has(C.label)||E.push({group:"nodes",data:{id:C.label,label:C.label},classes:"diff-removed"});for(const C of n.baseGraph.edges){const K=`${C.source}→${C.target}`;if(!A.has(K)){const ce=new Set([...T,...n.baseGraph.nodes.map(et=>et.label)]);ce.has(C.source)&&ce.has(C.target)&&E.push({group:"edges",data:{id:K,source:C.source,target:C.target},classes:"diff-removed"})}}}return E},h=t.layoutAlgorithm&&t.layoutAlgorithm!=="level-by-level"?t.layoutAlgorithm:"fcose",f=$e({container:r,elements:d(),style:Oe,layout:{name:h,animate:!1,fit:!0,padding:20},autoungrabify:!0,userZoomingEnabled:!0,userPanningEnabled:!0});let x="approved";const k=i.querySelector("#toggle-approved"),g=i.querySelector("#toggle-changeset"),m=S=>{if(S===x)return;x=S,k.classList.toggle("active",S==="approved"),g.classList.toggle("active",S==="changeset"),f.elements().remove();const v=S==="changeset"?p():d();f.add(v),f.layout({name:h,animate:!1,fit:!0,padding:20}).run()};k.onclick=()=>m("approved"),s&&(g.onclick=()=>m("changeset"));const b=i.querySelector("#preview-info");let _=!1;b.onclick=()=>{if(_=!_,_){if(!s)c.innerHTML=`
          <p style="color: var(--text-muted); padding: 8px;">No baseline available for this approval entry.</p>
          <button id="info-back" style="margin-top:8px">&#x2190; Back</button>
        `;else{const S=R(n.baseGraph,n.graph),v=je(S);c.innerHTML=`
          <p class="changeset-summary-text">${v}</p>
          <button id="info-back" style="margin-top:8px">&#x2190; Back</button>
        `}c.classList.add("visible"),r.style.display="none",c.querySelector("#info-back").onclick=()=>{_=!1,c.classList.remove("visible"),r.style.display="",f.resize(),f.fit(void 0,20)}}else c.classList.remove("visible"),r.style.display="",f.resize(),f.fit(void 0,20)},i.querySelector("#dlg-close-x").onclick=()=>{try{f.destroy()}catch{}w()}}function Le(){return`t${Date.now().toString(36)}${Math.random().toString(36).slice(2,5)}`}function Ue(n,e,t=!1,o=null){let s=$(n);s.specialTypes||(s.specialTypes=[]);const a=s.graphType==="DAG",l=(g,m)=>g.map(b=>{const _=m==="node"?"Node Type":"Edge Type";return`
    <div class="type-row" data-id="${b.id}" data-kind="${m}">
      <input type="text" class="type-label-input" value="${b.label}" placeholder="${_}">
      <input type="color" class="type-color-input" value="${b.color||"#4fc3f7"}">
      <button class="btn-delete-type" data-id="${b.id}" data-kind="${m}" title="Delete">✕</button>
    </div>
  `}).join(""),i=()=>{if(!a||s.nodeTypes.length===0)return"";const g=t,m=g?'<em style="font-size:10px;color:var(--text-muted)">Cannot change for active session</em>':"",b=s.nodeTypes.map(_=>{const S=s.specialTypes.indexOf(_.id),v=S!==-1,E=!v||S<=0||g?"disabled":"",T=!v||S>=s.specialTypes.length-1||g?"disabled":"";return`
        <div class="special-type-item">
          <input type="checkbox" class="special-type-cb" data-id="${_.id}" ${v?"checked":""} ${g?"disabled":""}>
          <span style="flex:1">${_.label}</span>
          <button class="st-up" data-id="${_.id}" ${E} title="Move up in order">↑</button>
          <button class="st-down" data-id="${_.id}" ${T} title="Move down in order">↓</button>
        </div>
      `}).join("");return`
      <div class="special-types-section">
        <div class="template-section-label">Path Tracking Types ${m}</div>
        <p style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Select node types used as anchors for path tracking (order matters).</p>
        <div id="special-types-list">${b}</div>
      </div>
    `},r=[{value:"cose",label:"COSE (force-directed)"},{value:"breadthfirst",label:"Breadth-first"},{value:"circle",label:"Circle"},{value:"grid",label:"Grid"},{value:"concentric",label:"Concentric"},{value:"dagre",label:"Dagre (DAG only)"}],c=()=>`
    <div class="dialog-header">
      <h3>Edit Template</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <div class="template-graph-type-label">
      Graph Type: <strong>${J[s.graphType]?.label||s.graphType}</strong>
    </div>
    <div class="template-section-label">Node Types</div>
    <div id="node-types-list">${l(s.nodeTypes,"node")}</div>
    <button id="add-node-type" class="btn-secondary btn-add-type">+ Add Node Type</button>
    <div class="template-section-label">Edge Types</div>
    <div id="edge-types-list">${l(s.edgeTypes,"edge")}</div>
    <button id="add-edge-type" class="btn-secondary btn-add-type">+ Add Edge Type</button>
    ${i()}
    <div class="template-section-label">Default Layout Algorithm</div>
    <select id="default-layout-algo">
      ${r.map(g=>`<option value="${g.value}" ${(s.defaultLayoutAlgorithm||"cose")===g.value?"selected":""}>${g.label}</option>`).join("")}
    </select>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Save</button>
    </div>
  `,u=()=>{d.querySelectorAll(".type-label-input").forEach(g=>{g.addEventListener("focus",()=>g.select())})},d=N(c());d.classList.add("dialog-wide"),u();const p=()=>{d.querySelectorAll(".type-row").forEach(m=>{const b=m.dataset.id,_=m.dataset.kind,S=m.querySelector(".type-label-input")?.value??"",v=m.querySelector(".type-color-input")?.value??"#4fc3f7";if(_==="node"){const E=s.nodeTypes.find(T=>T.id===b);E&&(E.label=S,E.color=v)}else{const E=s.edgeTypes.find(T=>T.id===b);E&&(E.label=S,E.color=v)}}),a&&(s.specialTypes=[],d.querySelectorAll(".special-type-cb:checked").forEach(m=>{s.specialTypes.push(m.dataset.id)})),d.querySelector("#node-types-list").innerHTML=l(s.nodeTypes,"node"),d.querySelector("#edge-types-list").innerHTML=l(s.edgeTypes,"edge");const g=d.querySelector(".special-types-section");g&&(g.outerHTML=i()),h(),f(),u()},h=()=>{d.querySelectorAll(".btn-delete-type").forEach(g=>{g.onclick=()=>{const m=g.dataset.id;g.dataset.kind==="node"?(s.nodeTypes=s.nodeTypes.filter(_=>_.id!==m),s.specialTypes=s.specialTypes.filter(_=>_!==m)):s.edgeTypes=s.edgeTypes.filter(_=>_.id!==m),p()}})},f=()=>{a&&(d.querySelectorAll(".st-up").forEach(g=>{g.onclick=()=>{const m=g.dataset.id,b=s.specialTypes.indexOf(m);b>0&&([s.specialTypes[b-1],s.specialTypes[b]]=[s.specialTypes[b],s.specialTypes[b-1]],p())}}),d.querySelectorAll(".st-down").forEach(g=>{g.onclick=()=>{const m=g.dataset.id,b=s.specialTypes.indexOf(m);b!==-1&&b<s.specialTypes.length-1&&([s.specialTypes[b],s.specialTypes[b+1]]=[s.specialTypes[b+1],s.specialTypes[b]],p())}}),d.querySelectorAll(".special-type-cb").forEach(g=>{g.onchange=()=>{const m=g.dataset.id;g.checked?s.specialTypes.includes(m)||s.specialTypes.push(m):s.specialTypes=s.specialTypes.filter(b=>b!==m),p()}}))};h(),f(),d.querySelector("#add-node-type").onclick=()=>{p(),s.nodeTypes.push({id:Le(),label:"New Type",color:"#4fc3f7"}),p()},d.querySelector("#add-edge-type").onclick=()=>{p(),s.edgeTypes.push({id:Le(),label:"New Type",color:"#5a6a8c"}),p()};const x=()=>{d.querySelectorAll(".type-row").forEach(g=>{const m=g.dataset.id,b=g.dataset.kind,_=g.querySelector(".type-label-input")?.value?.trim()||"Unnamed",S=g.querySelector(".type-color-input")?.value??"#4fc3f7";if(b==="node"){const v=s.nodeTypes.find(E=>E.id===m);v&&(v.label=_,v.color=S)}else{const v=s.edgeTypes.find(E=>E.id===m);v&&(v.label=_,v.color=S)}}),a&&(s.specialTypes=[],d.querySelectorAll(".special-type-cb:checked").forEach(g=>{s.specialTypes.push(g.dataset.id)})),s.defaultLayoutAlgorithm=d.querySelector("#default-layout-algo").value,e(s),y("Template saved","success")},k=o?()=>{w(),o()}:w;d.querySelector("#dlg-ok").onclick=x,d.querySelector("#dlg-cancel").onclick=k,d.querySelector("#dlg-close-x").onclick=k}function De(n,e){const t=n.panelEl;if(!n.pathTrackingEnabled||!n._pathTags)return;const o=n.template,s=o?.specialTypes||[],a=n._pathTags.get(e)||[],l=n._effectiveExclusions?.get(e)||new Set,i=new Set(n.exclusions[e]||[]);if(a.length===0){y("No path tags on this edge","info");return}const r=x=>L(x,s),c=x=>j(x,s,o?.nodeTypes||[]);let u={...n.exclusions};const d=a.map(x=>{const k=r(x),g=i.has(k),m=l.has(k)&&!g,b=g||m,_=c(x);return`
      <div class="exclusion-item ${m?"propagated":""}">
        <input type="checkbox" class="excl-cb" data-tag="${k}" data-propagated="${m}" ${b?"":"checked"} title="${m?"Propagated from downstream — uncheck to add direct exclusion":""}">
        <span>${_}${m?' <em style="font-size:10px;color:var(--text-muted)">(inherited)</em>':""}</span>
      </div>
    `}).join(""),[p,h]=e.split("→"),f=N(`
    <div class="dialog-header">
      <h3>Exclusions: ${p} → ${h}</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Checked = included in tracking. Uncheck to exclude a path.</p>
    <div class="exclusion-list">${d}</div>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `,t);f.querySelector("#dlg-ok").onclick=()=>{const x=f.querySelectorAll(".excl-cb"),k=[];x.forEach(m=>{const b=m.dataset.tag;m.checked||k.push(b)});const g=k.filter(m=>f.querySelector(`.excl-cb[data-tag="${m}"]`)?.dataset.propagated!=="true");g.length>0?u[e]=g:delete u[e],n.exclusions=u,n._recomputePathTrackingAsync(),n._emitChange(),w()},f.querySelector("#dlg-cancel").onclick=w,f.querySelector("#dlg-close-x").onclick=w}function Lt(n){const e=n.panelEl,o=[{value:"fcose",label:"Force-Directed (fcose)"},{value:"level-by-level",label:"Level-by-Level (DAG)"},{value:"circle",label:"Circle"},{value:"concentric",label:"Concentric"},{value:"breadthfirst",label:"Breadth-First"},{value:"grid",label:"Grid"}].map(c=>`<option value="${c.value}" ${n.layoutAlgorithm===c.value?"selected":""}>${c.label}</option>`).join(""),s=n.template,a=s?.graphType==="DAG",l=a&&s?.specialTypes?.length>0,i=a?`
    <div class="template-section-label" style="margin-top:12px">Path Tracking</div>
    ${l?`
    <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;white-space:nowrap">
      <input type="checkbox" id="dlg-tracking" style="width:auto;flex-shrink:0" ${n.pathTrackingEnabled?"checked":""}>
      Enable path tracking
    </label>
    `:'<p style="font-size:11px;color:var(--text-muted)">No special types configured in template. Edit the template to add special types for DAG path tracking.</p>'}
  `:"",r=N(`
    <div class="dialog-header">
      <h3>Panel Options</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <label>Layout Algorithm</label>
    <select id="dlg-layout-algo">${o}</select>
    ${i}
    <div class="dialog-actions">
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `,e);r.querySelector("#dlg-ok").onclick=()=>{const c=r.querySelector("#dlg-layout-algo").value;if(n.setLayoutAlgorithm(c),l){const u=r.querySelector("#dlg-tracking")?.checked||!1;u!==n.pathTrackingEnabled&&n.setPathTracking(u)}y("Options applied","success"),w()},r.querySelector("#dlg-close-x").onclick=w}function Dt(n,e,t,o){const s=n.template?.specialTypes||[],a=n.graph.nodes,l=s.length>0?a.filter(h=>s.includes(h.type)):a,i=t[e],r=i&&typeof i=="object"?i.scopeNodes||[]:[],c=r.length>0;let u;l.length===0?s.length>0?u='<p style="color:var(--text-muted);padding:8px 0">No special-type nodes found in target panel. Configure Path Tracking types in template settings.</p>':u='<p style="color:var(--text-muted);padding:8px 0">No nodes in target panel.</p>':u=l.map(h=>{const f=r.includes(h.label)?"checked":"";return`<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;font-size:12px">
          <input type="checkbox" class="scope-node-cb" value="${h.label}" ${f} style="width:auto;margin:0">
          <span>${h.label}</span>
        </div>`}).join("");const d=N(`
    <div class="dialog-header">
      <h3>Select Scope Nodes</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Select nodes in the target panel. Only upstream ancestors of these nodes will be merged.</p>
    <div style="max-height:200px;overflow-y:auto;margin-bottom:8px">${u}</div>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `),p=()=>{c||delete t[e],w(),o&&o()};d.querySelector("#dlg-ok").onclick=()=>{const h=[...d.querySelectorAll(".scope-node-cb:checked")].map(f=>f.value);t[e]={strategy:"scoped",scopeNodes:h},w(),o&&o()},d.querySelector("#dlg-cancel").onclick=p,d.querySelector("#dlg-close-x").onclick=p}function qt(n,e,t){const o=n.map(l=>`<option value="${l.id}">${l.name}</option>`).join(""),s=N(`
    <h3>Add Merge Button</h3>
    <label>Source Panel</label>
    <select id="dlg-source">${o}</select>
    <label>Target Panel</label>
    <select id="dlg-target">${o}</select>
    <p id="dlg-warning" style="color:var(--warning);font-size:11px;display:none;margin-bottom:6px">This merge direction already exists.</p>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `),a=()=>{const l=s.querySelector("#dlg-source").value,i=s.querySelector("#dlg-target").value,r=e.some(c=>c.source===l&&c.target===i);s.querySelector("#dlg-warning").style.display=r?"":"none"};s.querySelector("#dlg-source").onchange=a,s.querySelector("#dlg-target").onchange=a,s.querySelector("#dlg-cancel").onclick=w,s.querySelector("#dlg-ok").onclick=()=>{const l=s.querySelector("#dlg-source").value,i=s.querySelector("#dlg-target").value;if(l===i){y("Source and target must differ","error");return}w(),t({source:l,target:i})}}function Mt(n){const t=Object.keys(n).map(o=>`<option value="${o}">${o}</option>`).join("");return new Promise(o=>{const s=N(`
      <h3>New Session</h3>
      <label>Session Name</label>
      <input id="dlg-name" type="text" placeholder="Session name" autofocus>
      <label>Template</label>
      <select id="dlg-template">${t}</select>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Create</button>
      </div>
    `);s.querySelector("#dlg-cancel").onclick=()=>{w(),o(null)},s.querySelector("#dlg-ok").onclick=()=>{const a=s.querySelector("#dlg-name").value.trim();if(!a){y("Session name required","error");return}const l=s.querySelector("#dlg-template").value;w(),o({name:a,templateName:l})},s.querySelector("#dlg-name").onkeydown=a=>{a.key==="Enter"&&s.querySelector("#dlg-ok").click()}})}const qe=200;class Ot{constructor(e,{onPanelCreate:t,onPanelDestroy:o,onMerge:s,getState:a,setState:l,confirmClose:i,onResizeEnd:r,getPanels:c}){this.rootEl=e,this.onPanelCreate=t,this.onPanelDestroy=o,this.onMerge=s,this._getState=a||null,this._setState=l||null,this._confirmClose=i||null,this._onResizeEnd=r||null,this._getPanels=c||null,this.nextId=1,this.tree=null,this._zoomedPanelId=null,this._zoomSavedStates=new Map,this.mergeStrategies={},this.mergeButtonLists={},this._gutterSplitNodes={}}_getStrategy(e){const t=this.mergeStrategies[e];return t?typeof t=="string"?{strategy:t,scopeNodes:[]}:t:{strategy:"mirror",scopeNodes:[]}}_strategyBadge(e){switch(e){case"push":return"(P)";case"scoped":return"(S)";case"none":return"(N)";default:return"(M)"}}init(){const e=window.innerWidth<=600?"h":"v";this.tree={type:"split",direction:e,children:[{type:"panel",id:String(this.nextId++)},{type:"panel",id:String(this.nextId++)}],sizes:[50,50]},this.render()}getLayout(){return{tree:this.tree,nextId:this.nextId,mergeStrategies:this.mergeStrategies,mergeButtonLists:this.mergeButtonLists}}setLayout(e){this.tree=e.tree,this.nextId=e.nextId,this.mergeStrategies=e.mergeStrategies||{},this.mergeButtonLists=e.mergeButtonLists||{},this.render()}getMergeStrategies(){return this.mergeStrategies}setMergeStrategies(e){this.mergeStrategies=e||{}}getAllPanelIds(){const e=[],t=o=>{o.type==="panel"?e.push(o.id):o.children.forEach(t)};return this.tree&&t(this.tree),e}splitPanel(e,t){const o=String(this.nextId++),s=this._findPanelNode(this.tree,e);return this.tree=this._mapTree(this.tree,a=>a.type==="panel"&&a.id===e?{type:"split",direction:t,children:[{type:"panel",id:e,name:s?.name},{type:"panel",id:o}],sizes:[50,50]}:a),this.render(),o}closePanel(e){if(!(this.getAllPanelIds().length<=1)){this._zoomedPanelId===e&&(this._zoomedPanelId=null);for(const t of Object.keys(this.mergeButtonLists))this.mergeButtonLists[t]=this.mergeButtonLists[t].filter(o=>o.source!==e&&o.target!==e);this.tree=this._removePanel(this.tree,e),this.render()}}addPanel(){const e=String(this.nextId++),t=window.innerWidth<=600?"h":"v";return this.tree={type:"split",direction:t,children:[this.tree,{type:"panel",id:e}],sizes:[70,30]},this.render(),e}toggleZoom(e){this._zoomedPanelId===e?this._zoomedPanelId=null:this._zoomedPanelId=e,this.render()}render(){const e=new Map,t=new Set;this.rootEl.querySelectorAll(".panel-canvas").forEach(s=>{t.add(s.dataset.panel)});for(const s of t)if(this._getState){const a=this._getState(s);a&&e.set(s,a)}for(const s of t)this.onPanelDestroy(s);if(this.rootEl.innerHTML="",!this.tree)return;if(this._zoomedPanelId){const s=this._findPanelNode(this.tree,this._zoomedPanelId);if(s){for(const i of t)i!==this._zoomedPanelId&&e.has(i)&&this._zoomSavedStates.set(i,e.get(i));const a=this._renderPanel(s);a.style.flex="1",a.classList.add("zoomed"),this.rootEl.appendChild(a);const l=a.querySelector(".panel-canvas");this.onPanelCreate(this._zoomedPanelId,l),e.has(this._zoomedPanelId)&&this._setState&&this._setState(this._zoomedPanelId,e.get(this._zoomedPanelId));return}this._zoomedPanelId=null}for(const[s,a]of this._zoomSavedStates)e.has(s)||e.set(s,a);this._zoomSavedStates.clear();const o=this._renderNode(this.tree);o.style.flex="1",o.style.display="flex",o.style.minWidth="0",o.style.minHeight="0",this.rootEl.appendChild(o);for(const s of this.getAllPanelIds()){const a=this.rootEl.querySelector(`.panel-canvas[data-panel="${s}"]`);a&&(this.onPanelCreate(s,a),e.has(s)&&this._setState&&this._setState(s,e.get(s)))}}_renderNode(e){return e.type==="panel"?this._renderPanel(e):this._renderSplit(e)}_renderPanel(e){const t=e.name||`Panel ${e.id}`,o=document.createElement("div");o.className="panel",o.dataset.panelId=e.id;const s=document.createElement("div");s.className="panel-header",s.innerHTML=`
      <span class="panel-header-left">
        <button data-action="panel-options" class="btn-icon btn-header-icon" title="Panel options">&#x2699;</button>
        <button data-action="refresh" class="btn-icon btn-header-icon" title="Re-layout">&#x21BB;</button>
        <span class="panel-header-sep"></span>
        <button data-action="undo" class="btn-icon btn-header-icon" title="Undo (Ctrl+Z)">&#x21B6;</button>
        <button data-action="redo" class="btn-icon btn-header-icon" title="Redo (Ctrl+Shift+Z)">&#x21B7;</button>
        <span class="processing-indicator" title="Processing...">&#x27F3;</span>
      </span>
      <span class="panel-info"></span>
      <span class="panel-header-right">
        <button class="panel-split-btn" data-split="v" title="Split this panel into two side-by-side panels">&#x2194;</button>
        <button class="panel-split-btn" data-split="h" title="Split this panel into two stacked panels">&#x2195;</button>
        <span class="panel-header-sep"></span>
        <button class="panel-zoom-btn" title="Toggle full-screen zoom on this panel (Escape to exit)">&#x2922;</button>
        <button class="panel-close-btn" title="Close this panel and remove it from the layout">&#x2715;</button>
      </span>
    `,o.appendChild(s),s.querySelector(".panel-zoom-btn").onclick=()=>this.toggleZoom(e.id),s.querySelector('[data-split="v"]').onclick=()=>this.splitPanel(e.id,"v"),s.querySelector('[data-split="h"]').onclick=()=>this.splitPanel(e.id,"h"),s.querySelector(".panel-close-btn").onclick=async()=>{this._confirmClose&&!await this._confirmClose(e.id)||this.closePanel(e.id)};const a=document.createElement("div");a.className="panel-canvas",a.dataset.panel=e.id;const l=document.createElement("div");l.className="panel-name-overlay",l.title="Click to rename",l.textContent=t,l.onclick=()=>{Et(t,o).then(c=>{if(c!==null){e.name=c||void 0;const u=c||`Panel ${e.id}`;l.textContent=u,this.render()}})},a.appendChild(l);const i=document.createElement("div");i.className="diff-overlay",i.dataset.panelDiff=e.id,a.appendChild(i),o.appendChild(a);const r=document.createElement("div");return r.className="panel-actions",r.innerHTML=`
      <span class="panel-actions-left">
        <button data-action="add-node" class="btn-add" title="Add a new labeled node to the graph">+N</button>
        <button data-action="add-edge" class="btn-add" title="Add a new directed edge between two existing nodes">+E</button>
        <span class="action-separator"></span>
        <button data-action="approve" class="btn-approve" title="Snapshot current state as baseline and clear all diffs">&#x2713;</button>
        <button data-action="restore" class="btn-restore" title="Revert graph to last approved state (undo all changes since approval)">&#x21BA;</button>
        <span class="action-separator"></span>
        <button data-action="clear" class="btn-clear" title="Reset panel to empty state (clears graph, approval history, and diffs)">&#x232B;</button>
      </span>
      <span class="panel-actions-right">
        <button data-action="changeset" class="btn-icon" title="View pending changeset summary">&#x24D8;</button>
        <button data-action="changelog" class="btn-icon" title="View approval history">&#x2630;</button>
        <button data-action="import" class="btn-icon" title="Import graph from a JSON file">&#x21A5;</button>
        <button data-action="export" class="btn-icon" title="Export current graph as a JSON file">&#x21A7;</button>
      </span>
    `,o.appendChild(r),o}_renderSplit(e){const t=e.direction==="v",o=document.createElement("div");o.className=t?"split-v":"split-h";const s=this._renderNode(e.children[0]),a=this._renderNode(e.children[1]);s.style.flex=`${e.sizes[0]} 1 0`,s.style.overflow="hidden",s.style.display="flex",s.style.minWidth="0",s.style.minHeight="0",a.style.flex=`${e.sizes[1]} 1 0`,a.style.overflow="hidden",a.style.display="flex",a.style.minWidth="0",a.style.minHeight="0";const l=this._renderMergeGutter(e);return o.appendChild(s),o.appendChild(l),o.appendChild(a),o}_panelName(e){return e.name||`Panel ${e.id}`}_getPanelName(e){const t=this._findPanelNode(this.tree,e);return t?this._panelName(t):`Panel ${e}`}_gutterKey(e){const t=this._allPanelNodes(e.children[0]).map(s=>s.id).sort().join(","),o=this._allPanelNodes(e.children[1]).map(s=>s.id).sort().join(",");return`${t}|${o}`}_defaultButtons(e){const t=this._getZones(e.children[0],e.direction,"first"),o=this._getZones(e.children[1],e.direction,"second"),s=p=>{let h=0;return p.map(f=>{const x={start:h,end:h+f.size,panels:f.panels,slot:f.slot};return h+=f.size,x})},a=s(t),l=s(o),i=new Set([0,100]);for(const p of[...a,...l])i.add(p.start),i.add(p.end);const r=[...i].sort((p,h)=>p-h),c=(p,h)=>p.find(f=>f.start<=h&&h<f.end),u=[],d=new Set;for(let p=0;p<r.length-1;p++){const h=(r[p]+r[p+1])/2,f=c(a,h),x=c(l,h);if(!(!f||!x)&&!(f.slot!==null&&x.slot!==null&&f.slot!==x.slot))for(const k of f.panels)for(const g of x.panels){const m=`${k.id}→${g.id}`,b=`${g.id}→${k.id}`;d.has(m)||(d.add(m),u.push({source:k.id,target:g.id})),d.has(b)||(d.add(b),u.push({source:g.id,target:k.id}))}}return u}_getButtonList(e){const t=this._gutterKey(e);return this.mergeButtonLists[t]||(this.mergeButtonLists[t]=this._defaultButtons(e)),this.mergeButtonLists[t]}_rerenderGutter(e){const t=this._gutterSplitNodes[e];if(!t)return;const o=this.rootEl.querySelector(`.merge-gutter[data-gutter-key="${CSS.escape(e)}"]`);o&&o.replaceWith(this._renderMergeGutter(t))}_renderMergeGutter(e){const t=e.direction==="v",o=document.createElement("div");o.className="merge-gutter";const s=this._gutterKey(e);o.dataset.gutterKey=s,this._gutterSplitNodes[s]=e;const a=this._getButtonList(e),l=new Set(this._allPanelNodes(e.children[0]).map(p=>p.id)),i=document.createElement("div");i.className="merge-zone merge-zone-flat",a.forEach((p,h)=>{const{source:f,target:x}=p,k=`${f}→${x}`,g=this._getStrategy(k),m=this._getPanelName(f),b=this._getPanelName(x),_=l.has(f)?`${m} >> ${b}`:`${b} << ${m}`,S=document.createElement("button");S.className="merge-btn",g.strategy==="none"&&S.classList.add("merge-btn-disabled"),S.innerHTML=`<span class="merge-btn-text">${_}</span><span class="merge-strategy-badge">${this._strategyBadge(g.strategy)}</span>`,S.title=`Merge ${m} into ${b}. Right-click to change strategy or delete.`,S.dataset.mergeSource=f,S.dataset.mergeTarget=x,S.onclick=()=>{if(this._getStrategy(k).strategy==="none"){He("Merge Disabled","This merge direction is set to None.");return}this.onMerge(f,x)},S.addEventListener("contextmenu",T=>{T.preventDefault(),this._showStrategyPicker(k,S,s)});const v=document.createElement("div");v.className="merge-btn-row",v.draggable=!0;const E=document.createElement("span");E.className="merge-btn-drag",E.textContent="⋮⋮",E.title="Drag to reorder",v.appendChild(E),v.appendChild(S),v.addEventListener("dragstart",T=>{T.dataTransfer.setData("text/plain",String(h)),T.dataTransfer.effectAllowed="move",v.classList.add("dragging")}),v.addEventListener("dragend",()=>v.classList.remove("dragging")),v.addEventListener("dragover",T=>{T.preventDefault(),T.dataTransfer.dropEffect="move"}),v.addEventListener("drop",T=>{T.preventDefault();const A=parseInt(T.dataTransfer.getData("text/plain")),C=h;if(A===C)return;const K=this.mergeButtonLists[s];if(!K)return;const ce=K.splice(A,1)[0];K.splice(A<C?C-1:C,0,ce),this._rerenderGutter(s),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}),i.appendChild(v)});const r=document.createElement("button");r.className="merge-gutter-settings",r.innerHTML="&#x2699;",r.title="Manage merge buttons",r.onclick=()=>this._showMergeManagementModal(s,e),i.appendChild(r),o.appendChild(i);const c=document.createElement("div");c.className="resize-handle",this._setupResize(c,e,o),o.appendChild(c);const u=this._firstPanelId(e.children[0]),d=this._firstPanelId(e.children[1]);return requestAnimationFrame(()=>{if(!o.isConnected)return;const p=this.rootEl.querySelector(`.panel[data-panel-id="${u}"]`),h=this.rootEl.querySelector(`.panel[data-panel-id="${d}"]`);if(!p||!h)return;const f=()=>{if(!o.isConnected){x.disconnect();return}const k=o.getBoundingClientRect(),g=p.getBoundingClientRect(),m=h.getBoundingClientRect();if(t){const b=Math.min(g.height,m.height),_=Math.max(g.top,m.top)-k.top;i.style.top=`${Math.max(0,_)}px`,i.style.height=`${b}px`}else{const b=Math.min(g.width,m.width),_=Math.max(g.left,m.left)-k.left;i.style.left=`${Math.max(0,_)}px`,i.style.width=`${b}px`}},x=new ResizeObserver(f);x.observe(p),x.observe(h),f(),o._resizeObserver=x}),o}_getZones(e,t,o){if(e.type==="panel")return[{panels:[{id:e.id,name:this._panelName(e)}],size:100,slot:null}];const s=t==="v"?"h":"v";if(e.direction===s){const l=this._getZones(e.children[0],t,o),i=this._getZones(e.children[1],t,o);return[...l.map(r=>({panels:r.panels,size:r.size*e.sizes[0]/100,slot:r.slot!==null?r.slot:0})),...i.map(r=>({panels:r.panels,size:r.size*e.sizes[1]/100,slot:r.slot!==null?r.slot:1}))]}const a=o==="first"?e.children[1]:e.children[0];return this._getZones(a,t,o)}_allPanelNodes(e){return e.type==="panel"?[{id:e.id,name:this._panelName(e)}]:[...this._allPanelNodes(e.children[0]),...this._allPanelNodes(e.children[1])]}_findPanelNode(e,t){return e?e.type==="panel"?e.id===t?e:null:this._findPanelNode(e.children[0],t)||this._findPanelNode(e.children[1],t):null}_firstPanelId(e){return e.type==="panel"?e.id:this._firstPanelId(e.children[0])}_allPanelIds(e){return e.type==="panel"?[e.id]:[...this._allPanelIds(e.children[0]),...this._allPanelIds(e.children[1])]}_setupResize(e,t,o){const s=t.direction==="v",a=l=>{const i=o.parentElement;if(!i)return null;const r=i.getBoundingClientRect(),c=s?r.width:r.height;s?o.offsetWidth:o.offsetHeight;const u=p=>{let f=(s?p.x-r.left:p.y-r.top)/c;f=Math.max(qe/c,Math.min(1-qe/c,f)),t.sizes[0]=f*100,t.sizes[1]=(1-f)*100;const x=i.querySelectorAll(":scope > .panel, :scope > .split-v, :scope > .split-h");x.length>=2&&(x[0].style.flex=`${t.sizes[0]} 1 0`,x[x.length-1].style.flex=`${t.sizes[1]} 1 0`)},d=()=>{document.body.style.cursor="",document.body.style.userSelect="",this._onResizeEnd&&this._onResizeEnd(t)};return document.body.style.cursor=s?"col-resize":"row-resize",document.body.style.userSelect="none",{onMove:u,onEnd:d}};e.addEventListener("mousedown",l=>{l.preventDefault();const i=a({x:l.clientX,y:l.clientY});if(!i)return;const r=u=>i.onMove({x:u.clientX,y:u.clientY}),c=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",c),i.onEnd()};document.addEventListener("mousemove",r),document.addEventListener("mouseup",c)}),e.addEventListener("touchstart",l=>{l.preventDefault();const i=l.touches[0],r=a({x:i.clientX,y:i.clientY});if(!r)return;const c=d=>{d.preventDefault();const p=d.touches[0];r.onMove({x:p.clientX,y:p.clientY})},u=()=>{document.removeEventListener("touchmove",c),document.removeEventListener("touchend",u),document.removeEventListener("touchcancel",u),r.onEnd()};document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",u),document.addEventListener("touchcancel",u)})}_showStrategyPicker(e,t,o){document.querySelector(".merge-strategy-picker")?.remove();const s=this._getStrategy(e),a=s.strategy,l=document.createElement("div");l.className="merge-strategy-picker";const i=t.getBoundingClientRect();l.style.cssText=`position:fixed;left:${i.left}px;top:${i.bottom+4}px;z-index:10000`;const r=[{strat:"mirror",label:"Mirror (M)"},{strat:"push",label:"Push (P)"},{strat:"scoped",label:"Scoped (S)"},{strat:"none",label:"None (N)"}];l.innerHTML=r.map(d=>`<div class="strategy-option${a===d.strat?" active":""}" data-strat="${d.strat}">${a===d.strat?"✓ ":""}${d.label}</div>`).join("")+`
      <hr class="strategy-separator">
      <div class="strategy-option strategy-delete" data-strat="__delete__">&#x1F5D1; Delete</div>
    `,document.body.appendChild(l);const c=()=>{const d=this._getStrategy(e),p=t.querySelector(".merge-strategy-badge");p&&(p.textContent=this._strategyBadge(d.strategy)),t.classList.toggle("merge-btn-disabled",d.strategy==="none")},u=d=>{l.contains(d.target)||(l.remove(),document.removeEventListener("mousedown",u))};l.querySelectorAll(".strategy-option").forEach(d=>{d.onclick=p=>{p.stopPropagation();const h=d.dataset.strat;if(l.remove(),document.removeEventListener("mousedown",u),h==="__delete__"){if(o&&this.mergeButtonLists[o]){const f=this.mergeButtonLists[o].findIndex(x=>`${x.source}→${x.target}`===e);f!==-1&&this.mergeButtonLists[o].splice(f,1),this._rerenderGutter(o),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}return}if(h==="mirror"?delete this.mergeStrategies[e]:this.mergeStrategies[e]={strategy:h,scopeNodes:s.scopeNodes||[]},h==="scoped"){const f=e.split("→")[1],k=(this._getPanels?this._getPanels():null)?.get(f);k?Dt(k,e,this.mergeStrategies,()=>{c(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}):(c(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})))}else c(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}}),setTimeout(()=>document.addEventListener("mousedown",u),0)}updateMergeButtonStates(e){this.rootEl.querySelectorAll(".merge-btn[data-merge-source]").forEach(t=>{if(t.classList.contains("merge-btn-disabled"))return;const o=t.dataset.mergeSource,s=e.get(o),a=s?s.isClean():!0;t.classList.toggle("merge-btn-allowed",a),t.classList.toggle("merge-btn-blocked",!a)})}_showMergeManagementModal(e,t){const o=this.mergeButtonLists[e]||[],s=new Set(this._allPanelNodes(t.children[0]).map(u=>u.id)),a=()=>o.map((u,d)=>{const{source:p,target:h}=u,f=`${p}→${h}`,x=this._getStrategy(f),k=this._getPanelName(p),g=this._getPanelName(h),m=s.has(p)?`${k} >> ${g}`:`${g} << ${k}`,b=[{value:"mirror",label:"Mirror"},{value:"push",label:"Push"},{value:"scoped",label:"Scoped"},{value:"none",label:"None"}].map(_=>`<option value="${_.value}" ${x.strategy===_.value?"selected":""}>${_.label}</option>`).join("");return`
        <div class="mgmt-row" data-idx="${d}">
          <span class="mgmt-btn-label">${m}</span>
          <select class="mgmt-strat-select" data-key="${f}" data-idx="${d}">${b}</select>
          <button class="mgmt-delete-btn btn-danger" data-idx="${d}" title="Delete">&#x1F5D1;</button>
        </div>
      `}).join(""),i=N(`
      <div class="dialog-header">
        <h3>Merge Buttons</h3>
        <button id="mgmt-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Changes are applied live. Drag rows in the gutter to reorder.</p>
      <div id="mgmt-list">${a()||'<p style="color:var(--text-muted);padding:8px;text-align:center">No merge buttons</p>'}</div>
      <button id="mgmt-add" class="btn-secondary" style="margin-top:8px">+ Add Merge Button</button>
    `);i.classList.add("dialog-wide");const r=()=>{i.querySelector("#mgmt-list").innerHTML=a()||'<p style="color:var(--text-muted);padding:8px;text-align:center">No merge buttons</p>',c()},c=()=>{i.querySelectorAll(".mgmt-delete-btn").forEach(u=>{u.onclick=()=>{const d=parseInt(u.dataset.idx);o.splice(d,1),this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),r()}}),i.querySelectorAll(".mgmt-strat-select").forEach(u=>{u.onchange=()=>{const d=u.dataset.key,p=u.value;if(p==="mirror")delete this.mergeStrategies[d];else{const h=this._getStrategy(d);this.mergeStrategies[d]={strategy:p,scopeNodes:h.scopeNodes||[]}}this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}})};c(),i.querySelector("#mgmt-add").onclick=()=>{const u=this._allPanelNodes(this.tree),d=this.mergeButtonLists[e]||[];w(),qt(u,d,({source:p,target:h})=>{this.mergeButtonLists[e]||(this.mergeButtonLists[e]=[]),this.mergeButtonLists[e].push({source:p,target:h}),this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),this._showMergeManagementModal(e,t)})},i.querySelector("#mgmt-close-x").onclick=w}_mapTree(e,t){const o=t(e);return o!==e?o:e.type==="panel"?e:{...e,children:[this._mapTree(e.children[0],t),this._mapTree(e.children[1],t)]}}_removePanel(e,t){return e.type==="panel"?e:e.children[0].type==="panel"&&e.children[0].id===t?e.children[1]:e.children[1].type==="panel"&&e.children[1].id===t?e.children[0]:{...e,children:[this._removePanel(e.children[0],t),this._removePanel(e.children[1],t)]}}}let ne=null;function It(){let n=0;for(let e=0;e<localStorage.length;e++){const t=localStorage.key(e),o=localStorage.getItem(t);n+=(t.length+o.length)*2}return n}function zt(n){return n<1024?`${n}B`:n<1024*1024?`${(n/1024).toFixed(1)}KB`:`${(n/(1024*1024)).toFixed(1)}MB`}function jt(){const n=localStorage.getItem("graph-merge-sessions");if(!n)return null;try{const e=JSON.parse(n);let t=0,o=0,s=0,a=null;for(const[l,i]of Object.entries(e))if(i.panels){for(const[r,c]of Object.entries(i.panels))s++,c.graph&&(t+=c.graph.nodes?.length||0,o+=c.graph.edges?.length||0);i.savedAt&&(!a||new Date(i.savedAt)>new Date(a))&&(a=i.savedAt)}return{sessionCount:Object.keys(e).length,totalNodes:t,totalEdges:o,totalPanels:s,latestSavedAt:a}}catch(e){return console.error("Failed to parse session stats:",e),null}}function Z(){if(!ne)return;const n=ne.querySelector(".status-left"),e=ne.querySelector(".status-right"),t=It(),o=jt();let s=`Storage: ${zt(t)}`;if(o&&(s+=` | ${o.totalNodes}n ${o.totalEdges}e ${o.totalPanels}p ${o.sessionCount}s`),n.textContent=s,o&&o.latestSavedAt){const a=new Date(o.latestSavedAt).toLocaleTimeString();e.textContent=`Last: ${a}`}else e.textContent=""}function Gt(){if(ne=document.getElementById("status-bar"),!ne){console.warn("Status bar element not found");return}window.addEventListener("panel-change",Z),Z()}const Je="graph-merge-templates";function I(){try{const n=JSON.parse(localStorage.getItem(Je));if(n&&typeof n=="object")return n.Default||(n.Default=ee()),n}catch{}return{Default:ee()}}function te(n){localStorage.setItem(Je,JSON.stringify(n))}function pe(n,e){if(!e.includes(n))return n;let t=2;for(;e.includes(`${n} (${t})`);)t++;return`${n} (${t})`}function Ht(n){const e=J[n.graphType]?.label||n.graphType,t=n.nodeTypes?.length||0,o=n.edgeTypes?.length||0;return`${e} · ${t} node type${t!==1?"s":""} · ${o} edge type${o!==1?"s":""}`}function _e(){let n=null;const e=i=>{const r=Object.keys(i);return r.length===0?'<p style="color:var(--text-muted);padding:12px;text-align:center">No templates</p>':r.map(c=>{const u=i[c];return`
        <div class="template-list-item ${c===n?"selected":""}" data-name="${c}">
          <span class="tpl-name">${c}</span>
          <span class="tpl-meta">${Ht(u)}</span>
        </div>
      `}).join("")},t=i=>`
    <div class="dialog-header">
      <h3>Templates</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <div class="template-list" id="tpl-list">
      ${e(i)}
    </div>
    <div class="template-modal-footer">
      <button id="tpl-add">Add</button>
      <button id="tpl-remove">Remove</button>
      <button id="tpl-edit">Edit</button>
      <button id="tpl-copy">Copy</button>
      <button id="tpl-import">Import</button>
      <button id="tpl-export">Export</button>
    </div>
  `,o=I(),s=N(t(o));s.classList.add("dialog-wide");const a=()=>{const i=I();s.querySelector("#tpl-list").innerHTML=e(i),l()},l=()=>{s.querySelectorAll(".template-list-item").forEach(i=>{i.onclick=()=>{n=i.dataset.name,a()}})};l(),s.addEventListener("click",i=>{i.target.matches("#dlg-close-x")&&w()}),s.querySelector("#tpl-add").onclick=()=>{const i=Object.entries(J).map(([r,c])=>`<option value="${r}">${c.label}</option>`).join("");s.querySelector("#tpl-list").innerHTML=`
      <div style="padding:12px;display:flex;flex-direction:column;gap:8px">
        <label>Template Name</label>
        <input id="tpl-new-name" type="text" placeholder="Template name" autofocus>
        <label>Graph Type</label>
        <select id="tpl-graph-type">${i}</select>
        <div style="display:flex;gap:8px;margin-top:4px">
          <button id="tpl-create-confirm" class="btn-primary">Create</button>
          <button id="tpl-create-cancel">Cancel</button>
        </div>
      </div>
    `,s.querySelector("#tpl-new-name").focus(),s.querySelector("#tpl-create-cancel").onclick=a,s.querySelector("#tpl-create-confirm").onclick=()=>{const r=s.querySelector("#tpl-new-name").value.trim();if(!r){y("Template name required","error");return}const c=s.querySelector("#tpl-graph-type").value,u=I(),d=pe(r,Object.keys(u));u[d]=at(d,c),te(u),n=d,y(`Created template "${d}"`,"success"),a()}},s.querySelector("#tpl-remove").onclick=()=>{if(!n){y("Select a template first","info");return}if(n==="Default"){y("Cannot remove the Default template","info");return}const i=I(),r=n;confirm(`Delete template "${r}"?`)&&(delete i[r],te(i),n=null,y(`Deleted template "${r}"`,"info"),a())},s.querySelector("#tpl-edit").onclick=()=>{if(!n){y("Select a template first","info");return}const r=I()[n];if(!r)return;w();const c=n;Ue(JSON.parse(JSON.stringify(r)),u=>{const d=I();d[c]=u,te(d),y("Template updated","success"),_e()},!1,()=>_e())},s.querySelector("#tpl-copy").onclick=()=>{if(!n){y("Select a template first","info");return}const i=I(),r=i[n];if(!r)return;const c=pe(n+" Copy",Object.keys(i));i[c]={...JSON.parse(JSON.stringify(r)),name:c},te(i),n=c,y(`Copied as "${c}"`,"success"),a()},s.querySelector("#tpl-import").onclick=()=>{const i=document.createElement("input");i.type="file",i.accept=".json",i.onchange=()=>{const r=i.files[0];if(!r)return;const c=new FileReader;c.onload=u=>{let d;try{d=JSON.parse(u.target.result)}catch{y("Invalid JSON file","error");return}if(!d.template||!d.template.name){y("Invalid template file","error");return}const p=I(),h=pe(d.template.name,Object.keys(p));p[h]={...d.template,name:h},te(p),n=h,y(`Imported template "${h}"`,"success"),a()},c.readAsText(r)},i.click()},s.querySelector("#tpl-export").onclick=()=>{if(!n){y("Select a template first","info");return}const r=I()[n];if(!r)return;const c=JSON.stringify({version:1,template:r},null,2),u=new Blob([c],{type:"application/json"}),d=URL.createObjectURL(u),p=document.createElement("a");p.href=d,p.download=`template-${n.replace(/[^a-zA-Z0-9_-]/g,"_")}.json`,p.click(),URL.revokeObjectURL(d),y(`Exported template "${n}"`,"success")}}const We="graph-merge-sessions",Ze="graph-merge-active-session";let ae=null,F=null,Me=null,G=ee(),W=null;function U(){try{return JSON.parse(localStorage.getItem(We))||{}}catch{return{}}}function ie(n){localStorage.setItem(We,JSON.stringify(n))}function Q(){return localStorage.getItem(Ze)||"Default"}function he(n){localStorage.setItem(Ze,n)}function Bt(n){if(!n.state||n.layout)return n;const e=Object.keys(n.state),t={};let o=1;for(const s of e.slice(0,2)){const a=String(o++),l=n.state[s];t[a]={...l,id:a}}return{layout:{tree:{type:"split",direction:"v",children:[{type:"panel",id:"1"},{type:"panel",id:"2"}],sizes:[50,50]},nextId:o},panels:t,template:{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[]},savedAt:n.savedAt}}function Rt(n){return n.template?(n.template.specialTypes||(n={...n,template:{...n.template,specialTypes:[]}}),n):{...n,template:{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[],specialTypes:[]}}}function Ft(n){if(!n.panels)return n;const e={};for(const[t,o]of Object.entries(n.panels))e[t]={pathTrackingEnabled:!1,showExclusions:!0,exclusions:{},...o};return{...n,panels:e}}function Ut(){return G}function Y(){if(!ae||!F)return;const n=Q(),e=U(),t={};for(const[o,s]of ae)t[o]=s.getState();e[n]={layout:F.getLayout(),panels:t,template:G,savedAt:new Date().toISOString()},ie(e)}function me(n){if(!ae||!F)return;const e=U();let t=e[n];if(t){if(t=Bt(t),t=Rt(t),t=Ft(t),e[n]=t,ie(e),t.layoutAlgorithm&&t.panels)for(const o of Object.values(t.panels))o.layoutAlgorithm||(o.layoutAlgorithm=t.layoutAlgorithm);if(G=t.template||ee(),W&&W(G),t.layout&&F.setLayout(t.layout),t.panels)for(const[o,s]of ae)t.panels[o]&&s.setState(t.panels[o]);he(n),Z()}}function Ye(){clearTimeout(Me),Me=setTimeout(Y,2e3)}function oe(){const n=document.getElementById("session-controls");if(!n)return;const e=U(),t=Q(),o=Object.keys(e);o.includes(t)||o.unshift(t);const s=o.map(d=>`<option value="${d}" ${d===t?"selected":""}>${d}</option>`).join("");n.innerHTML=`
    <select id="session-select">${s}</select>
    <div class="session-menu-wrapper">
      <button id="session-menu-toggle" class="btn-icon" title="Session actions">&#x2630;</button>
      <div id="session-menu" class="session-dropdown" hidden>
        <button id="session-new">New</button>
        <button id="session-rename">Rename</button>
        <button id="session-delete">Delete</button>
        <hr class="menu-divider">
        <button id="session-edit-template">Edit Template</button>
        <hr class="menu-divider">
        <button id="session-export">Export</button>
        <button id="session-import">Import</button>
      </div>
    </div>
    <button id="templates-btn" title="Manage templates">Templates</button>
    <button id="add-panel-btn" title="Add panel" style="font-weight:bold;font-size:14px">+</button>
    <button class="help-btn" id="help-btn" title="Keyboard shortcuts">?</button>
  `;const a=n.querySelector("#session-menu"),l=n.querySelector("#session-menu-toggle"),i=()=>a.hidden=!0;l.onclick=d=>{d.stopPropagation(),a.hidden=!a.hidden};const r=d=>{n.contains(d.target)||i()};document.addEventListener("click",r);const c=new MutationObserver(()=>{document.contains(l)||(document.removeEventListener("click",r),c.disconnect())});c.observe(document.body,{childList:!0,subtree:!0});const u=(d,p)=>{const h=n.querySelector(d);h&&(h.onclick=()=>{i(),p()})};n.querySelector("#templates-btn").onclick=()=>_e(),n.querySelector("#session-select").onchange=d=>{Y(),me(d.target.value),y(`Switched to "${d.target.value}"`,"info"),Z()},u("#session-new",async()=>{const d=I(),p=await Mt(d);if(!p)return;const{name:h,templateName:f}=p,x=JSON.parse(JSON.stringify(d[f]||ee()));Y(),G=x,W&&W(G),F.init(),he(h.trim()),Y(),oe(),y(`Created session "${h.trim()}"`,"success"),Z()}),u("#session-rename",()=>{const d=Q(),p=prompt("New name:",d);if(!p||!p.trim()||p.trim()===d)return;const h=U();h[p.trim()]=h[d],delete h[d],ie(h),he(p.trim()),oe(),y(`Renamed to "${p.trim()}"`,"success")}),u("#session-delete",()=>{const d=Q();if(!confirm(`Delete session "${d}"?`))return;const p=U();delete p[d],ie(p);const h=Object.keys(p);h.length>0?me(h[0]):(he("Default"),F.init()),oe(),y(`Deleted session "${d}"`,"info"),Z()}),u("#session-edit-template",()=>{Ue(G,d=>{G=d,W&&W(G),Ye(),y("Template updated","success")},!0)}),u("#session-export",Wt),u("#session-import",Zt),n.querySelector("#add-panel-btn").onclick=()=>F.addPanel(),n.querySelector("#help-btn").onclick=()=>{Jt()}}function Jt(){let n=document.querySelector(".keyboard-help");n||(n=document.createElement("div"),n.className="keyboard-help",n.innerHTML=`
      <h3>Keyboard Shortcuts</h3>
      <dl>
        <dt><kbd>Ctrl</kbd>+<kbd>Z</kbd></dt><dd>Undo</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Z</kbd></dt><dd>Redo</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>C</kbd></dt><dd>Copy selected subgraph</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>V</kbd></dt><dd>Paste into focused panel</dd>
        <dt><kbd>Delete</kbd></dt><dd>Delete selected elements</dd>
        <dt><kbd>Escape</kbd></dt><dd>Deselect all / close dialog</dd>
      </dl>
      <div class="dialog-actions" style="margin-top:12px">
        <button onclick="this.closest('.keyboard-help').classList.remove('visible')">Close</button>
      </div>
    `,document.body.appendChild(n)),n.classList.toggle("visible")}function Wt(){Y();const n=Q(),t=U()[n];if(!t){y("No session to export","error");return}const o=JSON.stringify({version:2,exportedAt:new Date().toISOString(),sessionName:n,...t},null,2),s=new Blob([o],{type:"application/json"}),a=URL.createObjectURL(s),l=document.createElement("a");l.href=a;const i=new Date().toISOString().slice(0,10),r=n.replace(/[^a-zA-Z0-9_-]/g,"_");l.download=`session-${r}-${i}.json`,l.click(),URL.revokeObjectURL(a),y(`Exported session "${n}"`,"success")}function Zt(){const n=document.createElement("input");n.type="file",n.accept=".json",n.onchange=()=>{const e=n.files[0];if(!e)return;const t=new FileReader;t.onload=o=>{let s;try{s=JSON.parse(o.target.result)}catch{y("Invalid JSON file","error");return}if(!s.layout||!s.panels){y("Invalid session file: missing layout or panels","error");return}const a=U(),l=s.sessionName||"Imported",i=prompt("Session name for imported session:",pe(l,Object.keys(a)));if(!i||!i.trim())return;const r=i.trim();a[r]={layout:s.layout,panels:s.panels,template:s.template||{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[]},layoutAlgorithm:s.layoutAlgorithm,savedAt:s.savedAt||new Date().toISOString()},ie(a),Y(),me(r),oe(),y(`Imported session "${r}"`,"success"),Z()},t.readAsText(e)},n.click()}function Yt(n,e,t){ae=n,F=e,W=t,window.addEventListener("panel-change",Ye);const o=Q();U()[o]?me(o):Y(),oe()}let B=null,D=null,le={},M=null,re=null,H=null;function Kt(n){B=n,document.getElementById("app").addEventListener("mousedown",e=>{const t=e.target.closest("[data-panel-id]");t&&(M=t.dataset.panelId)}),document.addEventListener("keydown",e=>{if(!e.target.matches("input, textarea, select")){if(e.ctrlKey&&e.key==="c")e.preventDefault(),Qt();else if(e.ctrlKey&&e.key==="v")e.preventDefault(),es();else if(e.key==="Delete"||e.key==="Backspace"){if(M){const t=B().get(M);t&&t.deleteSelected((o,s)=>q(o,s,t.panelEl))}}else if(e.key==="Escape"&&M){const t=B().get(M);t&&t.cy.elements().unselect()}}})}function Ke(n){const e=B().get(n);if(!e)return;const t=e.getSelectedSubgraph();if(!t||t.nodes.length===0&&t.edges.length===0){y("Nothing selected to copy","info");return}D=t,le=e.getRelevantExclusions(t),re="elements",H=null,y(`Copied ${t.nodes.length} node(s), ${t.edges.length} edge(s)`,"success")}function Ve(n){if(!D){y("Clipboard is empty","info");return}const e=B().get(n);if(!e)return;const t=B().get(M),o=t?t.pathTrackingEnabled:!1,s=`paste → ${e.id}`,a=e.pasteSubgraph(D,s,le,o);a.ok?y("Pasted subgraph","success"):y(a.error,"error")}function Vt(n,e){const t=B().get(n);if(!t)return;const o=Ie(t.graph,e);if(o.nodes.length===0){y("No ancestors found","info");return}D=o,le=t.getRelevantExclusions(o),re="branch",H=e,t.selectBranch(e),y(`Copied branch from "${e}" (${o.nodes.length} node(s), ${o.edges.length} edge(s))`,"success")}function Xt(n,e){if(!D||re!=="branch"||!H){y("No branch in clipboard","info");return}const t=B().get(n);if(!t)return;let o=D;e!==H&&(o={nodes:[...D.nodes],edges:[...D.edges,it(H,e)]});const s=B().get(M),a=s?s.pathTrackingEnabled:!1,l=`branch paste → ${e}`,i=t.pasteSubgraph(o,l,le,a);i.ok?y(e===H?"Pasted branch (no linking edge)":`Pasted branch with edge ${H} → ${e}`,"success"):y(i.error,"error")}function Xe(){D=null,le={},re=null,H=null,y("Clipboard cleared","info")}function Qe(){return D?{hasContent:!0,mode:re,branchRoot:H,nodeCount:D.nodes.length,edgeCount:D.edges.length}:{hasContent:!1}}function Qt(){if(!M){y("Click a panel first","info");return}Ke(M)}function es(){if(!M){y("Click a panel first","info");return}Ve(M)}let z=null;function ts(){return z||(z=document.createElement("div"),z.className="context-menu",z.style.display="none",document.body.appendChild(z),document.addEventListener("click",n=>{z.contains(n.target)||ge()}),document.addEventListener("touchstart",n=>{z.contains(n.target)||ge()}),document.addEventListener("keydown",n=>{n.key==="Escape"&&ge()})),z}function xe(n,e,t){const o=ts();o.innerHTML="";for(const s of t){if(s.separator){const l=document.createElement("div");l.className="context-menu-separator",o.appendChild(l);continue}const a=document.createElement("button");a.className="context-menu-item",s.disabled&&(a.className+=" context-menu-item-disabled"),a.textContent=s.label,s.disabled||(a.onclick=()=>{ge(),s.action()}),o.appendChild(a)}o.style.display="block",o.style.left=`${n}px`,o.style.top=`${e}px`,requestAnimationFrame(()=>{const s=o.getBoundingClientRect();s.right>window.innerWidth&&(o.style.left=`${window.innerWidth-s.width-4}px`),s.bottom>window.innerHeight&&(o.style.top=`${window.innerHeight-s.height-4}px`)})}function ge(){z&&(z.style.display="none")}function Se(n){const e=n.originalEvent||n;return e.touches&&e.touches.length>0?{x:e.touches[0].clientX,y:e.touches[0].clientY}:e.changedTouches&&e.changedTouches.length>0?{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}:{x:e.clientX||0,y:e.clientY||0}}function ss(n){const e=[{label:"Add Node",action:()=>Be(n)},{label:"Add Edge",action:()=>Re(n)}],t=n.cy.$(":selected"),o=Qe();return(!t.empty()||o.hasContent)&&(e.push({separator:!0}),t.empty()||e.push({label:`Copy Selected (${t.length})`,action:()=>Ke(n.id)}),o.hasContent&&(e.push({label:`Paste (${o.nodeCount}n, ${o.edgeCount}e)`,action:async()=>{await q("Paste Confirmation",`Paste ${o.nodeCount} node(s) and ${o.edgeCount} edge(s)?${o.mode==="branch"?`
Branch root: "${o.branchRoot}"`:""}`,n.panelEl)&&Ve(n.id)}}),e.push({label:"Cancel Copy",action:()=>Xe()}))),t.empty()||(e.push({separator:!0}),e.push({label:`Delete Selected (${t.length})`,action:()=>n.deleteSelected((s,a)=>q(s,a,n.panelEl))})),e.push({separator:!0}),e.push({label:"Select All",action:()=>n.cy.elements().select()}),t.empty()||e.push({label:"Deselect All",action:()=>n.cy.elements().unselect()}),e}function ns(n,e){const t=e.data("label"),o=Qe(),s=n.cy.$(":selected").length,a=[{label:`Edit Node "${t}"`,action:()=>{n.cy.elements().unselect(),e.select(),Fe(n)}},{label:`Delete Node "${t}"`,action:()=>{n.cy.elements().unselect(),e.select(),n.deleteSelected((l,i)=>q(l,i,n.panelEl))}}];return s>1&&(a.push({separator:!0}),a.push({label:`Delete all selected (${s})`,action:()=>n.deleteSelected((l,i)=>q(l,i,n.panelEl))})),n.pathTrackingEnabled&&e.hasClass("node-fully-excluded")&&(a.push({separator:!0}),a.push({label:"Include All Paths",action:()=>{const l=n.graph.edges.filter(i=>i.source===t);for(const i of l){const r=`${i.source}→${i.target}`;if(n.exclusions[r]){const c=[...n.exclusions[r]||[]];for(const u of c)n.includePathTag(r,u)}}}})),a.push({separator:!0}),a.push({label:`Select Branch from "${t}"`,action:()=>n.selectBranch(t)}),a.push({label:`Copy Branch from "${t}"`,action:()=>Vt(n.id,t)}),o.hasContent&&o.mode==="branch"&&a.push({label:`Paste Branch onto "${t}"`,action:async()=>{const l=o.branchRoot!==t?`
Will create edge: ${o.branchRoot} → ${t}`:"";await q("Paste Branch Confirmation",`Paste branch from "${o.branchRoot}" (${o.nodeCount}n, ${o.edgeCount}e)?${l}`,n.panelEl)&&Xt(n.id,t)}}),o.hasContent&&a.push({label:"Cancel Copy",action:()=>Xe()}),a}function os(n,e){const t=e.data("source"),o=e.data("target"),s=`${t}→${o}`,a=n.cy.$(":selected").length,l=[{label:`Edit Edge "${t} -> ${o}"`,action:()=>{n.cy.elements().unselect(),e.select(),Fe(n)}},{label:`Delete Edge "${t} -> ${o}"`,action:()=>{n.cy.elements().unselect(),e.select(),n.deleteSelected((i,r)=>q(i,r,n.panelEl))}}];if(a>1&&(l.push({separator:!0}),l.push({label:`Delete all selected (${a})`,action:()=>n.deleteSelected((i,r)=>q(i,r,n.panelEl))})),n.pathTrackingEnabled&&n._pathTags){const i=n.template?.specialTypes||[],r=n._pathTags.get(s)||[],c=n._effectiveExclusions?.get(s)||new Set,u=new Set(n.exclusions[s]||[]);if(r.length>0){l.push({separator:!0});const d=h=>L(h,i),p=h=>j(h,i,n.template?.nodeTypes||[]);if(r.length<=6)for(const h of r){const f=d(h),x=u.has(f),k=c.has(f)&&!x,g=p(h);x?l.push({label:`Include ${g}`,action:()=>n.includePathTag(s,f)}):k?l.push({label:`Excluded ${g} (inherited)`,action:()=>De(n,s)}):l.push({label:`Exclude ${g}`,action:()=>n.excludePathTag(s,f)})}else l.push({label:"Exclusions...",action:()=>De(n,s)})}}return l}function as(n){n.container.addEventListener("contextmenu",s=>s.preventDefault());const e=s=>{if(s.target!==n.cy)return;const a=Se(s);xe(a.x,a.y,ss(n))};n.cy.on("cxttap",e),n.cy.on("taphold",e);const t=s=>{const a=s.target;if(a.hasClass("diff-removed"))return;const l=Se(s);xe(l.x,l.y,ns(n,a))};n.cy.on("cxttap","node",t),n.cy.on("taphold","node",t);const o=s=>{const a=s.target;if(a.hasClass("diff-removed"))return;const l=Se(s);xe(l.x,l.y,os(n,a))};n.cy.on("cxttap","edge",o),n.cy.on("taphold","edge",o)}$e.use(ot);const P=new Map;function is(n){for(const e of P.values())e.setTemplate(n)}const O=new Ot(document.getElementById("app"),{onPanelCreate(n,e){const t=Ut(),o=new $t(n,e,t);P.set(n,o),as(o)},onPanelDestroy(n){const e=P.get(n);e&&(e.cy.destroy(),P.delete(n))},async onMerge(n,e){const t=P.get(n),o=P.get(e);if(!t||!o)return;const s=`${n}→${e}`,a=O._getStrategy(s),l=a.strategy,i=a.scopeNodes||[];if(l==="none")return;if(t.baseGraph&&!t.isClean()){await He("Merge Blocked",`Panel ${n} has unapproved changes. Approve Panel ${n} first, then merge.`,document.querySelector(`.panel[data-panel-id="${e}"]`));return}const r=`${n} → ${e}`,c=o.receiveMerge(t.getGraph(),r,t.exclusions,t.pathTrackingEnabled,l,i);c.ok?y(`Pushed ${r}`,"success"):y(c.error,"error")},getState(n){const e=P.get(n);return e?e.getState():null},setState(n,e){const t=P.get(n);t&&t.setState(e)},async confirmClose(n){return await q("Close Panel?",`Close Panel ${n}? Graph data will be lost.`,document.querySelector(`.panel[data-panel-id="${n}"]`))},getPanels(){return P},onResizeEnd(n){const e=O._allPanelIds(n.children[0]),t=O._allPanelIds(n.children[1]);for(const o of[...e,...t]){const s=P.get(o);s&&s.cy&&(s.cy.resize(),s.cy.fit())}}});document.getElementById("app").addEventListener("click",async n=>{const e=n.target.closest("[data-action]");if(!e)return;const t=e.closest(".panel");if(!t)return;const o=t.dataset.panelId,s=P.get(o);if(s)switch(e.dataset.action){case"add-node":Be(s);break;case"add-edge":Re(s);break;case"clear":{await q("Clear Panel?",`Reset Panel ${o} to empty state? This clears the graph, approval history, and all diffs.`,t)&&s.clearGraph();break}case"approve":{await q("Approve Panel?",`This will set the current state of Panel ${o} as the baseline and clear all diffs.`,t)&&s.approve();break}case"undo":s.undo();break;case"redo":s.redo();break;case"changeset":Pt(s);break;case"changelog":Nt(s);break;case"refresh":s.cy.resize(),s._runLayout(),s._recomputePathTracking();break;case"restore":{await q("Restore Panel?",`Restore Panel ${o} to last approved state? Current changes will be lost.`,t)&&s.restoreFromApproved();break}case"import":Ct(s);break;case"export":s.exportGraph();break;case"panel-options":Lt(s);break}});O.init();Yt(P,O,n=>{is(n)});Kt(()=>P);Gt();requestAnimationFrame(()=>O.updateMergeButtonStates(P));document.addEventListener("keydown",async n=>{if(n.key==="Escape"&&O._zoomedPanelId){O.toggleZoom(O._zoomedPanelId);return}if((n.ctrlKey||n.metaKey)&&n.key==="z"&&!n.shiftKey){n.preventDefault();const e=Array.from(P.values()).find(t=>t.cy.container()===document.activeElement||t.cy.container().contains(document.activeElement));e?e.undo():P.size>0&&P.values().next().value.undo()}if((n.ctrlKey||n.metaKey)&&n.key==="z"&&n.shiftKey){n.preventDefault();const e=Array.from(P.values()).find(t=>t.cy.container()===document.activeElement||t.cy.container().contains(document.activeElement));e?e.redo():P.size>0&&P.values().next().value.redo()}});const ls=()=>O.updateMergeButtonStates(P);window.addEventListener("panel-change",ls);window.__panels=P;window.__layout=O;
