import{r as nt,g as ot,c as we}from"./vendor-Cd8GHXwj.js";(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))n(t);new MutationObserver(t=>{for(const a of t)if(a.type==="childList")for(const i of a.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function s(t){const a={};return t.integrity&&(a.integrity=t.integrity),t.referrerPolicy&&(a.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?a.credentials="include":t.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function n(t){if(t.ep)return;t.ep=!0;const a=s(t);fetch(t.href,a)}})();var at=nt();const lt=ot(at),Z={UCG:{label:"Undirected Cyclic Graph",directed:!1,acyclic:!1},UTree:{label:"Undirected Tree",directed:!1,acyclic:!0,mustBeConnected:!0},DAG:{label:"Directed Acyclic Graph",directed:!0,acyclic:!0},DG:{label:"Directed Graph",directed:!0,acyclic:!1},Forest:{label:"Forest",directed:!1,acyclic:!0}},se=()=>({name:"Default",graphType:"UCG",nodeTypes:[],edgeTypes:[],specialTypes:[],defaultLayoutAlgorithm:"fcose"}),it=(o,e="UCG")=>({name:o,graphType:e,nodeTypes:[],edgeTypes:[],specialTypes:[],defaultLayoutAlgorithm:"fcose"}),ze=[{selector:"node",style:{label:"data(label)","background-color":"#4fc3f7",color:"#e0e0e0","text-valign":"center","text-halign":"center","font-size":"12px",width:40,height:40,"border-width":2,"border-color":"#2a3a5c","text-outline-width":2,"text-outline-color":"#1a1a2e"}},{selector:"edge",style:{width:2,"line-color":"#5a6a8c","target-arrow-color":"#5a6a8c","target-arrow-shape":"triangle","curve-style":"bezier","arrow-scale":.8}},{selector:"node:selected",style:{"border-color":"#fff","border-width":3}},{selector:"edge:selected",style:{"line-color":"#fff","target-arrow-color":"#fff",width:3}},{selector:".edge-excluded",style:{"line-style":"dashed","line-dash-pattern":[6,3]}},{selector:".edge-all-excluded",style:{"line-style":"dotted","line-dash-pattern":[2,4],opacity:.4}},{selector:".node-fully-excluded",style:{"border-style":"dotted","border-width":3,opacity:.5}},{selector:".tracking-hidden",style:{display:"none"}},{selector:".diff-added",style:{"background-color":"#4CAF50","border-color":"#4CAF50","line-color":"#4CAF50","target-arrow-color":"#4CAF50"}},{selector:".diff-removed",style:{"background-color":"#F44336","border-color":"#F44336","line-color":"#F44336","target-arrow-color":"#F44336",opacity:.5,"border-style":"dashed","line-style":"dashed"}},{selector:".diff-modified",style:{"border-color":"#FF9800","border-width":3,"line-color":"#FF9800","target-arrow-color":"#FF9800"}}];function Ee(o){const e=[...ze],s=Z[o?.graphType];s&&!s.directed&&e.push({selector:"edge",style:{"target-arrow-shape":"none"}});for(const n of o?.nodeTypes||[])e.push({selector:`node[type = "${n.id}"]`,style:{"background-color":n.color}});for(const n of o?.edgeTypes||[])e.push({selector:`edge[type = "${n.id}"]`,style:{"line-color":n.color,"target-arrow-color":n.color}});return e}const _=o=>JSON.parse(JSON.stringify(o)),ve=()=>({nodes:[],edges:[]}),Q=o=>o.label,ee=o=>`${o.source}→${o.target}`,rt=(o,e,s={},n=null)=>({source:o,target:e,type:n,props:{...s}}),Ce=o=>o.nodes.length===0&&o.edges.length===0,Be=(o,e)=>{const s=new Set,n=[e];for(;n.length>0;){const t=n.shift();if(!s.has(t)){s.add(t);for(const a of o.edges)a.target===t&&!s.has(a.source)&&n.push(a.source)}}return{nodes:o.nodes.filter(t=>s.has(t.label)).map(t=>_(t)),edges:o.edges.filter(t=>s.has(t.source)&&s.has(t.target)).map(t=>_(t))}};function V(o,e){if(!o)return[];const s=[],n=new Map(o.nodes.map(l=>[Q(l),l])),t=new Map(e.nodes.map(l=>[Q(l),l])),a=new Map(o.edges.map(l=>[ee(l),l])),i=new Map(e.edges.map(l=>[ee(l),l]));for(const[l,r]of t)if(!n.has(l))s.push({type:"node",action:"added",key:l,oldProps:null,newProps:r.props});else{const c=n.get(l);Pe(c.props,r.props)||s.push({type:"node",action:"modified",key:l,oldProps:c.props,newProps:r.props})}for(const[l,r]of n)t.has(l)||s.push({type:"node",action:"removed",key:l,oldProps:r.props,newProps:null});for(const[l,r]of i)if(!a.has(l))s.push({type:"edge",action:"added",key:l,oldProps:null,newProps:r.props});else{const c=a.get(l);Pe(c.props,r.props)||s.push({type:"edge",action:"modified",key:l,oldProps:c.props,newProps:r.props})}for(const[l,r]of a)i.has(l)||s.push({type:"edge",action:"removed",key:l,oldProps:r.props,newProps:null});return s}function Pe(o,e){const s=Object.keys(o),n=Object.keys(e);return s.length!==n.length?!1:s.every(t=>o[t]===e[t])}function Ae(o,e){if(!e||e.length===0)return o;const s=new Set(e),n=[...e];for(;n.length>0;){const t=n.shift();for(const a of o.edges)a.target===t&&!s.has(a.source)&&(s.add(a.source),n.push(a.source))}return{nodes:o.nodes.filter(t=>s.has(t.label)),edges:o.edges.filter(t=>s.has(t.source)&&s.has(t.target))}}function Ne(o,e,s=null){const n=new Map(o.nodes.map(a=>[Q(a),_(a)])),t=new Map(o.edges.map(a=>[ee(a),_(a)]));for(const a of e.nodes){const i=Q(a);n.has(i)?n.get(i).props={...a.props}:n.set(i,_(a))}for(const a of e.edges){const i=ee(a);t.has(i)?t.get(i).props={...a.props}:t.set(i,_(a))}if(s){const a=new Set(e.nodes.map(r=>Q(r))),i=new Set(e.edges.map(r=>ee(r)));for(const r of s.nodes){const c=Q(r);a.has(c)||n.delete(c)}for(const r of s.edges){const c=ee(r);i.has(c)||t.delete(c)}const l=new Set(n.keys());for(const[r,c]of t)(!l.has(c.source)||!l.has(c.target))&&t.delete(r)}return{nodes:[...n.values()],edges:[...t.values()]}}function ct(o){if(!o||typeof o!="object")return{ok:!1,error:"Invalid data: expected an object"};if(!Array.isArray(o.nodes))return{ok:!1,error:"Invalid data: missing nodes array"};if(!Array.isArray(o.edges))return{ok:!1,error:"Invalid data: missing edges array"};const e=new Set;for(const n of o.nodes){if(!n.label||typeof n.label!="string")return{ok:!1,error:"Invalid node: missing or invalid label"};if(e.has(n.label))return{ok:!1,error:`Duplicate node label: "${n.label}"`};if(e.add(n.label),n.props&&typeof n.props!="object")return{ok:!1,error:`Invalid props on node "${n.label}"`}}for(const n of o.edges){if(!n.source||!n.target)return{ok:!1,error:"Invalid edge: missing source or target"};if(!e.has(n.source))return{ok:!1,error:`Edge references unknown source: "${n.source}"`};if(!e.has(n.target))return{ok:!1,error:`Edge references unknown target: "${n.target}"`};if(n.props&&typeof n.props!="object")return{ok:!1,error:`Invalid props on edge "${n.source}→${n.target}"`}}return{ok:!0,graph:{nodes:o.nodes.map(n=>({label:n.label,type:n.type||null,props:n.props||{}})),edges:o.edges.map(n=>({source:n.source,target:n.target,type:n.type||null,props:n.props||{}}))}}}const dt=o=>JSON.stringify(o,null,2);function ut(o){try{const e=JSON.parse(o);return ct(e)}catch(e){return{ok:!1,error:`Invalid JSON: ${e.message}`}}}function pt(o,e="graph.json"){const s=new Blob([dt(o)],{type:"application/json"}),n=URL.createObjectURL(s),t=document.createElement("a");t.href=n,t.download=e,t.click(),URL.revokeObjectURL(n)}function ht(){return new Promise(o=>{const e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async()=>{const s=e.files[0];if(!s)return o({ok:!1,error:"No file selected"});try{const n=await s.text();o(ut(n))}catch(n){o({ok:!1,error:`Failed to read file: ${n.message}`})}},e.click()})}function f(o,e="info",s=3e3){const n=document.getElementById("toast-container"),t=document.createElement("div");t.className=`toast toast-${e}`,t.textContent=o,n.appendChild(t),setTimeout(()=>{t.style.opacity="0",t.style.transition="opacity 0.3s",setTimeout(()=>t.remove(),300)},s)}function gt(o,e,s){const n=new Set,t=[s];for(;t.length>0;){const a=t.shift();if(a===e)return!0;if(!n.has(a)){n.add(a);for(const i of o.edges)i.source===a&&!n.has(i.target)&&t.push(i.target)}}return!1}function ft(o,e,s){const n=new Set,t=[e];for(;t.length>0;){const a=t.shift();if(a===s)return!0;if(!n.has(a)){n.add(a);for(const i of o.edges)i.source===a&&!n.has(i.target)&&t.push(i.target),i.target===a&&!n.has(i.source)&&t.push(i.source)}}return!1}function mt(o,e,s,n){return n?gt(o,e,s):ft(o,e,s)}function He(o){if(o.nodes.length===0)return!0;const e=new Set,s=[o.nodes[0].label];for(;s.length>0;){const n=s.shift();if(!e.has(n)){e.add(n);for(const t of o.edges)t.source===n&&!e.has(t.target)&&s.push(t.target),t.target===n&&!e.has(t.source)&&s.push(t.source)}}return e.size===o.nodes.length}function yt(o,e){const s={nodes:o.nodes.filter(n=>n.label!==e),edges:o.edges.filter(n=>n.source!==e&&n.target!==e)};return s.nodes.length>1&&!He(s)}function bt(o,e,s){const n={nodes:[...o.nodes],edges:o.edges.filter(t=>!(t.source===e&&t.target===s))};return!He(n)}function vt(o,e,s){return o.edges.some(n=>n.source===e&&n.target===s||n.source===s&&n.target===e)}function xt(o,e,s,n){const t=Z[n];return t?e===s?{ok:!1,error:"Self-loops are not allowed"}:!t.directed&&vt(o,e,s)?{ok:!1,error:`Edge ${e}–${s} already exists`}:t.directed&&o.edges.some(a=>a.source===e&&a.target===s)?{ok:!1,error:`Edge ${e}→${s} already exists`}:t.acyclic&&mt(o,e,s,t.directed)?{ok:!1,error:`Adding this edge would create a cycle (${t.label} must be acyclic)`}:{ok:!0}:{ok:!0}}function St(o,e){if(e){const s=new Set,n=new Set,t=a=>{s.add(a),n.add(a);for(const i of o.edges)if(i.source===a&&(n.has(i.target)||!s.has(i.target)&&t(i.target)))return!0;return n.delete(a),!1};for(const a of o.nodes)if(!s.has(a.label)&&t(a.label))return!0;return!1}else{const s={};for(const t of o.nodes)s[t.label]=t.label;const n=t=>(s[t]!==t&&(s[t]=n(s[t])),s[t]);for(const t of o.edges){const a=n(t.source),i=n(t.target);if(a===i)return!0;s[a]=i}return!1}}function kt(o){const e=new Map,s=new Map;for(const l of o.nodes)e.set(l.label,[]),s.set(l.label,0);for(const l of o.edges){const r=e.get(l.source);r&&r.push(l.target),s.set(l.target,(s.get(l.target)||0)+1)}const n=new Map;for(const l of o.nodes)n.set(l.label,0);for(const l of o.edges)n.set(l.source,(n.get(l.source)||0)+1);const t=[];for(const l of o.nodes)n.get(l.label)===0&&t.push(l.label);const a=[],i=new Set;for(;t.length>0;){const l=t.shift();if(!i.has(l)){i.add(l),a.push(l);for(const r of o.edges)if(r.target===l){const c=r.source;n.set(c,(n.get(c)||1)-1),n.get(c)===0&&t.push(c)}}}for(const l of o.nodes)i.has(l.label)||a.push(l.label);return a}function _t(o,e){if(!e||e.length===0)return new Map;const s=new Map(o.nodes.map(l=>[l.label,l])),n=new Map(o.nodes.map(l=>[l.label,[]]));for(const l of o.edges){const r=n.get(l.source);r&&r.push(l.target)}const t=kt(o),a=new Map;for(const l of t){const r=s.get(l);if(!r)continue;const c=n.get(l)||[];let u;if(c.length===0)r.type&&e.includes(r.type)?u=[{[r.type]:l}]:u=[{}];else{u=[];for(const p of c){const h=a.get(p)||[{}];u.push(...h)}const d=new Set;u=u.filter(p=>{const h=q(p,e);return d.has(h)?!1:(d.add(h),!0)}),r.type&&e.includes(r.type)&&(u=u.map(p=>({...p,[r.type]:l})))}a.set(l,u)}const i=new Map;for(const l of o.edges){const r=`${l.source}→${l.target}`;i.set(r,a.get(l.target)||[{}])}return i}function qe(o,e,s,n=[]){const t=new Map;for(const[r,c]of Object.entries(e)){const u=Array.isArray(c)?new Set(c):new Set(Object.keys(c).length?[c]:[]);u.size>0&&t.set(r,u)}if(!s||s.size===0)return t;const a=new Map;for(const r of o.nodes)a.set(r.label,[]);for(const r of o.edges){const c=a.get(r.target);c&&c.push(r.source)}const i=[];for(const[r,c]of t){const[u]=r.split("→");i.push({target:u,tags:new Set(c)})}const l=new Set;for(;i.length>0;){const{target:r,tags:c}=i.shift(),u=`${r}:${[...c].sort().join(",")}`;if(!l.has(u)){l.add(u);for(const d of a.get(r)||[]){const p=`${d}→${r}`,h=s.get(p);if(!h)continue;const y=new Set(h.map(x=>q(x,n))),b=new Set([...c].filter(x=>y.has(x)));if(b.size>0){const x=t.get(p)||new Set,S=new Set([...x,...b]);t.set(p,S),i.push({target:d,tags:b})}}}}return t}function $t(o,e,s,n,t=[]){const a=o.edges.filter(i=>i.source===e);if(a.length===0)return!1;for(const i of a){const l=`${i.source}→${i.target}`,r=s.get(l)||[],c=n.get(l)||new Set;for(const u of r){const d=q(u,t);if(!c.has(d))return!1}}return!0}function pe(o,e,s){if(!s||!e)return{...o};const n={...o};for(const[t,a]of Object.entries(e))if(n[t]){const i=new Set([...n[t],...a]);n[t]=[...i]}else n[t]=[...a];return n}function H(o,e,s){const n=[];for(const t of e)o[t]&&n.push(o[t]);return n.length===0?"(any)":`(${n.join(", ")})`}function q(o,e){return e.map(s=>o[s]||"").join("|")}function Le(o){const e={an:0,mn:0,rn:0,ae:0,me:0,re:0};for(const n of o){const t=n.type==="node";n.action==="added"?t?e.an++:e.ae++:n.action==="modified"?t?e.mn++:e.me++:n.action==="removed"&&(t?e.rn++:e.re++)}const s=[];return e.an&&s.push(`+${e.an}n`),e.mn&&s.push(`~${e.mn}n`),e.rn&&s.push(`-${e.rn}n`),e.ae&&s.push(`+${e.ae}e`),e.me&&s.push(`~${e.me}e`),e.re&&s.push(`-${e.re}e`),s.join(" ")}function Tt(o){if(o.length===0)return"No changes.";const e={addedNodes:[],removedNodes:[],modifiedNodes:[],addedEdges:[],removedEdges:[],modifiedEdges:[]};for(const n of o)n.type==="node"?n.action==="added"?e.addedNodes.push(n.key):n.action==="removed"?e.removedNodes.push(n.key):n.action==="modified"&&e.modifiedNodes.push({key:n.key,changes:n.changes}):n.action==="added"?e.addedEdges.push(n.key):n.action==="removed"?e.removedEdges.push(n.key):n.action==="modified"&&e.modifiedEdges.push({key:n.key,changes:n.changes});const s=[];if(e.addedNodes.length){const n=e.addedNodes.length;s.push(`Added ${n} node${n>1?"s":""}: ${e.addedNodes.join(", ")}`)}if(e.removedNodes.length){const n=e.removedNodes.length;s.push(`Removed ${n} node${n>1?"s":""}: ${e.removedNodes.join(", ")}`)}if(e.modifiedNodes.length){const n=e.modifiedNodes.map(({key:a,changes:i})=>{const l=i&&i.length?`(${i.map(r=>r.key).join(", ")} changed)`:"";return l?`${a} ${l}`:a}),t=e.modifiedNodes.length;s.push(`Modified ${t} node${t>1?"s":""}: ${n.join(", ")}`)}if(e.addedEdges.length){const n=e.addedEdges.length;s.push(`Added ${n} edge${n>1?"s":""}: ${e.addedEdges.join(", ")}`)}if(e.removedEdges.length){const n=e.removedEdges.length;s.push(`Removed ${n} edge${n>1?"s":""}: ${e.removedEdges.join(", ")}`)}if(e.modifiedEdges.length){const n=e.modifiedEdges.map(({key:a,changes:i})=>{const l=i&&i.length?`(${i.map(r=>r.key).join(", ")} changed)`:"";return l?`${a} ${l}`:a}),t=e.modifiedEdges.length;s.push(`Modified ${t} edge${t>1?"s":""}: ${n.join(", ")}`)}return s.join(". ")+"."}class wt{constructor(e,s,n=null){this.id=e,this.graph=ve(),this.baseGraph=null,this.mergeDirection=null,this.lastApproval=null,this.container=s,this.template=n||se(),this.layoutAlgorithm=n?.defaultLayoutAlgorithm||"fcose",this.pathTrackingEnabled=!1,this.showExclusions=!0,this.exclusions={},this._pathTags=null,this._effectiveExclusions=null,this._history=[],this._redoStack=[],this._maxHistory=10,this._approvalHistory=[],this._maxApprovalHistory=20,this._processingCount=0,this.cy=we({container:s,elements:[],style:Ee(this.template),layout:{name:"grid"},selectionType:"additive"}),this._tooltip=null,this._trackingOverlay=null,this.cy.on("mouseover","edge",t=>{const i=t.target.data("pathTagsTooltip");!i||!this.pathTrackingEnabled||this._showTooltip(t.originalEvent,i)}),this.cy.on("mouseout","edge",()=>this._hideTooltip()),this.cy.on("pan zoom",()=>this._hideTooltip()),this._updateHeader()}setTemplate(e){this.template=e,this.cy.style().fromJson(Ee(e)).update()}get panelEl(){return this.container.closest("[data-panel-id]")}getGraph(){return _(this.graph)}getBaseGraph(){return this.baseGraph?_(this.baseGraph):null}getState(){return{id:this.id,graph:_(this.graph),baseGraph:this.baseGraph?_(this.baseGraph):null,mergeDirection:this.mergeDirection,lastApproval:this.lastApproval,layoutAlgorithm:this.layoutAlgorithm,pathTrackingEnabled:this.pathTrackingEnabled,showExclusions:this.showExclusions,exclusions:_(this.exclusions),_history:this._history.map(e=>_(e)),_redoStack:this._redoStack.map(e=>_(e)),_approvalHistory:this._approvalHistory.map(e=>({graph:_(e.graph),baseGraph:e.baseGraph?_(e.baseGraph):null,timestamp:e.timestamp,diffSummary:e.diffSummary,exclusions:_(e.exclusions||{})}))}}setState(e){this.graph=e.graph||ve(),this.baseGraph=e.baseGraph||null,this.mergeDirection=e.mergeDirection||null,this.lastApproval=e.lastApproval||null;const s={cose:"fcose",dagre:"level-by-level"},n=e.layoutAlgorithm||"fcose";this.layoutAlgorithm=s[n]||n,this.pathTrackingEnabled=e.pathTrackingEnabled||!1,this.showExclusions=e.showExclusions??!0,this.exclusions=_(e.exclusions||{}),this._history=e._history?e._history.map(t=>_(t)):[],this._redoStack=e._redoStack?e._redoStack.map(t=>_(t)):[],this._approvalHistory=e._approvalHistory?e._approvalHistory.map(t=>({graph:_(t.graph),baseGraph:t.baseGraph?_(t.baseGraph):null,timestamp:t.timestamp,diffSummary:t.diffSummary,exclusions:_(t.exclusions||{}),pathTrackingEnabled:t.pathTrackingEnabled||!1})):[],this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader()}loadGraph(e){this.graph=_(e),this._syncCytoscape(),this._applyDiffClasses(),this._updateHeader(),this._emitChange()}addNode(e,s={},n=null){return this.graph.nodes.some(t=>t.label===e)?(f(`Node "${e}" already exists`,"error"),!1):(this._pushHistory(),this.graph={nodes:[...this.graph.nodes,{label:e,type:n,props:{...s}}],edges:[...this.graph.edges]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),!0)}addEdge(e,s,n={},t=null){if(!this.graph.nodes.some(l=>l.label===e))return f(`Source node "${e}" not found`,"error"),!1;if(!this.graph.nodes.some(l=>l.label===s))return f(`Target node "${s}" not found`,"error"),!1;const a=this.template?.graphType||"DG",i=xt(this.graph,e,s,a);return i.ok?(this._pushHistory(),this.graph={nodes:[...this.graph.nodes],edges:[...this.graph.edges,{source:e,target:s,type:t,props:{...n}}]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),!0):(f(i.error,"error"),!1)}updateNodeProps(e,s,n=void 0){this._pushHistory(),this.graph={nodes:this.graph.nodes.map(t=>t.label!==e?t:n!==void 0?{...t,props:{...s},type:n}:{...t,props:{...s}}),edges:[...this.graph.edges]},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}updateEdgeProps(e,s,n,t=void 0){this._pushHistory(),this.graph={nodes:[...this.graph.nodes],edges:this.graph.edges.map(a=>a.source===e&&a.target===s?t!==void 0?{...a,props:{...n},type:t}:{...a,props:{...n}}:a)},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}async deleteSelected(e=null){const s=this.cy.$(":selected");if(s.empty()){f("Nothing selected","info");return}const n=this.template?.graphType||"DG",t=Z[n],a=new Set;s.nodes().forEach(c=>a.add(c.data("label")));const i=new Set;if(s.edges().forEach(c=>i.add(`${c.data("source")}→${c.data("target")}`)),t?.mustBeConnected&&e){let c=!1;for(const u of a)if(yt(this.graph,u)){c=!0;break}if(!c)for(const u of i){const[d,p]=u.split("→");if(bt(this.graph,d,p)){c=!0;break}}if(c&&!await e("Disconnect Warning","Deleting this would disconnect the tree. Proceed anyway?"))return}this._pushHistory();const l=new Set([...i]);this.graph.edges.forEach(c=>{(a.has(c.source)||a.has(c.target))&&l.add(`${c.source}→${c.target}`)}),this.graph={nodes:this.graph.nodes.filter(c=>!a.has(c.label)),edges:this.graph.edges.filter(c=>!(i.has(`${c.source}→${c.target}`)||a.has(c.source)||a.has(c.target)))};const r={...this.exclusions};for(const c of l)delete r[c];this.exclusions=r,this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}clearGraph(){this._pushHistory(),this.graph=ve(),this.baseGraph=null,this.mergeDirection=null,this.lastApproval=null,this.exclusions={},this._approvalHistory=[],this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()}approve(){let e="(initial)";if(this.baseGraph){const s=V(this.baseGraph,this.graph);e=s.length>0?Le(s):"(no changes)"}this._approvalHistory.push({graph:_(this.graph),baseGraph:this.baseGraph?_(this.baseGraph):null,timestamp:new Date().toISOString(),diffSummary:e,exclusions:_(this.exclusions),pathTrackingEnabled:this.pathTrackingEnabled}),this._approvalHistory.length>this._maxApprovalHistory&&this._approvalHistory.shift(),this.baseGraph=_(this.graph),this.mergeDirection=null,this.lastApproval=new Date().toISOString(),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._clearDiffClasses(),this._updateHeader(),this._emitChange(),f(`Panel ${this.id} approved`,"success")}receiveMerge(e,s,n=null,t=!1,a="mirror",i=[]){if(Ce(this.graph)&&!this.baseGraph)return this.graph=_(e),this.baseGraph=_(e),this.lastApproval=new Date().toISOString(),this.mergeDirection=null,n&&(this.exclusions=pe(this.exclusions,n,t)),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),{ok:!0};this._pushHistory();const l=a==="scoped"&&i.length>0?Ae(e,i):e,r=a==="push"||a==="sync"?null:a==="scoped"&&i.length>0&&this.baseGraph?Ae(this.baseGraph,i):this.baseGraph;this.graph=Ne(this.graph,l,r),this.mergeDirection=s,n&&(this.exclusions=pe(this.exclusions,n,t)),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange();const c=Z[this.template?.graphType];return c?.acyclic&&St(this.graph,c.directed)&&f(`Warning: merge introduced a cycle in ${c.label}`,"warning"),{ok:!0}}pasteSubgraph(e,s,n=null,t=!1){return Ce(this.graph)&&!this.baseGraph?(this.graph=_(e),this.baseGraph=_(e),this.lastApproval=new Date().toISOString(),this.mergeDirection=null,n&&(this.exclusions=pe(this.exclusions,n,t)),this._syncCytoscape(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()):(this._pushHistory(),this.graph=Ne(this.graph,e,null),this.mergeDirection=s,n&&(this.exclusions=pe(this.exclusions,n,t)),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange()),{ok:!0}}selectBranch(e){const s=Be(this.graph,e);this.cy.elements().unselect();for(const n of s.nodes)this.cy.$id(n.label).select();for(const n of s.edges)this.cy.$id(`${n.source}→${n.target}`).select()}exportGraph(){pt(this.graph,`panel-${this.id}.json`)}undo(){if(this._history.length===0)return f("Nothing to undo","info"),!1;this._redoStack.push({graph:_(this.graph),exclusions:_(this.exclusions)});const e=this._history.pop();return this.graph=this._historyGraph(e),this.exclusions=this._historyExclusions(e),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),f("Undo","info"),!0}redo(){if(this._redoStack.length===0)return f("Nothing to redo","info"),!1;this._history.push({graph:_(this.graph),exclusions:_(this.exclusions)}),this._history.length>this._maxHistory&&this._history.shift();const e=this._redoStack.pop();return this.graph=this._historyGraph(e),this.exclusions=this._historyExclusions(e),this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),f("Redo","info"),!0}restoreFromApproved(){if(!this.baseGraph)return f("No approved state to restore","info"),!1;this._pushHistory(),this.graph=_(this.baseGraph);const e=this._approvalHistory[this._approvalHistory.length-1];return this.exclusions=e?.exclusions?_(e.exclusions):{},this._syncCytoscape(),this._applyDiffClasses(),this._recomputePathTrackingAsync(),this._updateHeader(),this._emitChange(),f(`Panel ${this.id} restored to approved state`,"success"),!0}getSelectedSubgraph(){const e=this.cy.$(":selected");if(e.empty())return null;const s=new Set,n=[];e.nodes().forEach(a=>{s.add(a.data("label"));const i=this.graph.nodes.find(l=>l.label===a.data("label"));i&&n.push(_(i))});const t=[];return e.edges().forEach(a=>{const i=a.data("source"),l=a.data("target");if(s.has(i)&&s.has(l)){const r=this.graph.edges.find(c=>c.source===i&&c.target===l);r&&t.push(_(r))}}),{nodes:n,edges:t}}isClean(){return this.baseGraph?V(this.baseGraph,this.graph).length===0:!0}_pushHistory(){this._history.push({graph:_(this.graph),exclusions:_(this.exclusions)}),this._history.length>this._maxHistory&&this._history.shift(),this._redoStack=[]}_historyGraph(e){return e&&e.graph?e.graph:e}_historyExclusions(e){return e&&e.exclusions?e.exclusions:{}}_syncCytoscape(){const e=[];for(const s of this.graph.nodes)e.push({group:"nodes",data:{id:s.label,label:s.label,type:s.type||null,...this._flattenProps(s.props,"p_")}});for(const s of this.graph.edges)e.push({group:"edges",data:{id:`${s.source}→${s.target}`,source:s.source,target:s.target,type:s.type||null,...this._flattenProps(s.props,"p_")}});if(this.baseGraph){const s=new Set(this.graph.nodes.map(t=>t.label)),n=new Set(this.graph.edges.map(t=>`${t.source}→${t.target}`));for(const t of this.baseGraph.nodes)s.has(t.label)||e.push({group:"nodes",data:{id:t.label,label:t.label},classes:"diff-removed"});for(const t of this.baseGraph.edges){const a=`${t.source}→${t.target}`;if(!n.has(a)){const i=new Set([...s,...this.baseGraph.nodes.map(l=>l.label)]);i.has(t.source)&&i.has(t.target)&&e.push({group:"edges",data:{id:a,source:t.source,target:t.target},classes:"diff-removed"})}}}this.cy.elements().remove(),this.cy.add(e),this._runLayout()}_applyDiffClasses(){if(!this.baseGraph)return;const e=V(this.baseGraph,this.graph);this.cy.elements().removeClass("diff-added diff-modified");for(const s of e){if(s.action==="removed")continue;const n=(s.type==="node",s.key),t=this.cy.$id(n);t.length&&t.addClass(`diff-${s.action}`)}this._updateDiffOverlay()}_clearDiffClasses(){this.cy.elements().removeClass("diff-added diff-removed diff-modified"),this.cy.$(".diff-removed").remove(),this._updateDiffOverlay()}_updateHeader(){const e=this.panelEl?.querySelector(".panel-info");if(!e)return;const s=[];if(this.baseGraph&&!this.isClean()){const n=V(this.baseGraph,this.graph).length;s.push(`${n} change${n!==1?"s":""}`)}e.innerHTML=s.join(" · "),this._updateApprovalOverlay()}_updateApprovalOverlay(){let e=this.container.querySelector(".approval-indicator");if(e||(e=document.createElement("div"),e.className="approval-indicator",this.container.appendChild(e)),this.lastApproval){const s=new Date(this.lastApproval).toLocaleTimeString();e.textContent=`✓ ${s}`}else e.textContent=""}_flattenProps(e,s){const n={};for(const[t,a]of Object.entries(e))n[`${s}${t}`]=a;return n}setLayoutAlgorithm(e){this.layoutAlgorithm=e,this._runLayout(),this._emitChange()}_runLayout(){if(this.cy.elements().length===0)return;const e=this.layoutAlgorithm||"fcose";if(e==="level-by-level"){this._runLevelLayout();return}this.cy.layout({name:this.cy.nodes().length>1?e:"grid",animate:!1,fit:!0,padding:20}).run()}_runLevelLayout(){const e=this.cy.nodes();if(e.length===0)return;const s=e.filter(u=>u.outgoers("edge").length===0),n=s.length>0?s:e,t=new Map,a=[];for(n.forEach(u=>{t.set(u.id(),0),a.push(u.id())});a.length>0;){const u=a.shift(),d=t.get(u);this.cy.$id(u).incomers("edge").forEach(p=>{const h=p.source().id();(!t.has(h)||t.get(h)<d+1)&&(t.set(h,d+1),a.push(h))})}e.forEach(u=>{t.has(u.id())||t.set(u.id(),0)});const i=new Map;for(const[u,d]of t)i.has(d)||i.set(d,[]),i.get(d).push(u);const l=80,r=80,c={};for(const[u,d]of i){const p=u*l,y=-((d.length-1)*r)/2;d.forEach((b,x)=>{c[b]={x:y+x*r,y:p}})}this.cy.layout({name:"preset",positions:u=>c[u.id()]||{x:0,y:0},animate:!1,fit:!0,padding:20}).run()}_updateDiffOverlay(){const e=this.container.parentElement?.querySelector(`.diff-overlay[data-panel-diff="${this.id}"]`);if(!e)return;if(!this.baseGraph){e.classList.remove("visible");return}const s=V(this.baseGraph,this.graph);if(s.length===0){e.classList.remove("visible");return}e.textContent=Le(s),e.classList.add("visible")}setPathTracking(e){this.pathTrackingEnabled=e,e?this._recomputePathTrackingAsync():(this._pathTags=null,this._effectiveExclusions=null,this._clearTrackingVisuals()),this._updateTrackingOverlay(),this._emitChange()}setShowExclusions(e){this.showExclusions=e,this._applyExclusionVisibility(),this._emitChange()}excludePathTag(e,s){this._pushHistory();const n=this.exclusions[e]||[];n.includes(s)||(this.exclusions={...this.exclusions,[e]:[...n,s]}),this._recomputePathTrackingAsync(),this._emitChange()}includePathTag(e,s){this._pushHistory();const t=(this.exclusions[e]||[]).filter(i=>i!==s),a={...this.exclusions};t.length===0?delete a[e]:a[e]=t,this.exclusions=a,this._recomputePathTrackingAsync(),this._emitChange()}getRelevantExclusions(e){const s=new Set(e.edges.map(t=>`${t.source}→${t.target}`)),n={};for(const[t,a]of Object.entries(this.exclusions))s.has(t)&&(n[t]=a);return n}_cleanupStaleExclusions(){if(!this._pathTags)return;const e=this.template?.specialTypes||[],s={};for(const[n,t]of Object.entries(this.exclusions)){const a=this._pathTags.get(n);if(!a||a.length===0)continue;const i=new Set(a.map(r=>q(r,e))),l=t.filter(r=>i.has(r));l.length>0&&(s[n]=l)}this.exclusions=s}_setProcessing(e){this._processingCount=e?this._processingCount+1:Math.max(0,this._processingCount-1),this.panelEl?.classList.toggle("processing",this._processingCount>0)}async _recomputePathTrackingAsync(){if(this.pathTrackingEnabled){this._setProcessing(!0),await new Promise(e=>setTimeout(e,0));try{this._recomputePathTracking()}finally{this._setProcessing(!1)}}}_recomputePathTracking(){if(!this.pathTrackingEnabled)return;const e=this.template?.specialTypes||[];e.length!==0&&(this._pathTags=_t(this.graph,e),this._effectiveExclusions=qe(this.graph,this.exclusions,this._pathTags,e),this._cleanupStaleExclusions(),this._effectiveExclusions=qe(this.graph,this.exclusions,this._pathTags,e),this._applyTrackingVisuals(),this._updateTrackingOverlay(),this._flashTrackingIndicator())}_flashTrackingIndicator(){const e=this.panelEl?.querySelector(".panel-info");e&&(e.classList.remove("tracking-flash"),e.offsetWidth,e.classList.add("tracking-flash"),setTimeout(()=>e.classList.remove("tracking-flash"),300))}_applyTrackingVisuals(){if(!this.pathTrackingEnabled||!this._pathTags)return;const e=this.template?.specialTypes||[];this.cy.edges().removeClass("edge-excluded edge-all-excluded"),this.cy.nodes().removeClass("node-fully-excluded");for(const s of this.graph.edges){const n=`${s.source}→${s.target}`,t=this._pathTags.get(n)||[],a=this._effectiveExclusions?.get(n)||new Set,i=this.cy.$id(n);if(i.empty())continue;const l=t.filter(u=>!a.has(q(u,e))),r=t.filter(u=>a.has(q(u,e))),c=[];l.length&&c.push("Included: "+l.map(u=>H(u,e,this.template?.nodeTypes)).join(", ")),r.length&&c.push("Excluded: "+r.map(u=>H(u,e,this.template?.nodeTypes)).join(", ")),i.data("pathTagsTooltip",c.join(`
`)||"(no tags)"),a.size>0&&i.addClass("edge-excluded"),t.length>0&&r.length===t.length&&i.addClass("edge-all-excluded")}for(const s of this.graph.nodes)$t(this.graph,s.label,this._pathTags,this._effectiveExclusions||new Map,e)&&this.cy.$id(s.label).addClass("node-fully-excluded");this._applyExclusionVisibility()}_applyExclusionVisibility(){this.pathTrackingEnabled&&(this.showExclusions?this.cy.elements().removeClass("tracking-hidden"):(this.cy.nodes(".node-fully-excluded").addClass("tracking-hidden"),this.cy.edges(".edge-all-excluded").addClass("tracking-hidden")))}_clearTrackingVisuals(){this.cy.elements().removeClass("edge-excluded edge-all-excluded node-fully-excluded tracking-hidden"),this.cy.edges().data("pathTagsTooltip",null),this._removeTrackingOverlay()}_showTooltip(e,s){this._tooltip||(this._tooltip=document.createElement("div"),this._tooltip.className="path-tooltip",this.container.appendChild(this._tooltip)),this._tooltip.textContent=s,this._tooltip.style.display="block";const n=this.container.getBoundingClientRect();this._tooltip.style.left=`${e.clientX-n.left+12}px`,this._tooltip.style.top=`${e.clientY-n.top-8}px`}_hideTooltip(){this._tooltip&&(this._tooltip.style.display="none")}_ensureTrackingOverlay(){if(this._trackingOverlay)return;const e=document.createElement("div");e.className="tracking-overlay",e.innerHTML='<label><input type="checkbox" class="show-exclusions-cb"> Show exclusions</label>',this.container.appendChild(e),e.querySelector(".show-exclusions-cb").addEventListener("change",s=>{this.setShowExclusions(s.target.checked)}),this._trackingOverlay=e}_removeTrackingOverlay(){this._trackingOverlay&&(this._trackingOverlay.remove(),this._trackingOverlay=null)}_updateTrackingOverlay(){if(this.pathTrackingEnabled){this._ensureTrackingOverlay();const e=this._trackingOverlay?.querySelector(".show-exclusions-cb");e&&(e.checked=this.showExclusions)}else this._removeTrackingOverlay()}_emitChange(){window.dispatchEvent(new CustomEvent("panel-change",{detail:{panelId:this.id}}))}}let xe=null,Se=null;function Et(o){const e=[];for(const s of o.split(",")){const n=s.trim();if(!n)continue;const t=n.match(/^(.+?)(\d+)-(\d+)$/);if(t){const[,a,i,l]=t,r=parseInt(i,10),c=parseInt(l,10);if(r<=c&&c-r<100){for(let u=r;u<=c;u++)e.push(`${a}${u}`);continue}}e.push(n)}return e}function Ct(o,e){const s=(n,t)=>{const a=o.getBoundingClientRect(),i=n-a.left,l=t-a.top;return(c,u)=>{o.style.position="fixed",o.style.margin="0",o.style.transform="none",o.style.left=`${Math.max(0,c-i)}px`,o.style.top=`${Math.max(0,u-l)}px`}};e.addEventListener("mousedown",n=>{if(n.target.closest("button, input, select, textarea"))return;n.preventDefault();const t=s(n.clientX,n.clientY),a=l=>t(l.clientX,l.clientY),i=()=>{document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",i)}),e.addEventListener("touchstart",n=>{if(n.target.closest("button, input, select, textarea"))return;n.preventDefault();const t=n.touches[0],a=s(t.clientX,t.clientY),i=r=>{r.preventDefault();const c=r.touches[0];a(c.clientX,c.clientY)},l=()=>{document.removeEventListener("touchmove",i),document.removeEventListener("touchend",l)};document.addEventListener("touchmove",i,{passive:!1}),document.addEventListener("touchend",l)},{passive:!1})}let he=null;function Ge(){return he||(he=document.createElement("dialog"),document.body.appendChild(he)),he}let oe=null;function $e(o){o&&o.querySelectorAll(".panel-overlay").forEach(e=>e.remove())}function N(o,e=null){const s=Ge();if(s.className="",s.innerHTML=o,e){$e(e);const t=document.createElement("div");t.className="panel-overlay",e.insertBefore(t,e.firstChild),oe=e;const a=()=>{$e(e),oe=null,s.removeEventListener("close",a)};s.addEventListener("close",a),s.className="panel-dialog",s.removeAttribute("style"),s.showModal();const i=e.getBoundingClientRect();s.style.position="fixed",s.style.transform="translate(-50%, -50%)",s.style.margin="0",s.style.left=`${i.left+i.width/2}px`,s.style.top=`${i.top+i.height/2}px`,requestAnimationFrame(()=>{const l=s.offsetWidth,r=s.offsetHeight,c=i.left+i.width/2,u=i.top+i.height/2,d=8;s.style.left=`${Math.max(l/2+d,Math.min(c,window.innerWidth-l/2-d))}px`,s.style.top=`${Math.max(r/2+d,Math.min(u,window.innerHeight-r/2-d))}px`})}else s.removeAttribute("style"),s.style.position="fixed",s.style.left="50%",s.style.top="50%",s.style.transform="translate(-50%, -50%)",s.style.margin="0",s.showModal();const n=s.querySelector(".dialog-header")||s.querySelector("h3");return n&&Ct(s,n),s}function $(){const o=Ge();o.open&&o.close(),o.className="",o.innerHTML="",o.removeAttribute("style"),oe&&($e(oe),oe=null)}function D(o,e,s=null){return new Promise(n=>{const t=N(`
      <h3>${o}</h3>
      <p>${e}</p>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Confirm</button>
      </div>
    `,s);t.querySelector("#dlg-cancel").onclick=()=>{$(),n(!1)},t.querySelector("#dlg-ok").onclick=()=>{$(),n(!0)}})}function Re(o,e,s=null){return new Promise(n=>{const t=N(`
      <div class="dialog-header">
        <h3>${o}</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p>${e}</p>
    `,s);t.querySelector("#dlg-close-x").onclick=()=>{$(),n()}})}function Pt(o,e=null){return new Promise(s=>{const n=N(`
      <h3>Rename Panel</h3>
      <label>Name</label>
      <input id="dlg-name" type="text" value="${o}" autofocus>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Rename</button>
      </div>
    `,e);n.querySelector("#dlg-cancel").onclick=()=>{$(),s(null)},n.querySelector("#dlg-ok").onclick=()=>{const t=n.querySelector("#dlg-name").value.trim();$(),s(t)},n.querySelector("#dlg-name").onkeydown=t=>{t.key==="Enter"&&n.querySelector("#dlg-ok").click()}})}function De(o){return Object.entries(o).map(([e,s])=>`${e}=${s}`).join(`
`)}function ae(o){const e={};for(const s of o.split(`
`)){const n=s.trim();if(!n)continue;const t=n.indexOf("=");if(t===-1)continue;const a=n.slice(0,t).trim(),i=n.slice(t+1).trim();a&&(e[a]=i)}return e}function Fe(o){const e=o.template,s=e?.nodeTypes?.length>0,n=s&&e.nodeTypes.some(i=>i.id===xe)?xe:null,t=s?`<label>Type</label>
    <select id="dlg-type">
      ${e.nodeTypes.map(i=>`<option value="${i.id}" ${(n||e.nodeTypes[0]?.id)===i.id?"selected":""}>${i.label}</option>`).join("")}
    </select>`:"",a=N(`
    <h3>Add Node</h3>
    <label>Label</label>
    <input id="dlg-label" type="text" placeholder="Node label (or A,B,C or P1-5)" autofocus>
    ${t}
    <label>Properties (key=value per line)</label>
    <textarea id="dlg-props" placeholder="color=blue&#10;weight=5"></textarea>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `,o.panelEl);a.querySelector("#dlg-cancel").onclick=$,a.querySelector("#dlg-ok").onclick=()=>{const i=a.querySelector("#dlg-label").value,l=Et(i);if(l.length===0){f("Label required","error");return}const r=ae(a.querySelector("#dlg-props").value),c=s&&a.querySelector("#dlg-type").value||null;s&&(xe=c);for(const u of l)o.addNode(u,r,c);l.length>1&&f(`Added ${l.length} nodes`,"success"),$()},a.querySelector("#dlg-label").onkeydown=i=>{i.key==="Enter"&&a.querySelector("#dlg-ok").click()}}function Ue(o){const e=o.graph.nodes.map(p=>p.label);if(e.length<2){f("Need at least 2 nodes to create an edge","error");return}const s=o.template,n=Z[s?.graphType||"DG"],t=n&&!n.directed,a=t?"Node A":"Source",i=t?"Node B":"Target",l=s?.edgeTypes?.length>0,r=l&&s.edgeTypes.some(p=>p.id===Se)?Se:null,c=l?`<label>Type</label>
    <select id="dlg-type">
      ${s.edgeTypes.map(p=>`<option value="${p.id}" ${(r||s.edgeTypes[0]?.id)===p.id?"selected":""}>${p.label}</option>`).join("")}
    </select>`:"",u=e.map(p=>`<option value="${p}">`).join(""),d=N(`
    <h3>Add Edge</h3>
    <datalist id="dlg-node-list">${u}</datalist>
    <label>${a}</label>
    <input id="dlg-source" list="dlg-node-list" placeholder="Start typing..." autocomplete="off">
    <label>${i}</label>
    <input id="dlg-target" list="dlg-node-list" placeholder="Start typing..." autocomplete="off">
    ${c}
    <label>Properties (key=value per line)</label>
    <textarea id="dlg-props" placeholder="weight=1"></textarea>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `,o.panelEl);d.querySelector("#dlg-source").value=e[0],e.length>1&&(d.querySelector("#dlg-target").value=e[1]),d.querySelector("#dlg-cancel").onclick=$,d.querySelector("#dlg-ok").onclick=()=>{const p=d.querySelector("#dlg-source").value.trim(),h=d.querySelector("#dlg-target").value.trim();if(!e.includes(p)){f(`Node "${p}" not found`,"error");return}if(!e.includes(h)){f(`Node "${h}" not found`,"error");return}if(p===h){f("Source and target must differ","error");return}const y=ae(d.querySelector("#dlg-props").value),b=l&&d.querySelector("#dlg-type").value||null;l&&(Se=b),o.addEdge(p,h,y,b),$()}}function Je(o){const e=o.cy.$(":selected");if(e.empty()){f("Nothing selected","info");return}const s=e[0],n=o.template;if(s.isNode()){const t=s.data("label"),a=o.graph.nodes.find(c=>c.label===t);if(!a)return;const i=n?.nodeTypes?.length>0,l=i?`<label>Type</label>
      <select id="dlg-type">
        ${n.nodeTypes.map(c=>`<option value="${c.id}" ${a.type===c.id?"selected":""}>${c.label}</option>`).join("")}
      </select>`:"",r=N(`
      <h3>Edit Node: ${t}</h3>
      ${l}
      <label>Properties (key=value per line)</label>
      <textarea id="dlg-props">${De(a.props)}</textarea>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Save</button>
      </div>
    `,o.panelEl);r.querySelector("#dlg-cancel").onclick=$,r.querySelector("#dlg-ok").onclick=()=>{const c=ae(r.querySelector("#dlg-props").value),u=i?r.querySelector("#dlg-type").value||null:void 0;o.updateNodeProps(t,c,u),$()}}else{const t=s.data("source"),a=s.data("target"),i=o.graph.edges.find(S=>S.source===t&&S.target===a);if(!i)return;const l=n?.edgeTypes?.length>0,r=l?`<label>Type</label>
      <select id="dlg-type">
        ${n.edgeTypes.map(S=>`<option value="${S.id}" ${i.type===S.id?"selected":""}>${S.label}</option>`).join("")}
      </select>`:"",c=`${t}→${a}`,u=o.pathTrackingEnabled&&o._pathTags,d=u?o._pathTags.get(c)||[]:[],p=o.template?.specialTypes||[],h=()=>{if(!u||d.length===0)return"";const S=o._effectiveExclusions?.get(c)||new Set,g=d.filter(k=>!S.has(q(k,p))),v=d.filter(k=>S.has(q(k,p))),m=[];return g.length&&m.push("Included: "+g.map(k=>H(k,p,o.template?.nodeTypes||[])).join(", ")),v.length&&m.push("Excluded: "+v.map(k=>H(k,p,o.template?.nodeTypes||[])).join(", ")),m.join(`
`)||"(no active paths)"},y=()=>{if(!u||d.length===0)return"";const S=o._effectiveExclusions?.get(c)||new Set,g=new Set(o.exclusions[c]||[]);return d.map(v=>{const m=q(v,p),k=g.has(m),E=S.has(m)&&!k,C=k||E,w=H(v,p,o.template?.nodeTypes||[]),T=E?"excl-toggle excl-btn-propagated":C?"excl-toggle excl-btn-excluded":"excl-toggle excl-btn-included",z=E?`${w} (inherited from upstream)`:w;return`<button class="${T}" data-tag="${m}" data-propagated="${E}" title="${z}">${w}</button>`}).join("")},b=u&&d.length>0?`
      <div class="template-section-label" style="margin-top:12px">Path Tags</div>
      <pre id="edge-tag-summary" style="background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:6px 8px;font-size:11px;margin-bottom:8px;white-space:pre-wrap;word-break:break-all">${h()}</pre>
      <div class="template-section-label">Manage Exclusions</div>
      <div id="edge-excl-toggles" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">${y()}</div>
    `:"",x=N(`
      <h3>Edit Edge: ${t} → ${a}</h3>
      ${r}
      <label>Properties (key=value per line)</label>
      <textarea id="dlg-props">${De(i.props)}</textarea>
      ${b}
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Save</button>
      </div>
    `,o.panelEl);if(u&&d.length>0){const S=new Set(o.exclusions[c]||[]),g=()=>{const m=o._effectiveExclusions?.get(c)||new Set,k=new Set(o.exclusions[c]||[]);return new Set([...m].filter(E=>!k.has(E)))},v=()=>{const m=g(),k=new Set([...S,...m]),E=d.filter(T=>!k.has(q(T,p))),C=d.filter(T=>k.has(q(T,p))),w=[];E.length&&w.push("Included: "+E.map(T=>H(T,p,o.template?.nodeTypes||[])).join(", ")),C.length&&w.push("Excluded: "+C.map(T=>H(T,p,o.template?.nodeTypes||[])).join(", ")),x.querySelector("#edge-tag-summary").textContent=w.join(`
`)||"(no active paths)",x.querySelectorAll("#edge-excl-toggles .excl-toggle").forEach(T=>{if(T.dataset.propagated==="true")return;const z=T.dataset.tag;T.className=S.has(z)?"excl-toggle excl-btn-excluded":"excl-toggle excl-btn-included"})};x.querySelectorAll("#edge-excl-toggles .excl-toggle").forEach(m=>{m.dataset.propagated!=="true"&&(m.onclick=()=>{const k=m.dataset.tag;S.has(k)?S.delete(k):S.add(k),v()})}),x.querySelector("#dlg-ok").onclick=()=>{const m=ae(x.querySelector("#dlg-props").value),k=l?x.querySelector("#dlg-type").value||null:void 0;o.updateEdgeProps(t,a,m,k),S.size>0?o.exclusions[c]=[...S]:delete o.exclusions[c],o._recomputePathTrackingAsync(),o._emitChange(),$()}}else x.querySelector("#dlg-ok").onclick=()=>{const S=ae(x.querySelector("#dlg-props").value),g=l?x.querySelector("#dlg-type").value||null:void 0;o.updateEdgeProps(t,a,S,g),$()};x.querySelector("#dlg-cancel").onclick=$}}async function At(o){const e=await ht();if(!e.ok){f(e.error,"error");return}const s=`import → ${o.id}`,n=o.receiveMerge(e.graph,s);n.ok?f("Graph imported","success"):f(n.error,"error")}function Nt(o){if(!o.baseGraph){N(`
      <div class="dialog-header">
        <h3>Changeset Summary</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="color: var(--text-muted); text-align: center; padding: 20px;">No baseline — approve first to track changes.</p>
    `,o.panelEl).querySelector("#dlg-close-x").onclick=$;return}const e=V(o.baseGraph,o.graph),s=Tt(e);N(`
    <div class="dialog-header">
      <h3>Changeset Summary</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p class="changeset-summary-text">${s}</p>
  `,o.panelEl).querySelector("#dlg-close-x").onclick=$}function qt(o){const e=o._approvalHistory||[];if(e.length===0){const i=N(`
      <div class="dialog-header">
        <h3>Approval History</h3>
        <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="color:var(--text-muted);text-align:center;padding:20px">No approvals yet.</p>
    `,o.panelEl);i.querySelector("#dlg-close-x").onclick=$;return}let s='<div class="changelog-list">';for(let i=e.length-1;i>=0;i--){const l=e[i],r=new Date(l.timestamp).toLocaleTimeString();s+=`
      <div class="changelog-entry" data-index="${i}">
        <span class="changelog-entry-label">#${i+1} ${r} <span style="color:var(--text-muted)">${l.diffSummary}</span></span>
        <button class="btn-preview" data-index="${i}">Preview</button>
      </div>`}s+="</div>";const n=N(`
    <div class="dialog-header">
      <h3>Approval History</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <div class="changelog-split">
      <div class="changelog-split-list">${s}</div>
      <div id="changelog-preview-pane" style="display:none;flex:1;flex-direction:column;min-width:260px"></div>
    </div>
  `,o.panelEl);let t=null;const a=()=>{if(t){try{t.destroy()}catch{}t=null}const i=n.querySelector("#changelog-preview-pane");i.style.display="none",i.innerHTML="",n.classList.remove("changelog-with-preview"),n.querySelectorAll(".changelog-entry").forEach(l=>l.classList.remove("active"))};n.querySelectorAll(".btn-preview").forEach(i=>{i.onclick=()=>{const l=parseInt(i.dataset.index),r=e[l],c=n.querySelector("#changelog-preview-pane");if(t){try{t.destroy()}catch{}t=null}n.querySelectorAll(".changelog-entry").forEach(h=>h.classList.remove("active")),i.closest(".changelog-entry").classList.add("active");const u=`#${l+1} — ${new Date(r.timestamp).toLocaleTimeString()}`;c.innerHTML=`
        <div style="display:flex;justify-content:space-between;align-items:center;padding:0 0 6px;border-bottom:1px solid var(--border);margin-bottom:6px">
          <span style="font-size:11px;font-weight:600">${u}</span>
          <button id="preview-close-pane" class="btn-close-icon" title="Close preview">&#x2715;</button>
        </div>
        <div id="preview-inline-canvas" style="flex:1;min-height:220px;border:1px solid var(--border);border-radius:3px"></div>
      `,c.style.display="flex",n.classList.add("changelog-with-preview");const d=o.layoutAlgorithm&&o.layoutAlgorithm!=="level-by-level"?o.layoutAlgorithm:"fcose",p=[];for(const h of r.graph.nodes)p.push({group:"nodes",data:{id:h.label,label:h.label}});for(const h of r.graph.edges){const y=`${h.source}→${h.target}`;p.push({group:"edges",data:{id:y,source:h.source,target:h.target}})}requestAnimationFrame(()=>{const h=c.querySelector("#preview-inline-canvas");!h||!h.isConnected||(t=we({container:h,elements:p,style:ze,layout:{name:d,animate:!1,fit:!0,padding:20},autoungrabify:!0,userZoomingEnabled:!0,userPanningEnabled:!0}))}),c.querySelector("#preview-close-pane").onclick=a}}),n.querySelector("#dlg-close-x").onclick=()=>{a(),$()}}function Me(){return`t${Date.now().toString(36)}${Math.random().toString(36).slice(2,5)}`}function Ze(o,e,s=!1,n=null){let t=_(o);t.specialTypes||(t.specialTypes=[]);const a={cose:"fcose",dagre:"level-by-level"};a[t.defaultLayoutAlgorithm]&&(t.defaultLayoutAlgorithm=a[t.defaultLayoutAlgorithm]);const i=t.graphType==="DAG",l=(g,v)=>g.map(m=>{const k=v==="node"?"Node Type":"Edge Type";return`
    <div class="type-row" data-id="${m.id}" data-kind="${v}">
      <input type="text" class="type-label-input" value="${m.label}" placeholder="${k}">
      <input type="color" class="type-color-input" value="${m.color||"#4fc3f7"}">
      <button class="btn-delete-type" data-id="${m.id}" data-kind="${v}" title="Delete">✕</button>
    </div>
  `}).join(""),r=()=>{if(!i||t.nodeTypes.length===0)return"";const g=!1,v="",m=t.nodeTypes.map(k=>{const E=t.specialTypes.indexOf(k.id),C=E!==-1,w=!C||E<=0||g?"disabled":"",T=!C||E>=t.specialTypes.length-1||g?"disabled":"";return`
        <div class="special-type-item">
          <input type="checkbox" class="special-type-cb" data-id="${k.id}" ${C?"checked":""} >
          <span style="flex:1">${k.label}</span>
          <button class="st-up" data-id="${k.id}" ${w} title="Move up in order">↑</button>
          <button class="st-down" data-id="${k.id}" ${T} title="Move down in order">↓</button>
        </div>
      `}).join("");return`
      <div class="special-types-section">
        <div class="template-section-label">Path Tracking Types ${v}</div>
        <p style="font-size:10px;color:var(--text-muted);margin-bottom:4px">Select node types used as anchors for path tracking (order matters).</p>
        <div id="special-types-list">${m}</div>
      </div>
    `},c=[{value:"fcose",label:"Force-Directed (fcose)"},{value:"level-by-level",label:"Level-by-Level (DAG)"},{value:"circle",label:"Circle"},{value:"concentric",label:"Concentric"},{value:"breadthfirst",label:"Breadth-First"},{value:"grid",label:"Grid"}],u=()=>`
    <div class="dialog-header">
      <h3>Edit Template</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <div class="template-graph-type-label">
      Graph Type: <strong>${Z[t.graphType]?.label||t.graphType}</strong>
    </div>
    <div class="template-section-label">Node Types</div>
    <div id="node-types-list">${l(t.nodeTypes,"node")}</div>
    <button id="add-node-type" class="btn-secondary btn-add-type">+ Add Node Type</button>
    <div class="template-section-label">Edge Types</div>
    <div id="edge-types-list">${l(t.edgeTypes,"edge")}</div>
    <button id="add-edge-type" class="btn-secondary btn-add-type">+ Add Edge Type</button>
    ${r()}
    <div class="template-section-label">Default Layout Algorithm</div>
    <select id="default-layout-algo">
      ${c.map(g=>`<option value="${g.value}" ${(t.defaultLayoutAlgorithm||"fcose")===g.value?"selected":""}>${g.label}</option>`).join("")}
    </select>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Save</button>
    </div>
  `,d=()=>{p.querySelectorAll(".type-label-input").forEach(g=>{g.addEventListener("focus",()=>g.select())})},p=N(u());p.classList.add("dialog-wide"),d();const h=()=>{p.querySelectorAll(".type-row").forEach(v=>{const m=v.dataset.id,k=v.dataset.kind,E=v.querySelector(".type-label-input")?.value??"",C=v.querySelector(".type-color-input")?.value??"#4fc3f7";if(k==="node"){const w=t.nodeTypes.find(T=>T.id===m);w&&(w.label=E,w.color=C)}else{const w=t.edgeTypes.find(T=>T.id===m);w&&(w.label=E,w.color=C)}}),i&&(t.specialTypes=[],p.querySelectorAll(".special-type-cb:checked").forEach(v=>{t.specialTypes.push(v.dataset.id)})),p.querySelector("#node-types-list").innerHTML=l(t.nodeTypes,"node"),p.querySelector("#edge-types-list").innerHTML=l(t.edgeTypes,"edge");const g=p.querySelector(".special-types-section");g&&(g.outerHTML=r()),y(),b(),d()},y=()=>{p.querySelectorAll(".btn-delete-type").forEach(g=>{g.onclick=()=>{const v=g.dataset.id;g.dataset.kind==="node"?(t.nodeTypes=t.nodeTypes.filter(k=>k.id!==v),t.specialTypes=t.specialTypes.filter(k=>k!==v)):t.edgeTypes=t.edgeTypes.filter(k=>k.id!==v),h()}})},b=()=>{i&&(p.querySelectorAll(".st-up").forEach(g=>{g.onclick=()=>{const v=g.dataset.id,m=t.specialTypes.indexOf(v);m>0&&([t.specialTypes[m-1],t.specialTypes[m]]=[t.specialTypes[m],t.specialTypes[m-1]],h())}}),p.querySelectorAll(".st-down").forEach(g=>{g.onclick=()=>{const v=g.dataset.id,m=t.specialTypes.indexOf(v);m!==-1&&m<t.specialTypes.length-1&&([t.specialTypes[m],t.specialTypes[m+1]]=[t.specialTypes[m+1],t.specialTypes[m]],h())}}),p.querySelectorAll(".special-type-cb").forEach(g=>{g.onchange=()=>{const v=g.dataset.id;g.checked?t.specialTypes.includes(v)||t.specialTypes.push(v):t.specialTypes=t.specialTypes.filter(m=>m!==v),h()}}))};y(),b(),p.querySelector("#add-node-type").onclick=()=>{h(),t.nodeTypes.push({id:Me(),label:"New Type",color:"#4fc3f7"}),h()},p.querySelector("#add-edge-type").onclick=()=>{h(),t.edgeTypes.push({id:Me(),label:"New Type",color:"#5a6a8c"}),h()};const x=()=>{p.querySelectorAll(".type-row").forEach(g=>{const v=g.dataset.id,m=g.dataset.kind,k=g.querySelector(".type-label-input")?.value?.trim()||"Unnamed",E=g.querySelector(".type-color-input")?.value??"#4fc3f7";if(m==="node"){const C=t.nodeTypes.find(w=>w.id===v);C&&(C.label=k,C.color=E)}else{const C=t.edgeTypes.find(w=>w.id===v);C&&(C.label=k,C.color=E)}}),i&&(t.specialTypes=[],p.querySelectorAll(".special-type-cb:checked").forEach(g=>{t.specialTypes.push(g.dataset.id)})),t.defaultLayoutAlgorithm=p.querySelector("#default-layout-algo").value,e(t),f("Template saved","success")},S=n?()=>{$(),n()}:$;p.querySelector("#dlg-ok").onclick=x,p.querySelector("#dlg-cancel").onclick=S,p.querySelector("#dlg-close-x").onclick=S}function Oe(o,e){const s=o.panelEl;if(!o.pathTrackingEnabled||!o._pathTags)return;const n=o.template,t=n?.specialTypes||[],a=o._pathTags.get(e)||[],i=o._effectiveExclusions?.get(e)||new Set,l=new Set(o.exclusions[e]||[]);if(a.length===0){f("No path tags on this edge","info");return}const r=b=>q(b,t),c=b=>H(b,t,n?.nodeTypes||[]);let u={...o.exclusions};const d=a.map(b=>{const x=r(b),S=l.has(x),g=i.has(x)&&!S,v=S||g,m=c(b);return`
      <div class="exclusion-item ${g?"propagated":""}">
        <input type="checkbox" class="excl-cb" data-tag="${x}" data-propagated="${g}" ${v?"":"checked"} title="${g?"Propagated from downstream — uncheck to add direct exclusion":""}">
        <span>${m}${g?' <em style="font-size:10px;color:var(--text-muted)">(inherited)</em>':""}</span>
      </div>
    `}).join(""),[p,h]=e.split("→"),y=N(`
    <div class="dialog-header">
      <h3>Exclusions: ${p} → ${h}</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Checked = included in tracking. Uncheck to exclude a path.</p>
    <div class="exclusion-list">${d}</div>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `,s);y.querySelector("#dlg-ok").onclick=()=>{const b=y.querySelectorAll(".excl-cb"),x=[];b.forEach(g=>{const v=g.dataset.tag;g.checked||x.push(v)});const S=x.filter(g=>y.querySelector(`.excl-cb[data-tag="${g}"]`)?.dataset.propagated!=="true");S.length>0?u[e]=S:delete u[e],o.exclusions=u,o._recomputePathTrackingAsync(),o._emitChange(),$()},y.querySelector("#dlg-cancel").onclick=$,y.querySelector("#dlg-close-x").onclick=$}function Lt(o){const e=o.panelEl,n=[{value:"fcose",label:"Force-Directed (fcose)"},{value:"level-by-level",label:"Level-by-Level (DAG)"},{value:"circle",label:"Circle"},{value:"concentric",label:"Concentric"},{value:"breadthfirst",label:"Breadth-First"},{value:"grid",label:"Grid"}].map(c=>`<option value="${c.value}" ${o.layoutAlgorithm===c.value?"selected":""}>${c.label}</option>`).join(""),t=o.template,a=t?.graphType==="DAG",i=a&&t?.specialTypes?.length>0,l=a?`
    <div class="template-section-label" style="margin-top:12px">Path Tracking</div>
    ${i?`
    <label style="display:flex;align-items:center;gap:8px;font-size:13px;cursor:pointer;white-space:nowrap">
      <input type="checkbox" id="dlg-tracking" style="width:auto;flex-shrink:0" ${o.pathTrackingEnabled?"checked":""}>
      Enable path tracking
    </label>
    `:'<p style="font-size:11px;color:var(--text-muted)">No special types configured in template. Edit the template to add special types for DAG path tracking.</p>'}
  `:"",r=N(`
    <div class="dialog-header">
      <h3>Panel Options</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <label>Layout Algorithm</label>
    <select id="dlg-layout-algo">${n}</select>
    ${l}
    <div class="dialog-actions">
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `,e);r.querySelector("#dlg-ok").onclick=()=>{const c=r.querySelector("#dlg-layout-algo").value;if(o.setLayoutAlgorithm(c),i){const u=r.querySelector("#dlg-tracking")?.checked||!1;u!==o.pathTrackingEnabled&&o.setPathTracking(u)}f("Options applied","success"),$()},r.querySelector("#dlg-close-x").onclick=$}function Dt(o,e,s,n,t){const a=o.template?.specialTypes||[],i=g=>{if(!g)return[];const v=g.graph.nodes;return a.length>0?v.filter(m=>a.includes(m.type)):v},l=i(o),r=i(e),c=n[s],u=c&&typeof c=="object"?c.scopeNodes||[]:[],d=u.length>0,p=(g,v)=>g.length===0?`<p style="font-size:11px;color:var(--text-muted)">${v}</p>`:g.map(m=>{const k=u.includes(m.label)?"checked":"";return`<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;font-size:12px">
        <input type="checkbox" class="scope-node-cb" value="${m.label}" ${k} style="width:auto;margin:0">
        <span>${m.label}</span>
      </div>`}).join(""),h=a.length>0?"No special-type nodes":"No nodes",[y,b]=s.split("→"),x=N(`
    <div class="dialog-header">
      <h3>Select Scope Nodes</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">
      Select nodes from either panel. Only upstream ancestors of selected nodes (in source) will be merged.
    </p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px">
      <div>
        <div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:6px">Target: ${b}</div>
        <div style="max-height:180px;overflow-y:auto">${p(l,h)}</div>
      </div>
      <div>
        <div style="font-size:11px;font-weight:600;color:var(--accent);margin-bottom:6px">Source: ${y}</div>
        <div style="max-height:180px;overflow-y:auto">${p(r,h)}</div>
      </div>
    </div>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Apply</button>
    </div>
  `),S=()=>{d||delete n[s],$(),t&&t()};x.querySelector("#dlg-ok").onclick=()=>{const g=[...x.querySelectorAll(".scope-node-cb:checked")].map(v=>v.value);n[s]={strategy:"scoped",scopeNodes:g},$(),t&&t()},x.querySelector("#dlg-cancel").onclick=S,x.querySelector("#dlg-close-x").onclick=S}function Mt(o,e,s){const n=o.map(i=>`<option value="${i.id}">${i.name}</option>`).join(""),t=N(`
    <h3>Add Merge Button</h3>
    <label>Source Panel</label>
    <select id="dlg-source">${n}</select>
    <label>Target Panel</label>
    <select id="dlg-target">${n}</select>
    <p id="dlg-warning" style="color:var(--warning);font-size:11px;display:none;margin-bottom:6px">This merge direction already exists.</p>
    <div class="dialog-actions">
      <button id="dlg-cancel">Cancel</button>
      <button id="dlg-ok" class="btn-primary">Add</button>
    </div>
  `),a=()=>{const i=t.querySelector("#dlg-source").value,l=t.querySelector("#dlg-target").value,r=e.some(c=>c.source===i&&c.target===l);t.querySelector("#dlg-warning").style.display=r?"":"none"};t.querySelector("#dlg-source").onchange=a,t.querySelector("#dlg-target").onchange=a,t.querySelector("#dlg-cancel").onclick=$,t.querySelector("#dlg-ok").onclick=()=>{const i=t.querySelector("#dlg-source").value,l=t.querySelector("#dlg-target").value;if(i===l){f("Source and target must differ","error");return}$(),s({source:i,target:l})}}function Ot(o){const s=Object.keys(o).map(n=>`<option value="${n}">${n}</option>`).join("");return new Promise(n=>{const t=N(`
      <h3>New Session</h3>
      <label>Session Name</label>
      <input id="dlg-name" type="text" placeholder="Session name" autofocus>
      <label>Template</label>
      <select id="dlg-template">${s}</select>
      <div class="dialog-actions">
        <button id="dlg-cancel">Cancel</button>
        <button id="dlg-ok" class="btn-primary">Create</button>
      </div>
    `);t.querySelector("#dlg-cancel").onclick=()=>{$(),n(null)},t.querySelector("#dlg-ok").onclick=()=>{const a=t.querySelector("#dlg-name").value.trim();if(!a){f("Session name required","error");return}const i=t.querySelector("#dlg-template").value;$(),n({name:a,templateName:i})},t.querySelector("#dlg-name").onkeydown=a=>{a.key==="Enter"&&t.querySelector("#dlg-ok").click()}})}const Ie=200;class It{constructor(e,{onPanelCreate:s,onPanelDestroy:n,onMerge:t,getState:a,setState:i,confirmClose:l,onResizeEnd:r,getPanels:c}){this.rootEl=e,this.onPanelCreate=s,this.onPanelDestroy=n,this.onMerge=t,this._getState=a||null,this._setState=i||null,this._confirmClose=l||null,this._onResizeEnd=r||null,this._getPanels=c||null,this.nextId=1,this.tree=null,this._zoomedPanelId=null,this._zoomSavedStates=new Map,this.mergeStrategies={},this.mergeButtonLists={},this._gutterSplitNodes={}}_getStrategy(e){const s=this.mergeStrategies[e];return s?typeof s=="string"?{strategy:s,scopeNodes:[]}:s:{strategy:"mirror",scopeNodes:[]}}_strategyBadge(e){switch(e){case"push":return"(P)";case"scoped":return"(S)";case"none":return"(N)";default:return"(M)"}}init(){const e=window.innerWidth<=600?"h":"v";this.tree={type:"split",direction:e,children:[{type:"panel",id:String(this.nextId++)},{type:"panel",id:String(this.nextId++)}],sizes:[50,50]},this.render()}getLayout(){return{tree:this.tree,nextId:this.nextId,mergeStrategies:this.mergeStrategies,mergeButtonLists:this.mergeButtonLists}}setLayout(e){this.tree=e.tree,this.nextId=e.nextId,this.mergeStrategies=e.mergeStrategies||{},this.mergeButtonLists=e.mergeButtonLists||{},this.render()}getMergeStrategies(){return this.mergeStrategies}setMergeStrategies(e){this.mergeStrategies=e||{}}getAllPanelIds(){const e=[],s=n=>{n.type==="panel"?e.push(n.id):n.children.forEach(s)};return this.tree&&s(this.tree),e}splitPanel(e,s){const n=String(this.nextId++),t=this._findPanelNode(this.tree,e);return this.tree=this._mapTree(this.tree,a=>a.type==="panel"&&a.id===e?{type:"split",direction:s,children:[{type:"panel",id:e,name:t?.name},{type:"panel",id:n}],sizes:[50,50]}:a),this.render(),n}closePanel(e){if(!(this.getAllPanelIds().length<=1)){this._zoomedPanelId===e&&(this._zoomedPanelId=null);for(const s of Object.keys(this.mergeButtonLists))this.mergeButtonLists[s]=this.mergeButtonLists[s].filter(n=>n.source!==e&&n.target!==e);this.tree=this._removePanel(this.tree,e),this.render()}}addPanel(){const e=String(this.nextId++),s=window.innerWidth<=600?"h":"v";return this.tree={type:"split",direction:s,children:[this.tree,{type:"panel",id:e}],sizes:[70,30]},this.render(),e}toggleZoom(e){this._zoomedPanelId===e?this._zoomedPanelId=null:this._zoomedPanelId=e,this.render()}render(){const e=new Map,s=new Set;this.rootEl.querySelectorAll(".panel-canvas").forEach(t=>{s.add(t.dataset.panel)});for(const t of s)if(this._getState){const a=this._getState(t);a&&e.set(t,a)}for(const t of s)this.onPanelDestroy(t);if(this.rootEl.innerHTML="",!this.tree)return;if(this._zoomedPanelId){const t=this._findPanelNode(this.tree,this._zoomedPanelId);if(t){for(const l of s)l!==this._zoomedPanelId&&e.has(l)&&this._zoomSavedStates.set(l,e.get(l));const a=this._renderPanel(t);a.style.flex="1",a.classList.add("zoomed"),this.rootEl.appendChild(a);const i=a.querySelector(".panel-canvas");this.onPanelCreate(this._zoomedPanelId,i),e.has(this._zoomedPanelId)&&this._setState&&this._setState(this._zoomedPanelId,e.get(this._zoomedPanelId));return}this._zoomedPanelId=null}for(const[t,a]of this._zoomSavedStates)e.has(t)||e.set(t,a);this._zoomSavedStates.clear();const n=this._renderNode(this.tree);n.style.flex="1",n.style.display="flex",n.style.minWidth="0",n.style.minHeight="0",this.rootEl.appendChild(n);for(const t of this.getAllPanelIds()){const a=this.rootEl.querySelector(`.panel-canvas[data-panel="${t}"]`);a&&(this.onPanelCreate(t,a),e.has(t)&&this._setState&&this._setState(t,e.get(t)))}}_renderNode(e){return e.type==="panel"?this._renderPanel(e):this._renderSplit(e)}_renderPanel(e){const s=e.name||`Panel ${e.id}`,n=document.createElement("div");n.className="panel",n.dataset.panelId=e.id;const t=document.createElement("div");t.className="panel-header",t.innerHTML=`
      <span class="panel-header-left">
        <button data-action="panel-options" class="btn-icon btn-header-icon" title="Panel options">&#x2699;</button>
        <button data-action="refresh" class="btn-icon btn-header-icon" title="Re-layout">&#x21BB;</button>
        <span class="panel-header-sep"></span>
        <button data-action="undo" class="btn-icon btn-header-icon" title="Undo (Ctrl+Z)">&#x21B6;</button>
        <button data-action="redo" class="btn-icon btn-header-icon" title="Redo (Ctrl+Shift+Z)">&#x21B7;</button>
        <span class="processing-indicator" title="Processing...">&#x27F3;</span>
      </span>
      <span class="panel-info"></span>
      <span class="panel-header-right">
        <button class="panel-split-btn" data-split="v" title="Split this panel into two side-by-side panels">&#x2194;</button>
        <button class="panel-split-btn" data-split="h" title="Split this panel into two stacked panels">&#x2195;</button>
        <span class="panel-header-sep"></span>
        <button class="panel-zoom-btn" title="Toggle full-screen zoom on this panel (Escape to exit)">&#x2922;</button>
        <span class="panel-header-sep"></span>
        <button class="panel-close-btn" title="Close this panel and remove it from the layout">&#x2715;</button>
      </span>
    `,n.appendChild(t),t.querySelector(".panel-zoom-btn").onclick=()=>this.toggleZoom(e.id),t.querySelector('[data-split="v"]').onclick=()=>this.splitPanel(e.id,"v"),t.querySelector('[data-split="h"]').onclick=()=>this.splitPanel(e.id,"h"),t.querySelector(".panel-close-btn").onclick=async()=>{this._confirmClose&&!await this._confirmClose(e.id)||this.closePanel(e.id)};const a=document.createElement("div");a.className="panel-canvas",a.dataset.panel=e.id;const i=document.createElement("div");i.className="panel-name-overlay",i.title="Click to rename",i.textContent=s,i.onclick=()=>{Pt(s,n).then(c=>{if(c!==null){e.name=c||void 0;const u=c||`Panel ${e.id}`;i.textContent=u,this.render()}})},a.appendChild(i);const l=document.createElement("div");l.className="diff-overlay",l.dataset.panelDiff=e.id,a.appendChild(l),n.appendChild(a);const r=document.createElement("div");return r.className="panel-actions",r.innerHTML=`
      <span class="panel-actions-left">
        <button data-action="add-node" class="btn-add" title="Add a new labeled node to the graph">+N</button>
        <button data-action="add-edge" class="btn-add" title="Add a new directed edge between two existing nodes">+E</button>
        <span class="action-separator"></span>
        <button data-action="approve" class="btn-approve" title="Snapshot current state as baseline and clear all diffs">&#x2713;</button>
        <button data-action="restore" class="btn-restore" title="Revert graph to last approved state (undo all changes since approval)">&#x21BA;</button>
        <span class="action-separator"></span>
        <button data-action="clear" class="btn-clear" title="Reset panel to empty state (clears graph, approval history, and diffs)">&#x232B;</button>
      </span>
      <span class="panel-actions-right">
        <button data-action="changeset" class="btn-icon" title="View pending changeset summary">&#x24D8;</button>
        <button data-action="changelog" class="btn-icon" title="View approval history">&#x2630;</button>
        <button data-action="import" class="btn-icon" title="Import graph from a JSON file">&#x21A5;</button>
        <button data-action="export" class="btn-icon" title="Export current graph as a JSON file">&#x21A7;</button>
      </span>
    `,n.appendChild(r),n}_renderSplit(e){const s=e.direction==="v",n=document.createElement("div");n.className=s?"split-v":"split-h";const t=this._renderNode(e.children[0]),a=this._renderNode(e.children[1]);t.style.flex=`${e.sizes[0]} 1 0`,t.style.overflow="hidden",t.style.display="flex",t.style.minWidth="0",t.style.minHeight="0",a.style.flex=`${e.sizes[1]} 1 0`,a.style.overflow="hidden",a.style.display="flex",a.style.minWidth="0",a.style.minHeight="0";const i=this._renderMergeGutter(e);return n.appendChild(t),n.appendChild(i),n.appendChild(a),n}_panelName(e){return e.name||`Panel ${e.id}`}_getPanelName(e){const s=this._findPanelNode(this.tree,e);return s?this._panelName(s):`Panel ${e}`}_gutterKey(e){const s=this._allPanelNodes(e.children[0]).map(t=>t.id).sort().join(","),n=this._allPanelNodes(e.children[1]).map(t=>t.id).sort().join(",");return`${s}|${n}`}_defaultButtons(e){const s=this._getZones(e.children[0],e.direction,"first"),n=this._getZones(e.children[1],e.direction,"second"),t=p=>{let h=0;return p.map(y=>{const b={start:h,end:h+y.size,panels:y.panels,slot:y.slot};return h+=y.size,b})},a=t(s),i=t(n),l=new Set([0,100]);for(const p of[...a,...i])l.add(p.start),l.add(p.end);const r=[...l].sort((p,h)=>p-h),c=(p,h)=>p.find(y=>y.start<=h&&h<y.end),u=[],d=new Set;for(let p=0;p<r.length-1;p++){const h=(r[p]+r[p+1])/2,y=c(a,h),b=c(i,h);if(!(!y||!b)&&!(y.slot!==null&&b.slot!==null&&y.slot!==b.slot))for(const x of y.panels)for(const S of b.panels){const g=`${x.id}→${S.id}`,v=`${S.id}→${x.id}`;d.has(g)||(d.add(g),u.push({source:x.id,target:S.id})),d.has(v)||(d.add(v),u.push({source:S.id,target:x.id}))}}return u}_getButtonList(e){const s=this._gutterKey(e);return this.mergeButtonLists[s]||(this.mergeButtonLists[s]=this._defaultButtons(e)),this.mergeButtonLists[s]}_rerenderGutter(e){const s=this._gutterSplitNodes[e];if(!s)return;const n=this.rootEl.querySelector(`.merge-gutter[data-gutter-key="${CSS.escape(e)}"]`);n&&n.replaceWith(this._renderMergeGutter(s))}_renderMergeGutter(e){const s=e.direction==="v",n=document.createElement("div");n.className="merge-gutter";const t=this._gutterKey(e);n.dataset.gutterKey=t,this._gutterSplitNodes[t]=e;const a=this._getButtonList(e),i=new Set(this._allPanelNodes(e.children[0]).map(h=>h.id)),l=new Set(this._allPanelNodes(e.children[1]).map(h=>h.id)),r=document.createElement("div");r.className="merge-zone merge-zone-flat",a.forEach((h,y)=>{const{source:b,target:x}=h,S=`${b}→${x}`,g=this._getStrategy(S),v=this._getPanelName(b),m=this._getPanelName(x),k=i.has(b),E=k?"»":"«",C=k?`<span class="merge-btn-source">${v}</span><span class="merge-btn-icon">${E}</span><span class="merge-btn-target">${m}</span>`:`<span class="merge-btn-target">${m}</span><span class="merge-btn-icon">${E}</span><span class="merge-btn-source">${v}</span>`,w=i.has(b)&&l.has(x)||l.has(b)&&i.has(x),T=document.createElement("button");T.className="merge-btn",g.strategy==="none"&&T.classList.add("merge-btn-disabled"),w||T.classList.add("merge-btn-cross"),T.innerHTML=`<span class="merge-btn-labels">${C}</span><span class="merge-strategy-badge">${this._strategyBadge(g.strategy)}</span>`,T.title=`Merge ${v} into ${m}`,T.dataset.mergeSource=b,T.dataset.mergeTarget=x,T.onclick=()=>{if(this._getStrategy(S).strategy==="none"){Re("Merge Disabled","This merge direction is set to None.");return}this.onMerge(b,x)};const z=document.createElement("div");z.className="merge-btn-row",z.appendChild(T),r.appendChild(z)});const c=document.createElement("button");c.className="merge-gutter-settings",c.innerHTML="&#x2699;",c.title="Manage merge buttons",c.onclick=()=>this._showMergeManagementModal(t,e),r.appendChild(c),n.appendChild(r);const u=document.createElement("div");u.className="resize-handle",this._setupResize(u,e,n),n.appendChild(u);const d=this._firstPanelId(e.children[0]),p=this._firstPanelId(e.children[1]);return requestAnimationFrame(()=>{if(!n.isConnected)return;const h=this.rootEl.querySelector(`.panel[data-panel-id="${d}"]`),y=this.rootEl.querySelector(`.panel[data-panel-id="${p}"]`);if(!h||!y)return;const b=()=>{if(!n.isConnected){x.disconnect();return}const S=n.getBoundingClientRect(),g=h.getBoundingClientRect(),v=y.getBoundingClientRect();if(s){const m=Math.min(g.height,v.height),k=Math.max(g.top,v.top)-S.top;r.style.top=`${Math.max(0,k)}px`,r.style.height=`${m}px`}else{const m=Math.min(g.width,v.width),k=Math.max(g.left,v.left)-S.left;r.style.left=`${Math.max(0,k)}px`,r.style.width=`${m}px`}},x=new ResizeObserver(b);x.observe(h),x.observe(y),b(),n._resizeObserver=x}),n}_getZones(e,s,n){if(e.type==="panel")return[{panels:[{id:e.id,name:this._panelName(e)}],size:100,slot:null}];const t=s==="v"?"h":"v";if(e.direction===t){const i=this._getZones(e.children[0],s,n),l=this._getZones(e.children[1],s,n);return[...i.map(r=>({panels:r.panels,size:r.size*e.sizes[0]/100,slot:r.slot!==null?r.slot:0})),...l.map(r=>({panels:r.panels,size:r.size*e.sizes[1]/100,slot:r.slot!==null?r.slot:1}))]}const a=n==="first"?e.children[1]:e.children[0];return this._getZones(a,s,n)}_allPanelNodes(e){return e.type==="panel"?[{id:e.id,name:this._panelName(e)}]:[...this._allPanelNodes(e.children[0]),...this._allPanelNodes(e.children[1])]}_findPanelNode(e,s){return e?e.type==="panel"?e.id===s?e:null:this._findPanelNode(e.children[0],s)||this._findPanelNode(e.children[1],s):null}_firstPanelId(e){return e.type==="panel"?e.id:this._firstPanelId(e.children[0])}_allPanelIds(e){return e.type==="panel"?[e.id]:[...this._allPanelIds(e.children[0]),...this._allPanelIds(e.children[1])]}_setupResize(e,s,n){const t=s.direction==="v",a=i=>{const l=n.parentElement;if(!l)return null;const r=l.getBoundingClientRect(),c=t?r.width:r.height;t?n.offsetWidth:n.offsetHeight;const u=p=>{let y=(t?p.x-r.left:p.y-r.top)/c;y=Math.max(Ie/c,Math.min(1-Ie/c,y)),s.sizes[0]=y*100,s.sizes[1]=(1-y)*100;const b=l.querySelectorAll(":scope > .panel, :scope > .split-v, :scope > .split-h");b.length>=2&&(b[0].style.flex=`${s.sizes[0]} 1 0`,b[b.length-1].style.flex=`${s.sizes[1]} 1 0`)},d=()=>{document.body.style.cursor="",document.body.style.userSelect="",this._onResizeEnd&&this._onResizeEnd(s)};return document.body.style.cursor=t?"col-resize":"row-resize",document.body.style.userSelect="none",{onMove:u,onEnd:d}};e.addEventListener("mousedown",i=>{i.preventDefault();const l=a({x:i.clientX,y:i.clientY});if(!l)return;const r=u=>l.onMove({x:u.clientX,y:u.clientY}),c=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",c),l.onEnd()};document.addEventListener("mousemove",r),document.addEventListener("mouseup",c)}),e.addEventListener("touchstart",i=>{i.preventDefault();const l=i.touches[0],r=a({x:l.clientX,y:l.clientY});if(!r)return;const c=d=>{d.preventDefault();const p=d.touches[0];r.onMove({x:p.clientX,y:p.clientY})},u=()=>{document.removeEventListener("touchmove",c),document.removeEventListener("touchend",u),document.removeEventListener("touchcancel",u),r.onEnd()};document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",u),document.addEventListener("touchcancel",u)})}_showStrategyPicker(e,s,n){document.querySelector(".merge-strategy-picker")?.remove();const t=this._getStrategy(e),a=t.strategy,i=document.createElement("div");i.className="merge-strategy-picker";const l=s.getBoundingClientRect();i.style.cssText=`position:fixed;left:${l.left}px;top:${l.bottom+4}px;z-index:10000`;const r=[{strat:"mirror",label:"Mirror (M)"},{strat:"push",label:"Push (P)"},{strat:"scoped",label:"Scoped (S)"},{strat:"none",label:"None (N)"}];i.innerHTML=r.map(d=>`<div class="strategy-option${a===d.strat?" active":""}" data-strat="${d.strat}">${a===d.strat?"✓ ":""}${d.label}</div>`).join("")+`
      <hr class="strategy-separator">
      <div class="strategy-option strategy-delete" data-strat="__delete__">&#x2715; Delete</div>
    `,document.body.appendChild(i);const c=()=>{const d=this._getStrategy(e),p=s.querySelector(".merge-strategy-badge");p&&(p.textContent=this._strategyBadge(d.strategy)),s.classList.toggle("merge-btn-disabled",d.strategy==="none")},u=d=>{i.contains(d.target)||(i.remove(),document.removeEventListener("mousedown",u))};i.querySelectorAll(".strategy-option").forEach(d=>{d.onclick=p=>{p.stopPropagation();const h=d.dataset.strat;if(i.remove(),document.removeEventListener("mousedown",u),h==="__delete__"){if(n&&this.mergeButtonLists[n]){const y=this.mergeButtonLists[n].findIndex(b=>`${b.source}→${b.target}`===e);y!==-1&&this.mergeButtonLists[n].splice(y,1),this._rerenderGutter(n),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}return}if(h==="mirror"?delete this.mergeStrategies[e]:this.mergeStrategies[e]={strategy:h,scopeNodes:t.scopeNodes||[]},h==="scoped"){const[y,b]=e.split("→"),x=this._getPanels?this._getPanels():null,S=x?.get(b),g=x?.get(y);S?Dt(S,g,e,this.mergeStrategies,()=>{c(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}):(c(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})))}else c(),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}}))}}),setTimeout(()=>document.addEventListener("mousedown",u),0)}updateMergeButtonStates(e){this.rootEl.querySelectorAll(".merge-btn[data-merge-source]").forEach(s=>{if(s.classList.contains("merge-btn-disabled"))return;const n=s.dataset.mergeSource,t=e.get(n),a=t?t.isClean():!0;s.classList.toggle("merge-btn-allowed",a),s.classList.toggle("merge-btn-blocked",!a)})}_showMergeManagementModal(e,s){const n=this.mergeButtonLists[e]||[],t=new Set(this._allPanelNodes(s.children[0]).map(u=>u.id)),a=()=>n.map((u,d)=>{const{source:p,target:h}=u,y=`${p}→${h}`,b=this._getStrategy(y),x=this._getPanelName(p),S=this._getPanelName(h),g=t.has(p)?`${x} » ${S}`:`${S} « ${x}`;return`
        <div class="mgmt-row" data-idx="${d}" data-key="${y}">
          <span class="mgmt-btn-label">${g}</span>
          <span class="mgmt-strat-label" title="Current strategy">${b.strategy}</span>
          <button class="mgmt-settings-btn btn-icon" data-idx="${d}" title="Edit strategy">&#x2699;</button>
          <button class="mgmt-up-btn btn-icon" data-idx="${d}" title="Move up" ${d===0?"disabled":""}>&#x25B2;</button>
          <button class="mgmt-dn-btn btn-icon" data-idx="${d}" title="Move down" ${d===n.length-1?"disabled":""}>&#x25BC;</button>
          <button class="mgmt-delete-btn btn-danger" data-idx="${d}" title="Delete">&#x00D7;</button>
        </div>
      `}).join(""),l=N(`
      <div class="dialog-header">
        <h3>Merge Buttons</h3>
        <button id="mgmt-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
      </div>
      <p style="font-size:11px;color:var(--text-muted);margin-bottom:8px">Changes are applied live. Use &#x25B2;&#x25BC; buttons to reorder.</p>
      <div id="mgmt-list">${a()||'<p style="color:var(--text-muted);padding:8px;text-align:center">No merge buttons</p>'}</div>
      <button id="mgmt-add" class="btn-secondary" style="margin-top:8px">+ Add Merge Button</button>
    `);l.classList.add("dialog-wide");const r=()=>{l.querySelector("#mgmt-list").innerHTML=a()||'<p style="color:var(--text-muted);padding:8px;text-align:center">No merge buttons</p>',c()},c=()=>{l.querySelectorAll(".mgmt-delete-btn").forEach(u=>{u.onclick=()=>{const d=parseInt(u.dataset.idx);n.splice(d,1),this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),r()}}),l.querySelectorAll(".mgmt-up-btn").forEach(u=>{u.onclick=()=>{const d=parseInt(u.dataset.idx);d!==0&&([n[d-1],n[d]]=[n[d],n[d-1]],this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),r())}}),l.querySelectorAll(".mgmt-dn-btn").forEach(u=>{u.onclick=()=>{const d=parseInt(u.dataset.idx);d!==n.length-1&&([n[d],n[d+1]]=[n[d+1],n[d]],this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),r())}}),l.querySelectorAll(".mgmt-settings-btn").forEach(u=>{u.onclick=()=>{const d=parseInt(u.dataset.idx),p=u.closest(".mgmt-row"),h=p.nextElementSibling;if(h?.classList.contains("mgmt-row-edit")){h.remove();return}l.querySelectorAll(".mgmt-row-edit").forEach(A=>A.remove());const y=p.dataset.key,b=this._getStrategy(y),x=b.strategy,S=["mirror","push","scoped","none"].map(A=>`<label style="display:flex;align-items:center;gap:4px;font-size:11px">
              <input type="radio" name="mgmt-strat-${d}" value="${A}" ${x===A?"checked":""}>
              ${A.charAt(0).toUpperCase()+A.slice(1)}
             </label>`).join(""),[g,v]=y.split("→"),m=this._getPanels?this._getPanels():null,k=m?.get(g),E=m?.get(v),C=E?.template?.specialTypes||[],w=[...E?.graph?.nodes||[],...k?.graph?.nodes||[]].filter((A,K,be)=>be.findIndex(st=>st.label===A.label)===K).filter(A=>C.length===0||C.includes(A.type)),T=b.scopeNodes||[],z=w.length>0?`
            <div id="mgmt-scope-${d}" style="display:${x==="scoped"?"block":"none"};margin-top:4px">
              <div style="font-size:10px;color:var(--text-muted);margin-bottom:2px">Scope nodes:</div>
              ${w.map(A=>`<label style="display:flex;align-items:center;gap:4px;font-size:11px">
                <input type="checkbox" class="mgmt-scope-cb" value="${A.label}" ${T.includes(A.label)?"checked":""}>
                ${A.label}</label>`).join("")}
            </div>`:"",B=document.createElement("div");B.className="mgmt-row-edit",B.innerHTML=`
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:4px">${S}</div>
            ${z}
            <button class="mgmt-apply-btn btn-primary" style="font-size:11px;padding:3px 8px;margin-top:4px">Apply</button>
          `,p.after(B),B.querySelectorAll(`input[name="mgmt-strat-${d}"]`).forEach(A=>{A.onchange=()=>{const K=B.querySelector(`#mgmt-scope-${d}`);K&&(K.style.display=A.value==="scoped"?"block":"none")}}),B.querySelector(".mgmt-apply-btn").onclick=()=>{const A=B.querySelector(`input[name="mgmt-strat-${d}"]:checked`)?.value||"mirror",K=[...B.querySelectorAll(".mgmt-scope-cb:checked")].map(be=>be.value);A==="mirror"?delete this.mergeStrategies[y]:this.mergeStrategies[y]={strategy:A,scopeNodes:K},this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),B.remove(),r()}}})};c(),l.querySelector("#mgmt-add").onclick=()=>{const u=this._allPanelNodes(this.tree),d=this.mergeButtonLists[e]||[];$(),Mt(u,d,({source:p,target:h})=>{this.mergeButtonLists[e]||(this.mergeButtonLists[e]=[]),this.mergeButtonLists[e].push({source:p,target:h}),this._rerenderGutter(e),window.dispatchEvent(new CustomEvent("panel-change",{detail:{type:"layout"}})),this._showMergeManagementModal(e,s)})},l.querySelector("#mgmt-close-x").onclick=$}_mapTree(e,s){const n=s(e);return n!==e?n:e.type==="panel"?e:{...e,children:[this._mapTree(e.children[0],s),this._mapTree(e.children[1],s)]}}_removePanel(e,s){return e.type==="panel"?e:e.children[0].type==="panel"&&e.children[0].id===s?e.children[1]:e.children[1].type==="panel"&&e.children[1].id===s?e.children[0]:{...e,children:[this._removePanel(e.children[0],s),this._removePanel(e.children[1],s)]}}}let le=null;function jt(){let o=0;for(let e=0;e<localStorage.length;e++){const s=localStorage.key(e),n=localStorage.getItem(s);o+=(s.length+n.length)*2}return o}function zt(o){return o<1024?`${o}B`:o<1024*1024?`${(o/1024).toFixed(1)}KB`:`${(o/(1024*1024)).toFixed(1)}MB`}function Bt(){const o=localStorage.getItem("graph-merge-sessions");if(!o)return null;try{const e=JSON.parse(o);let s=0,n=0,t=0,a=null;for(const[i,l]of Object.entries(e))if(l.panels){for(const[r,c]of Object.entries(l.panels))t++,c.graph&&(s+=c.graph.nodes?.length||0,n+=c.graph.edges?.length||0);l.savedAt&&(!a||new Date(l.savedAt)>new Date(a))&&(a=l.savedAt)}return{sessionCount:Object.keys(e).length,totalNodes:s,totalEdges:n,totalPanels:t,latestSavedAt:a}}catch(e){return console.error("Failed to parse session stats:",e),null}}function Y(){if(!le)return;const o=le.querySelector(".status-left"),e=le.querySelector(".status-right"),s=jt(),n=Bt();let t=`Storage: ${zt(s)}`;if(n&&(t+=` | ${n.totalNodes}n ${n.totalEdges}e ${n.totalPanels}p ${n.sessionCount}s`),o.textContent=t,n&&n.latestSavedAt){const a=new Date(n.latestSavedAt).toLocaleTimeString();e.textContent=`Last: ${a}`}else e.textContent=""}function Ht(){if(le=document.getElementById("status-bar"),!le){console.warn("Status bar element not found");return}window.addEventListener("panel-change",Y),Y()}const We="graph-merge-templates";function I(){try{const o=JSON.parse(localStorage.getItem(We));if(o&&typeof o=="object")return o.Default||(o.Default=se()),o}catch{}return{Default:se()}}function ne(o){localStorage.setItem(We,JSON.stringify(o))}function ge(o,e){if(!e.includes(o))return o;let s=2;for(;e.includes(`${o} (${s})`);)s++;return`${o} (${s})`}function Gt(o){const e=Z[o.graphType]?.label||o.graphType,s=o.nodeTypes?.length||0,n=o.edgeTypes?.length||0;return`${e} · ${s} node type${s!==1?"s":""} · ${n} edge type${n!==1?"s":""}`}function Te(){let o=null;const e=l=>{const r=Object.keys(l);return r.length===0?'<p style="color:var(--text-muted);padding:12px;text-align:center">No templates</p>':r.map(c=>{const u=l[c];return`
        <div class="template-list-item ${c===o?"selected":""}" data-name="${c}">
          <span class="tpl-name">${c}</span>
          <span class="tpl-meta">${Gt(u)}</span>
        </div>
      `}).join("")},s=l=>`
    <div class="dialog-header">
      <h3>Templates</h3>
      <button id="dlg-close-x" class="btn-close-icon" title="Close">&#x2715;</button>
    </div>
    <div class="template-list" id="tpl-list">
      ${e(l)}
    </div>
    <div class="template-modal-footer">
      <button id="tpl-add">Add</button>
      <button id="tpl-remove">Remove</button>
      <button id="tpl-edit">Edit</button>
      <button id="tpl-copy">Copy</button>
      <button id="tpl-import">Import</button>
      <button id="tpl-export">Export</button>
    </div>
  `,n=I(),t=N(s(n));t.classList.add("dialog-wide");const a=()=>{const l=I();t.querySelector("#tpl-list").innerHTML=e(l),i()},i=()=>{t.querySelectorAll(".template-list-item").forEach(l=>{l.onclick=()=>{o=l.dataset.name,a()}})};i(),t.addEventListener("click",l=>{l.target.matches("#dlg-close-x")&&$()}),t.querySelector("#tpl-add").onclick=()=>{const l=Object.entries(Z).map(([r,c])=>`<option value="${r}">${c.label}</option>`).join("");t.querySelector("#tpl-list").innerHTML=`
      <div style="padding:12px;display:flex;flex-direction:column;gap:8px">
        <label>Template Name</label>
        <input id="tpl-new-name" type="text" placeholder="Template name" autofocus>
        <label>Graph Type</label>
        <select id="tpl-graph-type">${l}</select>
        <div style="display:flex;gap:8px;margin-top:4px">
          <button id="tpl-create-confirm" class="btn-primary">Create</button>
          <button id="tpl-create-cancel">Cancel</button>
        </div>
      </div>
    `,t.querySelector("#tpl-new-name").focus(),t.querySelector("#tpl-create-cancel").onclick=a,t.querySelector("#tpl-create-confirm").onclick=()=>{const r=t.querySelector("#tpl-new-name").value.trim();if(!r){f("Template name required","error");return}const c=t.querySelector("#tpl-graph-type").value,u=I(),d=ge(r,Object.keys(u));u[d]=it(d,c),ne(u),o=d,f(`Created template "${d}"`,"success"),a()}},t.querySelector("#tpl-remove").onclick=()=>{if(!o){f("Select a template first","info");return}if(o==="Default"){f("Cannot remove the Default template","info");return}const l=I(),r=o;confirm(`Delete template "${r}"?`)&&(delete l[r],ne(l),o=null,f(`Deleted template "${r}"`,"info"),a())},t.querySelector("#tpl-edit").onclick=()=>{if(!o){f("Select a template first","info");return}const r=I()[o];if(!r)return;$();const c=o;Ze(JSON.parse(JSON.stringify(r)),u=>{const d=I();d[c]=u,ne(d),f("Template updated","success"),Te()},!1,()=>Te())},t.querySelector("#tpl-copy").onclick=()=>{if(!o){f("Select a template first","info");return}const l=I(),r=l[o];if(!r)return;const c=ge(o+" Copy",Object.keys(l));l[c]={...JSON.parse(JSON.stringify(r)),name:c},ne(l),o=c,f(`Copied as "${c}"`,"success"),a()},t.querySelector("#tpl-import").onclick=()=>{const l=document.createElement("input");l.type="file",l.accept=".json",l.onchange=()=>{const r=l.files[0];if(!r)return;const c=new FileReader;c.onload=u=>{let d;try{d=JSON.parse(u.target.result)}catch{f("Invalid JSON file","error");return}if(!d.template||!d.template.name){f("Invalid template file","error");return}const p=I(),h=ge(d.template.name,Object.keys(p));p[h]={...d.template,name:h},ne(p),o=h,f(`Imported template "${h}"`,"success"),a()},c.readAsText(r)},l.click()},t.querySelector("#tpl-export").onclick=()=>{if(!o){f("Select a template first","info");return}const r=I()[o];if(!r)return;const c=JSON.stringify({version:1,template:r},null,2),u=new Blob([c],{type:"application/json"}),d=URL.createObjectURL(u),p=document.createElement("a");p.href=d,p.download=`template-${o.replace(/[^a-zA-Z0-9_-]/g,"_")}.json`,p.click(),URL.revokeObjectURL(d),f(`Exported template "${o}"`,"success")}}const Ye="graph-merge-sessions",Xe="graph-merge-active-session";let re=null,U=null,je=null,G=se(),W=null;function J(){try{return JSON.parse(localStorage.getItem(Ye))||{}}catch{return{}}}function ce(o){localStorage.setItem(Ye,JSON.stringify(o))}function te(){return localStorage.getItem(Xe)||"Default"}function fe(o){localStorage.setItem(Xe,o)}function Rt(o){if(!o.state||o.layout)return o;const e=Object.keys(o.state),s={};let n=1;for(const t of e.slice(0,2)){const a=String(n++),i=o.state[t];s[a]={...i,id:a}}return{layout:{tree:{type:"split",direction:"v",children:[{type:"panel",id:"1"},{type:"panel",id:"2"}],sizes:[50,50]},nextId:n},panels:s,template:{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[]},savedAt:o.savedAt}}function Ft(o){return o.template?(o.template.specialTypes||(o={...o,template:{...o.template,specialTypes:[]}}),o):{...o,template:{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[],specialTypes:[]}}}function Ut(o){if(!o.panels)return o;const e={};for(const[s,n]of Object.entries(o.panels))e[s]={pathTrackingEnabled:!1,showExclusions:!0,exclusions:{},...n};return{...o,panels:e}}function Jt(){return G}function X(){if(!re||!U)return;const o=te(),e=J(),s={};for(const[n,t]of re)s[n]=t.getState();e[o]={layout:U.getLayout(),panels:s,template:G,savedAt:new Date().toISOString()},ce(e)}function ye(o){if(!re||!U)return;const e=J();let s=e[o];if(s){if(s=Rt(s),s=Ft(s),s=Ut(s),e[o]=s,ce(e),s.layoutAlgorithm&&s.panels)for(const n of Object.values(s.panels))n.layoutAlgorithm||(n.layoutAlgorithm=s.layoutAlgorithm);if(G=s.template||se(),W&&W(G),s.layout&&U.setLayout(s.layout),s.panels)for(const[n,t]of re)s.panels[n]&&t.setState(s.panels[n]);fe(o),Y()}}function Ke(){clearTimeout(je),je=setTimeout(X,2e3)}function ie(){const o=document.getElementById("session-controls");if(!o)return;const e=J(),s=te(),n=Object.keys(e);n.includes(s)||n.unshift(s);const t=n.map(d=>`<option value="${d}" ${d===s?"selected":""}>${d}</option>`).join("");o.innerHTML=`
    <select id="session-select">${t}</select>
    <div class="session-menu-wrapper">
      <button id="session-menu-toggle" class="btn-icon" title="Session actions">&#x2630;</button>
      <div id="session-menu" class="session-dropdown" hidden>
        <button id="session-new">New</button>
        <button id="session-rename">Rename</button>
        <button id="session-delete">Delete</button>
        <hr class="menu-divider">
        <button id="session-edit-template">Edit Template</button>
        <hr class="menu-divider">
        <button id="session-export">Export</button>
        <button id="session-import">Import</button>
      </div>
    </div>
    <button id="templates-btn" title="Manage templates">Templates</button>
    <button id="add-panel-btn" title="Add panel" style="font-weight:bold;font-size:14px">+</button>
    <button class="help-btn" id="help-btn" title="Keyboard shortcuts">?</button>
  `;const a=o.querySelector("#session-menu"),i=o.querySelector("#session-menu-toggle"),l=()=>a.hidden=!0;i.onclick=d=>{d.stopPropagation(),a.hidden=!a.hidden};const r=d=>{o.contains(d.target)||l()};document.addEventListener("click",r);const c=new MutationObserver(()=>{document.contains(i)||(document.removeEventListener("click",r),c.disconnect())});c.observe(document.body,{childList:!0,subtree:!0});const u=(d,p)=>{const h=o.querySelector(d);h&&(h.onclick=()=>{l(),p()})};o.querySelector("#templates-btn").onclick=()=>Te(),o.querySelector("#session-select").onchange=d=>{X(),ye(d.target.value),f(`Switched to "${d.target.value}"`,"info"),Y()},u("#session-new",async()=>{const d=I(),p=await Ot(d);if(!p)return;const{name:h,templateName:y}=p,b=JSON.parse(JSON.stringify(d[y]||se()));X(),G=b,W&&W(G),U.init(),fe(h.trim()),X(),ie(),f(`Created session "${h.trim()}"`,"success"),Y()}),u("#session-rename",()=>{const d=te(),p=prompt("New name:",d);if(!p||!p.trim()||p.trim()===d)return;const h=J();h[p.trim()]=h[d],delete h[d],ce(h),fe(p.trim()),ie(),f(`Renamed to "${p.trim()}"`,"success")}),u("#session-delete",()=>{const d=te();if(!confirm(`Delete session "${d}"?`))return;const p=J();delete p[d],ce(p);const h=Object.keys(p);h.length>0?ye(h[0]):(fe("Default"),U.init()),ie(),f(`Deleted session "${d}"`,"info"),Y()}),u("#session-edit-template",()=>{Ze(G,d=>{G=d,W&&W(G),Ke(),f("Template updated","success")},!0)}),u("#session-export",Wt),u("#session-import",Yt),o.querySelector("#add-panel-btn").onclick=()=>U.addPanel(),o.querySelector("#help-btn").onclick=()=>{Zt()}}function Zt(){let o=document.querySelector(".keyboard-help");o||(o=document.createElement("div"),o.className="keyboard-help",o.innerHTML=`
      <h3>Keyboard Shortcuts</h3>
      <dl>
        <dt><kbd>Ctrl</kbd>+<kbd>Z</kbd></dt><dd>Undo</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>Shift</kbd>+<kbd>Z</kbd></dt><dd>Redo</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>C</kbd></dt><dd>Copy selected subgraph</dd>
        <dt><kbd>Ctrl</kbd>+<kbd>V</kbd></dt><dd>Paste into focused panel</dd>
        <dt><kbd>Delete</kbd></dt><dd>Delete selected elements</dd>
        <dt><kbd>Escape</kbd></dt><dd>Deselect all / close dialog</dd>
      </dl>
      <div class="dialog-actions" style="margin-top:12px">
        <button onclick="this.closest('.keyboard-help').classList.remove('visible')">Close</button>
      </div>
    `,document.body.appendChild(o)),o.classList.toggle("visible")}function Wt(){X();const o=te(),s=J()[o];if(!s){f("No session to export","error");return}const n=JSON.stringify({version:2,exportedAt:new Date().toISOString(),sessionName:o,...s},null,2),t=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(t),i=document.createElement("a");i.href=a;const l=new Date().toISOString().slice(0,10),r=o.replace(/[^a-zA-Z0-9_-]/g,"_");i.download=`session-${r}-${l}.json`,i.click(),URL.revokeObjectURL(a),f(`Exported session "${o}"`,"success")}function Yt(){const o=document.createElement("input");o.type="file",o.accept=".json",o.onchange=()=>{const e=o.files[0];if(!e)return;const s=new FileReader;s.onload=n=>{let t;try{t=JSON.parse(n.target.result)}catch{f("Invalid JSON file","error");return}if(!t.layout||!t.panels){f("Invalid session file: missing layout or panels","error");return}const a=J(),i=t.sessionName||"Imported",l=prompt("Session name for imported session:",ge(i,Object.keys(a)));if(!l||!l.trim())return;const r=l.trim();a[r]={layout:t.layout,panels:t.panels,template:t.template||{name:"Default",graphType:"DG",nodeTypes:[],edgeTypes:[]},layoutAlgorithm:t.layoutAlgorithm,savedAt:t.savedAt||new Date().toISOString()},ce(a),X(),ye(r),ie(),f(`Imported session "${r}"`,"success"),Y()},s.readAsText(e)},o.click()}function Xt(o,e,s){re=o,U=e,W=s,window.addEventListener("panel-change",Ke);const n=te();J()[n]?ye(n):X(),ie()}let F=null,L=null,de={},M=null,ue=null,R=null;function Kt(o){F=o,document.getElementById("app").addEventListener("mousedown",e=>{const s=e.target.closest("[data-panel-id]");s&&(M=s.dataset.panelId)}),document.addEventListener("keydown",e=>{if(!e.target.matches("input, textarea, select")){if(e.ctrlKey&&e.key==="c")e.preventDefault(),es();else if(e.ctrlKey&&e.key==="v")e.preventDefault(),ts();else if(e.key==="Delete"||e.key==="Backspace"){if(M){const s=F().get(M);s&&s.deleteSelected((n,t)=>D(n,t,s.panelEl))}}else if(e.key==="Escape"&&M){const s=F().get(M);s&&s.cy.elements().unselect()}}})}function Ve(o){const e=F().get(o);if(!e)return;const s=e.getSelectedSubgraph();if(!s||s.nodes.length===0&&s.edges.length===0){f("Nothing selected to copy","info");return}L=s,de=e.getRelevantExclusions(s),ue="elements",R=null,f(`Copied ${s.nodes.length} node(s), ${s.edges.length} edge(s)`,"success")}function Qe(o){if(!L){f("Clipboard is empty","info");return}const e=F().get(o);if(!e)return;const s=F().get(M),n=s?s.pathTrackingEnabled:!1,t=`paste → ${e.id}`,a=e.pasteSubgraph(L,t,de,n);a.ok?f("Pasted subgraph","success"):f(a.error,"error")}function Vt(o,e){const s=F().get(o);if(!s)return;const n=Be(s.graph,e);if(n.nodes.length===0){f("No ancestors found","info");return}L=n,de=s.getRelevantExclusions(n),ue="branch",R=e,s.selectBranch(e),f(`Copied branch from "${e}" (${n.nodes.length} node(s), ${n.edges.length} edge(s))`,"success")}function Qt(o,e){if(!L||ue!=="branch"||!R){f("No branch in clipboard","info");return}const s=F().get(o);if(!s)return;let n=L;e!==R&&(n={nodes:[...L.nodes],edges:[...L.edges,rt(R,e)]});const t=F().get(M),a=t?t.pathTrackingEnabled:!1,i=`branch paste → ${e}`,l=s.pasteSubgraph(n,i,de,a);l.ok?f(e===R?"Pasted branch (no linking edge)":`Pasted branch with edge ${R} → ${e}`,"success"):f(l.error,"error")}function et(){L=null,de={},ue=null,R=null,f("Clipboard cleared","info")}function tt(){return L?{hasContent:!0,mode:ue,branchRoot:R,nodeCount:L.nodes.length,edgeCount:L.edges.length}:{hasContent:!1}}function es(){if(!M){f("Click a panel first","info");return}Ve(M)}function ts(){if(!M){f("Click a panel first","info");return}Qe(M)}let j=null;function ss(){return j||(j=document.createElement("div"),j.className="context-menu",j.style.display="none",document.body.appendChild(j),document.addEventListener("click",o=>{j.contains(o.target)||me()}),document.addEventListener("touchstart",o=>{j.contains(o.target)||me()}),document.addEventListener("keydown",o=>{o.key==="Escape"&&me()})),j}function ke(o,e,s){const n=ss();n.innerHTML="";for(const t of s){if(t.separator){const i=document.createElement("div");i.className="context-menu-separator",n.appendChild(i);continue}const a=document.createElement("button");a.className="context-menu-item",t.disabled&&(a.className+=" context-menu-item-disabled"),a.textContent=t.label,t.disabled||(a.onclick=()=>{me(),t.action()}),n.appendChild(a)}n.style.display="block",n.style.left=`${o}px`,n.style.top=`${e}px`,requestAnimationFrame(()=>{const t=n.getBoundingClientRect();t.right>window.innerWidth&&(n.style.left=`${window.innerWidth-t.width-4}px`),t.bottom>window.innerHeight&&(n.style.top=`${window.innerHeight-t.height-4}px`)})}function me(){j&&(j.style.display="none")}function _e(o){const e=o.originalEvent||o;return e.touches&&e.touches.length>0?{x:e.touches[0].clientX,y:e.touches[0].clientY}:e.changedTouches&&e.changedTouches.length>0?{x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}:{x:e.clientX||0,y:e.clientY||0}}function ns(o){const e=[{label:"Add Node",action:()=>Fe(o)},{label:"Add Edge",action:()=>Ue(o)}],s=o.cy.$(":selected"),n=tt();return(!s.empty()||n.hasContent)&&(e.push({separator:!0}),s.empty()||e.push({label:`Copy Selected (${s.length})`,action:()=>Ve(o.id)}),n.hasContent&&(e.push({label:`Paste (${n.nodeCount}n, ${n.edgeCount}e)`,action:async()=>{await D("Paste Confirmation",`Paste ${n.nodeCount} node(s) and ${n.edgeCount} edge(s)?${n.mode==="branch"?`
Branch root: "${n.branchRoot}"`:""}`,o.panelEl)&&Qe(o.id)}}),e.push({label:"Cancel Copy",action:()=>et()}))),s.empty()||(e.push({separator:!0}),e.push({label:`Delete Selected (${s.length})`,action:()=>o.deleteSelected((t,a)=>D(t,a,o.panelEl))})),e.push({separator:!0}),e.push({label:"Select All",action:()=>o.cy.elements().select()}),s.empty()||e.push({label:"Deselect All",action:()=>o.cy.elements().unselect()}),e}function os(o,e){const s=e.data("label"),n=tt(),t=o.cy.$(":selected").length,a=[{label:`Edit Node "${s}"`,action:()=>{o.cy.elements().unselect(),e.select(),Je(o)}},{label:`Delete Node "${s}"`,action:()=>{o.cy.elements().unselect(),e.select(),o.deleteSelected((i,l)=>D(i,l,o.panelEl))}}];return t>1&&(a.push({separator:!0}),a.push({label:`Delete all selected (${t})`,action:()=>o.deleteSelected((i,l)=>D(i,l,o.panelEl))})),o.pathTrackingEnabled&&e.hasClass("node-fully-excluded")&&(a.push({separator:!0}),a.push({label:"Include All Paths",action:()=>{const i=o.graph.edges.filter(l=>l.source===s);for(const l of i){const r=`${l.source}→${l.target}`;if(o.exclusions[r]){const c=[...o.exclusions[r]||[]];for(const u of c)o.includePathTag(r,u)}}}})),a.push({separator:!0}),a.push({label:`Select Branch from "${s}"`,action:()=>o.selectBranch(s)}),a.push({label:`Copy Branch from "${s}"`,action:()=>Vt(o.id,s)}),n.hasContent&&n.mode==="branch"&&a.push({label:`Paste Branch onto "${s}"`,action:async()=>{const i=n.branchRoot!==s?`
Will create edge: ${n.branchRoot} → ${s}`:"";await D("Paste Branch Confirmation",`Paste branch from "${n.branchRoot}" (${n.nodeCount}n, ${n.edgeCount}e)?${i}`,o.panelEl)&&Qt(o.id,s)}}),n.hasContent&&a.push({label:"Cancel Copy",action:()=>et()}),a}function as(o,e){const s=e.data("source"),n=e.data("target"),t=`${s}→${n}`,a=o.cy.$(":selected").length,i=[{label:`Edit Edge "${s} -> ${n}"`,action:()=>{o.cy.elements().unselect(),e.select(),Je(o)}},{label:`Delete Edge "${s} -> ${n}"`,action:()=>{o.cy.elements().unselect(),e.select(),o.deleteSelected((l,r)=>D(l,r,o.panelEl))}}];if(a>1&&(i.push({separator:!0}),i.push({label:`Delete all selected (${a})`,action:()=>o.deleteSelected((l,r)=>D(l,r,o.panelEl))})),o.pathTrackingEnabled&&o._pathTags){const l=o.template?.specialTypes||[],r=o._pathTags.get(t)||[],c=o._effectiveExclusions?.get(t)||new Set,u=new Set(o.exclusions[t]||[]);if(r.length>0){i.push({separator:!0});const d=h=>q(h,l),p=h=>H(h,l,o.template?.nodeTypes||[]);if(r.length<=6)for(const h of r){const y=d(h),b=u.has(y),x=c.has(y)&&!b,S=p(h);b?i.push({label:`Include ${S}`,action:()=>o.includePathTag(t,y)}):x?i.push({label:`Excluded ${S} (inherited)`,action:()=>Oe(o,t)}):i.push({label:`Exclude ${S}`,action:()=>o.excludePathTag(t,y)})}else i.push({label:"Exclusions...",action:()=>Oe(o,t)})}}return i}function ls(o){o.container.addEventListener("contextmenu",t=>t.preventDefault());const e=t=>{if(t.target!==o.cy)return;const a=_e(t);ke(a.x,a.y,ns(o))};o.cy.on("cxttap",e),o.cy.on("taphold",e);const s=t=>{const a=t.target;if(a.hasClass("diff-removed"))return;const i=_e(t);ke(i.x,i.y,os(o,a))};o.cy.on("cxttap","node",s),o.cy.on("taphold","node",s);const n=t=>{const a=t.target;if(a.hasClass("diff-removed"))return;const i=_e(t);ke(i.x,i.y,as(o,a))};o.cy.on("cxttap","edge",n),o.cy.on("taphold","edge",n)}we.use(lt);const P=new Map;function is(o){for(const e of P.values())e.setTemplate(o)}const O=new It(document.getElementById("app"),{onPanelCreate(o,e){const s=Jt(),n=new wt(o,e,s);P.set(o,n),ls(n)},onPanelDestroy(o){const e=P.get(o);e&&(e.cy.destroy(),P.delete(o))},async onMerge(o,e){const s=P.get(o),n=P.get(e);if(!s||!n)return;const t=`${o}→${e}`,a=O._getStrategy(t),i=a.strategy,l=a.scopeNodes||[];if(i==="none")return;if(s.baseGraph&&!s.isClean()){await Re("Merge Blocked",`Panel ${o} has unapproved changes. Approve Panel ${o} first, then merge.`,document.querySelector(`.panel[data-panel-id="${e}"]`));return}const r=`${o} → ${e}`,c=n.receiveMerge(s.getGraph(),r,s.exclusions,s.pathTrackingEnabled,i,l);c.ok?f(`Pushed ${r}`,"success"):f(c.error,"error")},getState(o){const e=P.get(o);return e?e.getState():null},setState(o,e){const s=P.get(o);s&&s.setState(e)},async confirmClose(o){return await D("Close Panel?",`Close Panel ${o}? Graph data will be lost.`,document.querySelector(`.panel[data-panel-id="${o}"]`))},getPanels(){return P},onResizeEnd(o){const e=O._allPanelIds(o.children[0]),s=O._allPanelIds(o.children[1]);for(const n of[...e,...s]){const t=P.get(n);t&&t.cy&&(t.cy.resize(),t.cy.fit())}}});document.getElementById("app").addEventListener("click",async o=>{const e=o.target.closest("[data-action]");if(!e)return;const s=e.closest(".panel");if(!s)return;const n=s.dataset.panelId,t=P.get(n);if(t)switch(e.dataset.action){case"add-node":Fe(t);break;case"add-edge":Ue(t);break;case"clear":{await D("Clear Panel?",`Reset Panel ${n} to empty state? This clears the graph, approval history, and all diffs.`,s)&&t.clearGraph();break}case"approve":{await D("Approve Panel?",`This will set the current state of Panel ${n} as the baseline and clear all diffs.`,s)&&t.approve();break}case"undo":t.undo();break;case"redo":t.redo();break;case"changeset":Nt(t);break;case"changelog":qt(t);break;case"refresh":t.cy.resize(),t._runLayout(),t._recomputePathTracking();break;case"restore":{await D("Restore Panel?",`Restore Panel ${n} to last approved state? Current changes will be lost.`,s)&&t.restoreFromApproved();break}case"import":At(t);break;case"export":t.exportGraph();break;case"panel-options":Lt(t);break}});O.init();Xt(P,O,o=>{is(o)});Kt(()=>P);Ht();requestAnimationFrame(()=>O.updateMergeButtonStates(P));document.addEventListener("keydown",async o=>{if(o.key==="Escape"&&O._zoomedPanelId){O.toggleZoom(O._zoomedPanelId);return}if((o.ctrlKey||o.metaKey)&&o.key==="z"&&!o.shiftKey){o.preventDefault();const e=Array.from(P.values()).find(s=>s.cy.container()===document.activeElement||s.cy.container().contains(document.activeElement));e?e.undo():P.size>0&&P.values().next().value.undo()}if((o.ctrlKey||o.metaKey)&&o.key==="z"&&o.shiftKey){o.preventDefault();const e=Array.from(P.values()).find(s=>s.cy.container()===document.activeElement||s.cy.container().contains(document.activeElement));e?e.redo():P.size>0&&P.values().next().value.redo()}});const rs=()=>O.updateMergeButtonStates(P);window.addEventListener("panel-change",rs);window.__panels=P;window.__layout=O;
